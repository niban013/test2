åœ¨ Tableau Desktop è¨­å®šè³‡æ–™ä¾†æºå¸³è™Ÿ

é–‹å•Ÿ Tableau Desktopï¼Œæ‰“é–‹ä½ çš„å·¥ä½œç°¿ã€‚

é€£ç·šåˆ°è³‡æ–™ä¾†æº (ä¾‹å¦‚ SQL Serverã€Oracleã€MySQL ç­‰)ã€‚

åœ¨è³‡æ–™ä¾†æºé€£ç·šè¦–çª—ä¸­ï¼Œé¸æ“‡ ä½¿ç”¨è€…åç¨± / å¯†ç¢¼ï¼š

è¼¸å…¥å¯ä»¥å­˜å–è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼ˆå»ºè­°ä½¿ç”¨è®€å–æ¬Šé™çš„å¸³è™Ÿï¼‰ã€‚

ç¢ºèªå¯ä»¥æˆåŠŸé€£ç·šã€‚

2ï¸âƒ£ ç™¼ä½ˆåˆ° Tableau Server

é»é¸ Server â†’ Publish Workbookã€‚

é¸æ“‡ç›®æ¨™å°ˆæ¡ˆ(Project)ã€‚

åœ¨ç™¼ä½ˆå°è©±æ¡†ä¸­ï¼Œæ‰¾åˆ° Data Sources å€å¡Šã€‚

å°ä½ çš„è³‡æ–™ä¾†æºé»é¸ Editã€‚

åœ¨ Authentication æˆ– Connection è¨­å®šä¸­é¸æ“‡ï¼š

Embedded passwordï¼ˆæˆ– Use Embedded Credentialsï¼‰

é€™æ¨£å¸³è™Ÿå¯†ç¢¼æœƒå…§åµŒåœ¨å·¥ä½œç°¿è£¡ï¼ŒServer åœ¨ä½¿ç”¨è€…è¨ªå•æ™‚æœƒè‡ªå‹•ä½¿ç”¨ã€‚


3ï¸âƒ£ ç™¼ä½ˆé¸é …

Show sheets as tabs â†’ å‹¾é¸æˆ–å–æ¶ˆä¾éœ€æ±‚ã€‚

Permissions â†’ è¨­å®šèª°èƒ½å­˜å–ï¼š

Guest: å¦‚æœä½ æ‰“ç®—çµ¦ Guest çœ‹ï¼Œç¢ºä¿å°ˆæ¡ˆ/å·¥ä½œç°¿å…è¨± Guest View æ¬Šé™ã€‚

4ï¸âƒ£ é©—è­‰ Guest æ˜¯å¦èƒ½å­˜å–

æ‰“é–‹ç€è¦½å™¨ï¼Œä½¿ç”¨ Guest èº«ä»½è¨ªå•è©²å°ˆæ¡ˆ/å·¥ä½œç°¿ã€‚

å¦‚æœä¸€åˆ‡è¨­å®šæ­£ç¢ºï¼š

å ±è¡¨æœƒç›´æ¥è¼‰å…¥è³‡æ–™ï¼Œä¸éœ€è¦ç™»å…¥è³‡æ–™åº«å¸³è™Ÿã€‚

Guest ç„¡æ³•ä¿®æ”¹è³‡æ–™ï¼Œåªæœ‰æª¢è¦–æ¬Šé™ã€‚

ğŸ”¹ æ³¨æ„äº‹é …

ä¸è¦ç”¨ Prompt Userï¼Œå¦å‰‡ Guest ç„¡æ³•è¼¸å…¥è³‡æ–™åº«å¸³è™Ÿã€‚

åƒ…æˆæ¬Š Guest æ¬Šé™ï¼Œé¿å…æ•æ„Ÿè³‡æ–™è¢«å¤–éƒ¨ä½¿ç”¨è€…çœ‹åˆ°ã€‚

å¦‚æœè³‡æ–™ä¾†æºæœ‰ Row-Level Securityï¼Œéœ€è¦é¡å¤–è¨­å®š Guest ç¾¤çµ„å°æ‡‰çš„éæ¿¾æ¢ä»¶ã€‚
--------
ğŸ”¹ è¨­å®šæ–¹å¼

å•Ÿç”¨ Guest ä½¿ç”¨è€…

ç³»çµ±ç®¡ç†å“¡è¦åœ¨ Tableau Server è¨­å®šä¸­é–‹å•Ÿã€Œå…è¨±ä½¿ç”¨ Guestã€ã€‚

Guest ä½¿ç”¨è€…æœƒå‡ºç¾åœ¨ Users æ¸…å–®è£¡ï¼ˆä½†ä¸å¯ç™»å…¥ï¼Œåªèƒ½è¢«åˆ†é…æ¬Šé™ï¼‰ã€‚

è¨­å®šå°ˆæ¡ˆ/å·¥ä½œç°¿/æª¢è¦–çš„æ¬Šé™

åˆ°ç›®æ¨™ å°ˆæ¡ˆ(Project) â†’ æ¬Šé™(Permissions)

æ‰¾åˆ° Guest ä½¿ç”¨è€… â†’ åªçµ¦äºˆã€Œæª¢è¦–(View)ã€çš„æ¬Šé™ã€‚

å…¶ä»–å°ˆæ¡ˆæˆ–å ±è¡¨ï¼Œå° Guest è¨­å®šç‚ºã€Œç„¡å­˜å–ã€(Deny)ã€‚

åµŒå…¥ <tableau-viz> æ™‚

ç•¶ä½¿ç”¨è€…è¨ªå•å«æœ‰ <tableau-viz> çš„é é¢æ™‚ï¼Œæœƒä»¥ Guest èº«ä»½å»å­˜å– Tableau Serverã€‚

å¦‚æœè©²å ±è¡¨å…è¨± Guest â†’ å¯ä»¥é¡¯ç¤ºã€‚

å¦‚æœæ²’æ¬Šé™ â†’ æœƒé¡¯ç¤ºã€Œå­˜å–è¢«æ‹’ã€è¨Šæ¯ã€‚

ğŸ”¹ é‡é»

Guest æ˜¯å…¨ä¼ºæœå™¨å…±äº«çš„ä¸€å€‹å¸³è™Ÿï¼Œæ‰€ä»¥æ¬Šé™æ˜¯çµ±ä¸€çš„ï¼Œä¸æœƒä¾ä½¿ç”¨è€…ä¸åŒè€Œæ”¹è®Šã€‚

ä½ å¯ä»¥åˆ©ç”¨ã€Œå°ˆæ¡ˆå±¤ç´šã€æ¬Šé™ï¼ŒæŠŠ Guest é–å®šåœ¨æŸå¹¾å€‹å°ˆæ¡ˆã€‚

å…¶ä»–å°ˆæ¡ˆå³ä½¿å…§éƒ¨å“¡å·¥èƒ½çœ‹ï¼ŒGuest ä¹Ÿå®Œå…¨ç„¡æ³•çœ‹ã€‚

âœ… é€™æ¨£å°±èƒ½åšåˆ°ï¼š

å…¬é–‹æŸäº›å°ˆæ¡ˆ (Guest å¯çœ‹)

å…¶ä»–å°ˆæ¡ˆä»ç„¶éœ€è¦ç™»å…¥å¸³è™Ÿ


è¨­å®š Guest ä¹‹å¾Œï¼Œå ±è¡¨çš„è³‡æ–™é€£ç·š (data source connection) æœ¬èº« ä¸æœƒæ”¹è®Šï¼Œä½†æ˜¯æœƒå—åˆ°ã€Œä½¿ç”¨è€…é©—è­‰æ–¹å¼ã€å½±éŸ¿ï¼š

ğŸ”¹ Tableau ä¸­è³‡æ–™é€£ç·šå¸¸è¦‹æ–¹å¼

åµŒå…¥å¸³è™Ÿå¯†ç¢¼ (Embedded Credentials)

ç™¼å¸ƒå ±è¡¨åˆ° Server æ™‚ï¼Œé¸æ“‡ã€ŒåµŒå…¥å¸³è™Ÿå¯†ç¢¼ã€ã€‚

ä¸è«–æ˜¯å…§éƒ¨ä½¿ç”¨è€…é‚„æ˜¯ Guestï¼Œè³‡æ–™éƒ½æ˜¯é€éé€™å€‹å¸³è™Ÿå»æŸ¥è©¢ã€‚

âœ… Guest ä¸€æ¨£å¯ä»¥å­˜å–ï¼Œå› ç‚ºå ±è¡¨å±¤ç´šå·²ç¶“ç¶å®šäº†ç™»å…¥è³‡è¨Šã€‚

éœ€è¦ä½¿ç”¨è€…æä¾›æ†‘è­‰ (Prompt User)

å ±è¡¨éœ€è¦ä½¿ç”¨è€…è‡ªå·±è¼¸å…¥è³‡æ–™åº«å¸³è™Ÿå¯†ç¢¼ã€‚

âŒ Guest æ²’æœ‰è¼¸å…¥è³‡æ–™åº«æ†‘è­‰çš„æ©Ÿåˆ¶ï¼Œæœƒç›´æ¥ç„¡æ³•è¼‰å…¥ã€‚

ä½¿ç”¨ Tableau Server çš„ã€Œæœå‹™å¸³è™Ÿ / OAuth / SSOã€

ä¾‹å¦‚ç”¨ Service Account æˆ– OAuth token å­˜å–è³‡æ–™ã€‚

âœ… Guest ä¾èˆŠå¯ä»¥é€éé€™ç¨®æ–¹å¼å­˜å–ï¼Œå› ç‚ºæ†‘è­‰å·²ç¶“ç”± Server ç®¡ç†ã€‚

ğŸ”¹ çµè«–

åªè¦è³‡æ–™é€£ç·šè¨­å®šç‚ºã€ŒåµŒå…¥æ†‘è­‰ã€æˆ–ã€Œç”± Server ç®¡ç†ã€ â†’ Guest å¯ä»¥æ­£å¸¸è®€å–ï¼Œä¸æœƒå—å½±éŸ¿ã€‚

å¦‚æœéœ€è¦å€‹åˆ¥ä½¿ç”¨è€…è¼¸å…¥æ†‘è­‰ â†’ Guest ç„¡æ³•ä½¿ç”¨ï¼Œæœƒå ±éŒ¯æˆ–é¡¯ç¤ºç„¡è³‡æ–™ã€‚

ğŸ‘‰ å»ºè­°ï¼š
å¦‚æœä½ è¦é–‹æ”¾ Guest ä½¿ç”¨ï¼Œæ‰€æœ‰è¦çµ¦ Guest çœ‹çš„å ±è¡¨ï¼Œè³‡æ–™ä¾†æºéƒ½è¦è¨­å®šã€ŒåµŒå…¥æ†‘è­‰ã€ï¼Œé€™æ¨£æ‰ä¸æœƒè®“è¨ªå®¢å¡åœ¨ç™»å…¥ç•«é¢ã€‚
âœ… é©åˆ Guest çš„è³‡æ–™é€£ç·šè¨­å®š

åµŒå…¥å¸³è™Ÿå¯†ç¢¼ (Embedded Credentials)

ç™¼å¸ƒå ±è¡¨æ™‚ï¼Œåœ¨ã€Œè³‡æ–™ä¾†æºã€è¨­å®šè£¡å‹¾é¸ã€ŒåµŒå…¥æ†‘è­‰ã€ã€‚

é€£ç·šä½¿ç”¨ç™¼ä½ˆè€…æä¾›çš„å¸³è™Ÿï¼ŒGuest ç›´æ¥ç¹¼æ‰¿ä½¿ç”¨ã€‚

âœ” æœ€å¸¸è¦‹åšæ³•ï¼Œç°¡å–®å¯é ã€‚

Tableau Server ç®¡ç†çš„å¸³è™Ÿ (ä¾‹å¦‚ Service Account / Kerberos Delegation)

ç”± Tableau Server ä»£ç‚ºå­˜å–è³‡æ–™åº«ï¼Œä¸éœ€è¦ä½¿ç”¨è€…è¼¸å…¥æ†‘è­‰ã€‚

Guest ä¸€æ¨£é€é Tableau Server çš„èº«ä»½é€£ç·šã€‚

OAuth / SSO Token (å·²æˆæ¬Šä¸¦ç¶å®šåˆ°è³‡æ–™ä¾†æº)

å¦‚æœç™¼ä½ˆè€…åœ¨ Tableau Server ä¸Šè¨­å®š OAuthï¼Œä¸¦é¸æ“‡ã€ŒåµŒå…¥ OAuth æ†‘è­‰ã€ã€‚

Guest ç…§æ¨£èƒ½ä½¿ç”¨ï¼Œä¸éœ€è¦é‡æ–°ç™»å…¥ã€‚

âŒ ä¸é©åˆ Guest çš„è³‡æ–™é€£ç·šè¨­å®š

Prompt User (æ¯æ¬¡è¼‰å…¥è¦ä½¿ç”¨è€…è¼¸å…¥å¸³è™Ÿå¯†ç¢¼)

Guest æ²’æœ‰ç™»å…¥æ©Ÿåˆ¶ï¼Œç„¡æ³•è¼¸å…¥æ†‘è­‰ã€‚

â†’ å ±è¡¨æœƒè¼‰å…¥å¤±æ•—æˆ–é¡¯ç¤ºã€Œç„¡æ³•å­˜å–è³‡æ–™ã€ã€‚

Row-Level Security (RLS) ä¾ä½¿ç”¨è€…å¸³è™Ÿåˆ¤æ–·è³‡æ–™

å¦‚æœç”¨ USERNAME() æˆ– ISMEMBEROF() åˆ¤æ–·è§’è‰²ï¼ŒGuest æœƒè¢«è¦–ç‚ºä¸€å€‹åŒ¿åä½¿ç”¨è€…ã€‚

é™¤éç‰¹åˆ¥å…è¨± Guest ç¾¤çµ„ï¼Œå¦å‰‡æœƒçœ‹ä¸åˆ°è³‡æ–™ã€‚

åƒ…æ”¯æ´å·²ç™»å…¥ä½¿ç”¨è€…çš„å¤–éƒ¨æœå‹™ (ä¾‹å¦‚å€‹åˆ¥é›²ç«¯å¸³è™Ÿ BigQuery / Snowflake)

å¦‚æœæ²’æœ‰åµŒå…¥ Service Accountï¼Œè€Œæ˜¯è¦æ±‚ä½¿ç”¨è€… OAuth ç™»å…¥è‡ªå·±çš„å¸³è™Ÿã€‚

Guest æ²’æœ‰å¸³è™Ÿï¼Œæœƒå®Œå…¨å¤±æ•ˆã€‚

ğŸ”¹ å»ºè­°åšæ³•

ç™¼ä½ˆåˆ° Guest å¯ç”¨çš„å°ˆæ¡ˆ â†’ ç¢ºä¿è³‡æ–™ä¾†æºå…¨éƒ¨è¨­å®šæˆã€ŒåµŒå…¥æ†‘è­‰ã€ã€‚

å¦‚æœæœ‰ RLS â†’ å»ºç«‹ä¸€å€‹ã€ŒGuest ç¾¤çµ„ã€ï¼Œè®“å®ƒæœ‰ç‰¹å®šçš„è³‡æ–™ç¯„åœã€‚

é¿å… Prompt User â†’ æ”¹ç‚ºã€ŒåµŒå…¥æ†‘è­‰ã€æˆ–ã€Œç”± Server ç®¡ç†ã€ã€‚
const requests = $('#table1, #table2').map(function () {
    const table = $(this).DataTable();
    const ajax = table.settings().init().ajax;

    let payload = {};
    if (typeof ajax.data === "function") {
        ajax.data(payload);   // å‘¼å« function å…ˆå–å¾— DataTables åŸæœ¬è¦å‚³çš„åƒæ•¸
    } else if (typeof ajax.data === "object") {
        payload = $.extend({}, ajax.data); // è¤‡è£½åŸæœ¬è¨­å®š
    }

    // âœ… ä¿®æ”¹åŸæœ¬åƒæ•¸
    payload.city = "é«˜é›„";

    // âœ… é¡å¤–åŠ æ–°åƒæ•¸
    payload.extraParam1 = "æ–°åƒæ•¸1";
    payload.extraParam2 = 12345;

    return $.ajax({
        url: ajax.url,
        type: ajax.type || "GET",
        data: payload,
        dataType: "json"
    });
}).get();

æ–¹æ³• 2ï¼šç”¨ Visual Studio Attach + Symbol Load

å¦‚æœä½ å¸Œæœ›ã€Œé‚Šè·‘ ASP.NET å°ˆæ¡ˆé‚Šçœ‹ã€ï¼Œå¯ä»¥ï¼š

æŠŠå°ˆæ¡ˆè·‘èµ·ä¾†ï¼ˆIIS Express æˆ– IISï¼‰ã€‚

åœ¨ Visual Studio â†’ Debug â†’ Attach to Processï¼Œé¸æ“‡ iisexpress.exe æˆ– w3wp.exeã€‚

é–‹å•Ÿ Modules è¦–çª—ï¼ˆDebug â†’ Windows â†’ Modulesï¼‰ï¼Œæ‰¾åˆ° DotNetCasClient.dllã€‚

å¦‚æœä½ æœ‰ PDB æª”ï¼ˆç¬¦è™Ÿæª”ï¼‰ï¼Œå°±å¯ä»¥è¼‰å…¥ä¸¦è¨­æ–·é»ã€‚

æ²’æœ‰ PDB çš„è©±ï¼Œä½ åªèƒ½é  åç·¨è­¯å·¥å…·çœ‹æµç¨‹ï¼Œå†å¯«è‡ªå·±çš„ HttpModule ä¾† Debugã€‚

Debug æµç¨‹çš„è§€å¯Ÿé»

Redirect åˆ° CAS Loginï¼šä½ æœƒçœ‹åˆ°ç¨‹å¼ç¢¼åˆ¤æ–· !IsAuthenticated â†’ Response.Redirect(casLoginUrl + "?service=...")

Ticket é©—è­‰ï¼šè£¡é¢æœƒæœ‰å‘¼å« CasAuthenticationService.ValidateTicket()

User å»ºç«‹ï¼šç”¨ GenericPrincipal æˆ– FormsAuthentication.SetAuthCookie ä¾†æ›ä¸Šç™»å…¥è³‡è¨Š
<system.web>
  <trace enabled="true" pageOutput="true" requestLimit="50" localOnly="false"/>
</system.web>

protected void Application_AuthenticateRequest(object sender, EventArgs e)
{
    if (Context.User != null && Context.User.Identity.IsAuthenticated)
    {
        System.Diagnostics.Debug.WriteLine("CAS é©—è­‰æˆåŠŸ: " + Context.User.Identity.Name);
    }
}
<?xml version="1.0"?>
<configuration>
  <system.web>
    <!-- ä½¿ç”¨ .NET å…§å»ºçš„ FormsAuthenticationï¼ŒCAS æ¨¡çµ„æœƒå¹«ä½ è™•ç† -->
    <authentication mode="Forms">
      <forms loginUrl="~/login.aspx" timeout="30"/>
    </authentication>

    <authorization>
      <deny users="?"/>
    </authorization>

    <!-- CAS Authentication Module -->
    <httpModules>
      <add name="CasAuthenticationModule"
           type="DotNetCasClient.CasAuthenticationModule, DotNetCasClient"/>
    </httpModules>

    <compilation debug="true" targetFramework="4.7.2"/>
    <trace enabled="true" pageOutput="false" requestLimit="50" localOnly="false"/>
  </system.web>

  <system.webServer>
    <modules>
      <add name="CasAuthenticationModule"
           type="DotNetCasClient.CasAuthenticationModule, DotNetCasClient"
           preCondition="managedHandler"/>
    </modules>
  </system.webServer>

  <!-- DotNetCasClient è¨­å®š -->
  <dotNetCasClient
      casServerLoginUrl="https://your-cas-server.com/cas/login"
      casServerUrlPrefix="https://your-cas-server.com/cas/"
      serverName="https://your-app.example.com"
      notAuthorizedUrl="~/NotAuthorized.aspx"
      redirectAfterValidation="true"
      renew="false"
      singleSignOut="true"
      gateway="false"
      cookiesRequiredUrl="~/CookiesRequired.aspx"
      loginCallbackUrl="~/LoginCallback.aspx" />
</configuration>
using System;
using System.Web;

public class Global : HttpApplication
{
    protected void Application_AuthenticateRequest(object sender, EventArgs e)
    {
        if (Context.User != null && Context.User.Identity.IsAuthenticated)
        {
            System.Diagnostics.Debug.WriteLine("CAS é©—è­‰æˆåŠŸï¼š" + Context.User.Identity.Name);
        }
        else
        {
            System.Diagnostics.Debug.WriteLine("å°šæœªé©—è­‰");
        }
    }
}
<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="Default.aspx.cs" Inherits="CasDemo.Default" %>
<!DOCTYPE html>
<html>
<head runat="server">
    <title>CAS é©—è­‰æ¸¬è©¦</title>
</head>
<body>
    <form id="form1" runat="server">
        <div>
            <h2>CAS é©—è­‰æ¸¬è©¦é é¢</h2>
            <asp:Label ID="lblUser" runat="server" Text=""></asp:Label>
        </div>
    </form>
</body>
</html>
using System;

namespace CasDemo
{
    public partial class Default : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (User != null && User.Identity.IsAuthenticated)
            {
                lblUser.Text = "ç™»å…¥æˆåŠŸï¼Œä½¿ç”¨è€…ï¼š" + User.Identity.Name;
            }
            else
            {
                lblUser.Text = "å°šæœªç™»å…¥";
            }
        }
    }
}
æ¸¬è©¦æµç¨‹

å•Ÿå‹•å°ˆæ¡ˆ â†’ ç€è¦½ http://localhost:xxxx/

å› ç‚º <authorization><deny users="?" /></authorization>ï¼Œæœªç™»å…¥æœƒè¢«å°å‘ CAS Login

æˆåŠŸç™»å…¥å¾Œ â†’ CAS å¸¶ ticket=ST-xxx å›ä¾†

CAS Authentication Module æœƒè‡ªå‹•é©—è­‰ä¸¦å»ºç«‹ FormsAuthenticationTicket

ä½ åœ¨ HttpContext.User.Identity.Name å°±èƒ½æ‹¿åˆ°ä½¿ç”¨è€…å¸³è™Ÿ
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>DataTables å¤šè¡¨æ ¼ Excel åŒ¯å‡º</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- Bootstrap CSS (spinner) -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"> -->
  <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.3/css/dx.light.css">
  <script src="https://cdn3.devexpress.com/jslib/22.2.3/js/jquery.min.js"></script>
  <script src="https://cdn3.devexpress.com/jslib/22.2.3/js/jszip.min.js"></script>
  <script src="https://cdn3.devexpress.com/jslib/22.2.3/js/dx.all.js"></script>
<!-- Bootstrap 4 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
 .tooltip-dark {
  position: relative;
  cursor: pointer;
}
.tooltip-dark:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
}
.tooltip-light {
  position: relative;
  cursor: help;
}
.tooltip-light:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  top: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: #f9f9f9;
  color: #333;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 13px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
  white-space: nowrap;
}
.tooltip-color {
  position: relative;
  cursor: pointer;
}
.tooltip-color:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 130%;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #42a5f5, #478ed1);
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: bold;
  white-space: nowrap;
}
.table-container {
  position: relative; /* é€™è£¡å¾ˆé‡è¦ */
  margin-bottom: 40px;
}

/* overlay èƒŒæ™¯ */
.table-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.1);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  pointer-events: auto;
}

/* æ–¹æ¡† */
.overlay-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 30px;
  background: rgba(255,255,255,0.9);
  border: 2px solid #007bff;
  border-radius: 10px;
  color: #007bff;
  font-weight: bold;
  font-size: 16px;
}

/* æ—‹è½‰åœ–ç¤º */
.spinner-icon {
  font-size: 36px;
  margin-bottom: 10px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

/* æ–‡å­—ä¾æ¬¡è·³å‹• */
.overlay-text span {
  display: inline-block;
  animation: jump 1s infinite;
  margin: 0 1px;
}

@keyframes jump {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
 .card-header {
      background: linear-gradient(135deg, #007bff, #00c6ff);
      color: white;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }
</style>
</head>

<body class="p-4">
     <div class="container-fluid form-group">
   <div class="card  border border-dark">
    <div class="card-header bg-primary text-white">
      <i class="fas fa-edit mr-2"></i> DevExtreme è¡¨å–®é¢æ¿
    </div>
    <div class="card-body">
      <form>
        <!-- ç¬¬ä¸€åˆ— -->
        <div class="form-row mb-3">
          <div class="col-md-4">
            <label for="dxName">å§“å</label>
            <div id="dxName"></div>
          </div>
          <div class="col-md-4">
            <label for="dxAge">å¹´é½¡</label>
            <div id="dxAge"></div>
          </div>
          <div class="col-md-4">
            <label for="dxCity">åŸå¸‚</label>
            <div id="dxCity"></div>
          </div>
        </div>

        <!-- ç¬¬äºŒåˆ— -->
        <div class="form-row">
          <div class="col-md-4">
            <label for="dxEmail">Email</label>
            <div id="dxEmail"></div>
          </div>
         <div class="col-md-4">
  <label for="dxStartDate">å…¥è·æ—¥æœŸ (yyyymm)</label>
  <div id="dxStartDate"></div>
</div>
          <div class="col-md-4">
            <label for="dxDept">éƒ¨é–€</label>
            <div id="dxDept"></div>
          </div>
        </div>
      </form>
    </div>
  <div class="card-footer text-center">
  <button type="button" class="btn btn-success">é€å‡º</button>
  <button type="reset" class="btn btn-secondary">é‡è¨­</button>
</div>
  </div>
    </div>
 <!-- è‡ªè¨‚ overlay -->
    <!-- <div class="table-overlay" id="overlay"> -->
      <!-- <div class="spinner-icon"><i class="fas fa-circle-notch"></i></div> -->
      <!-- <div>è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div> -->
    <!-- </div> -->
<h3>Table 1</h3>
<div class="table-container">
   <table id="zexample1" class="display" style="width:100%">
  <thead>
    <tr>
      <th>å§“å</th>
      <th>å¹´é½¡</th>
      <th>åŸå¸‚</th>
      <th>è·ç¨±</th>
    </tr>
  </thead>
</table>
  <div class="table-overlay" id="overlay1">
    <div class="overlay-box">
      <div class="spinner-icon"><i class="fas fa-circle-notch"></i></div>
      <div id="overlay-text" class="overlay-text">Table 1 è¼‰å…¥ä¸­...</div>
    </div>
  </div>
</div>
 
<h3 class="mt-4">Table 2</h3>
 <!-- <div class="table-container"> -->
<table id="zexample2" class="display" style="width:100%">
  <thead>
    <tr>
      <th>éƒ¨é–€ä»£è™Ÿ</th>
      <th>éƒ¨é–€åç¨±</th>
    </tr>
  </thead>
</table>

<div class="mt-4">
  <button id="exportExcel" class="btn btn-success">
    <i class="bi bi-download"></i> åŒ¯å‡º Excel
  </button>
</div> 
 <h2>jQuery Modal ç¯„ä¾‹</h2>
  <button id="openModal" class="btn btn-primary">é–‹å•Ÿ Modal</button>

  <!-- Modal å…ƒä»¶ -->
  <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">æç¤ºè¨Šæ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          é€™æ˜¯ä¸€å€‹ Bootstrap Modal çš„ç¯„ä¾‹ï¼
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
          <button type="button" class="btn btn-primary" id="confirmBtn">ç¢ºèª</button>
        </div>
      </div>
    </div>
  </div>
 

<script>


// å°‡æ–‡å­—æ‹†æˆ span è®“æ¯å€‹å­—ä¾æ¬¡è·³å‹•
function splitTextToSpan(elId){
  const el = document.getElementById(elId);
  const text = el.textContent;
  el.textContent = '';
  text.split('').forEach((char, i)=>{
    const span = document.createElement('span');
    span.textContent = char;
    span.style.animationDelay = `${i*0.1}s`;
    el.appendChild(span);
  });
}
splitTextToSpan('overlay-text');

$(document).ready(function() {
  // DxTextBox
    $("#dxName").dxTextBox({ placeholder: "è«‹è¼¸å…¥å§“å" });
    $("#dxAge").dxTextBox({ mode: "number", placeholder: "è«‹è¼¸å…¥å¹´é½¡" });
    $("#dxEmail").dxTextBox({ mode: "email", placeholder: "è«‹è¼¸å…¥ Email" });
  // DxDateBox
$("#dxStartDate").dxDateBox({
    type: "date",
    displayFormat: "yyyyMM",
    pickerType: "rollers",
    placeholder: "é¸æ“‡å…¥è·å¹´æœˆ"
});

    // DxSelectBox
    $("#dxCity").dxSelectBox({
      items: ["å°åŒ—", "å°ä¸­", "é«˜é›„"],
      placeholder: "é¸æ“‡åŸå¸‚"
    });

    $("#dxDept").dxSelectBox({
      items: ["ç ”ç™¼éƒ¨", "è¨­è¨ˆéƒ¨", "è¡ŒéŠ·éƒ¨"],
      placeholder: "é¸æ“‡éƒ¨é–€"
    });








  // é»æ“ŠæŒ‰éˆ•é–‹å•Ÿ modal
      $("#openModal").click(function () {
        $("#myModal").modal("show");
      });

      // é»æ“Šç¢ºèªæŒ‰éˆ•äº‹ä»¶
      $("#confirmBtn").click(function () {
        alert("ä½ é»äº†ç¢ºèªï¼");
        $("#myModal").modal("hide"); // é—œé–‰ modal
      });
  var overlay1 = $('#overlay1');
  var overlay2 = $('#overlay2');
  function showOverlay(overlay) {
    overlay.show();
    overlay.css('opacity', 1);
  }

  function hideOverlay(overlay) {
    overlay.css('opacity', 0);
    setTimeout(function(){ overlay.hide(); }, 500);
  }

  showOverlay(overlay1); // é é¢åˆå§‹é¡¯ç¤º overlay
  // Table 1 å…§åµŒè³‡æ–™
  let table1 = $('#zexample1').DataTable({
  language: {
    loadingRecords: "", // è¼‰å…¥è³‡æ–™æ™‚ä¸é¡¯ç¤ºæ–‡å­—
    zeroRecords: "" // ä»å¯è‡ªè¨‚ç„¡è³‡æ–™è¨Šæ¯
  },
     scrollY: '300px',   // å›ºå®šé«˜åº¦
    scrollCollapse: false, // è³‡æ–™å°‘æ–¼é«˜åº¦æ™‚æ˜¯å¦æ”¶ç¸®ï¼Œfalse å¯ç¶­æŒé«˜åº¦
    <!-- data: [ -->
      <!-- { name: "ç‹å°æ˜", age: 28, city: "å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—å°åŒ—", title: "å·¥ç¨‹å¸«å·¥ç¨‹å¸«å·¥ç¨‹å¸«å·¥ç¨‹å¸«å·¥ç¨‹å¸«å·¥ç¨‹å¸«å·¥ç¨‹å¸«å·¥ç¨‹å¸«" }, -->
      <!-- { name: "æå°è¯", age: 34, city: "å°ä¸­", title: "è¨­è¨ˆå¸«" }, -->
      <!-- { name: "å¼µå¤§åŒ", age: 41, city: "é«˜é›„", title: "ç¶“ç†" } -->
    <!-- ], -->
	  <!-- ajax: { -->
      <!-- url: 'http://localhost:8000/data1.json', -->
      <!-- dataType: 'json', -->
      <!-- dataSrc: '' // å› ç‚º JSON æ˜¯é™£åˆ— -->
    <!-- },  -->
ajax: function(data, callback) {
      // æ¨¡æ“¬å»¶é² 2 ç§’å†ç™¼ AJAX
      setTimeout(function() {
        $.ajax({
          url: 'http://localhost:8000/data1.json',   // âœ… æ›æˆä½ çš„ API
          type: 'GET',
          success: function(res) {
            // å‡è¨­å›å‚³æ ¼å¼ { data: [...] }
              callback({ data: res });
			      // å–å¾— overlayï¼Œå¹³æ»‘æ·¡å‡º
			 // è¼‰å…¥å®Œæˆæ·¡å‡º overlay
            hideOverlay(overlay1); // è¼‰å…¥å®Œæˆæ‰éš±è— overlay
          },
          error: function() {
            callback({ data: [] }); // éŒ¯èª¤å›ç©ºè¡¨
		    hideOverlay(overlay1); // è¼‰å…¥å®Œæˆæ‰éš±è— overlay
          }
        });
      }, 12000); // 2 ç§’å»¶é²
    },
 
    columns: [
      { data: 'name',export: false , createdCell: function(td, cellData) {
        $(td).addClass("tooltip-light").attr("data-tooltip", "è·æ¥­ï¼š" + cellData);
      } },
      { data: 'age',export: false },
      { data: 'city',export: true},
      { data: 'title',export: true }
    ]
  });

  // Table 2 å…§åµŒè³‡æ–™
  let table2 = $('#zexample2').DataTable({
    <!-- data: [ -->
      <!-- { deptId: "D01", deptName: "ç ”ç™¼éƒ¨" }, -->
      <!-- { deptId: "D02", deptName: "è¡ŒéŠ·éƒ¨" }, -->
      <!-- { deptId: "D03", deptName: "è²¡å‹™éƒ¨" } -->
    <!-- ], -->
	  ajax: {
      url: 'http://localhost:8000/data2.json',
      dataType: 'json',
      dataSrc: '' // å› ç‚º JSON æ˜¯é™£åˆ—
    },
    columns: [
      { data: 'deptId' },
      { data: 'deptName',export: true }
    ]
  });
  function exportnodt(tableId){
   $.ajax({
        url: 'http://localhost:8000/data1.json',  // JSON æª”æ¡ˆè·¯å¾‘
        type: 'GET',
        dataType: 'json',
        success: async function(data) {
            let workbook = new ExcelJS.Workbook();
			let ws = workbook.addWorksheet(tableId);
			let headers = ''
            ws.addRow(headers);
			ws.getRow(1).eachCell(cell => {
				cell.font = { bold: true };
				cell.alignment = { horizontal: 'center', vertical: 'middle' };
		    });
			data.forEach(row => {
			// row æœ¬èº«æ˜¯ arrayï¼ˆè‹¥ dataSrc ç”¨ array æ ¼å¼ï¼‰
			   ws.addRow(Object.values(row));
		    });
			 // è‡ªé©æ‡‰æ¬„å¯¬
			  ws.columns.forEach(col => {
				  col.width = 30; // å›ºå®šå¯¬åº¦
				  col.eachCell(cell => {
					cell.alignment = { vertical: 'middle' }; 
				  });
				});

			  // åŠ æ ¼ç·š
			  ws.eachRow({ includeEmpty: false }, row => {
				row.eachCell(cell => {
				  cell.border = {
					top: { style: 'thin' },
					left: { style: 'thin' },
					bottom: { style: 'thin' },
					right: { style: 'thin' }
				  };
				});
			  });
			   // ä¸‹è¼‰ Excel
				const buffer = await workbook.xlsx.writeBuffer();
				saveAs(new Blob([buffer]), 'AllTables_Export.xlsx');
        },
        error: function(xhr, status, error) {
          console.error('è®€å– JSON ç™¼ç”ŸéŒ¯èª¤:', error);
        }
      });
  }
  //function exportdt()
  
  async function fetchData(ws,exportCols) {
  try {
        const data = await $.ajax({
				url: 'http://localhost:8000/data2.json',  // JSON æª”æ¡ˆè·¯å¾‘
				type: 'GET',
				dataType: 'json' 
			  }); 
			  data.forEach(row => {
			  // åªå–è¦åŒ¯å‡ºçš„æ¬„ä½å€¼
				const rowData = exportCols.map(c => row[c.data]);
				ws.addRow(rowData);
			  });  
	  
  } catch (err) {
    console.error('AJAX éŒ¯èª¤:', err);
  }
   return ws
}

function getAjaxUrl(table) {
  let ajaxCfg = table.settings().init().ajax;
  let url = typeof ajaxCfg === "string" ? ajaxCfg : ajaxCfg.url;

  if (typeof ajaxCfg === "object" && ajaxCfg.data) {
    let params = new URLSearchParams(ajaxCfg.data).toString();
    if (params.length > 0) {
      return url + "?" + params;
    }
  }
  return url;
}
	async  function exportdt2(filename,tablekey){
       try{
	        const workbook = new ExcelJS.Workbook();
			const tables = $('table[id^="'+tablekey+'"]');
			// å…ˆæ”¶é›†æ‰€æœ‰ ajax è«‹æ±‚ (ç”¨ DataTable è¨­å®šçš„ URL)
			const requests = tables.map(function () {
			  const table = $(this).DataTable();
		      const url = getAjaxUrl(table)
			  return $.ajax({ url  , dataType: "json" });
			}).get();
			 // ç­‰å¾…æ‰€æœ‰ ajax å®Œæˆ
			const results = await Promise.all(requests);

			// ä¸€å¼µ table å°æ‡‰ä¸€å€‹ worksheet
			tables.each(function (i) {
			  const table = $(this).DataTable();
			  const sheetName = $(this).attr("id"); // ç”¨ table id ç•¶ sheet åç¨±
			  const ws = workbook.addWorksheet(sheetName);

			  const data = results[i];
			  if (data.length === 0) return;
			  
              const tableInit = table.settings().init()
              const exportCols = tableInit.columns.filter(c => c.export)
			  if(exportCols.length == 0){
			       throw new Error("table:ã€Œ"+sheetName+"ã€æ²’æœ‰è¨­å®šåŒ¯å‡ºæ¬„ä»»ï¼Œcolumns-> æ¬„ä½è¨­å®šexport: true");
			  }
			  exportCols.map((col, idx) => {
			    	//col.title ? col.title : $(table.column(idx).header()).text()
				   let _idx = table.columns().indexes().filter(function (i) {
					  return tableInit.columns[i].data === col.data;
					})[0];
					col.title = $(table.column(_idx).header()).text().trim(); // æŠŠè¡¨é ­æ–‡å­—å¯«å›æ¬„ä½è¨­å®š
			  });
      //const exportCols2 = tableInit.columns.filter(c => c.export);
  
			 // const ths = $(`#${tableId} thead th`);
			//	exportCols.forEach((c, idx) => {
			//	  c.title = ths.eq(idx).text().trim(); // æŠŠè¡¨é ­æ–‡å­—å¯«å›æ¬„ä½è¨­å®š
			//  });
  






			  // å– DataTable columns è¨­å®šçš„æ¨™é¡Œ (å¦‚æœæ²’è¨­å°±æŠ“ th çš„æ–‡å­—)
			 // const settings = table.settings().init();
			 // let headers = settings.columns.map((col, idx) =>
			//	col.title ? col.title : $(table.column(idx).header()).text()
			 // );

			  // åŠ è¡¨é ­
			  const headerRow = ws.addRow(exportCols.map(c => c.title));
			  headerRow.eachCell(cell => {
				cell.font = { bold: true };
				cell.alignment = { horizontal: "center", vertical: "middle" };
			  });

			  // åŠ è³‡æ–™
			  data.forEach(row => {
			    const rowData = exportCols.map(c => row[c.data]);
				ws.addRow(rowData); // ç”¨æ¬„ä½åç¨±å°æ‡‰
			  });

			  // è‡ªå‹•æ¬„å¯¬
			  ws.columns.forEach(col => {
				let maxLength = 10;
				col.eachCell({ includeEmpty: true }, cell => {
				  const v = cell.value ? cell.value.toString() : "";
				  maxLength = Math.max(maxLength, v.length);
				});
				col.width = maxLength + 2;
			  });
			});

			// åŒ¯å‡ºæª”æ¡ˆ
			const buffer = await workbook.xlsx.writeBuffer();
			saveAs(new Blob([buffer]), "DataTables_MultiSheet.xlsx");
	   }
	   catch (err) {
		 console.error("åŒ¯å‡ºéŒ¯èª¤:", err);
		alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ console");
	   }
	}
  async function exportdt(filename,tablekey){
     let workbook = new ExcelJS.Workbook();

    $('table[id^="'+tablekey+'"]').each(function() {
       let tableId = $(this).attr('id');
       let dt = $(`#${tableId}`).DataTable();
       let ws = workbook.addWorksheet(tableId); 
	   const tableInit = dt.settings().init()
       const exportCols = tableInit.columns.filter(c => c.export);
  
	   const ths = $(`#${tableId} thead th`);
		exportCols.forEach((c, idx) => {
		  c.title = ths.eq(idx).text().trim(); // æŠŠè¡¨é ­æ–‡å­—å¯«å›æ¬„ä½è¨­å®š
	  });
  
      ws.addRow(exportCols.map(c => c.title)); 
	  // è¡¨é ­åŠ ç²— + ç½®ä¸­
	  const headerRow = ws.getRow(1);
	  headerRow.eachCell({ includeEmpty: true }, (cell) => {
		cell.font = { bold: true };
		cell.alignment = { horizontal: 'center', vertical: 'middle' };
	  });
 
	  if(tableInit.fulldata){
	    ws= fetchData(ws,exportCols)
	  }
      else
	  {
		   const data = dt.rows({ search: 'applied' }).data().toArray();
			 data.forEach(row => {
		  // åªå–è¦åŒ¯å‡ºçš„æ¬„ä½å€¼
			const rowData = exportCols.map(c => row[c.data]);
			ws.addRow(rowData);
		  }); 
	  }	  
      
      // è‡ªé©æ‡‰æ¬„å¯¬
	  ws.columns.forEach(col => {
		  col.width = 30; // å›ºå®šå¯¬åº¦
		  col.eachCell(cell => {
			//cell.alignment = { vertical: 'middle' }; 
		  });
		});

      // åŠ æ ¼ç·š
      ws.eachRow({ includeEmpty: false }, row => {
        row.eachCell(cell => {
          cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
          };
        });
      });

    });

    // ä¸‹è¼‰ Excel
    const buffer = await workbook.xlsx.writeBuffer();
 //   saveAs(new Blob([buffer]), filename+'.xlsx');
  }
  // åŒ¯å‡º Excel
  $('#exportExcel').on('click', async function() { 
      //exportnodt('zexample')
    exportdt2('test','zexample')
	//exportdt('test','zexample')
  });

});
</script>
</body>
</html>
