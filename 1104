<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESG Dashboard - å¸¶æµ®å‹•å­é¸å–®</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./i18n.js"></script>
<style>
body {
  overflow-x:hidden;
  margin:0;
  background-color:#f4f8f5; /* æŸ”å’Œç¶ åº• */
  font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
}

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: 240px;
  height: 100%;
  background: linear-gradient(180deg, #2b593f 0%, #1e3a2b 100%); /* æ·±ç¶ æ¼¸å±¤ */
  color: #e9f5ee;
  transition: all .3s ease-in-out;
  z-index: 1040;
  overflow-y: auto;
  box-shadow: 2px 0 6px rgba(0,0,0,0.2);
}
.sidebar a {
  color: #d2f0de;
  display: block;
  padding: 10px 15px;
  text-decoration: none;
  transition: all .2s;
}
.sidebar a:hover, .sidebar a.active {
  background: #5cb85c; /* ç¶ è‰²ä¸»èª¿ */
  color: #fff;
}

/* Submenu */
.sidebar .submenu { display: none; padding-left: 25px; }
.sidebar .submenu a {
  font-size: 0.9em;
  color: #c6e8d1;
}
.sidebar .submenu a:hover {
  background: rgba(255,255,255,0.1);
}
/* é˜²æ­¢å±•é–‹æ™‚ hover æˆ– active è®Šç™½ */
.sidebar .has-submenu.open > a,
.sidebar .has-submenu > a:hover {
  background: #2b593f !important;
  color: #fff !important;
}
/* Sidebar ç¸®èµ· */
.sidebar.collapsed { width: 60px; overflow: visible; }
.sidebar.collapsed a span.text { display: none; }

/* âœ… æµ®å‹•å­é¸å–®ï¼ˆç¸®é€²ç‹€æ…‹ä¸‹é¡¯ç¤ºï¼‰ */
.sidebar.collapsed .has-submenu:hover > .submenu {
  display: block !important;
  position: absolute;
  left: 60px;
  top: 0;
  background: #2f5c43;
  border-radius: 0 4px 4px 0;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
  width: 180px;
  padding: 5px 0;
  z-index: 1050;
}

/* Main Panel */
#main-panel {
  margin-left: 240px;
  transition: margin-left .3s ease-in-out;
  background-color: #f4f8f5;
  min-height: 100vh;
}
#main-panel.full { margin-left: 60px; }

/* Header */
#main-header {
  background: #e9f5ee;
  border-bottom: 1px solid #c8e3d0;
  height: 50px;
  padding: 0 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

#main-header .btn {
  background-color: #5cb85c;
  color: #fff;
  border: none;
  transition: background .2s;
}
#main-header .btn:hover { background-color: #4cae4c; }

#main-header .header-title {
  flex: 1;
  text-align: center;
  margin: 0;
  font-size: 17px;
  font-weight: 600;
  color: #2e4634;
  letter-spacing: 1px;
}
#main-header .user-info {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: #2b3b2b;
}
#logoutBtn {
  background-color: #e26a5c;
  border: none;
  color: #fff;
}
#logoutBtn:hover { background-color: #c9574c; }

/* Content */
#content-container {
  padding: 25px 35px;
  background: #f8fbf9;
  border-radius: 6px;
  margin: 15px;
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
}

/* Accordion Footer */
.accordion-footer {
  margin-top: 30px;
}
.accordion-footer .panel-heading {
  background: #d9f0df;
  border-top: 1px solid #b6dec0;
  cursor: pointer;
}
.accordion-footer .panel-title a {
  display: block;
  text-decoration: none;
  color: #2b3b2b;
  font-weight: 500;
}
.accordion-footer .panel-body {
  background: #f4f8f5;
  border-top: 1px solid #cde7d5;
}
.nav > li > a:focus{
    background-color: #5cb85c !important;
    text-decoration: none !important;
  }
  
  .nav > li > a:hover {
    background-color: #5cb85c !important;
    text-decoration: none !important;
  }
/* ---------------------------
   Sidebar Icon èˆ‡æ–‡å­—æ¨£å¼
--------------------------- */

/* li a ç½®ä¸­å°é½Šå®¹å™¨ */
.sidebar a {
  display: flex;
  align-items: center;
  gap: 8px; /* icon èˆ‡æ–‡å­—é–“éš” */
  transition: all 0.2s ease;
}

/* Icon */
.sidebar a span.glyphicon {
  flex-shrink: 0;
  font-size: 16px;
  width: 20px;
  text-align: center;
  transition: all 0.2s ease;
}

/* æ”¶åˆæ™‚æ”¾å¤§ä¸¦ç½®ä¸­ */
.sidebar.collapsed a span.glyphicon {
  font-size: 24px;
  width: 100%;
  text-align: center;
}

/* æ”¶åˆæ™‚éš±è—æ–‡å­— */
.sidebar.collapsed a span.text {
  display: none;
}

/* äºŒç´š submenu li */
.sidebar .submenu a {
  display: flex;
  align-items: center;
  gap: 6px;
  padding-left: 30px;
  transition: all 0.2s ease;
}

/* æ”¶åˆæ™‚ submenu ä¹Ÿç½®ä¸­ iconã€éš±è—æ–‡å­— */
.sidebar.collapsed .submenu a span.text {
  display: none;
}
.sidebar.collapsed .submenu a {
  justify-content: center;
}

/* æ”¶åˆæ™‚æ‰€æœ‰å­é¸å–®éš±è—ï¼Œåƒ…æµ®å‹•æ™‚é¡¯ç¤º */
.sidebar.collapsed .submenu {
  display: none !important;
}

/* æµ®å‹•å­é¸å–®ï¼ˆæ»‘é¼  hoverï¼‰ */
.sidebar.collapsed .has-submenu:hover > .submenu {
  display: block !important;
  position: absolute;
  left: 60px;
  top: 0;
  background: #2f5c43;
  border-radius: 0 4px 4px 0;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
  width: 100px;
  padding: 5px 0;
  z-index: 1050;
}

/* æ”¶åˆæ™‚ hover æ•ˆæœï¼Œicon æ”¾å¤§ */
.sidebar.collapsed a:hover span.glyphicon,
.sidebar.collapsed .submenu a:hover span.glyphicon {
  font-size: 24px;
}

/* âœ… æµ®å‹•å³å´ä¸‹è¼‰é€²åº¦é¢æ¿ */
#download-panel {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 280px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  overflow: hidden;
  transition: all .3s ease;
  z-index: 1060;
}

/* header */
#download-panel .panel-header {
  background: #2b593f;
  color: #fff;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  font-weight: 600;
}
#download-panel .panel-header:hover {
  background: #36744e;
}

/* å…§å®¹å€ */
#download-panel .panel-body {
  max-height: 240px;
  overflow-y: auto;
  background: #f8fbf9;
  padding: 10px;
}

/* å–®ç­†ä¸‹è¼‰é …ç›® */
.download-item {
  padding: 6px 0;
  border-bottom: 1px solid #dbe9e0;
}
.download-item:last-child { border-bottom: none; }

.download-item .file-name {
  font-size: 13px;
  color: #2b3b2b;
  margin-bottom: 4px;
}
.download-item .progress {
  height: 6px;
  margin: 0;
}
.download-item .progress-bar {
  background-color: #5cb85c;
}

/* æ”¶åˆç‹€æ…‹ */
#download-panel.collapsed {
  height: 42px;
  width: 200px;
}
#download-panel.collapsed .panel-body {
  display: none;
}

/* æ”¶åˆæŒ‰éˆ•åœ–ç¤º */
#download-toggle {
  font-size: 16px;
}
/* æ‰‹æ©Ÿæ¨¡å¼ Sidebar */
@media (max-width:767px){
  .sidebar {
    width: 80%; max-width: 300px;
    transform: translateX(-110%);
    background: rgba(34,73,53,0.97);
    box-shadow: 3px 0 15px rgba(0,0,0,0.3);
    transition: transform .3s ease, opacity .3s ease;
    opacity: 0;
  }
  .sidebar.show { transform: translateX(0); opacity: 1; }
  #main-panel { margin-left: 0 !important; }
}
#adminlte-footer-box {
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 1060;
    transition: height 0.3s ease;
}

#adminlte-footer-box.collapsed-box {
    height: 40px; /* åªæœ‰ header é«˜åº¦ */
}

#adminlte-footer-box .box-header {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #36744e;
    color: #fff;
    padding: 0 15px;
    cursor: pointer;
    position: relative;
    z-index: 1061;
}

#adminlte-footer-box .box-body {
    position: absolute;
    bottom: 40px; /* å¾ header ä¸Šæ–¹å±•é–‹ */
    width: 100%;
    display: none;
    background: #f4f8f5;
    color: #2b3b2b;
    max-height: 200px;
    overflow-y: auto;
    padding: 15px;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    z-index: 1059;
}
#adminlte-footer-box.expanded .box-body {
    display: block;
}
/* å›ºå®šåœ¨ sidebar åº•éƒ¨ */
.sidebar-bottom-btn {
  position: absolute;
  bottom: 10px;
  width: 100%;
  text-align: center;
  z-index: 1050;
}

/* æŒ‰éˆ•æ¨£å¼ */
.sidebar-bottom-btn button {
  width: 80%;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

/* æ”¶åˆæ™‚åªé¡¯ç¤º icon */
.sidebar.collapsed .sidebar-bottom-btn button .text {
  display: none;
}



</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <div class="text-center" style="padding:10px;">
    <a href="#" id="portal" style="color:#fff;text-decoration:none;font-weight:600;"  data-i18n="menu"><strong>é¸å–®</strong></a>
  </div>
  <ul class="nav nav-pills nav-stacked" id="menu">
    <li><a href="#" data-target="z302.html" data-toggle="tooltip" title="é¢æ¿ä¸€"><span class="glyphicon glyphicon-leaf"></span> <span class="text" data-i18n="menuItems.sustain">æ°¸çºŒå ±å‘Š</span></a></li>
    <li class="has-submenu">
      <a href="#" data-toggle="tooltip" title="é¢æ¿äºŒ"><span class="glyphicon glyphicon-stats"></span> <span class="text">ç¢³æ’åˆ†æ â–¾</span></a>
      <ul class="submenu nav">
        <li><a href="#" data-target="sub1.html" data-toggle="tooltip" title="sub1"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub1</span></a></li>
        <li><a href="#" data-target="sub2.html" data-toggle="tooltip" title="sub2"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub2</span></a></li>
      </ul>
    </li>
    <li><a href="#" data-target="z22.html" data-toggle="tooltip" title="Tableau"><span class="glyphicon glyphicon-globe"></span> <span class="text">z22</span></a></li>
  </ul>
   <!-- åº•éƒ¨æŒ‰éˆ• -->
  <div class="sidebar-bottom-btn">
    <button id="sidebar-action-btn" class="btn btn-sm btn-success" title="è¨­å®š">
      <span class="glyphicon glyphicon-cog"></span>
      <span class="text">è¨­å®š</span>
    </button>
  </div>
</div>

<!-- Main Panel -->
<div id="main-panel">
  <!-- Header -->
  <div id="main-header">
    <button id="toggleSidebar" class="btn btn-sm">â˜°</button>
    <h5 id="page-title" class="header-title"></h5>
    <div class="user-info">
      <span>ä½ å¥½, ä½¿ç”¨è€…</span>
      <button class="btn btn-xs" id="logoutBtn">ç™»å‡º</button>
	  <button id="testDownload" class="btn btn-primary">é–‹å§‹æ¨¡æ“¬ä¸‹è¼‰</button>
    </div>
	  <!-- âœ… æ–°å¢èªè¨€é¸æ“‡ -->
      <select id="langSelect" class="form-control input-sm" style="width:100px;display:inline-block;">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
  </div>

<iframe id="content-frame" class="flex-grow-1 overflow-auto"
        style="width:100%; height: calc(100vh - 80px); border:none; background:white;"></iframe>


 <!-- AdminLTE å›ºå®šåº•éƒ¨ Footer -->
<!-- Footer Box -->
<!-- AdminLTE Footer Box -->
<div id="adminlte-footer-box" class="box collapsed-box">
  <div class="box-header">
    <span class="box-title">ğŸ“„ ESG Footer</span>
    <button id="footer-toggle-btn" type="button" class="btn btn-box-tool">
      <i class="fa fa-plus"></i>
    </button>
  </div>
  <div class="box-body">
    <p>é€™è£¡æ˜¯å¯å±•é–‹çš„ Footer å…§å®¹ï¼Œå¯æ”¾ä¸‹è¼‰é€²åº¦ã€å…¬å‘Šæˆ–å…¶ä»–è³‡è¨Šã€‚</p>
  </div>
</div>


</div>

<!-- âœ… å³å´æµ®å‹•ä¸‹è¼‰é€²åº¦æ¸…å–® -->
<div id="download-panel" class="collapsed">
  <div class="panel-header">
    <span>ğŸ“¥ ä¸‹è¼‰é€²åº¦</span>
    <span id="download-toggle" class="glyphicon glyphicon-chevron-up"></span>
  </div>
  <div class="panel-body">
    
  </div>
</div>

<script>
// åº•éƒ¨æŒ‰éˆ•äº‹ä»¶


// ================================
// AdminLTE Footer æ§åˆ¶å°è£
// ================================
const AdminLTEFooterBox = (function(){
    let $box = null;
    let $toggleBtn = null;
    let pagesToShow = [];
    let collapseTimer = null;

    return {
        init: function(boxSelector="#adminlte-footer-box", toggleBtnSelector="#footer-toggle-btn", showPages=[]){
            $box = $(boxSelector);
            $toggleBtn = $(toggleBtnSelector);
            pagesToShow = showPages;

            if(!$box.length || !$toggleBtn.length) return;

            // é è¨­ collapsed
            $box.addClass("collapsed-box").removeClass("expanded");
            $toggleBtn.find("i").removeClass("fa-minus").addClass("fa-plus");

            // toggle æŒ‰éˆ•äº‹ä»¶
            $toggleBtn.on("click", e => { 
                e.stopPropagation(); 
                this.toggle(); 
            });

            // header é»æ“Šä¹Ÿå¯ toggle
            $box.find(".box-header").on("click", e => {
                if(!$(e.target).is($toggleBtn)) this.toggle();
            });

            // hover é›¢é–‹ footer body æ™‚ 5 ç§’å¾Œè‡ªå‹• collapse
            $box.on("mouseenter", () => this._clearCollapseTimer());
            $box.on("mouseleave", () => this._startCollapseTimer());
        },

        expand: function(){
            if(!$box || !$toggleBtn) return;
            $box.removeClass("collapsed-box").addClass("expanded");
            $toggleBtn.find("i").removeClass("fa-plus").addClass("fa-minus");
        },

        collapse: function(){
            if(!$box || !$toggleBtn) return;
            $box.addClass("collapsed-box").removeClass("expanded");
            $toggleBtn.find("i").removeClass("fa-minus").addClass("fa-plus");
        },

        toggle: function(){
            if(!$box || !$toggleBtn) return;
            if($box.hasClass("expanded")){
                this.collapse();
            } else {
                this.expand();
            }
        },

        checkDisplay: function(pageName){
            if(!$box) return;
            if(pagesToShow.includes(pageName)){
                $box.show();
            } else {
                $box.hide();
            }
        },

        setPages: function(pages){
            pagesToShow = pages;
        },

        _startCollapseTimer: function(){
            this._clearCollapseTimer();
            collapseTimer = setTimeout(() => this.collapse(), 500); // 5 ç§’è‡ªå‹•æ”¶åˆ
        },

        _clearCollapseTimer: function(){
            if(collapseTimer){
                clearTimeout(collapseTimer);
                collapseTimer = null;
            }
        }
    };
})();






class IFrameLoader {
    constructor(iframeId, menuSelector, options = {}) {
        this.iframeId = iframeId;
        this.menuSelector = menuSelector;
        this.cacheExpireMs = options.cacheExpireMs || 30 * 60 * 1000;
        this.maxCacheItems = options.maxCacheItems || 10;
        this.debugMode = options.debugMode || false;

        this.iframe = document.getElementById(iframeId);

        // popstate æ”¯æ´ç€è¦½å™¨å‰é€²/å¾Œé€€
        window.addEventListener("popstate", e => {
            if (e.state?.url) this.load(e.state.url, false);
        });

        // menu é»æ“Šäº‹ä»¶
        $(document).on("click", `${menuSelector} a[data-target]`, e => {
            e.preventDefault();
            const $a = $(e.currentTarget);
            const target = $a.data("target");
            this.setActiveMenu($a);
            localStorage.setItem("activePage", target);
            this.load(target);
        });

        // å°‡ load å‡½å¼æ›åˆ°å…¨åŸŸï¼Œæ–¹ä¾¿å­é å‘¼å«
        window.loader = this;

        // è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡é é¢
        const savedPage = localStorage.getItem("activePage") || $(menuSelector + " a[data-target]").first().data("target");
        const $savedLink = $(`${menuSelector} a[data-target='${savedPage}']`);
        this.setActiveMenu($savedLink);
        this.load(savedPage, false);
    }

    // è¨­å®š menu active æ¨£å¼
    setActiveMenu($a) {
        $(this.menuSelector + " a").removeClass("active");
        $a.addClass("active");
    }

    load(target, pushToHistory = true) {
        this.showLoading();

        if (this.debugMode) {
            this.iframe.src = target;
            if (pushToHistory) history.pushState({ url: target }, "", "#" + target);
            this.monitorTitle();
            return;
        }

        const cacheKey = "spa_cache_" + target;
        const cacheTimeKey = cacheKey + "_time";
        const now = Date.now();
        const cachedHtml = localStorage.getItem(cacheKey);
        const cachedTime = parseInt(localStorage.getItem(cacheTimeKey) || "0");

        if (cachedHtml && now - cachedTime < this.cacheExpireMs) {
            this.iframe.srcdoc = cachedHtml;
            if (pushToHistory) history.pushState({ url: target }, "", "#" + target);
            this.monitorTitle();
            this.hideLoading();
            return;
        }

        fetch(target, { cache: "no-cache" })
            .then(res => res.text())
            .then(html => {
                this.iframe.srcdoc = html;
                localStorage.setItem(cacheKey, html);
                localStorage.setItem(cacheTimeKey, now.toString());
                this.maintainCacheLimit();
            })
            .catch(err => console.error("Iframe load error:", err))
            .finally(() => this.hideLoading());

        if (pushToHistory) history.pushState({ url: target }, "", "#" + target);
        this.monitorTitle();
    }

    // é™åˆ¶å¿«å–æ•¸é‡
    maintainCacheLimit() {
        let keys = Object.keys(localStorage).filter(x => x.startsWith("spa_cache_") && !x.endsWith("_time"));
        while (keys.length > this.maxCacheItems) {
            const removeKey = keys.shift();
            localStorage.removeItem(removeKey);
            localStorage.removeItem(removeKey + "_time");
        }
    }

    // é¡¯ç¤º Loading
    showLoading() {
        if ($("#loading-mask").length === 0) {
            $("body").append(`
                <div id="loading-mask"
                    style="position:fixed;top:0;left:0;width:100%;height:100%;
                    background:rgba(0,0,0,.25);z-index:2000;display:flex;
                    align-items:center;justify-content:center;">
                    <div class="spinner-border"></div>
                    <span style="color:white;font-size:18px;margin-left:10px;">Loading...</span>
                </div>
            `);
        } else $("#loading-mask").show();
    }

    hideLoading() {
        $("#loading-mask").fadeOut(200);
    }

    // ç›£æ§ iframe æ¨™é¡Œä¸¦åŒæ­¥åˆ°çˆ¶é  header
    monitorTitle() {
        const iframe = this.iframe;
        const updateTitle = () => {
            try {
                const innerDoc = iframe.contentDocument || iframe.contentWindow.document;
                const titleElement = innerDoc.querySelector(".page-title");
                if (titleElement) $("#page-title").text(titleElement.textContent.trim());
                else $("#page-title").text("ESG Dashboard");
            } catch (e) {
                $("#page-title").text("ESG Dashboard");
            }
        };

        iframe.onload = () => {
            this.hideLoading();
            updateTitle();

            // è§€å¯Ÿå­é  DOM è®Šå‹•ï¼ˆå‹•æ…‹ä¿®æ”¹ page-titleï¼‰
            try {
                const observer = new MutationObserver(updateTitle);
                const innerDoc = iframe.contentDocument || iframe.contentWindow.document;
                const titleEl = innerDoc.querySelector(".page-title");
                if (titleEl) observer.observe(titleEl, { childList: true, characterData: true, subtree: true });
            } catch (e) {}
        };
    }
}



     
	    $(async function(){
  var $sidebar = $("#sidebar"),
      $main = $("#main-panel"),
      $content = $("#content-container");
	  
	  $("#download-panel").hide(); // ä¸€é–‹å§‹éš±è—
	 
	 // 1ï¸âƒ£ åˆå§‹åŒ–
// åˆå§‹åŒ– Loader
const loader = new IFrameLoader("content-frame", "#menu", {
    cacheExpireMs: 30*60*1000, // 30 åˆ†é˜
    maxCacheItems: 10,
    debugMode: false
});
 AdminLTEFooterBox.init("#adminlte-footer-box", "#footer-toggle-btn", ["z302.html", "sub1.html"]);

	 
  // åˆå§‹åŒ–èªè¨€
      await i18n.init();
	    // åˆå§‹åŒ–èªè¨€é¸å–®
      $("#langSelect").val(i18n.getLang());

       // èªè¨€åˆ‡æ›
      $("#langSelect").on("change", async function(){
        const lang = $(this).val();
        await i18n.setLang(lang);
		  // å†æ¬¡å¥—ç”¨ç¿»è­¯
        i18n.apply(document);
      });
 console.log(i18n.t("welcome", "ç‹å°æ˜"));  // ä½ å¥½ï¼Œç‹å°æ˜ï¼
// å¤šåƒæ•¸
console.log(i18n.t("greet", "ç‹å°æ˜", "æ—©ä¸Šå¥½")); // ç‹å°æ˜ï¼Œæ—©ä¸Šå¥½ï¼
// æä¾›çµ¦å­é é¢ a.html å‘¼å«
function navigateTo(pageUrl) {
  //  loadPanel(pageUrl);
  loader.load(pageUrl)
}

// å°‡å‡½å¼æ›åˆ°å…¨åŸŸï¼Œa.html å¯ä»¥å‘¼å«
window.navigateTo = navigateTo;
	  
	  
	  
 // âœ… æ–°å¢ä¸‹è¼‰é¢æ¿é–‹é—œ
  $("#download-panel .panel-header").on("click", function(){
    $("#download-panel").toggleClass("collapsed");
    $("#download-toggle")
      .toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
  });
   // ğŸ”¸ äºŒç´šé¸å–®å±•é–‹/æ”¶åˆï¼ˆä¸æœƒè®Šç™½ï¼‰
  $("#menu").on("click", ".has-submenu > a", function(e){
    e.preventDefault();

    // ä¸æ”¹è®Š active ç‹€æ…‹ï¼ˆé˜²æ­¢è®Šç™½ï¼‰
    var $submenu = $(this).next(".submenu");
    var isOpen = $submenu.is(":visible");

    // æ”¶åˆå…¶ä»– submenu
    $("#menu .submenu").not($submenu).slideUp(200);
    $("#menu .has-submenu").not($(this).parent()).removeClass("open");

    // åˆ‡æ›ç•¶å‰ submenu
    $submenu.slideToggle(200);
    $(this).parent().toggleClass("open", !isOpen);
  });
 function loadPanelWithFooter(targetPage){
    loader.load(targetPage); // ä½ çš„åŸ loadPanel
     AdminLTEFooterBox.checkDisplay(pageName);
}

  // é»æ“Šåˆ‡æ›å…§å®¹
  $("#menu").on("click","a[data-target]",function(e){
    e.preventDefault();
     // åªè®“ã€Œé has-submenu çš„é …ç›®ã€è®Š active
    if(!$(this).closest(".has-submenu").length){
      $("#menu a").removeClass("active");
      $(this).addClass("active");
    } else {
      // æ˜¯å­é …çš„è©±ï¼Œä¹Ÿè¦è¨­ active
      $("#menu a").removeClass("active");
      $(this).addClass("active");
    }
    var target = $(this).data("target");
     loadPanelWithFooter(target);//loadPanel(target);
    if($(window).width() < 768) $sidebar.removeClass("show");
    localStorage.setItem("activePage", target);
  });

  // è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡é é¢
  var saved = localStorage.getItem("activePage") || "z181.html";
  $("#menu a[data-target='"+saved+"']").addClass("active");
  //loadPanel(saved);
loader.load(saved)
  // Sidebar åˆ‡æ›
  $("#portal, #toggleSidebar").on("click", function(){
    if($(window).width() < 768){
      $sidebar.toggleClass("show");
    } else {
      $sidebar.toggleClass("collapsed");
      $main.toggleClass("full");
    }
  });

  // ç™»å‡º
  $("#logoutBtn").click(function(){$("#adminlte-footer-box").show(); // é¡¯ç¤º
  alert("å·²ç™»å‡ºï¼"); });
});
 
 $(function () {
  // âœ… æ¨¡æ“¬/çœŸå¯¦é€²åº¦æ›´æ–°
  function updateProgress($bar, id, fileName) {
    const timer = setInterval(() => {
      $.get(`http://localhost:57216/Download/Progress?id=${id}`, function (res) {
        const pct = res.progress;
        $bar.css("width", pct + "%").text(pct + "%");
        if (pct >= 100) {
          clearInterval(timer);
          $bar.removeClass("progress-bar-success").addClass("progress-bar-info");
          $bar.closest(".download-item").find(".file-name").append(" âœ…");

          // é€²åº¦åˆ°100å¾Œè‡ªå‹• stream ä¸‹è¼‰
          streamDownload(fileName);
        }
      });
    }, 800);
  }

  // âœ… åˆªé™¤æŒ‰éˆ•äº‹ä»¶
  $(document).on("click", ".delete-btn", function () {
    const $item = $(this).closest(".download-item");
    $item.slideUp(200, function () {
      $item.remove();
      if ($("#download-panel .download-item").length === 0) {
        $("#download-panel").fadeOut(300);
      }
    });
  });

  
  // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™
  window.addDownloadTask2 = function(fileName) {
    $("#download-panel").show().removeClass("collapsed");
    const $newItem = $(`
      <div class="download-item">
        <div class="file-name">${fileName}</div>
        <div class="progress">
          <div class="progress-bar progress-bar-success" style="width:0%">0%</div>
        </div>
		<div id="downloadSpeed" style="font-size:12px;color:#555;"></div>
        <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
      </div>
    `);
    $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

    // é–‹å§‹æµå¼ä¸‹è¼‰
    streamDownload2(fileName);
  };
  
  
  // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™ï¼ˆæ•´åˆå¾Œç«¯ï¼‰
  window.addDownloadTask = function (fileName) {
    $("#download-panel").show().removeClass("collapsed");
    const $newItem = $(` 
      <div class="download-item">
        <div class="file-name">${fileName}</div>
        <div class="progress"><div class="progress-bar progress-bar-success" style="width:0%">0%</div></div>
        <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
      </div>
    `);
    $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

    const $bar = $newItem.find(".progress-bar");

    // å‘¼å«å¾Œç«¯é–‹å§‹ä¸‹è¼‰
    $.post("http://localhost:57216/Download/Start", { fileName: fileName }, function (res) {
      if (res.success) {
        updateProgress($bar, res.id, fileName);
      }
    });
  };

// âœ… Stream ä¸‹è¼‰å‡½å¼ï¼ˆå¯å¤šä»»å‹™ï¼‰
  async function streamDownload2(fileName) {
    try {
      const response = await fetch(`http://localhost:57216/Download/GetFileStream?fileName=${encodeURIComponent(fileName)}`);
      if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

    const contentLength = response.headers.get("Content-Length");
    const totalSize = contentLength ? parseInt(contentLength, 10) : null;
      const reader = response.body.getReader();
      const chunks = [];
      let received = 0; 
      let startTime = Date.now();
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
 // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”
      if (totalSize) {
        const pct = Math.round((received / totalSize) * 100);
        $("#downloadProgress").css("width", pct + "%").text(pct + "%");
      }
	  
	  // è¨ˆç®—ä¸‹è¼‰é€Ÿåº¦ (Bytes/s)
      const elapsed = (Date.now() - startTime) / 1000; // ç§’
      const speed = received / elapsed; // Bytes/s
      let speedText = "";
      if (speed > 1024 * 1024) speedText = (speed / (1024 * 1024)).toFixed(2) + " MB/s";
      else if (speed > 1024) speedText = (speed / 1024).toFixed(2) + " KB/s";
      else speedText = speed.toFixed(0) + " B/s";

      // é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¸Šæˆ–æ—é‚Š
      $("#downloadSpeed").text(speedText);
	  
	  
	  
        // æ›´æ–°è©²æª”æ¡ˆçš„é€²åº¦
        const pct = contentLength ? Math.round((received / contentLength) * 100) : 0;
        $(`.download-item:contains("${fileName}") .progress-bar`)
          .css("width", pct + "%")
          .text(pct + "%");
		  
		  
		  
      }

      const blob = new Blob(chunks, { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName + ".xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // å®Œæˆå¾Œæ›´æ–°æ¨™è¨˜
      $(`.download-item:contains("${fileName}") .file-name`).append(" âœ…");
      $(`.download-item:contains("${fileName}") .progress-bar`)
        .removeClass("progress-bar-success")
        .addClass("progress-bar-info");
 $("#downloadSpeed").text("å®Œæˆ"); // å¯é¸
    } catch (e) {
      alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
    }
  }



  // âœ… Stream ä¸‹è¼‰å‡½å¼
  async function streamDownload(fileName) {
    try {
      const response = await fetch(`http://localhost:57216/Download/GetFile?fileName=${encodeURIComponent(fileName)}`);
      if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

      const contentLength = response.headers.get("Content-Length");
      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;

        if (contentLength) {
          const pct = Math.round((received / contentLength) * 100);
          // å¯é¸ï¼šæ›´æ–°æ•´å€‹ panel é€²åº¦ï¼ˆæˆ–å„è‡ªé€²åº¦ï¼‰
          $("#downloadProgress").css("width", pct + "%").text(pct + "%");
        }
      }

      const blob = new Blob(chunks);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName + ".txt"; // æˆ–åŸæª”å
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
    }
  }

  // âœ… å¯æ‰‹å‹•æ¸¬è©¦
  $("#testDownload").on("click", function () {$("#adminlte-footer-box").hide(); // å®Œå…¨éš±è—
  //  addDownloadTask2("ESG_Report_2025");
  });
});
$("#sidebar-action-btn").on("click", function(){
    alert("ä½ é»äº†åº•éƒ¨æŒ‰éˆ•ï¼");
    // é€™è£¡å¯ä»¥æ”¾ä»»ä½•åŠŸèƒ½ï¼Œä¾‹å¦‚æ‰“é–‹è¨­å®šé¢æ¿
});

// Sidebar æ”¶åˆ/å±•é–‹
$("#portal, #toggleSidebar").on("click", function(){
    if($(window).width() < 768){
      $("#sidebar").toggleClass("show");
    } else {
      $("#sidebar").toggleClass("collapsed");
      $("#main-panel").toggleClass("full");

      // æ”¶åˆæ™‚è‡ªå‹•æµ®å‹•åº•éƒ¨æŒ‰éˆ•ç½®ä¸­
      if($("#sidebar").hasClass("collapsed")){
        $(".sidebar-bottom-btn").css("text-align", "center");
      } else {
        $(".sidebar-bottom-btn").css("text-align", "right"); // æˆ– default
      }
    }
});
// æ‰‹å‹•æ§åˆ¶
//AdminLTEFooter.expand();   // å±•é–‹
//dminLTEFooter.collapse(); // æ”¶åˆ
//AdminLTEFooter.toggle();   // åˆ‡æ›
//AdminLTEFooter.show();   // é¡¯ç¤º footer
//AdminLTEFooter.hide();   // éš±è— footer
//AdminLTEFooter.toggle(); // é–‹åˆåˆ‡æ›
//AdminLTEFooter.setPages(["page1.html","page2.html"]); // æ›´æ–°é¡¯ç¤ºé é¢åˆ—è¡¨

</script>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‡ªé©æ‡‰ä¸‰åˆ—å¤šè¡Œ ECharts å®¹å™¨ (autoDataZoom + å‹•æ…‹ xlabelMode + legendMode)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<style>
body { font-family:"Microsoft JhengHei",sans-serif; margin:20px; background:#FFFFFF; }
h2 { text-align:center; color:#444; margin-bottom:20px; }
/* âœ… ä¿®æ”¹å¾Œçš„éŸ¿æ‡‰å¼ä¸‰æ¬„ç¶²æ ¼ */
/* ===== å…¨å¯¬éŸ¿æ‡‰å¼ï¼šæ”¹ç”¨ Flexboxï¼Œæœ€å¤š 3 æ¬„ï¼Œå°‘æ–¼ 3 å€‹å¹³å‡åˆ†é… ===== */
/* âœ… æœ€å¤§ 3 æ¬„ï¼Œè‡ªå‹•æ›è¡Œ */
.chart-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  width: 100%;
  box-sizing: border-box;
}

/* âœ… æ¡Œæ©Ÿï¼šå¹³å‡ä¸‰æ¬„ */
.chart-item {
  flex: 1 1 calc(33.333% - 20px);
  background: #FFFFFF;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  min-height: 300px;
  padding: 10px;
  border: none;
  box-sizing: border-box;
}

/* âœ… å¹³æ¿ (2 æ¬„) */
@media (max-width: 992px) {
  .chart-item {
    flex: 1 1 calc(50% - 20px);
  }
}

/* âœ… æ‰‹æ©Ÿï¼šä¸€åˆ—ä¸€å€‹ */
@media (max-width: 600px) {
  .chart-item {
    flex: 1 1 100%;
  }
}


/* tooltipå‹•ç•« */
.echarts-tooltip, .echarts-tooltip div { white-space: normal !important; }
.custom-tooltip { font-size: 13px; line-height: 1.5; }
.tooltip-line { position: relative; padding-bottom: 2px; margin: 2px 0; }
.tooltip-line .line-underline { position: absolute; bottom: 0; left: 0; height: 2px; width: 100%; background: transparent; }
.tooltip-line.active-line .line-underline {
  background: linear-gradient(90deg, transparent, red, transparent);
  background-size: 200% 100%;
  animation: underline-flow 1.5s linear infinite;
}
@keyframes underline-flow { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body>

<h2>ğŸ“Š è‡ªé©æ‡‰ä¸‰åˆ—å¤šè¡Œ ECharts åœ–è¡¨ï¼ˆautoDataZoom + å‹•æ…‹ xlabelMode + legendModeï¼‰</h2>
<div class="chart-grid" id="chartContainer"></div>
<!-- Modal -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">åœ–è¡¨æ”¾å¤§</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalChart" style="width:100%;height:600px;"></div>
      </div>
    </div>
  </div>
</div>
<script>
const ChartUtil = {

  openInModal(cfg, onClose) {
    // è‹¥ Modal ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹
    let modalEl = document.getElementById('chartModal');
    if (!modalEl) {
      modalEl = document.createElement('div');
      modalEl.className = 'modal fade';
      modalEl.id = 'chartModal';
      modalEl.tabIndex = -1;
      modalEl.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="modalChart" style="width:100%;height:400px;"></div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modalEl);
    }

    const modalChartEl = modalEl.querySelector('#modalChart');
    modalEl.querySelector('.modal-title').textContent = cfg.title || 'åœ–è¡¨';

    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();

    // é¡¯ç¤ºå¾Œåˆå§‹åŒ– ECharts
    const shownHandler = () => {
      if (modalChartEl.chartInstance) {
        modalChartEl.chartInstance.dispose();
      }
      ChartUtil.renderChart(modalChartEl.id, cfg);
      modalEl.removeEventListener('shown.bs.modal', shownHandler);
    };
    modalEl.addEventListener('shown.bs.modal', shownHandler);

    // é—œé–‰å¾Œé‡‹æ”¾åœ–è¡¨èˆ‡å›å‘¼
    const hiddenHandler = () => {
      console.log('Modal å·²é—œé–‰');
      if (modalChartEl.chartInstance) {
        modalChartEl.chartInstance.dispose();
        modalChartEl.chartInstance = null;
      }
      if (typeof onClose === 'function') onClose();
      modalEl.removeEventListener('hidden.bs.modal', hiddenHandler);
    };
    modalEl.addEventListener('hidden.bs.modal', hiddenHandler);
  },
  renderChart: function(containerId, config){
    const container = document.getElementById(containerId);
    if(container.chartInstance) container.chartInstance.dispose();
    //const chart = echarts.init(container);
	
	 const chart = echarts.init(container, null, {
  // è‡ªå‹•åµæ¸¬è£ç½® pixel ratio
  renderer: 'canvas',
  devicePixelRatio: window.devicePixelRatio || 1
});
    container.chartInstance = chart;
    const isMobile = window.innerWidth < 600;

    // === Legend è¨­å®šï¼ˆæ–°å¢ legendMode æ§åˆ¶ï¼‰
    const legendMode = config.legendMode || 'scroll'; // scroll / wrap / none
    const legendBase = (config.type==='pie')
      ? (isMobile?{orient:'horizontal',top:'10%',left:'center'}:{orient:'vertical',left:'5%',top:'10%'})
      : (isMobile?{top:0,left:'center'}:{orient:'horizontal',top:'10%',left:'center'});
    const legendOption = (legendMode==='none') ? {show:false} : {
      ...legendBase,
      type: legendMode==='scroll' ? 'scroll' : 'plain',
      itemGap: 10,
      padding: [5,5,5,5],
      textStyle:{fontSize:12}
    };

    // === Grid padding
    const gridPadding = isMobile ? { left:'10%', right:'10%', bottom:'15%', containLabel:true } : { left:'5%', right:'5%', bottom:'10%' , containLabel:true};

    // === XLabel è‡ªå‹•è™•ç†
    function getXAxisLabelOption(categories, mode){
      const maxLen = 8;
      if(mode==='auto'){
        if(categories.length > 10){
          return { interval:0, rotate: categories.some(v=>v.length>maxLen)?45:30, fontSize:12 };
        } else return { interval:0, rotate:0, fontSize:12 };
      }
      switch(mode){
        case 'wrap': return {interval:0, rotate:0, formatter:v=>v.length>maxLen?v.match(new RegExp('.{1,'+maxLen+'}','g')).join('\n'):v,fontSize:12};
        case 'rotate': return {interval:0, rotate: categories.some(v=>v.length>maxLen)?(isMobile?30:45):0,formatter:'{value}',fontSize:12};
        case 'alternate': return {interval:0, formatter:(v,i)=>i%2===0?v:'\n'+v,fontSize:12};
        default: return {interval:0,formatter:'{value}',fontSize:12};
      }
    }

    // === è¨ˆç®—é–“è·é¿å… title / legend ç–Š
    const titleHeight = config.title?40:0;
    const legendRows = (legendMode==='wrap')
      ? Math.ceil((config.series?.length||1)/6)
      : 1;
    const legendHeight = (legendMode==='none')?0:(legendRows*30);
    const gridTop = titleHeight + legendHeight + 30; // +30 æä¾›å®‰å…¨é–“è·

    // === dataZoom
    let dataZoomOption;
    if(typeof config.autoDataZoom === 'number'){
      const N = config.categories.length;
      if(config.autoDataZoom === -1){
        dataZoomOption = undefined;
      } else if(config.autoDataZoom > 0 && N > config.autoDataZoom){
        const end = (config.autoDataZoom / N) * 100;
        dataZoomOption = [{ type:'slider', xAxisIndex:0, start:0, end }];
      }
    }
const bgColor = getComputedStyle(document.body).backgroundColor;
    // === çµ„åˆ Option
	
	  // ä½¿ç”¨ axisTitleMap è¨­å®š title / X / Y è»¸
  const chartTitle = config.axisTitleMap['title'] || config.title ;
  const xTitle = config.axisTitleMap[config.xlabel] || config.xlabel;
  const yTitle = config.axisTitleMap[config.ylabel] || config.ylabel;

	// tooltip formatter
    const formatterFunc = (params) => {
              let str = `<div class="custom-tooltip"><div class="tooltip-title">${params[0].axisValue}</div>`;
			   const activeSeries = chart._hoveredSeries || null;
              params.forEach(p=>{
                const valueStr = (config.type==='stackedPercent' && p.data.rawValue!==undefined)? `${p.data.rawValue} (${p.value}%)`:p.value;
                const activeClass = (p.seriesName===activeSeries)?'active-line':'';
                str += `<div class="tooltip-line ${activeClass}">${p.marker}${p.seriesName}: ${valueStr}<span class="line-underline"></span></div>`;
              });
              str += '</div>'; return str;
            };
    let option = {};
    switch(config.type){
      case 'bar': case 'grouped': case 'stacked': case 'stackedPercent': case 'line': case 'mixed':
        option = {
		 backgroundColor: bgColor,
 
          title:{ text: chartTitle, left:'center' },
          legend: legendOption,
          grid: Object.assign({}, gridPadding, { top:gridTop }),
          tooltip:{
            trigger:'axis',
            axisPointer:{ type:'shadow'
			},
            enterable:true,
            formatter: formatterFunc
          },
          xAxis:{ type:'category', data: config.categories,  nameGap:40,    nameLocation: 'center',name: xTitle, axisLabel:getXAxisLabelOption(config.categories, config.xlabelMode) },
          yAxis:{ type:'value', name: yTitle, min:0, max: config.type==='stackedPercent'?100:undefined, axisLabel:{  margin: 20,formatter:config.type==='stackedPercent'?'{value}%':'{value}'} },
          series: config.series.map((s,i)=>({
            name: s.name,
            type: s.type || (config.type==='line'?'line':'bar'),
            stack: (config.type==='stacked' || config.type==='stackedPercent')?'total':undefined,
            label:{ show:s.type!=='line', position:'top', formatter: config.type==='stackedPercent'?'{c}%':'{c}' },
            data: s.data,
            itemStyle:{ color: config.colors?.[i] },
            smooth: s.type==='line'?true:false
          })),
          dataZoom: dataZoomOption
        };
        break;

      case 'pie':
        const pieData = config.series.map((s,i)=>({
          name:s.name,
          value:s.data.reduce((a,b)=>a+b,0),
          itemStyle:{ color: config.colors?.[i] }
        }));
        option = {
          title:{ text: config.title, left:'center' },
          tooltip:{ trigger:'item', formatter:'{a}<br/>{b}: {c} ({d}%)' },
          legend: legendOption,
          series:[{
            name: config.ylabel||'ç¸½å’Œ',
            type:'pie',
            radius:['40%','70%'],
            center:isMobile?['50%','55%']:['65%','55%'],
            data:pieData,
            label:{formatter:'{b}: {d}%'}
          }]
        };
        break;
    }

    chart.setOption(option);
    chart.resize();
chart.getOption().series.forEach((s, i) => {
  chart.on('mouseover', function(params){
    if(params.seriesIndex === i){
      chart._hoveredSeries = params.seriesName;
    }
  });
  chart.on('mouseout', function(params){
    if(params.seriesIndex === i){
      chart._hoveredSeries = null;
    }
  });
});
    // === å‹•æ…‹èª¿æ•´ XLabel
    function updateXAxisLabel(el){
      if(!chart.getOption().xAxis) return;
      const axis = chart.getOption().xAxis[0];
      if(!axis) return;
      let visibleCategories = axis.data;
      const dz = chart.getOption().dataZoom?.[0];
      if(dz){
        const total = axis.data.length;
        const startIndex = Math.floor(dz.start/100*total);
        const endIndex = Math.ceil(dz.end/100*total);
        visibleCategories = axis.data.slice(startIndex,endIndex);
      }
      const newLabel = getXAxisLabelOption(visibleCategories, config.xlabelMode);
      chart.setOption({ xAxis:[{ axisLabel: newLabel }] });
	  
	    const resizeObserver = new ResizeObserver(() => chart.resize());
  resizeObserver.observe(container);
  // âœ… é é˜² SPA æˆ–è¼‰å…¥å»¶é²ï¼Œåˆæ¬¡è£œä¸€åˆ€
//  setTimeout(() => chart.resize(), 100);
    }

    updateXAxisLabel();
    chart.on('dataZoom', updateXAxisLabel());
	
	
    window.addEventListener('resize', ()=>{ chart.resize(); updateXAxisLabel(); });
    return chart;
  }
};
const rawData1 = []
// ç¯„ä¾‹è³‡æ–™
const rawData = [
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABp","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AAc","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHy" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAs","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAk","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHa" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHz" },
  { "ACT_LV1":"AAb","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHz" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHu" },
  { "ACT_LV1":"ABp","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABe","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AAc","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABx","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAxs","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAk","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABcz","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHz" },
  { "ACT_LV1":"AAbz","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABzc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHz" }
]

// === å»ºç«‹åœ–è¡¨è¨­å®š ===
function buildChartConfig(data, opts={}) {
  const { valueField='EM_TOTAL', xField='ACT_LV1', groupField='SITE', chartType='bar', title='åœ–è¡¨', axisTitleMap, xlabel=xField, ylabel=valueField, xlabelMode='auto', colors=[], autoDataZoom=0, legendMode='scroll' } = opts;
  if(!Array.isArray(data)||data.length===0) return { type:chartType, title, categories:[], series:[], autoDataZoom,axisTitleMap };
  const categories = [...new Set(data.map(d=>d[xField]))];
  let series = [];
  if(chartType==='pie'){
    const groups = groupField?[...new Set(data.map(d=>d[groupField]))]:categories;
    series = groups.map(g=>({ name:g, data:[data.filter(d=>groupField?d[groupField]===g:d[xField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0)] }));
  } else {
    const groups = groupField?[...new Set(data.map(d=>d[groupField]))]:[];
    if(chartType==='stackedPercent'){
      series = groups.map(g=>({ name:g, data:categories.map(cat=>{
        const total = data.filter(d=>d[xField]===cat).reduce((sum,d)=>sum+Number(d[valueField]||0),0);
        const val = data.filter(d=>d[xField]===cat && d[groupField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0);
        return { value: total?((val/total)*100).toFixed(2):0, rawValue: val };
      })}));
    } else {
      series = groups.map((g,i)=>({ name:g, type: chartType==='mixed' && i===1?'line':undefined, data:categories.map(cat=>data.filter(d=>d[xField]===cat && d[groupField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0)) }));
    }
  }
  return { type:chartType, title, xlabel, ylabel, xlabelMode, categories, series, colors, autoDataZoom, legendMode,axisTitleMap };
}
const axisMap = {
  title: 'å †ç–Šåœ–ç¤ºä¾‹',
  ACT_LV1: 'æ´»å‹•ç­‰ç´š',
  EM_TOTAL: 'ç¸½é‡',
  SITE: 'ç«™é»'
};

// === ç”Ÿæˆåœ–è¡¨ ===
const charts = [
  buildChartConfig(rawData,{ chartType:'stacked', title:'å †ç–Šåœ–ç¤ºä¾‹', legendMode:'wrap', axisTitleMap:axisMap }),
  buildChartConfig(rawData,{ chartType:'stackedPercent', title:'ç™¾åˆ†æ¯”å †ç–Šåœ–', autoDataZoom:20, legendMode:'scroll', axisTitleMap:axisMap }), 
    buildChartConfig(rawData,{ chartType:'grouped', title:'ç¾¤çµ„ç›´æ¢åœ–', autoDataZoom:20, axisTitleMap:axisMap }),
  buildChartConfig(rawData,{ chartType:'pie', title:'åœ“é¤…åœ–ç¤ºä¾‹', legendMode:'scroll', axisTitleMap:axisMap }),
 // buildChartConfig(rawData,{ chartType:'line', title:'æŠ˜ç·šåœ–ç¤ºä¾‹', autoDataZoom:10 }),
 // buildChartConfig(rawData,{ chartType:'mixed', title:'æŸ±ç‹€+æŠ˜ç·šæ··åˆ', colors:['#3b82f6','#f97316'], autoDataZoom:20 })
];

const container = document.getElementById('chartContainer');
charts.forEach((cfg,i)=>{
  const div = document.createElement('div');
  div.className='chart-item';
  div.id='chart'+i;
  container.appendChild(div);
  const chart= ChartUtil.renderChart(div.id,cfg);
   
   // é»æ“Šå°åœ–è¡¨ â†’ modal æ”¾å¤§
  div.addEventListener('click', ()=>{
   ChartUtil.openInModal(cfg, () => {
    console.log('ä½¿ç”¨è€…é—œé–‰ Modal');
  });
  });
  
  
});

 
</script>
</body>
</html>


 
