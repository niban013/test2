<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Bootstrap 3 Tab åˆ‡æ›ç¯„ä¾‹</title>
  <!-- Bootstrap 3 CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
   <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@2.4.18/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@2.4.18/dist/css/skins/skin-blue.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- iCheck flat-blue CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/iCheck/1.0.3/skins/flat/blue.css" rel="stylesheet">

<!-- ä¿®æ­£ç‰ˆ iCheckï¼ˆæ”¯æ´ jQuery 3.xï¼‰ -->
<script src="https://cdn.jsdelivr.net/gh/fronteed/icheck@master/icheck.min.js"></script>

<!-- Bootstrap 3 JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
	<!-- AdminLTE JS -->
	<script src="https://cdn.jsdelivr.net/npm/admin-lte@2.4.18/dist/js/adminlte.min.js"></script>
  <style>
    .tab-content {
      margin-top: 20px;
    }
	      /* è®“å…§å®¹ç½®ä¸­ä¸”æœ‰åŸºæœ¬å¯¬åº¦ */
        .content-area {
            max-width: 1400px;
            margin: 20px auto;
        }

        /* ä¸€åˆ— 6 æ¬„ */
        #field-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            padding: 10px;
        }

        .field-item {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 13px;
            margin-bottom: 3px;
        }

        select {
            padding: 5px;
            border: 1px solid #bbb;
            border-radius: 4px;
        }
    
   #jsonOutput {
    white-space: pre-wrap;
    font-size: 13px;
  }
  
.icheck-field-wrapper {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
}

.icheck-field-wrapper label {
    margin-left: 8px;
    font-size: 14px;
    cursor: pointer;
}
  .field-wrapper {
            margin-bottom: 10px;
        }

        /* checkbox label åº•ä¸‹æ–‡å­—å°é½Š */
        .icheck-field {
            display: flex;
            align-items: center;
        }
        .icheck-field label {
            margin-left: 8px;
            cursor: pointer;
        }
  </style>
</head>
<body>
<div class="container">
  <h2>Bootstrap 3 Tab ç¯„ä¾‹</h2>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="active"><a href="#home" role="tabpanel" data-toggle="tab">é¦–é </a></li>
    <li><a href="#profile" role="tabpanel" data-toggle="tab">å€‹äººè³‡æ–™</a></li>
    <li><a href="#messages" role="tabpanel" data-toggle="tab">è¨Šæ¯</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div class="tab-pane fade in active" id="home">
     <!-- ğŸ”¹ä¸‹æ‹‰è¨­å®š -->
      <div class="mb-3">
        <label class="form-label">é¸æ“‡æ¬„ä½è¨­å®š</label>
        <select id="configSelector" class="form-select form-select-sm" style="width:200px;">
          <option value="default">é è¨­è¨­å®š</option>
          <option value="simple">ç°¡æ˜“ç‰ˆ (ID + Name)</option>
          <option value="hr">HR ç‰ˆæœ¬ (Name + Department)</option>
        </select>
      </div>
      <!-- ğŸ”¹é¡å¤–è¨­å®š -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">é¡å¤–è¨­å®š</h5>
        <div class="row g-3">

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkHeader" class="form-check-input">
            <label for="chkHeader" class="form-check-label me-2">è¡¨é ­å•Ÿç”¨</label>
            <input type="text" id="txtHeaderName" class="form-control form-control-sm w-auto">
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkBody" class="form-check-input">
            <label for="chkBody" class="form-check-label me-2">è¡¨èº«å•Ÿç”¨</label>
            <input type="text" id="txtBodyName" class="form-control form-control-sm w-auto">
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkPopup" class="form-check-input">
            <label for="chkPopup" class="form-check-label me-2">å½ˆè·³å•Ÿç”¨</label>
            <input type="text" id="txtPopupName" class="form-control form-control-sm w-auto">
       
          </div>

        </div>
      </div>

   

      <!-- ğŸ”¹æ¬„ä½è¨­å®šè¡¨ -->
      <h5>æ¬„ä½è¨­å®š</h5>
      <table id="fieldTable" class="table table-bordered align-middle table-sm">
        <thead>
          <tr class="table-light">
            <th style="width:50px;">æ‹–æ›³</th>
            <th>æ¬„ä½</th>
            <th style="width:120px;">å‹æ…‹</th>
            <th style="width:80px;">æœå°‹å•Ÿç”¨</th>
            <th style="width:80px;">é¡¯ç¤ºå•Ÿç”¨</th>
            <th style="width:90px;">æ’åº</th>
            <th>æ¢ä»¶</th>
            <th style="width:60px;">åˆªé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="btnAdd" class="btn btn-outline-primary btn-sm">
        <i class="fa fa-plus"></i> æ–°å¢æ¬„ä½
      </button>
      <button id="btnApply" class="btn btn-success btn-sm">
        <i class="fa fa-play"></i> å¥—ç”¨è¨­å®š
      </button>
    </div>
    <div class="tab-pane fade" id="profile">
    <div class="content-area">
  
        <!-- â­ æŠ˜ç–Š Panel -->
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">æŸ¥è©¢æ¢ä»¶</h3>

                <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>

            <div class="box-body">
                <div id="field-container"></div>
            </div>
        </div>

   
</div>

<div class="content-area">
   
        <!-- â­ æŠ˜ç–Š Panel -->
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">æŸ¥è©¢çµæœ</h3>

                <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>

            <div class="box-body">
               <div class="row">
					<div class="col-md-12">
					  <table id="dataTable" class="display w-100"  style="width:100% !important;">
						<thead><tr></tr></thead>
						<tbody></tbody>
					  </table>
				 
					</div> 
			   </div>
            </div>
        </div>

    
</div>
    </div>
    <div class="tab-pane fade" id="messages">
         <h5>æŸ¥è©¢çµæœ</h5>

      <div class="row">
        <div class="col-md-12">
         <pre id="jsonOutput" class="border p-2 bg-light" style="height:500px; overflow:auto;"></pre>
        </div>

       
      </div>
    </div>
  </div>
</div>

<div id="popupModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="popupModalTitle">å½ˆè·³è¦–çª—</h4>
      </div>

      <div class="modal-body" id="popupModalBody">
      </div>

      <div class="modal-footer">
        <button class="btn btn-default" data-dismiss="modal">é—œé–‰</button>
        <button class="btn btn-primary" id="btnSavePopup">å„²å­˜</button>
      </div>

    </div>
  </div>
</div>

<script>
class LargeSelect2 {
    constructor(selectId, options={}){
        this.$select = $(`#${selectId}`);
        this.pageSize = options.pageSize || 50;
        this.largeData = options.largeData || null;
        this.url = options.url || null;
        this.showAllOption = options.showAllOption || false;
        this.allOptionText = options.allOptionText || "å…¨éƒ¨";

        const prependAll = (results)=>{
            if(this.showAllOption && !results.some(r=>r.id==="")){
                results.unshift({id:"", text:this.allOptionText});
            }
            return results;
        }

        this.$select.select2({
            placeholder: options.placeholder || "è«‹é¸",
            allowClear:true,
            minimumResultsForSearch:0,
            ajax: this.largeData || this.url ? {
                transport: (params, success, failure)=>{
                    const page = params.data.page || 1;
                    const term = params.data.q || "";

                    if(this.largeData){
                        let filtered = this.largeData.filter(x=>x.text.includes(term));
                        const start=(page-1)*this.pageSize;
                        const end=start+this.pageSize;
                        success({
                            results: prependAll(filtered.slice(start,end)),
                            pagination:{ more:end<filtered.length }
                        });
                    } else if(this.url){
                        $.ajax({
                            url: this.url,
                            dataType:'json',
                            data:{ q:term, page:page },
                            success:(data)=>{
                                success({
                                    results: prependAll(data.items||data.results||[]),
                                    pagination:{ more:data.hasMore||false }
                                });
                            },
                            error: failure
                        });
                    }
                },
                delay:250
            } : undefined
        });

        // åˆå§‹åŒ–æ™‚é¸ ALL
        if(this.showAllOption){
            // é€™è£¡é¸ä¸­ ALLï¼Œid = ""
            const initialOption = new Option(this.allOptionText, "", true, true);
            this.$select.append(initialOption).trigger('change');
        }
    }

    getValue(){ return this.$select.val(); }

    onChange(callback){
        this.$select.on('change', e => callback(e.target.value));
    }
}
 // ============================
// âœ” ICheckFieldBuilder å·¥å…·é¡
// ============================
class ICheckFieldBuilder {

    /**
     * å‹•æ…‹åŠ å…¥ checkbox (iCheck flat-blue)
     * @param container DOM æˆ– jQuery å®¹å™¨
     * @param name æ¬„ä½åç¨±ï¼ˆç”¨æ–¼é¡¯ç¤º + IDï¼‰
     * @param checked é è¨­æ˜¯å¦å‹¾é¸
     */
    static addCheckbox(container, name, checked = false) {
        const safeId = `dyn_${name.replace(/\s+/g, '_')}`;

        // å¤–å±¤ DIV
        let wrap = document.createElement("div");
        wrap.className = "icheck-field-wrapper";

        // checkbox input
        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = safeId;
        checkbox.className = "icheck-flat-blue";
        if (checked) checkbox.checked = true;

        // label
        let label = document.createElement("label");
        label.setAttribute("for", safeId);
        label.textContent = name;

        // append
        wrap.appendChild(checkbox);
        wrap.appendChild(label);

        // æ’å…¥å®¹å™¨
        container.appendChild(wrap);

        // å¥—ç”¨ iCheck
        $(checkbox).iCheck({
            checkboxClass: "icheckbox_flat-blue"
        });
    }
}


class FieldBuilder {

    /** ç”¢ç”Ÿå®‰å…¨ id */
    static safeId(name) {
        return "fld_" + name.replace(/\s+/g, "_");
    }

    /** === å»ºç«‹æ–‡å­—æ¡† ================================= */
    static addText(container, name, value = "") {
        const id = FieldBuilder.safeId(name);

        const wrap = document.createElement("div");
        wrap.className = "field-wrapper form-group";

        wrap.innerHTML = `
            <label class="control-label" for="${id}">${name}</label>
            <input type="text" id="${id}" class="form-control" value="${value}">
        `;

        container.appendChild(wrap);
        return id;
    }
	 static addDropdown(container, name, value = "") {
	 
	    const id = FieldBuilder.safeId(name);

        const wrap = document.createElement("div");
	 	wrap.className = "field-item";
	 
	 	let label = document.createElement("label");
			label.textContent = name;

			let select = document.createElement("select");
			select.setAttribute("id",  `sel${name}`);
	 
			wrap.appendChild(label);
			wrap.appendChild(select); 
		
			container.appendChild(wrap);
			
				
				 new LargeSelect2(select.id,{
				largeData,
				pageSize:50,
				showAllOption:true,
			   allOptionText:"å…¨éƒ¨é¸é …"
			});
	 
  return id;
	 
	 
	 
	 }
    /** === å»ºç«‹æ•¸å­—æ¡† ================================= */
    static addNumber(container, name, value = 0) {
        const id = FieldBuilder.safeId(name);

        const wrap = document.createElement("div");
        wrap.className = "field-wrapper form-group";

        wrap.innerHTML = `
            <label class="control-label" for="${id}">${name}</label>
            <input type="number" id="${id}" class="form-control" value="${value}">
        `;

        container.appendChild(wrap);
        return id;
    }

    /** === å»ºç«‹ iCheck checkboxï¼ˆflat-blueï¼‰ ============= */
    static addCheckbox(container, name, checked = false) {
        const id = FieldBuilder.safeId(name);

        const wrap = document.createElement("div");
        wrap.className = "field-wrapper icheck-field";

        wrap.innerHTML = `
            <input type="checkbox" id="${id}" ${checked ? "checked" : ""}>
            <label for="${id}">${name}</label>
        `;

        container.appendChild(wrap);

        // å¥—ç”¨ iCheck
        $(`#${id}`).iCheck({
            checkboxClass: "icheckbox_flat-blue"
        });

        return id;
    }
}


let table;
let fields =[];
let fields1 =[];
const allConfigs = [
  {
	  key: 'default',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		{ index: 0, name: 'ID', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown',disabled: true },
		{ index: 1, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'asc', condition: '', type: 'checkbox',disabled: true  },
		{ index: 2, name: 'Department', searchEnabled: false, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown' },
		{ index: 3, name: 'HireDate', searchEnabled: true, displayEnabled: true, sort: 'desc', condition: '', type: 'text' },
	  ] 
  },
   {
	  key: 'simple',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		 { index: 0, name: 'ID', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
         { index: 1, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'asc', condition: '', type: 'text' },
	  ] 
  }, 
   {
	  key: 'hr',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		   { index: 0, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
          { index: 1, name: 'Department', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown' },
	  ] 
  } 
];


let largeData = [];
for(let i=1;i<=3;i++){
    largeData.push({id:i, text:`é¸é … ${i}`});
}
// Dropdown options
//const dropdownOptions = [
  //  { value: "A", text: "é¸é … A" },
    //{ value: "B", text: "é¸é … B" },
  //  { value: "C", text: "é¸é … C" }
//];
function getSortIcon(sort) {
  if (sort === "asc") return '<i class="fa fa-arrow-up"></i>';
  if (sort === "desc") return '<i class="fa fa-arrow-down"></i>';
  return '<i class="fa fa-minus"></i>';
}
// ç”¢ç”Ÿæ¬„ä½
function generateFields() {
    const container = document.getElementById("field-container");
document.getElementById("field-container").innerHTML = "";
    fields1.forEach(item => {
		  if (item.type === "checkbox") {
			FieldBuilder.addCheckbox(container, item.name, true);

			}
    if (item.type === "text") {
			FieldBuilder.addText(container,  item.name, "Tom");
			}
			
				 if (item.type === "dropdown") {
			FieldBuilder.addDropdown(container,  item.name, "");		    
				      			
	 }
			   if (item.type === "number") {
			FieldBuilder.addNumber(container, item.name, true);

			}
	   
        
    });
}
function renderFields() {
  const $tb = $("#fieldTable tbody");
  $tb.empty();
  fields.forEach((f, i) => {
    $tb.append(`
      <tr data-index="${i}">
        <td class="text-center cursor-move"><i class="fa fa-bars"></i></td>
        <td class="editable">${f.name}</td>
	    <td>
          <select class="form-select form-select-sm field-type">
            <option value="text" ${f.type ==='text'? "selected" : ""}>Text</option>
            <option value="dropdown" ${f.type ==='dropdown'? "selected" : ""}>Dropdown</option>
            <option value="checkbox" ${f.type ==='checkbox'? "selected" : ""}>Checkbox</option>
          </select>
        </td>
       <td class="text-center">
          <input type="checkbox" class="form-check-input searchChk" ${f.searchEnabled?"checked":""}>
        </td>
        <td class="text-center">
          <input type="checkbox" class="form-check-input displayChk" ${f.displayEnabled?"checked":""}>
        </td>
        <td class="text-center">
          <button class="btn btn-outline-secondary btn-sm sortBtn" data-sort="${f.sort}">
            ${getSortIcon(f.sort)}
          </button>
        </td>
        <td><input type="text" class="form-control form-control-sm condInput" value="${f.condition}"></td>
        <td class="text-center">
          <button class="btn btn-outline-danger btn-sm delBtn"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `);
  });
  updateJSON();
}
function syncDataTableOrder(){
	$("#btnApply").click();
}

function buildColumns(showfields) {
    const cols = [];

    // ğŸ‘‰ ç¬¬ä¸€æ¬„ï¼šå‹•æ…‹åŠ å…¥ç·¨è¼¯ + åˆªé™¤æŒ‰éˆ•
    cols.push({
        data: null,
        orderable: false,
        searchable: false,
        render: function (data, type, row) {
            return `
                <button class="btn btn-xs btn-info edit-btn" data-id="${row.id}">
                    <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-xs btn-danger delete-btn" data-id="${row.id}">
                    <i class="fa fa-trash"></i>
                </button>
            `;
        }
    });

    // ğŸ‘‰ å…¶å®ƒæ¬„ä½å‹•æ…‹åŠ å…¥
    showfields.forEach(f => {
        cols.push({ data: f.data,title:f.title });
    });

    return cols;
}

function generateMockData(fields, rowCount = 10) {
    const result = [];

    for (let i = 0; i < rowCount; i++) {
        let row = {};

        fields.forEach(f => {
            const key = f.name;

            // è‡ªå‹•ç”¢ç”Ÿè³‡æ–™ä¾ type
            switch (f.type) {
                case "number":
                    row[key] = Math.floor(Math.random() * 100); // 0-99
                    break;

                case "dropdown":
                    if (Array.isArray(f.options) && f.options.length > 0) {
                        let opt = f.options[Math.floor(Math.random() * f.options.length)];
                        row[key] = opt.value;
                    } else {
                        row[key] = "Option" + (i + 1); // fallback
                    }
                    break;

                case "checkbox":
                    row[key] = Math.random() > 0.5;
                    break;

                case "date":
                case "HireDate":
                    row[key] = randomDate("2020-01-01", "2024-12-31");
                    break;

                default:
                    // text
                    row[key] = key + "_" + (i + 1);
                    break;
            }
        });

        result.push(row);
    }

    return result;
}

// çµ¦ date type ä½¿ç”¨
function randomDate(start, end) {
    const s = new Date(start).getTime();
    const e = new Date(end).getTime();
    const d = new Date(s + Math.random() * (e - s));
    return d.toISOString().slice(0, 10); // YYYY-MM-DD
}



// ğŸ§© æ¨¡æ“¬å¾Œç«¯æŸ¥è©¢
function fakeFetchData(filter) {
  const allData = [
    { ID: 1, Name: "John", Department: "IT", HireDate: "2020-05-01" },
    { ID: 2, Name: "Mary", Department: "HR", HireDate: "2019-07-15" },
    { ID: 3, Name: "Alex", Department: "Sales", HireDate: "2021-03-20" },
    { ID: 4, Name: "Lisa", Department: "IT", HireDate: "2022-01-05" },
  ];

  let result = allData;
  filter.forEach(f => {
    if (f.condition) result = result.filter(x => String(x[f.name]).includes(f.condition));
  });

  const sortField = filter.find(f => f.sort !== "none");
  if (sortField) {
    result.sort((a, b) =>
      sortField.sort === "asc"
        ? a[sortField.name] > b[sortField.name] ? 1 : -1
        : a[sortField.name] < b[sortField.name] ? 1 : -1
    );
  }

  return result;
}

// âœ… å¥—ç”¨è¨­å®šï¼ˆæŸ¥è©¢ + DataTable é¡¯ç¤ºï¼‰
$("#btnApply").click(() => {
  const filterFields = fields.filter(f=>f.searchEnabled);
  const displayFields = fields.filter(f=>f.displayEnabled);
  const filter = filterFields.map(f => ({
    name: f.name,
    condition: f.condition,
    sort: f.sort
  }));

 
   

  // DataTable order: index + asc/desc
  const order = [];
  displayFields.forEach((f, i) => {
    if (f.sort !== "none") {
      order.push([i, f.sort]); // [columnIndex, 'asc'|'desc']
    }
  }); 
  

 // const columns = displayFields.map(f => ({ title: f.name, data: f.name }));
  const _columns = displayFields.map(f => ({ title: f.name, data: f.name }));
  columns = buildColumns(_columns)



 columns.forEach(col => {
        let thContent;
        if(col.data == null) { 
	       thContent = ` <button class="btn btn-sm btn-success header-btn" data-col="${col.data}">æ–°å¢</button>`;
        }
		else
		{
           thContent = col.data;
		}
		   $('#dataTable thead tr').append(`<th class="text-center">${thContent}</th>`);
		  
    });
 
// æ¨¡æ“¬æŸ¥è©¢çµæœ
  const data = generateMockData(displayFields, 20);
  //fakeFetchData(filter);

  // âœ… ä¿è­‰æ¯ç­†è³‡æ–™éƒ½å«æœ‰ç›®å‰å•Ÿç”¨çš„æ¬„ä½ï¼ˆå³ä½¿ fakeFetchData æ²’æœ‰ï¼‰
  data.forEach(row => {
    displayFields.forEach(f => {
      if (!(f.name in row)) row[f.name] = ""; // åŠ å…¥ç©ºæ¬„ä½
    });
  });
   if ($.fn.DataTable.isDataTable("#dataTable")) {
    table.clear().destroy();
    $("#dataTable").empty();
  }
  table =$('#dataTable').DataTable({
    data: data,
    columns: columns,
    order: order,       // ğŸ”¹ å¥—ç”¨æ’åº
    pageLength: 10,
    responsive: true, searching: false,  
    dom:
    '<"row mb-2"' +
            
            '<"col-sm-12 text-right d-flex justify-content-end align-items-center custom-buttons">' +
        '>' +

    '<"row"<"col-sm-12"tr>>' +                                      // è¡¨æ ¼æœ¬é«”

    '<"row mt-2"' +
        '<"col-sm-5"l>' +                                           // âœ” å·¦ä¸‹ï¼šShow XX entries
        '<"col-sm-3"i>' +                                           // ä¸­é–“ï¼šInfo
        '<"col-sm-4"p>' +                                           // å³ä¸‹ï¼šåˆ†é 
    '>'
,
 

    // ğŸ”¥ ä¸‹æ‹‰æ¡†é¸é …ï¼ˆä¸€å®šè¦è¨­å®šï¼‰
    lengthMenu: [
        [10, 25, 50, -1],   // å¯¦éš›å€¼
        [10, 25, 50, "å…¨éƒ¨"] // é¡¯ç¤ºæ–‡å­—
    ],
 // ğŸ”¹ è¡¨æ ¼åˆå§‹åŒ–å¾Œæ³¨å…¥è‡ªè¨‚æŒ‰éˆ•
                initComplete: function () {

                    $(".custom-buttons").html(`
                        <button id="btnImport" class="btn btn-primary btn-sm mr-2">åŒ¯å…¥</button>
                        <button id="btnExport" class="btn btn-success btn-sm">åŒ¯å‡º</button>
                    `);
 
                }
  });
generateFields(); 
    
   


})


 // 2ï¸âƒ£ å°‡äº‹ä»¶ç¶å®šæ”¾åœ¨ DataTable å¤–é¢ï¼ˆäº‹ä»¶å§”æ´¾æ–¹å¼ï¼‰
            $(document).on("click", "#btnImport", function () {
                alert("ä½ é»æ“Šäº†ã€åŒ¯å…¥ã€ï¼");
            });

            $(document).on("click", "#btnExport", function () {
                alert("ä½ é»æ“Šäº†ã€åŒ¯å‡ºã€ï¼");
            }); 
   // Header æŒ‰éˆ•äº‹ä»¶å§”æ´¾
    $(document).on("click", ".header-btn", function(){
        const colName = $(this).data("col");
		 openPopup("add", null);
        // å¯ä»¥åœ¨é€™è£¡æ–°å¢åˆ—æˆ–å…¶ä»–æ“ä½œ
    });




// æ›´æ–° JSON
function updateJSON() {

const key = $("#configSelector").val(); 
 const extraSetting = {
    header: {
      enabled: $("#chkHeader").prop("checked"),
      name: $("#txtHeaderName").val()
    },
    body: {
      enabled: $("#chkBody").prop("checked"),
      name: $("#txtBodyName").val()
    },
    popup: {
      enabled: $("#chkPopup").prop("checked"),
      name: $("#txtPopupName").val()
    }
  };
  const fieldSetting = fields.map(f => ({
    index: f.index,
    name: f.name,
    type: f.type,
    searchEnabled: f.searchEnabled,
    displayEnabled: f.displayEnabled,
    sort: f.sort,
    condition: f.condition
  }));
  const singleConfig  = {
    key: key,               // â† ä½ è¦çš„è­˜åˆ¥ key
    extra: extraSetting,
    fields: fieldSetting
  };


	const idx = allConfigs.findIndex(x => x.key === key);

	if (idx >= 0) {
		allConfigs[idx] = singleConfig;  // è¦†è“‹
	} else {
		allConfigs.push(singleConfig);   // æ–°å¢
	}
syncDataTableOrder()
  $("#jsonOutput").text(JSON.stringify(singleConfig, null, 2));
}
function loadConfig(key) {
    const cfg = allConfigs.find(x => x.key === key);
    if (!cfg) return;

    // å¥—ç”¨ extra
    $("#chkHeader").prop("checked", cfg.extra.header.enabled);
    $("#txtHeaderName").val(cfg.extra.header.name);

    $("#chkBody").prop("checked", cfg.extra.body.enabled);
    $("#txtBodyName").val(cfg.extra.body.name);

    $("#chkPopup").prop("checked", cfg.extra.popup.enabled);
    $("#txtPopupName").val(cfg.extra.popup.name);

    // å¥—ç”¨ fields
    fields = cfg.fields.map(f => ({ ...f }));
	
    fields1 = cfg.fields.filter(p=>p.searchEnabled==true).map(f => ({ ...f }));
	generateFields(); 
    renderFields();
    syncDataTableOrder();
}

$("#configSelector").change(function () {
  const key = $(this).val(); 
  loadConfig(key) 
});
// âœ… æ‹–æ›³æ’åºï¼ˆä¿æŒè³‡æ–™æ­£ç¢ºï¼‰
new Sortable(document.querySelector("#fieldTable tbody"), {
  handle: ".cursor-move",
  animation: 150,
  onEnd: e => {
    const moved = fields.splice(e.oldIndex, 1)[0];
    fields.splice(e.newIndex, 0, moved);
     // æ›´æ–° index
    fields.forEach((f, i) => f.index = i);
    renderFields();
    syncDataTableOrder(); // ğŸ”¹ åŒæ­¥ DataTable æ¬„ä½é †åº
  }
});
// âœ… é›™æ“Šç·¨è¼¯æ¬„ä½åç¨±
$(document).on("dblclick", ".editable", function() {
  const $td = $(this);
  const oldText = $td.text().trim();
  $td.html(`<input type="text" class="form-control form-control-sm editInput" value="${oldText}"/>`);
  $td.find("input").focus().select();
});

// âœ… ç·¨è¼¯çµæŸï¼ˆé˜²é‡åèˆ‡ç©ºå€¼ï¼‰
$(document).on("blur", ".editInput", function() {
  const $input = $(this);
  const newText = $input.val().trim();
  const $td = $input.closest("td");
  const idx = $td.closest("tr").data("index");
  const oldText = fields[idx].name;

  // æª¢æŸ¥é‡åæˆ–ç©ºå€¼
  const exists = fields.some((f, i) => i !== idx && f.name.toLowerCase() === newText.toLowerCase());
  if (!newText) {
    alert("æ¬„ä½åç¨±ä¸å¯ç‚ºç©ºï¼");
    $td.text(oldText);
  } else if (exists) {
    alert(`æ¬„ä½åç¨±ã€Œ${newText}ã€å·²å­˜åœ¨ï¼`);
    $td.text(oldText);
  } else {
    fields[idx].name = newText;
    $td.text(newText);
  }
  
  updateJSON();
})

$(document).on("keypress", ".editInput", function(e) {
  if (e.which === 13) $(this).blur();
});

// å‹æ…‹è®Šæ›´
$(document).on("change", ".field-type", function(){
  const idx = $(this).closest("tr").data("index");
  fields[idx].type = $(this).val();
  updateJSON();
});

// âœ… æ’åºåˆ‡æ›
$(document).on("click", ".sortBtn", function() {
  const $btn = $(this);
  const idx = $btn.closest("tr").data("index");
  const cur = fields[idx].sort;
  const next = cur === "none" ? "asc" : cur === "asc" ? "desc" : "none";
  fields[idx].sort = next;
  $btn.html(getSortIcon(next)).attr("data-sort", next);
  updateJSON();
});

// æœå°‹å•Ÿç”¨
$(document).on("click", ".searchChk", function(){
  const idx = $(this).closest("tr").data("index");
  fields[idx].searchEnabled = this.checked;
  updateJSON();
});

// é¡¯ç¤ºå•Ÿç”¨
$(document).on("click", ".displayChk", function(){
  const idx = $(this).closest("tr").data("index");
  fields[idx].displayEnabled = this.checked;
  updateJSON();
});


// âœ… æ¢ä»¶è¼¸å…¥
$(document).on("input", ".condInput", function() {
  const idx = $(this).closest("tr").data("index");
  fields[idx].condition = $(this).val();
  updateJSON();
});
// âœ… æ–°å¢æ¬„ä½
$("#btnAdd").click(() => {
  let idx = 1;
  let newName;
  do {
    newName = "NewField" + idx++;
  } while (fields.some(f => f.name === newName));

  fields.push({ index: fields.length, name: newName, searchEnabled: true, displayEnabled: true, sort: "none", condition: "", type: "text" });
  renderFields();
  syncDataTableOrder();
});

// âœ… åˆªé™¤åˆ—
$(document).on("click", ".delBtn", function() {
  const idx = $(this).closest("tr").data("index");
  fields.splice(idx, 1);
  // æ›´æ–° index
  fields.forEach((f, i) => f.index = i);
  renderFields();
  syncDataTableOrder();
});
function safeId(name){
  return 'popup_' + String(name).replace(/\W+/g, '_');
}
/**
 * mode = "add" | "edit"
 * rowData = ç·¨è¼¯æ™‚å¸¶å…¥è³‡æ–™ï¼Œæ–°å¢æ™‚å¯å‚³ null
 */
function openPopup(mode, rowData) {

    // å¼·åˆ¶ rowData æ˜¯ç‰©ä»¶ï¼Œé¿å… undefined
    rowData = rowData || {};

    // æ¸…é™¤å…§å®¹
    $("#popupModalBody").empty();

    fields.forEach(f => {
        const colName = f.name;
        const id = safeId(colName);

        // æ–°å¢ = ç©ºå€¼ï¼Œç·¨è¼¯ = rowData å€¼
        const value = (mode === "edit" && rowData[colName] !== undefined)
            ? rowData[colName]
            : "";

        let html = `<div class="form-group">
                      <label class="control-label">${colName}</label>`;

        // ä¸‹æ‹‰é¸å–®
        if (f.type === 'dropdown') { 
            html += `<select id="${id}" ${f.disabled ? "disabled" : ""}>`;

            html += `</select>`;
			
			 new LargeSelect2( `${id} `,{
    largeData,
    pageSize:50,
    showAllOption:true,
   allOptionText:"å…¨éƒ¨é¸é …"
});
        }

        // checkbox
        else if (f.type === 'checkbox') {
            html += `<div class="checkbox">
                       <label>
                         <input type="checkbox" id="${id}" ${value ? "checked" : ""} ${f.disabled ? "disabled" : ""}>
                         ${f.text || "å‹¾é¸"}
                       </label>
                     </div>`;
        }

        // number
        else if (f.type === 'number') {
            html += `<input type="number" class="form-control" id="${id}" value="${value}" ${f.disabled ? "disabled" : ""}>`;
        }

        // text / default
        else {
            const escaped = String(value).replace(/"/g, "&quot;");
            html += `<input type="text" class="form-control" id="${id}" value="${escaped}" ${f.disabled ? "disabled" : ""}>`;
        }

        html += `</div>`;
        $("#popupModalBody").append(html);
    });

    // ====== è¨­å®šæ¨™é¡Œ ======
    if (mode === "add") {
        $("#popupModalTitle").text("æ–°å¢è³‡æ–™");
    } else {
        $("#popupModalTitle").text("ç·¨è¼¯è³‡æ–™");
    }

    // ====== è¨­å®šæ¨¡å¼ ======
    $("#popupModal").data("mode", mode);

    // é¡¯ç¤º
    $("#popupModal").modal("show");
}
$("#btnSavePopup").click(function () {
    const mode = $("#popupModal").data("mode");
    let obj = {};

    fields.forEach(f => {
        const id = safeId(f.name);

        if (f.type === "checkbox") {
            obj[f.name] = $("#" + id).is(":checked");
        } else {
            obj[f.name] = $("#" + id).val();
        }
    });

    if (mode === "add") {
        console.log("æ–°å¢è³‡æ–™", obj);
        // å‘¼å« API æ–°å¢
    } else {
        console.log("ç·¨è¼¯è³‡æ–™", obj);
        // å‘¼å« API æ›´æ–°
    }

    $("#popupModal").modal("hide");
});

// ç·¨è¼¯
$(document).on("click", ".edit-btn", function () {

  const row = table.row($(this).closest("tr")).data();
   openPopup("edit", row);
 
 
});

// åˆå§‹åŒ–
loadConfig('default')
renderFields();
updateJSON();
$("#chkHeader, #chkBody, #chkPopup").change(updateJSON);
$("#txtHeaderName, #txtBodyName, #txtPopupName").on("input", updateJSON);
</script>
</body>
</html>





<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Bootstrap 3 Tab åˆ‡æ›ç¯„ä¾‹</title>
  <!-- Bootstrap 3 CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
   <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@2.4.18/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@2.4.18/dist/css/skins/skin-blue.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- iCheck flat-blue CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/iCheck/1.0.3/skins/flat/blue.css" rel="stylesheet">

<!-- ä¿®æ­£ç‰ˆ iCheckï¼ˆæ”¯æ´ jQuery 3.xï¼‰ -->
<script src="https://cdn.jsdelivr.net/gh/fronteed/icheck@master/icheck.min.js"></script>

<!-- Bootstrap 3 JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
	<!-- AdminLTE JS -->
	<script src="https://cdn.jsdelivr.net/npm/admin-lte@2.4.18/dist/js/adminlte.min.js"></script>
  <style>
    .tab-content {
      margin-top: 20px;
    }
	      /* è®“å…§å®¹ç½®ä¸­ä¸”æœ‰åŸºæœ¬å¯¬åº¦ */
        .content-area {
            max-width: 1400px;
            margin: 20px auto;
        }

        /* ä¸€åˆ— 6 æ¬„ */
        #field-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            padding: 10px;
        }

        .field-item {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 13px;
            margin-bottom: 3px;
        }

        select {
            padding: 5px;
            border: 1px solid #bbb;
            border-radius: 4px;
        }
    
   #jsonOutput {
    white-space: pre-wrap;
    font-size: 13px;
  }
  
.icheck-field-wrapper {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
}

.icheck-field-wrapper label {
    margin-left: 8px;
    font-size: 14px;
    cursor: pointer;
}
  .field-wrapper {
            margin-bottom: 10px;
        }

        /* checkbox label åº•ä¸‹æ–‡å­—å°é½Š */
        .icheck-field {
            display: flex;
            align-items: center;
        }
        .icheck-field label {
            margin-left: 8px;
            cursor: pointer;
        }
  </style>
</head>
<body>
<div class="container">
  <h2>Bootstrap 3 Tab ç¯„ä¾‹</h2>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="active"><a href="#home" role="tabpanel" data-toggle="tab">é¦–é </a></li>
    <li><a href="#profile" role="tabpanel" data-toggle="tab">å€‹äººè³‡æ–™</a></li>
    <li><a href="#messages" role="tabpanel" data-toggle="tab">è¨Šæ¯</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div class="tab-pane fade in active" id="home">
     <!-- ğŸ”¹ä¸‹æ‹‰è¨­å®š -->
      <div class="mb-3">
        <label class="form-label">é¸æ“‡æ¬„ä½è¨­å®š</label>
        <select id="configSelector" class="form-select form-select-sm" style="width:200px;">
          <option value="default">é è¨­è¨­å®š</option>
          <option value="simple">ç°¡æ˜“ç‰ˆ (ID + Name)</option>
          <option value="hr">HR ç‰ˆæœ¬ (Name + Department)</option>
        </select>
      </div>
      <!-- ğŸ”¹é¡å¤–è¨­å®š -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">é¡å¤–è¨­å®š</h5>
        <div class="row g-3">

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkHeader" class="form-check-input">
            <label for="chkHeader" class="form-check-label me-2">è¡¨é ­å•Ÿç”¨</label>
            <input type="text" id="txtHeaderName" class="form-control form-control-sm w-auto">
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkBody" class="form-check-input">
            <label for="chkBody" class="form-check-label me-2">è¡¨èº«å•Ÿç”¨</label>
            <input type="text" id="txtBodyName" class="form-control form-control-sm w-auto">
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkPopup" class="form-check-input">
            <label for="chkPopup" class="form-check-label me-2">å½ˆè·³å•Ÿç”¨</label>
            <input type="text" id="txtPopupName" class="form-control form-control-sm w-auto">
       
          </div>

        </div>
      </div>

   

      <!-- ğŸ”¹æ¬„ä½è¨­å®šè¡¨ -->
      <h5>æ¬„ä½è¨­å®š</h5>
      <table id="fieldTable" class="table table-bordered align-middle table-sm">
        <thead>
          <tr class="table-light">
            <th style="width:50px;">æ‹–æ›³</th>
            <th>æ¬„ä½</th>
            <th style="width:120px;">å‹æ…‹</th>
            <th style="width:80px;">æœå°‹å•Ÿç”¨</th>
            <th style="width:80px;">é¡¯ç¤ºå•Ÿç”¨</th>
            <th style="width:90px;">æ’åº</th>
            <th>æ¢ä»¶</th>
            <th style="width:60px;">åˆªé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="btnAdd" class="btn btn-outline-primary btn-sm">
        <i class="fa fa-plus"></i> æ–°å¢æ¬„ä½
      </button>
      <button id="btnApply" class="btn btn-success btn-sm">
        <i class="fa fa-play"></i> å¥—ç”¨è¨­å®š
      </button>
    </div>
    <div class="tab-pane fade" id="profile">
    <div class="content-area">
  
        <!-- â­ æŠ˜ç–Š Panel -->
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">æŸ¥è©¢æ¢ä»¶</h3>

                <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>

            <div class="box-body">
                <div id="field-container"></div>
            </div>
        </div>

   
</div>

<div class="content-area">
   
        <!-- â­ æŠ˜ç–Š Panel -->
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">æŸ¥è©¢çµæœ</h3>

                <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>

            <div class="box-body">
               <div class="row">
					<div class="col-md-12">
					  <table id="dataTable" class="display w-100"  style="width:100% !important;">
						<thead><tr></tr></thead>
						<tbody></tbody>
					  </table>
				 
					</div> 
			   </div>
            </div>
        </div>

    
</div>
    </div>
    <div class="tab-pane fade" id="messages">
         <h5>æŸ¥è©¢çµæœ</h5>

      <div class="row">
        <div class="col-md-12">
         <pre id="jsonOutput" class="border p-2 bg-light" style="height:500px; overflow:auto;"></pre>
        </div>

       
      </div>
    </div>
  </div>
</div>

<div id="popupModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title" id="popupModalTitle">å½ˆè·³è¦–çª—</h4>
      </div>

      <div class="modal-body" id="popupModalBody">
      </div>

      <div class="modal-footer">
        <button class="btn btn-default" data-dismiss="modal">é—œé–‰</button>
        <button class="btn btn-primary" id="btnSavePopup">å„²å­˜</button>
      </div>

    </div>
  </div>
</div>

<script>
/******************************************************************
 *  LargeSelect2 - å¤§é‡ä¸‹æ‹‰é¸å–®
 ******************************************************************/
class LargeSelect2 {
    constructor(selectId, options = {}) {
        this.$select = $(`#${selectId}`);
        this.pageSize = options.pageSize || 50;
        this.largeData = options.largeData || null;
        this.url = options.url || null;
        this.showAllOption = options.showAllOption || false;
        this.allOptionText = options.allOptionText || "å…¨éƒ¨";

        const prependAll = (results) => {
            if (this.showAllOption && !results.some(r => r.id === "")) {
                results.unshift({ id: "", text: this.allOptionText });
            }
            return results;
        };

        this.$select.select2({
            placeholder: options.placeholder || "è«‹é¸",
            allowClear: true,
            minimumResultsForSearch: 0,
            ajax: this.largeData || this.url ? {
                transport: (params, success, failure) => {
                    const page = params.data.page || 1;
                    const term = params.data.q || "";

                    if (this.largeData) {
                        let filtered = this.largeData.filter(x => x.text.includes(term));
                        const start = (page - 1) * this.pageSize;
                        const end = start + this.pageSize;

                        success({
                            results: prependAll(filtered.slice(start, end)),
                            pagination: { more: end < filtered.length }
                        });
                    }
                    else if (this.url) {
                        $.ajax({
                            url: this.url,
                            dataType: 'json',
                            data: { q: term, page: page },
                            success: data => {
                                success({
                                    results: prependAll(data.items || data.results || []),
                                    pagination: { more: data.hasMore || false }
                                });
                            },
                            error: failure
                        });
                    }
                },
                delay: 250
            } : undefined
        });

        if (this.showAllOption) {
            const initial = new Option(this.allOptionText, "", true, true);
            this.$select.append(initial).trigger("change");
        }
    }

    getValue() {
        return this.$select.val();
    }
}

/******************************************************************
 *  ICheckFieldBuilder - ç”¢ç”Ÿ iCheck Checkbox
 ******************************************************************/
class ICheckFieldBuilder {
    static add(container, name, checked = false) {
        const safeId = `chk_${name.replace(/\s+/g, "_")}`;

        let wrap = document.createElement("div");
        wrap.className = "icheck-field-wrapper";

        let cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = safeId;
        cb.checked = checked;

        let label = document.createElement("label");
        label.setAttribute("for", safeId);
        label.textContent = name;

        wrap.appendChild(cb);
        wrap.appendChild(label);

        container.appendChild(wrap);

        $(cb).iCheck({
            checkboxClass: "icheckbox_flat-blue"
        });

        return safeId;
    }
}

/******************************************************************
 *  FieldBuilder - ç”¢ç”Ÿ Text/Number/Dropdown/Checkbox
 ******************************************************************/
class FieldBuilder {
    static safeId(name) {
        return "fld_" + name.replace(/\s+/g, "_");
    }

    static addText(container, name, value = "") {
        const id = this.safeId(name);
        container.innerHTML += `
            <div class="field-wrapper form-group">
                <label>${name}</label>
                <input id="${id}" type="text" class="form-control" value="${value}">
            </div>`;
        return id;
    }

    static addNumber(container, name, value = 0) {
        const id = this.safeId(name);
        container.innerHTML += `
            <div class="field-wrapper form-group">
                <label>${name}</label>
                <input id="${id}" type="number" class="form-control" value="${value}">
            </div>`;
        return id;
    }

    static addCheckbox(container, name, checked = false) {
        return ICheckFieldBuilder.add(container, name, checked);
    }

    static addDropdown(container, name, options = {}) {
        const id = this.safeId(name);
        const wrap = document.createElement("div");
        wrap.className = "field-item";

        wrap.innerHTML = `
            <label>${name}</label>
            <select id="${id}"></select>
        `;
        container.appendChild(wrap);

        new LargeSelect2(id, {
            largeData: options.largeData || [],
            showAllOption: true
        });

        return id;
    }
}

/******************************************************************
 * ConfigManager â€“ ç®¡ç† default/simple/hr ç‰ˆæœ¬
 ******************************************************************/
class ConfigManager {
    constructor(configs) {
        this.configs = configs;
    }

    getConfig(key) {
        return this.configs.find(c => c.key === key);
    }
}

/******************************************************************
 * FieldTableManager â€“ ç®¡ç†æ¬„ä½è¨­å®šè¡¨ï¼ˆä½ çš„è¡¨æ ¼ï¼‰
 ******************************************************************/
class FieldTableManager {
    constructor(tableId) {
        this.tableId = tableId;
        this.fields = [];
    }

    loadFields(newFields) {
        this.fields = JSON.parse(JSON.stringify(newFields));
        this.render();
    }

    render() {
        const $tb = $(`${this.tableId} tbody`);
        $tb.empty();

        this.fields.forEach((f, i) => {
            $tb.append(`
                <tr data-i="${i}">
                    <td><i class="fa fa-bars cursor-move"></i></td>
                    <td>${f.name}</td>
                    <td>
                        <select class="field-type">
                            <option value="text" ${f.type === 'text' ? "selected" : ""}>Text</option>
                            <option value="dropdown" ${f.type === 'dropdown' ? "selected" : ""}>Dropdown</option>
                            <option value="checkbox" ${f.type === 'checkbox' ? "selected" : ""}>Checkbox</option>
                        </select>
                    </td>
                    <td><input type="checkbox" class="searchChk" ${f.searchEnabled ? "checked" : ""}></td>
                    <td><input type="checkbox" class="displayChk" ${f.displayEnabled ? "checked" : ""}></td>
                    <td><button class="sortBtn btn btn-sm btn-default" data-sort="${f.sort}">${this.sortIcon(f.sort)}</button></td>
                    <td><input class="condInput form-control" value="${f.condition || ""}"></td>
                    <td><button class="delBtn btn btn-danger btn-sm"><i class="fa fa-trash"></i></button></td>
                </tr>
            `);
        });
    }

    sortIcon(sort) {
        if (sort === "asc") return `<i class="fa fa-arrow-up"></i>`;
        if (sort === "desc") return `<i class="fa fa-arrow-down"></i>`;
        return `<i class="fa fa-minus"></i>`;
    }
}

/******************************************************************
 * DynamicFormRenderer - ç”¢ç”Ÿ Profile tab è£¡çš„æŸ¥è©¢æ¢ä»¶æ¬„ä½
 ******************************************************************/
class DynamicFormRenderer {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
    }

    render(fields) {
        this.container.innerHTML = "";
        fields.forEach(f => {
            switch (f.type) {
                case "text": FieldBuilder.addText(this.container, f.name); break;
                case "number": FieldBuilder.addNumber(this.container, f.name); break;
                case "checkbox": FieldBuilder.addCheckbox(this.container, f.name); break;
                case "dropdown": FieldBuilder.addDropdown(this.container, f.name, { largeData }); break;
            }
        });
    }
}
const allConfigs = [
  {
	  key: 'default',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		{ index: 0, name: 'ID', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown',disabled: true },
		{ index: 1, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'asc', condition: '', type: 'checkbox',disabled: true  },
		{ index: 2, name: 'Department', searchEnabled: false, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown' },
		{ index: 3, name: 'HireDate', searchEnabled: true, displayEnabled: true, sort: 'desc', condition: '', type: 'text' },
	  ] 
  },
   {
	  key: 'simple',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		 { index: 0, name: 'ID', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
         { index: 1, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'asc', condition: '', type: 'text' },
	  ] 
  }, 
   {
	  key: 'hr',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		   { index: 0, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
          { index: 1, name: 'Department', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown' },
	  ] 
  } 
];

let largeData = [];
for(let i=1;i<=3;i++){
    largeData.push({id:i, text:`é¸é … ${i}`});
}
/******************************************************************
 * App â€“ ç¸½æ§åˆ¶å™¨
 ******************************************************************/
class App {
    constructor() {
        this.configManager = new ConfigManager(allConfigs);
        this.tableMgr = new FieldTableManager("#fieldTable");
        this.dynamicRenderer = new DynamicFormRenderer("field-container");

        this.bindEvents();
    }

    bindEvents() {
        $("#configSelector").on("change", () => this.applyConfig());
        $("#btnAdd").on("click", () => this.addField());
    }

    applyConfig() {
        const config = this.configManager.getConfig($("#configSelector").val());
        this.tableMgr.loadFields(config.fields);
        this.dynamicRenderer.render(config.fields);
    }

    addField() {
        this.tableMgr.fields.push({
            name: "NewField",
            type: "text",
            searchEnabled: false,
            displayEnabled: true,
            sort: "none",
            condition: ""
        });
        this.tableMgr.render();
    }
}

/******************************************************************
 * åˆå§‹åŒ–
 ******************************************************************/
$(document).ready(() => {
    window.app = new App();
    app.applyConfig();
});

</script>
</body>
</html>

