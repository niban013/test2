<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
 

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> <!-- â† å¿…åŠ  -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

 
<style>
  #jsonOutput {
    white-space: pre-wrap;
    font-size: 13px;
  }
</style>
 
  <!-- â­ TAB æ¨™ç±¤ -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-setting" data-bs-toggle="tab" data-bs-target="#settingTab" type="button" role="tab">
        è¨­å®šæ¨¡å¼
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-result" data-bs-toggle="tab" data-bs-target="#resultTab" type="button" role="tab">
        å¥—ç”¨çµæœ
      </button>
    </li>
	 <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-json" data-bs-toggle="tab" data-bs-target="#jsonTab" type="button" role="tab">
        json
      </button>
    </li>
  </ul>

  <!-- â­ TAB å…§å®¹ -->
  <div class="tab-content">
<button id="btnLoadJson" class="btn btn-secondary btn-sm">è¼‰å…¥ JSON</button>

    <!-- ğŸ”¶ TAB1ï¼šè¨­å®šæ¨¡å¼ -->
    <div class="tab-pane fade show active p-3" id="settingTab" role="tabpanel">
   <!-- ğŸ”¹ä¸‹æ‹‰è¨­å®š -->
      <div class="mb-3">
        <label class="form-label">é¸æ“‡æ¬„ä½è¨­å®š</label>
        <select id="configSelector" class="form-select form-select-sm" style="width:200px;">
          <option value="default">é è¨­è¨­å®š</option>
          <option value="simple">ç°¡æ˜“ç‰ˆ (ID + Name)</option>
          <option value="hr">HR ç‰ˆæœ¬ (Name + Department)</option>
        </select>
      </div>
      <!-- ğŸ”¹é¡å¤–è¨­å®š -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">é¡å¤–è¨­å®š</h5>
        <div class="row g-3">

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkHeader" class="form-check-input">
            <label for="chkHeader" class="form-check-label me-2">è¡¨é ­å•Ÿç”¨</label>
            <input type="text" id="txtHeaderName" class="form-control form-control-sm w-auto">
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkBody" class="form-check-input">
            <label for="chkBody" class="form-check-label me-2">è¡¨èº«å•Ÿç”¨</label>
            <input type="text" id="txtBodyName" class="form-control form-control-sm w-auto">
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <input type="checkbox" id="chkPopup" class="form-check-input">
            <label for="chkPopup" class="form-check-label me-2">å½ˆè·³å•Ÿç”¨</label>
            <input type="text" id="txtPopupName" class="form-control form-control-sm w-auto">
       
          </div>

        </div>
      </div>

   

      <!-- ğŸ”¹æ¬„ä½è¨­å®šè¡¨ -->
      <h5>æ¬„ä½è¨­å®š</h5>
      <table id="fieldTable" class="table table-bordered align-middle table-sm">
        <thead>
          <tr class="table-light">
            <th style="width:50px;">æ‹–æ›³</th>
            <th>æ¬„ä½</th>
            <th style="width:120px;">å‹æ…‹</th>
            <th style="width:80px;">æœå°‹å•Ÿç”¨</th>
            <th style="width:80px;">é¡¯ç¤ºå•Ÿç”¨</th>
            <th style="width:90px;">æ’åº</th>
            <th>æ¢ä»¶</th>
            <th style="width:60px;">åˆªé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="btnAdd" class="btn btn-outline-primary btn-sm">
        <i class="fa fa-plus"></i> æ–°å¢æ¬„ä½
      </button>
      <button id="btnApply" class="btn btn-success btn-sm">
        <i class="fa fa-play"></i> å¥—ç”¨è¨­å®š
      </button>

    </div>

    <!-- ğŸ”¶ TAB2ï¼šå¥—ç”¨çµæœ -->
    <div class="tab-pane fade p-3" id="resultTab" role="tabpanel">

      <h5>æŸ¥è©¢çµæœ</h5>

      <div class="row">
        <div class="col-md-12">
          <table id="dataTable" class="display w-100">
            <thead><tr></tr></thead>
            <tbody></tbody>
          </table>
        </div>

       
      </div>

    </div>
	   <div class="tab-pane fade p-3" id="jsonTab" role="tabpanel">

      <h5>æŸ¥è©¢çµæœ</h5>

      <div class="row">
        <div class="col-md-12">
         <pre id="jsonOutput" class="border p-2 bg-light" style="height:500px; overflow:auto;"></pre>
        </div>

       
      </div>

    </div>
	 

  </div>

</div>


<div class="modal fade" id="myModal">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h4 class="modal-title">é»é¸æ ¼å­è³‡è¨Š</h4>
      </div>

      <div class="modal-body">
        <p><b>æ¬„ä½ Indexï¼š</b> <span id="modalColIndex"></span></p>
        <p><b>æ¬„ä½åç¨±ï¼š</b> <span id="modalColName"></span></p>
        <p><b>æ¬„ä½å€¼ï¼š</b> <span id="modalCellValue"></span></p>
        <hr>
        <pre id="modalRowJson"></pre>
      </div>

    </div>
  </div>
</div>

<script>
let table;
let fields =[];
const allConfigs = [
  {
	  key: 'default',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		{ index: 0, name: 'ID', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
		{ index: 1, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'asc', condition: '', type: 'text' },
		{ index: 2, name: 'Department', searchEnabled: false, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown' },
		{ index: 3, name: 'HireDate', searchEnabled: true, displayEnabled: true, sort: 'desc', condition: '', type: 'text' },
	  ] 
  },
   {
	  key: 'simple',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		 { index: 0, name: 'ID', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
         { index: 1, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'asc', condition: '', type: 'text' },
	  ] 
  }, 
   {
	  key: 'hr',
	  extra: {
		header: {
		  enabled: false,
		  name: ''
		},
		body: {
		 enabled: false,
		  name: ''
		},
		popup: {
		  enabled: true,
		  name: ''
		}
	  },
	  fields: [
		   { index: 0, name: 'Name', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'text' },
          { index: 1, name: 'Department', searchEnabled: true, displayEnabled: true, sort: 'none', condition: '', type: 'dropdown' },
	  ] 
  } 
];


function loadConfig(key) {
    const cfg = allConfigs.find(x => x.key === key);
    if (!cfg) return;

    // å¥—ç”¨ extra
    $("#chkHeader").prop("checked", cfg.extra.header.enabled);
    $("#txtHeaderName").val(cfg.extra.header.name);

    $("#chkBody").prop("checked", cfg.extra.body.enabled);
    $("#txtBodyName").val(cfg.extra.body.name);

    $("#chkPopup").prop("checked", cfg.extra.popup.enabled);
    $("#txtPopupName").val(cfg.extra.popup.name);

    // å¥—ç”¨ fields
    fields = cfg.fields.map(f => ({ ...f }));

    renderFields();
    syncDataTableOrder();
}







$("#configSelector").change(function () {
  const key = $(this).val(); 
  loadConfig(key) 
});


$("#chkPopup, #txtPopupName").on("change input", function () {
    updateJSON();
});
 

// æ›´æ–° JSON
function updateJSON() {

const key = $("#configSelector").val(); 
 const extraSetting = {
    header: {
      enabled: $("#chkHeader").prop("checked"),
      name: $("#txtHeaderName").val()
    },
    body: {
      enabled: $("#chkBody").prop("checked"),
      name: $("#txtBodyName").val()
    },
    popup: {
      enabled: $("#chkPopup").prop("checked"),
      name: $("#txtPopupName").val()
    }
  };
  const fieldSetting = fields.map(f => ({
    index: f.index,
    name: f.name,
    type: f.type,
    searchEnabled: f.searchEnabled,
    displayEnabled: f.displayEnabled,
    sort: f.sort,
    condition: f.condition
  }));
  const singleConfig  = {
    key: key,               // â† ä½ è¦çš„è­˜åˆ¥ key
    extra: extraSetting,
    fields: fieldSetting
  };


const idx = allConfigs.findIndex(x => x.key === key);

if (idx >= 0) {
    allConfigs[idx] = singleConfig;  // è¦†è“‹
} else {
    allConfigs.push(singleConfig);   // æ–°å¢
}

  $("#jsonOutput").text(JSON.stringify(singleConfig, null, 2));
}
function getSortIcon(sort) {
  if (sort === "asc") return '<i class="fa fa-arrow-up"></i>';
  if (sort === "desc") return '<i class="fa fa-arrow-down"></i>';
  return '<i class="fa fa-minus"></i>';
}

// âœ… ç”¢ç”Ÿæ¬„ä½åˆ—
function renderFields() {
  const $tb = $("#fieldTable tbody");
  $tb.empty();
  fields.forEach((f, i) => {
    $tb.append(`
      <tr data-index="${i}">
        <td class="text-center cursor-move"><i class="fa fa-bars"></i></td>
        <td class="editable">${f.name}</td>
	    <td>
          <select class="form-select form-select-sm field-type">
            <option value="text" ${f.type ==='text'? "selected" : ""}>Text</option>
            <option value="dropdown" ${f.type ==='dropdown'? "selected" : ""}>Dropdown</option>
            <option value="checkbox" ${f.type ==='checkbox'? "selected" : ""}>Checkbox</option>
          </select>
        </td>
       <td class="text-center">
          <input type="checkbox" class="form-check-input searchChk" ${f.searchEnabled?"checked":""}>
        </td>
        <td class="text-center">
          <input type="checkbox" class="form-check-input displayChk" ${f.displayEnabled?"checked":""}>
        </td>
        <td class="text-center">
          <button class="btn btn-outline-secondary btn-sm sortBtn" data-sort="${f.sort}">
            ${getSortIcon(f.sort)}
          </button>
        </td>
        <td><input type="text" class="form-control form-control-sm condInput" value="${f.condition}"></td>
        <td class="text-center">
          <button class="btn btn-outline-danger btn-sm delBtn"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `);
  });
  updateJSON();
}

// âœ… é›™æ“Šç·¨è¼¯æ¬„ä½åç¨±
$(document).on("dblclick", ".editable", function() {
  const $td = $(this);
  const oldText = $td.text().trim();
  $td.html(`<input type="text" class="form-control form-control-sm editInput" value="${oldText}"/>`);
  $td.find("input").focus().select();
});

// âœ… ç·¨è¼¯çµæŸï¼ˆé˜²é‡åèˆ‡ç©ºå€¼ï¼‰
$(document).on("blur", ".editInput", function() {
  const $input = $(this);
  const newText = $input.val().trim();
  const $td = $input.closest("td");
  const idx = $td.closest("tr").data("index");
  const oldText = fields[idx].name;

  // æª¢æŸ¥é‡åæˆ–ç©ºå€¼
  const exists = fields.some((f, i) => i !== idx && f.name.toLowerCase() === newText.toLowerCase());
  if (!newText) {
    alert("æ¬„ä½åç¨±ä¸å¯ç‚ºç©ºï¼");
    $td.text(oldText);
  } else if (exists) {
    alert(`æ¬„ä½åç¨±ã€Œ${newText}ã€å·²å­˜åœ¨ï¼`);
    $td.text(oldText);
  } else {
    fields[idx].name = newText;
    $td.text(newText);
  }
  
  updateJSON();
})

$(document).on("keypress", ".editInput", function(e) {
  if (e.which === 13) $(this).blur();
});

// å‹æ…‹è®Šæ›´
$(document).on("change", ".field-type", function(){
  const idx = $(this).closest("tr").data("index");
  fields[idx].type = $(this).val();
  updateJSON();
});
// âœ… æ’åºåˆ‡æ›
$(document).on("click", ".sortBtn", function() {
  const $btn = $(this);
  const idx = $btn.closest("tr").data("index");
  const cur = fields[idx].sort;
  const next = cur === "none" ? "asc" : cur === "asc" ? "desc" : "none";
  fields[idx].sort = next;
  $btn.html(getSortIcon(next)).attr("data-sort", next);
  updateJSON();
});

// æœå°‹å•Ÿç”¨
$(document).on("click", ".searchChk", function(){
  const idx = $(this).closest("tr").data("index");
  fields[idx].searchEnabled = this.checked;
  updateJSON();
});

// é¡¯ç¤ºå•Ÿç”¨
$(document).on("click", ".displayChk", function(){
  const idx = $(this).closest("tr").data("index");
  fields[idx].displayEnabled = this.checked;
  updateJSON();
});


// âœ… æ¢ä»¶è¼¸å…¥
$(document).on("input", ".condInput", function() {
  const idx = $(this).closest("tr").data("index");
  fields[idx].condition = $(this).val();
  updateJSON();
});

// âœ… åˆªé™¤åˆ—
$(document).on("click", ".delBtn", function() {
  const idx = $(this).closest("tr").data("index");
  fields.splice(idx, 1);
  // æ›´æ–° index
  fields.forEach((f, i) => f.index = i);
  renderFields();
  syncDataTableOrder();
});

// âœ… æ–°å¢æ¬„ä½
$("#btnAdd").click(() => {
  let idx = 1;
  let newName;
  do {
    newName = "NewField" + idx++;
  } while (fields.some(f => f.name === newName));

  fields.push({ index: fields.length, name: newName, searchEnabled: true, displayEnabled: true, sort: "none", condition: "", type: "text" });
  renderFields();
  syncDataTableOrder();
});
// âœ… æ‹–æ›³æ’åºï¼ˆä¿æŒè³‡æ–™æ­£ç¢ºï¼‰
new Sortable(document.querySelector("#fieldTable tbody"), {
  handle: ".cursor-move",
  animation: 150,
  onEnd: e => {
    const moved = fields.splice(e.oldIndex, 1)[0];
    fields.splice(e.newIndex, 0, moved);
     // æ›´æ–° index
    fields.forEach((f, i) => f.index = i);
    renderFields();
    syncDataTableOrder(); // ğŸ”¹ åŒæ­¥ DataTable æ¬„ä½é †åº
  }
});

// ğŸ§© æ¨¡æ“¬å¾Œç«¯æŸ¥è©¢
function fakeFetchData(filter) {
  const allData = [
    { ID: 1, Name: "John", Department: "IT", HireDate: "2020-05-01" },
    { ID: 2, Name: "Mary", Department: "HR", HireDate: "2019-07-15" },
    { ID: 3, Name: "Alex", Department: "Sales", HireDate: "2021-03-20" },
    { ID: 4, Name: "Lisa", Department: "IT", HireDate: "2022-01-05" },
  ];

  let result = allData;
  filter.forEach(f => {
    if (f.condition) result = result.filter(x => String(x[f.name]).includes(f.condition));
  });

  const sortField = filter.find(f => f.sort !== "none");
  if (sortField) {
    result.sort((a, b) =>
      sortField.sort === "asc"
        ? a[sortField.name] > b[sortField.name] ? 1 : -1
        : a[sortField.name] < b[sortField.name] ? 1 : -1
    );
  }

  return result;
}

// âœ… å¥—ç”¨è¨­å®šï¼ˆæŸ¥è©¢ + DataTable é¡¯ç¤ºï¼‰
$("#btnApply").click(() => {
  const filterFields = fields.filter(f=>f.searchEnabled);
  const displayFields = fields.filter(f=>f.displayEnabled);
  const filter = filterFields.map(f => ({
    name: f.name,
    condition: f.condition,
    sort: f.sort
  }));

  // æ¨¡æ“¬æŸ¥è©¢çµæœ
  const data = fakeFetchData(filter);

  // âœ… ä¿è­‰æ¯ç­†è³‡æ–™éƒ½å«æœ‰ç›®å‰å•Ÿç”¨çš„æ¬„ä½ï¼ˆå³ä½¿ fakeFetchData æ²’æœ‰ï¼‰
  data.forEach(row => {
    displayFields.forEach(f => {
      if (!(f.name in row)) row[f.name] = ""; // åŠ å…¥ç©ºæ¬„ä½
    });
  });

  const columns = displayFields.map(f => ({ title: f.name, data: f.name }));

  // DataTable order: index + asc/desc
  const order = [];
  displayFields.forEach((f, i) => {
    if (f.sort !== "none") {
      order.push([i, f.sort]); // [columnIndex, 'asc'|'desc']
    }
  }); 
  
  if ($.fn.DataTable.isDataTable("#dataTable")) {
    table.clear().destroy();
    $("#dataTable").empty();
  }

  table = $("#dataTable").DataTable({
    data: data,
    columns: columns,
    order: order,       // ğŸ”¹ å¥—ç”¨æ’åº
    pageLength: 5,
    responsive: true,
  });

// åœ¨ä½  new DataTable(...) ä¹‹å¾ŒåŠ å…¥ï¼š
//$("#dataTable tbody").off("click.popupRow").on("click.popupRow", "tr", function () {
  // å¦‚æœé‚„æ²’å•Ÿç”¨ popupï¼Œç›´æ¥ return
//  if (!$("#chkPopup").is(":checked")) return;

  // å–å¾— dataï¼ˆDataTable row ç‰©ä»¶ï¼‰
  //const row = table.row(this);//
  //if (!row) return;
  //const rowData = row.data();

  // å‘¼å«æ‰“é–‹ modal çš„å‡½å¼
  //openPopupWithRowData(rowData);
//});




$('#dataTable tbody').on('click', 'td', function () {

    const table = $('#dataTable').DataTable();

    // âœ” å–å¾—æ¬„ä½ index
    const cellIndex = table.cell(this).index().column;

    // âœ” å–å¾—æ¬„ä½åç¨±ï¼ˆå¦‚æœ columns è£¡é¢çš„ data æœ‰å¯«ï¼‰
    const colName = table.settings()[0].aoColumns[cellIndex].data;

    // âœ” å–å¾—æ•´åˆ—è³‡æ–™ï¼ˆç‰©ä»¶ or é™£åˆ—ï¼‰
    const rowData = table.row($(this).closest('tr')).data();

    // âœ” å–å¾—æ­¤æ ¼å­çš„å€¼
    const cellValue = table.cell(this).data();

    // é–‹å•Ÿ modal
    openPopupRowCol(rowData, cellIndex, colName, cellValue);
});

function openPopupRowCol(rowData, colName, cellValue) {

    $.ajax({
        url: "/YourController/LoadPopup",
        type: "POST",
        data: {
            rowJson: JSON.stringify(rowData),
            columnName: colName,
            cellValue: cellValue
        },
        success: function (html) {

            // æŠŠéƒ¨åˆ†è¦–åœ–æ”¾åˆ° Modal Content
            $("#myModalBody").html(html);

            $("#myModal").modal("show");
        }
    });
}

[HttpPost]
public ActionResult LoadPopup(string rowJson, string columnName, string cellValue)
{
    var rowData = Newtonsoft.Json.JsonConvert.DeserializeObject<Dictionary<string, object>>(rowJson);

    var model = new PopupViewModel
    {
        RowData = rowData,
        ColumnName = columnName,
        CellValue = cellValue
    };

    return PartialView("_PopupDetail", model);
}
@model YourNamespace.PopupViewModel

<div>
    <h4>æ¬„ä½ï¼š@Model.ColumnName</h4>

    <p>å€¼ï¼š@Model.CellValue</p>

    <h5>æ•´åˆ—è³‡æ–™ï¼š</h5>
    <pre>@Newtonsoft.Json.JsonConvert.SerializeObject(Model.RowData, Newtonsoft.Json.Formatting.Indented)</pre>

    <!-- ä½ ä¹Ÿå¯ä»¥æ”¾ä»»ä½•ä½ è¦çš„ MVC æ§ä»¶ -->
    <input type="text" value="@Model.CellValue" class="form-control" />
</div>


<div class="modal fade" id="myModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h4 class="modal-title">è³‡æ–™è©³æƒ…</h4>
      </div>

      <div class="modal-body" id="myModalBody">
        <!-- éƒ¨åˆ†è¦–åœ–æœƒè¢«è¼‰å…¥åˆ°é€™è£¡ -->
      </div>

    </div>
  </div>
</div>

function savePopup() {
    const newValue = $("#popupValue").val();

    const rowIdx = $("#myModal").data("rowIdx");
    const colIdx = $("#myModal").data("colIdx");

    const table = $("#dataTable").DataTable();

    table.cell(rowIdx, colIdx).data(newValue).draw(false);

    $("#myModal").modal("hide");
}

function savePopup() {
    const id = $("#popup-id").val();   // ä¾†è‡ª partial hidden field
    const name = $("#popup-name").val();
    const status = $("#popup-status").val();

    $.post("/YourController/Save", {
        id,
        name,
        status
    }, function (res) {

        if (res.success) {

            // 1. æ‰¾åˆ°çœŸæ­£çš„é‚£ç­†è³‡æ–™
            const table = $("#myTable").DataTable();
            const row = table
                .rows()
                .indexes()
                .filter((idx) => table.row(idx).data().Id == id);

            if (row.length > 0) {
                // 2. æ›´æ–° DataTable è©²è¡Œè³‡æ–™
                const data = table.row(row[0]).data();
                data.Name = name;
                data.Status = status;

                table.row(row[0]).data(data).draw(false);
            }

            $("#popupModal").modal("hide");
        }
    });
}







  
  updateJSON();
});

function openPopupRowCol(rowData, colIndex, colName, cellValue) {

    $("#modalRowJson").text(JSON.stringify(rowData, null, 2));
    $("#modalColIndex").text(colIndex);
    $("#modalColName").text(colName);
    $("#modalCellValue").text(cellValue);

    $("#myModal").modal("show");
}

  function safeId(name){
  return 'popup_' + String(name).replace(/\W+/g, '_');
}
// ============================================
// â­ ä¾æ¬„ä½è¨­å®šï¼Œè‡ªå‹•ç”¢ç”Ÿå½ˆè·³è¦–çª—å…§å®¹
// ============================================
function openPopupWithRowData(rowData){
  // æ¸…ç©º
  $("#popupModalBody").empty();

  // ä¾ fields é™£åˆ—ç”¢ç”Ÿ UIï¼ˆä¿ç•™æ¬„ä½é †åºï¼‰
  fields.forEach(f => {
    // åªè™•ç† displayEnabled æ¬„ä½æˆ–ä½ æƒ³è¦å…¨éƒ¨æ¬„ä½éƒ½é¡¯ç¤ºå¯æ”¹é€™è£¡
    // if (!f.displayEnabled) return;

    const colName = f.name;
    const id = safeId(colName);
    const value = rowData && (colName in rowData) ? rowData[colName] : "";

    let html = `<div class="mb-3">
                  <label class="form-label">${colName}</label>`;

    if (f.type === 'dropdown'){
      // é€™è£¡ç¤ºç¯„ç°¡å–®é¸é …ï¼›è‹¥æƒ³ç”¨å‹•æ…‹é¸é …å¯å¾ f.options å–å€¼
      html += `<select class="form-select" id="${id}">
                 <option value="">è«‹é¸æ“‡</option>
                 <option value="A" ${value === 'A' ? 'selected' : ''}>A</option>
                 <option value="B" ${value === 'B' ? 'selected' : ''}>B</option>
               </select>`;
    } else if (f.type === 'checkbox'){
      html += `<div class="form-check">
                 <input class="form-check-input" type="checkbox" id="${id}" ${value ? 'checked' : ''}>
               </div>`;
    } else if (f.type === 'number'){
      html += `<input type="number" class="form-control" id="${id}" value="${value}">`;
    } else {
      // default -> text
      // escape value roughly to avoid breaking attributes
      const escaped = String(value).replace(/"/g, '&quot;');
      html += `<input type="text" class="form-control" id="${id}" value="${escaped}">`;
    }

    html += `</div>`;
    $("#popupModalBody").append(html);
  });

  // modal æ¨™é¡Œ
  const title = $("#txtPopupName").val() || "å½ˆè·³è¦–çª—";
  $("#popupModalTitle").text(title);

  // show modal
  const modalEl = document.getElementById('popupModal');
  const modal = new bootstrap.Modal(modalEl);
  modal.show();
}


// --- åŒæ­¥ DataTable æ¬„ä½é †åº â†’ JSON ---
function syncDataTableOrder(){
$("#btnApply").click();
}

// åˆå§‹åŒ–
loadConfig('default')
renderFields();
updateJSON();
$("#chkHeader, #chkBody, #chkPopup").change(updateJSON);
$("#txtHeaderName, #txtBodyName, #txtPopupName").on("input", updateJSON);
</script>
