using System;
using System.Web;
using System.Net;
using System.Security.Principal;

namespace MyApp.Security
{
    public class CasAuthenticationModule : IHttpModule
    {
        private const string CasLoginUrl = "https://cas.example.com/cas/login";
        private const string CasValidateUrl = "https://cas.example.com/cas/serviceValidate";
        private const string ServiceUrl = "https://localhost/MyApp/"; // ä½ çš„æ‡‰ç”¨ç¨‹å¼ URL

        public void Init(HttpApplication context)
        {
            context.AuthenticateRequest += new EventHandler(OnAuthenticateRequest);
        }

        private void OnAuthenticateRequest(object sender, EventArgs e)
        {
            HttpApplication app = (HttpApplication)sender;
            HttpContext ctx = app.Context;

            // å¦‚æœå·²ç¶“ç™»å…¥éï¼Œè·³é
            if (ctx.User != null && ctx.User.Identity.IsAuthenticated)
                return;

            string ticket = ctx.Request.QueryString["ticket"];

            if (string.IsNullOrEmpty(ticket))
            {
                // æ²’æœ‰ ticket â†’ å°å‘ CAS ç™»å…¥
                string loginUrl = $"{CasLoginUrl}?service={HttpUtility.UrlEncode(ServiceUrl)}";
                ctx.Response.Redirect(loginUrl, true);
            }
            else
            {
                // é©—è­‰ ticket
                string validateUrl = $"{CasValidateUrl}?ticket={ticket}&service={HttpUtility.UrlEncode(ServiceUrl)}";
                string responseXml;

                using (WebClient client = new WebClient())
                {
                    responseXml = client.DownloadString(validateUrl);
                }

                if (responseXml.Contains("<cas:authenticationSuccess>"))
                {
                    string userId = ExtractCasUser(responseXml);

                    // ğŸ”¹ é€™è£¡å‘¼å«ä½ çš„ User Repositoryï¼ŒæŠŠ userId è½‰æ›æˆ User Entity
                    var userEntity = UserRepository.GetUserByAccount(userId);

                    if (userEntity != null)
                    {
                        // å»ºç«‹è‡ªè¨‚ Identity
                        var identity = new GenericIdentity(userEntity.Account, "CAS");
                        var principal = new GenericPrincipal(identity, userEntity.Roles);

                        ctx.User = principal;
                        ctx.Items["CurrentUser"] = userEntity;  // å­˜åœ¨ Contextï¼Œå¾ŒçºŒå¯ç›´æ¥å–
                        ctx.Session["User"] = userEntity;       // ä¹Ÿå¯ä»¥å­˜é€² Session
                    }
                    else
                    {
                        ctx.Response.StatusCode = 403;
                        ctx.Response.Write("ä½¿ç”¨è€…ä¸å­˜åœ¨æ–¼ç³»çµ±");
                        ctx.Response.End();
                    }
                }
                else
                {
                    ctx.Response.StatusCode = 403;
                    ctx.Response.Write("CAS Authentication Failed");
                    ctx.Response.End();
                }
            }
        }

        private string ExtractCasUser(string xml)
        {
            int start = xml.IndexOf("<cas:user>") + "<cas:user>".Length;
            int end = xml.IndexOf("</cas:user>");
            return xml.Substring(start, end - start);
        }

        public void Dispose() { }
    }

    // ğŸ”¹ æ¨¡æ“¬è³‡æ–™åº«çš„ UserRepository
    public static class UserRepository
    {
        public static UserEntity GetUserByAccount(string account)
        {
            // é€™è£¡å¯ä»¥æ”¹æˆæŸ¥ DB / API
            if (account == "johndoe")
            {
                return new UserEntity
                {
                    Account = "johndoe",
                    DisplayName = "ç´„ç¿°Â·æœ",
                    Roles = new[] { "Admin", "User" },
                    Department = "IT"
                };
            }
            return null;
        }
    }

    // ğŸ”¹ ä½¿ç”¨è€…å¯¦é«”
    public class UserEntity
    {
        public string Account { get; set; }
        public string DisplayName { get; set; }
        public string[] Roles { get; set; }
        public string Department { get; set; }
    }
}










public ActionResult CasCallback(string ticket)
{
    string serviceUrl = "https://localhost/MyApp/Login/CasCallback";
    string validateUrl = $"https://cas.example.com/cas/serviceValidate?ticket={ticket}&service={HttpUtility.UrlEncode(serviceUrl)}";

    string responseXml;
    using (var client = new WebClient())
    {
        responseXml = client.DownloadString(validateUrl);
    }

    if (responseXml.Contains("<cas:authenticationSuccess>"))
    {
        string userId = ExtractCasUser(responseXml);

        // ğŸ”¹ è‡ªè¡ŒæŸ¥ç³»çµ±è³‡æ–™åº«ï¼Œè½‰æ›æˆ UserEntity
        var user = UserRepository.GetUserByAccount(userId);

        if (user != null)
        {
            // å­˜å…¥ Sessionï¼Œç•¶ä½œå·²ç™»å…¥
            Session["User"] = user;
            return RedirectToAction("Index", "Home");
        }
        else
        {
            return Content("ä½¿ç”¨è€…ä¸å­˜åœ¨æ–¼ç³»çµ±");
        }
    }
    else
    {
        return Content("CAS é©—è­‰å¤±æ•—");
    }
}

private string ExtractCasUser(string xml)
{
    int start = xml.IndexOf("<cas:user>") + "<cas:user>".Length;
    int end = xml.IndexOf("</cas:user>");
    return xml.Substring(start, end - start);
}

