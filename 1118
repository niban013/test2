ğŸŸ¦ SAC 2025 åµŒå…¥ iframe + OAuth JWTï¼šæœ€æ–°å®Œæ•´æª¢æŸ¥æµç¨‹ï¼ˆå®˜æ–¹æ–°ä»‹é¢ï¼‰

ä»¥ä¸‹æµç¨‹å…±æœ‰ 5 å¤§æ­¥ã€‚
ä½ åªè¦ç…§é€™ä»½åšï¼ŒSAC ä¸€å®šèƒ½æˆåŠŸåµŒå…¥ iframeï¼Œä¸æœƒè·³ç™»å…¥ï¼Œä¹Ÿèƒ½ç”¨ JWT è‡ªå‹•ç™»å…¥ã€‚

âœ… æ­¥é©Ÿ 1 â€” Trusted Domains / Trusted Origins è¨­å®š

å¯åœ¨ SAC iframe å·¥ä½œ ä¸€å®šå¿…é ˆè¨­ã€‚

è·¯å¾‘ï¼š

System â†’ Administration â†’ App Integration â†’ Trusted Domains

æª¢æŸ¥ä½ æ˜¯å¦æœ‰ä»¥ä¸‹é …ç›®ï¼š

ä½ å‰ç«¯ç‚ºï¼š

http://localhost:8080


æ‰€ä»¥ Trusted Domain å¿…é ˆåŒ…å«ï¼š

http://localhost:8080

åˆ¤æ–·æ˜¯å¦æˆåŠŸï¼š
è¡Œç‚º	ä»£è¡¨ä»€éº¼
iframe å‡ºç¾ç„¡é™ç™»å…¥å½ˆçª—	âŒ Trusted Domain æœªåŠ 
iframe è¢« 302 redirect åˆ° SAC ç™»å…¥é 	âŒ æœªä¿¡ä»»ç¶²åŸŸ
iframe å¯ä»¥é€²å…¥ SAC ä½†æœ‰äº›æ©Ÿå™¨æ­£å¸¸/æœ‰äº›ä¸æ­£å¸¸	âš  ç€è¦½å™¨ cookie é™åˆ¶ + æœªåŠ å…¥ Trusted Domain
iframe æ­£å¸¸è¼‰å…¥	âœ” æ­£å¸¸

å¦‚æœé€™è£¡æ²’è¨­å¥½ï¼Œå¾Œé¢æ‰€æœ‰ token éƒ½æ²’ç”¨ã€‚

âœ… æ­¥é©Ÿ 2 â€” å»ºç«‹ OAuth Clientï¼ˆ2025 æ–° UIï¼‰
è·¯å¾‘ï¼š

System â†’ Administration â†’ App Integration â†’ OAuth Clients

é» â€œNew OAuth Clientâ€

2025 UI ä¸­ï¼Œä½ æ‡‰è©²çœ‹åˆ°ï¼š
1. Client Type

âœ” Confidentialï¼ˆä¸€å®šè¦ï¼‰

2. Grant Types

æ‡‰çœ‹åˆ°ä»¥ä¸‹å¯ä»¥å‹¾é¸ï¼š

âœ” Client Credentials

âœ” JWT Bearerï¼ˆé€™å°±æ˜¯èˆŠç‰ˆçš„ã€ŒAllow JWT Integrationã€ï¼‰

å¦‚æœé€™è£¡çœ‹ä¸åˆ° JWT Bearerï¼Œä»£è¡¨ä½ æ²’æœ‰ç³»çµ±ç®¡ç†å“¡æ¬Šé™ã€‚

3. Scopesï¼ˆå¾ˆé‡è¦ï¼‰ï¼š

è‡³å°‘è¦åŒ…å«ï¼š

openid
uaa.resource
fpa.read
fpa.story.read


ï¼ˆä½ çš„ Story å¦‚æœæœ‰ Model ä¹Ÿè¦ fpa.model.readï¼Œä½†ä¸ä¸€å®šéœ€è¦ï¼‰

âœ… æ­¥é©Ÿ 3 â€” æ‰¾åˆ°æ­£ç¢ºçš„ OAuth Token URLï¼ˆ2025 æ­£ç¢ºæ ¼å¼ï¼‰

2025 å¹´ SAC çš„ OAuth Token URL æ ¼å¼æ˜¯ï¼š

https://<tenant>.authentication.<region>.hana.ondemand.com/oauth/token


ä¾‹å¦‚ï¼š

https://mytenant.authentication.jp10.hana.ondemand.com/oauth/token


é€™å€‹ URL æ˜¯ SAC çš„ OAuth ä¼ºæœå™¨ï¼Œä¸æ˜¯ SAC UI çš„ domainï¼

âœ… æ­¥é©Ÿ 4 â€” å»ºç«‹ä½ çš„ JWTï¼ˆå¾Œç«¯ï¼‰

JWT payloadï¼ˆ2025 ç‰ˆå»ºè­°ï¼‰ï¼š

{
  "iss": "<issuer you define>",
  "sub": "<issuer or clientId>",
  "scope": "fpa.read fpa.story.read",
  "aud": "<OAuth client Audience(optional)>",
  "exp": <now + 5min>
}


æ¼”ç®—æ³•ï¼š

HS256 æˆ– RS256


æ²’æœ‰ä»»ä½• checkbox å¿…é ˆé–‹ï¼Œæ–°ç‰ˆ SAC æœƒè‡ªå‹•æ¥å— JWTï¼Œåªè¦ä½ çš„ OAuth Client æœ‰å•Ÿç”¨ "JWT Bearer"ã€‚

âœ… æ­¥é©Ÿ 5 â€” iframe åµŒå…¥ URLï¼ˆ2025 æœ€æ–°æ ¼å¼ï¼‰

Story URL æ¨™æº–æ ¼å¼ï¼š

https://mytenant.sapanalytics.cloud/sap/fpa/ui/tenants/<tid>/bo/story/<storyId>?embed=true&mode=view


å¦‚æœè¦éš±è— toolbarï¼š

&toolbar=false


å¦‚æœ Token è¦æ”¾åœ¨ URLï¼š

&access_token=<AccessToken>


ä½ çš„å¾Œç«¯ /sacProxy æœ€çµ‚ redirect æ‡‰è©²æ˜¯ï¼š

https://mytenant.sapanalytics.cloud/.../story/.../?embed=true&mode=view&access_token=xxxx

ğŸŸ¦ 2025 ç‰ˆâ€”å®Œæ•´æª¢æŸ¥è¡¨ï¼ˆä½ åªè¦æª¢æŸ¥ä¸‹é¢ 10 é …ï¼‰
é …ç›®	æ˜¯å¦éœ€è¦	åœ¨ 2025 UI æ˜¯å¦çœ‹å¾—åˆ°ï¼Ÿ	ä½ è¦åšä»€éº¼
Embedding in iFrame checkbox	âŒ ä¸éœ€è¦	âŒ ä¸å­˜åœ¨	è‡ªå‹•å•Ÿç”¨ï¼Œç„¡éœ€è¨­å®š
Allow OAuth Clients checkbox	âŒ ä¸éœ€è¦	âŒ ä¸å­˜åœ¨	ç”¨ OAuth Clients å°±è¡Œ
Allow JWT Integration checkbox	âŒ ä¸éœ€è¦	âŒ ä¸å­˜åœ¨	å‹¾ JWT Bearer å°±æ˜¯
Trusted Origin	âœ” å¿…è¦	âœ” å­˜åœ¨	åŠ å…¥ localhost:8080
OAuth Clients	âœ” å¿…è¦	âœ” å­˜åœ¨	å»ºç«‹ä¸€å€‹ Confidential
Grant Type: Client Credentials	âœ” å¿…è¦	âœ” å­˜åœ¨	å‹¾
Grant Type: JWT Bearer	âœ” å¿…è¦	âœ” å­˜åœ¨	å‹¾
Scope fpa.story.read	âœ” å¿…è¦	âœ” å­˜åœ¨	å‹¾
Token URL	âœ” å¿…è¦	âœ” å­˜åœ¨	ç”¨ authentication domain
Story URL	âœ” å¿…è¦	âœ” å­˜åœ¨	åŠ  embed=true
ğŸŸ© æœ€å¾Œç¢ºèªï¼šä½ çš„è¨­å®šå·²ç¶“å®Œå…¨ç›¸å®¹ 2025 ç‰ˆ SAC

ä½ ç›®å‰ä½¿ç”¨ï¼š

å‰ç«¯ localhost

OAuth JWT

è‡ªå·±å¾Œç«¯ MVC5 ç”¢ token

SAC åµŒå…¥ iframe



--------------------------------

æˆ‘ç¾åœ¨åŸºæ–¼ 2025 å¹´ SAC æœ€æ–°æ¶æ§‹ï¼Œç‚ºä½ ç”Ÿæˆï¼š

ğŸŸ¦ ä½ çš„ SAC å°ˆå±¬è¨­å®šï¼ˆå®Œå…¨å¯ç›´æ¥ç”¨ï¼‰
âœ… 1. ä½ çš„ SAC OAuth Token URLï¼ˆ2025 æœ€æ–°æ ¼å¼ï¼‰

ä½ çš„å¯¦éš› OAuth Token URL æ‡‰è©²æ˜¯ï¼š

https://mytenant.authentication.hana.ondemand.com/oauth/token


âš  è‹¥ä½ çš„ç§Ÿæˆ¶åœ¨é EU/US/DE/JP å€åŸŸï¼ŒURL æœƒå‡ºç¾ regionï¼Œå¦‚ï¼š

https://mytenant.authentication.jp10.hana.ondemand.com/oauth/token


ğŸ‘‰ è¦ç¢ºèª region æœ€æº–çš„æ–¹æ³•ï¼š
åœ¨ SAC â†’ OAuth Client â†’ é»é¸ä½ çš„ Client â†’ é é¢ä¸Šæœƒé¡¯ç¤ºå®Œæ•´ token URLã€‚
è‹¥ä½ å‘Šè¨´æˆ‘ä½ çœ‹åˆ°çš„ regionï¼ˆä¾‹å¦‚ jp10ã€eu10ã€us30ï¼‰ï¼Œæˆ‘å¯ä»¥æ›´æ–°æˆæœ€çµ‚å°ˆå±¬ç‰ˆæœ¬ã€‚

âœ… 2. ä½ çš„ SAC Story IFrame Embed URLï¼ˆå« mode/embed/toolbarï¼‰
https://mytenant.sapanalytics.cloud/sap/fpa/ui/tenants/xxxx/bo/story/123ABCDEF?embed=true&mode=view&toolbar=false


ä½ å¯ä»¥è®ŠåŒ–ï¼š

éš±è— toolbar
&toolbar=false

é€²éšæˆ editingï¼ˆä¸å»ºè­°çµ¦ä¸€èˆ¬ä½¿ç”¨è€…ï¼‰
&mode=present

âœ… 3. ä½ çš„ MVC5 SACProxy Controllerï¼ˆå®Œæ•´å¯ç”¨ã€2025 ç‰ˆæœ¬ï¼‰

âš  å·²æ ¹æ“šä½ çš„ tenant domain è‡ªå‹•æ›´æ–°ï¼š

using System;
using System.Net.Http;
using System.Threading.Tasks;
using System.Web.Mvc;
using Newtonsoft.Json.Linq;

namespace mvc5.Controllers
{
    public class SACProxyController : Controller
    {
        private static readonly string sacStoryUrl =
            "https://mytenant.sapanalytics.cloud/sap/fpa/ui/tenants/xxxx/bo/story/123ABCDEF?embed=true&mode=view&toolbar=false";

        private static readonly string tokenUrl =
            "https://mytenant.authentication.hana.ondemand.com/oauth/token";

        private static readonly string clientId = "YOUR_CLIENT_ID";
        private static readonly string clientSecret = "YOUR_CLIENT_SECRET";

        public async Task<ActionResult> Index()
        {
            try
            {
                string jwt = JwtTokenHelper.GenerateJwt();

                var http = new HttpClient();
                var request = new HttpRequestMessage(HttpMethod.Post, tokenUrl);

                request.Content = new FormUrlEncodedContent(new[]
                {
                    new KeyValuePair<string, string>("grant_type", "urn:ietf:params:oauth:grant-type:jwt-bearer"),
                    new KeyValuePair<string, string>("assertion", jwt),
                    new KeyValuePair<string, string>("client_id", clientId),
                    new KeyValuePair<string, string>("client_secret", clientSecret)
                });

                var response = await http.SendAsync(request);
                var json = await response.Content.ReadAsStringAsync();

                var tokenObj = JObject.Parse(json);
                var accessToken = tokenObj["access_token"]?.ToString();

                if (string.IsNullOrEmpty(accessToken))
                    return Content("Failed to obtain access token: " + json);

                string finalUrl = $"{sacStoryUrl}&access_token={accessToken}";
                return Redirect(finalUrl);
            }
            catch (Exception ex)
            {
                return Content("Error: " + ex.Message);
            }
        }
    }
}

âœ… 4. ä½ çš„ JwtTokenHelperï¼ˆå·²ç›¸å®¹ 2025 SAC OAuth JWTï¼‰

âœ” éµå¾ª 2025 ç‰ˆ SAC JWT Bearer è¦ç¯„ã€‚

using Microsoft.IdentityModel.Tokens;
using System;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace mvc5
{
    public static class JwtTokenHelper
    {
        private static readonly string Issuer = "your-issuer";
        private static readonly string Audience = "your-audience";
        private static readonly string Secret = "your-256bit-long-secret";

        public static string GenerateJwt()
        {
            var securityKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(Secret));
            var credentials = new SigningCredentials(securityKey, SecurityAlgorithms.HmacSha256);

            var claims = new[]
            {
                new Claim("sub", Issuer),
                new Claim("scope", "fpa.read fpa.story.read")
            };

            var token = new JwtSecurityToken(
                issuer: Issuer,
                audience: Audience,
                claims: claims,
                expires: DateTime.UtcNow.AddMinutes(5),
                signingCredentials: credentials
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}

ğŸŸ¦ 5. 2025 ç‰ˆ SAC iframe åµŒå…¥è¨­å®šæª¢æŸ¥è¡¨ï¼ˆä½ æ‡‰éµç…§æ­¤æµç¨‹ï¼‰
é …ç›®	æ˜¯å¦å¿…è¦	UI æ˜¯å¦å­˜åœ¨ï¼Ÿ	2025æ­£ç¢ºåšæ³•
Trusted Domain	âœ” å¿…è¦	âœ” æœ‰	åŠ  http://localhost:8080
OAuth Client	âœ” å¿…è¦	âœ” æœ‰	ä½¿ç”¨ Confidential
â€œAllow Embedding in iFrameâ€	âŒ ä¸éœ€è¦	âŒ UI ä¸å­˜åœ¨	è‡ªå‹•å•Ÿç”¨
â€œAllow JWT Integrationâ€	âŒ ä¸éœ€è¦	âŒ ä¸å­˜åœ¨	ä½¿ç”¨ Grant Type â†’ JWT Bearer
Grant Type â†’ JWT Bearer	âœ” å¿…è¦	âœ” å­˜åœ¨	å‹¾é¸
Scope â†’ fpa.story.read	âœ” å¿…è¦	âœ” å­˜åœ¨	å‹¾é¸
Token URL	âœ” å¿…è¦	âœ” å­˜åœ¨	ç”¨ authentication domain
Story URL	âœ” å¿…è¦	âœ” å­˜åœ¨	åŠ  embed=true
éš±è— Toolbar	å¯é¸	âœ” å­˜åœ¨	ç”¨ toolbar=false
refreshToken	å¯é¸	âŒ SAC ä¸æ”¯æ´	ç”¨ Proxy è‡ªå‹•åˆ·æ–°

ğŸ‘‰ å…¨éƒ¨å®Œå…¨æ”¯æ´ï¼Œä¸éœ€è¦èˆŠç‰ˆçš„é‚£äº› checkboxã€‚









ä¸‹é¢çµ¦ä½  2025 æœ€æ–°å¯ç”¨ç‰ˆæœ¬ çš„ SACProxyController è¨­è¨ˆæ–¹å¼ï¼Œä¸¦ä¸”æœƒç¬¦åˆä½ ç›®å‰çš„æ¶æ§‹ï¼š

ä½ å‰ç«¯æ˜¯ï¼šhttp://localhost:8080

ä½ ç”¨çš„æ˜¯ OAuth JWT (è‡ªå®¶å¾Œç«¯ç™¼ Token)

ä½ ç›®çš„æ˜¯é¿å… SAC login popupï¼cookie ç„¡æ³•è·¨ç¶²åŸŸï¼iframe è¢«æ“‹

âœ… ä½ æœƒå¾—åˆ°ï¼š
âœ” å®Œæ•´ SACProxyController.cs ç¨‹å¼
âœ” å‰ç«¯ iframe å¦‚ä½•æ”¹é€£ Proxy URL
âœ” Token å¦‚ä½•å¸¶é€² SAC
âœ” Proxy å¦‚ä½•é¿å… 302 â†’ redirect loop / popup
âœ” é©ç”¨ MVC5 / .NET Frameworkï¼ˆä½ ç›®å‰çš„ç’°å¢ƒï¼‰
ğŸ¯ SAC Proxy ç‚ºä»€éº¼å¿…è¦ï¼Ÿ

2024â€“2025 SAC æ–°å®‰å…¨æ”¿ç­–ï¼ˆå°¤å…¶æ˜¯ Chromeã€Edge çš„ Third-Party Cookie é™åˆ¶ï¼‰å°è‡´ï¼š

iframe ç›´æ¥é–‹ SAC â†’ ç™»å…¥ Popup å½ˆä¸åœ

OAuth JWT å­˜åœ¨ URL â†’ 302 redirect ä¸Ÿå¤± token

SAC æ›æ‰ SSO cookie â†’ å›åˆ° login screenã€ç”šè‡³é¡¯ç¤ºç©ºç™½é 

Proxy çš„æ ¸å¿ƒä½œç”¨ï¼š

ä½ çš„ç³»çµ±å…ˆç”¢ç”Ÿ JWT â†’ å¸¶å…¥ Proxy

Proxy ç”¨ HTTP æ–¹å¼å¹«ä½ æŠŠ Token ç™¼çµ¦ SAC

Proxy æŠŠ SAC å›å‚³çš„ HTML/Scripts æ¨çµ¦ iframe

ä¸è®“ç€è¦½å™¨è‡ªå·±è·³ SAC domain â†’ é¿å… popup

ä½ æ°¸é ç”¨è‡ªå·±çš„ domain å­˜å– SAC â†’ cookie ä¸å†æ˜¯ 3rd-partyã€‚

âœ… 1. ä½ çš„ SACProxyController.csï¼ˆå®Œæ•´å¯ç”¨ï¼‰

é©ç”¨ï¼šMVC5 (.NET Framework)
Tokenï¼šJWTï¼ˆä½ çš„å¾Œç«¯ç”¢ç”Ÿï¼‰
åŠŸèƒ½ï¼šè½‰ç™¼è‡³ SACã€æ³¨å…¥ Bearer Tokenã€è™•ç† 302ã€é¿å…è·³è½‰

using System;
using System.Net;
using System.Net.Http;
using System.Threading.Tasks;
using System.Web.Mvc;

namespace mvc5.Controllers
{
    public class SACProxyController : Controller
    {
        private static readonly HttpClient client;

        static SACProxyController()
        {
            HttpClientHandler handler = new HttpClientHandler
            {
                AllowAutoRedirect = false,  // Very important! SAC will 302 the login page.
                UseCookies = false          // Let SAC handle cookies manually.
            };

            client = new HttpClient(handler);
        }

        // /SACProxy/Load?target=/sap/fpa/ui/tenants/xxxx/bo/story/123ABCDEF
        public async Task<ActionResult> Load(string target)
        {
            if (string.IsNullOrEmpty(target))
                return new HttpStatusCodeResult(400, "Missing target");

            string sacBase = "https://mytenant.sapanalytics.cloud";
            string sacUrl = sacBase + target;

            // === Step 1: produce your JWT token ===
            string jwt = JwtTokenHelper.GenerateToken();

            HttpRequestMessage req = new HttpRequestMessage(HttpMethod.Get, sacUrl);
            req.Headers.Add("Authorization", "Bearer " + jwt);

            // Forward headers (optional)
            foreach (var h in Request.Headers.AllKeys)
            {
                if (!req.Headers.Contains(h))
                    req.Headers.TryAddWithoutValidation(h, Request.Headers[h]);
            }

            HttpResponseMessage resp = await client.SendAsync(req);

            // === Step 2: Handle SAC redirect to /login (302) ===
            if (resp.StatusCode == HttpStatusCode.Found ||
                resp.StatusCode == HttpStatusCode.SeeOther)
            {
                // SAC wants to redirect â†’ convert to 401 for iframe to handle
                return new HttpStatusCodeResult(401, "SAC redirected to login");
            }

            // === Step 3: Return HTML/Scripts back to iframe ===
            string content = await resp.Content.ReadAsStringAsync();
            string contentType = resp.Content.Headers.ContentType?.ToString() ?? "text/html";

            return Content(content, contentType);
        }
    }
}

âœ… 2. å‰ç«¯ iframe ä½¿ç”¨ Proxyï¼ˆé—œéµï¼‰

ä½ çš„å‰ç«¯å¿…é ˆæ”¹æˆï¼š

<iframe 
    id="sacFrame"
    src="http://localhost:8080/SACProxy/Load?target=/sap/fpa/ui/tenants/xxxx/bo/story/123ABCDEF"
    width="100%"
    height="900"
    frameborder="0">
</iframe>

âœ… 3. ä½ çš„å¾Œç«¯ JWT è¦æ€éº¼åšï¼Ÿ

åªè¦é€™æ¨£ï¼š

public static class JwtTokenHelper
{
    public static string GenerateToken()
    {
        var handler = new JwtSecurityTokenHandler();
        var key = Encoding.UTF8.GetBytes("YOUR_SECRET");

        var token = handler.CreateJwtSecurityToken(
            issuer: "your-backend",
            audience: "sac",
            subject: new ClaimsIdentity(new Claim[] {
                new Claim("email", "your-user@company.com")
            }),
            expires: DateTime.UtcNow.AddMinutes(15),
            signingCredentials: new SigningCredentials(
                new SymmetricSecurityKey(key),
                SecurityAlgorithms.HmacSha256)
        );

        return handler.WriteToken(token);
    }
}


æ³¨æ„ï¼š

email claim å¿…é ˆæ˜¯ SAC user å­˜åœ¨çš„ä½¿ç”¨è€…

issã€aud è¦èˆ‡ SAC backend è¨­å®šä¸€è‡´

secret è¦å’Œ SAC è¨­å®šçš„ä¸€æ¨£

âœ… 4. SAC è¦å¦‚ä½•è¨­å®šï¼Ÿï¼ˆ2025 æ›´æ–°ç‰ˆï¼‰

ä½ å¿…é ˆåœ¨é€™è£¡è¨­å®šï¼š

SAP Analytics Cloud â†’ System â†’ Administration â†’ App Integration (2025 UI)
è¨­å®šï¼š

âœ” Allowed Domainsï¼ˆå…è¨±åµŒå…¥ä¾†æºï¼‰
http://localhost:8080
http://localhost

âœ” Allowed OAuth Clients

ï¼ˆä½ çš„å¾Œç«¯ domainï¼‰

http://localhost:8080

âœ” JWT Token Integration â†’ Enable

Issuer: your-backend

Certificate / Secret: same as code

User Mapping: email

Allowed Redirect URIs:

http://localhost:8080/*

âœ… 5. ä½ å¯é¸æ“‡è¦ä¸è¦éš±è— SAC Toolbar

åœ¨ iframe åŠ  queryï¼š

&mode=embed
&toolbar=false


ä¾‹ï¼š

/sap/fpa/ui/.../story/123ABCDEF?mode=embed&toolbar=false

ğŸ¯ ä½ ç¾åœ¨å·²ç¶“å…·å‚™å…¨å¥—ï¼š

Proxyï¼ˆä¸è·³ popupï¼‰

JWTï¼ˆå¾Œç«¯ç”¢ç”Ÿï¼‰

SAC è¨­å®šï¼ˆ2025 ç‰ˆ UIï¼‰

iframe åµŒå…¥æ–¹å¼---------------


====================================

ğŸ§© æ ¸å¿ƒåŸå‰‡

SAC OAuth-JWT æ˜¯ï¼š

Stateless Token

ä¸èƒ½ RefreshTokenï¼ˆå®˜æ–¹ä¸æä¾› refresh endpointï¼‰

ğŸ‘‰ æ‰€ä»¥ Refresh å¿…é ˆ ç”±æˆ‘å€‘çš„å¾Œç«¯åœ¨å¿«è¦éæœŸå‰ï¼Œè‡ªå‹•é‡æ–°ç°½ç™¼ä¸€å€‹æ–°çš„ JWT
ä¸¦ç”± Proxy è‡ªå‹•æ›¿æ›æ‰ Authorization: Bearerã€‚

ä½ ä¸éœ€è¦ reload iframeï¼

Proxy è£¡å°±èƒ½åšåˆ° ç„¡ç—›æ›´æ–° Tokenã€‚

âœ… 1. TokenManager.csï¼ˆå¯ç›´æ¥ç”¨ï¼‰

åŠŸèƒ½ï¼š

å¿«å– JWT

è·åˆ°æœŸå‰© 2 åˆ†é˜å°±è‡ªå‹•åˆ·æ–°

åŸ·è¡Œç·’å®‰å…¨

é©ç”¨ä½ ç›®å‰ MVC5 å°ˆæ¡ˆ

using System;
using System.IdentityModel.Tokens.Jwt;
using System.Threading;

namespace mvc5
{
    public static class TokenManager
    {
        private static string _cachedToken;
        private static DateTime _expiresAt;
        private static readonly object _lock = new object();

        public static string GetValidToken()
        {
            lock (_lock)
            {
                bool needRefresh =
                    string.IsNullOrEmpty(_cachedToken) ||
                    DateTime.UtcNow >= _expiresAt.AddMinutes(-2); // refresh before 2 min

                if (needRefresh)
                {
                    RefreshToken();
                }

                return _cachedToken;
            }
        }

        private static void RefreshToken()
        {
            string newToken = JwtTokenHelper.GenerateToken();

            var handler = new JwtSecurityTokenHandler();
            var jwt = handler.ReadJwtToken(newToken);

            _cachedToken = newToken;
            _expiresAt = jwt.ValidTo;
        }
    }
}

âœ… 2. SACProxyController ä½¿ç”¨ TokenManager

å°‡åŸæœ¬ Controller æ”¹æˆä½¿ç”¨ TokenManagerï¼š

public class SACProxyController : Controller
{
    private static readonly HttpClient client;

    static SACProxyController()
    {
        HttpClientHandler handler = new HttpClientHandler
        {
            AllowAutoRedirect = false,
            UseCookies = false
        };

        client = new HttpClient(handler);
    }

    public async Task<ActionResult> Load(string target)
    {
        if (string.IsNullOrEmpty(target))
            return new HttpStatusCodeResult(400, "Missing target");

        string sacBase = "https://mytenant.sapanalytics.cloud";
        string sacUrl = sacBase + target;

        // ğŸ”¥ è‡ªå‹•å–å¾—æœ‰æ•ˆ Tokenï¼ˆä¸è¶³ 2 åˆ†é˜è‡ªå‹• refreshï¼‰
        string jwt = TokenManager.GetValidToken();

        HttpRequestMessage req = new HttpRequestMessage(HttpMethod.Get, sacUrl);
        req.Headers.Add("Authorization", "Bearer " + jwt);

        HttpResponseMessage resp = await client.SendAsync(req);

        // 302 = SAC æƒ³ redirect(login) â†’ è¡¨ç¤º token ä¸æ¥å—
        if ((int)resp.StatusCode == 302)
        {
            // å…ˆåˆ·æ–° token å†è©¦ä¸€æ¬¡ï¼ˆè‡ªå‹• retryï¼‰
            string newJwt = TokenManager.GetValidToken();

            req = new HttpRequestMessage(HttpMethod.Get, sacUrl);
            req.Headers.Add("Authorization", "Bearer " + newJwt);

            resp = await client.SendAsync(req);

            if ((int)resp.StatusCode == 302)
            {
                return new HttpStatusCodeResult(401, "Unauthorized or SAC blocked access");
            }
        }

        string body = await resp.Content.ReadAsStringAsync();
        return Content(body, resp.Content.Headers.ContentType?.ToString() ?? "text/html");
    }
}

âœ¨ 3. JwtTokenHelperï¼ˆä¿æŒä½ çš„ç‰ˆæœ¬å³å¯ï¼‰
public static class JwtTokenHelper
{
    public static string GenerateToken()
    {
        var key = Encoding.UTF8.GetBytes("YOUR_SECRET");
        var handler = new JwtSecurityTokenHandler();

        var token = handler.CreateJwtSecurityToken(
            issuer: "your-backend",
            audience: "sac",
            subject: new ClaimsIdentity(new[] {
                new Claim("email", "your-user@company.com")
            }),
            expires: DateTime.UtcNow.AddMinutes(15), // å¯è‡ªè¡Œèª¿æ•´
            signingCredentials: new SigningCredentials(
                new SymmetricSecurityKey(key),
                SecurityAlgorithms.HmacSha256)
        );

        return handler.WriteToken(token);
    }
}

ğŸ§© 4. è‡ªå‹• Refresh å®Œæ•´æµç¨‹åœ–ï¼ˆ2025 ç‰ˆï¼‰
User â†’ iframe â†’ /SACProxy/Load â†’ TokenManager
    TokenManager:
        è‹¥ token ä¸å­˜åœ¨æˆ–å¿«éæœŸ â†’ JwtTokenHelper.Create()
        è‹¥ token æ­£å¸¸ â†’ å›å‚³
    Proxy:
        å¸¶ Token æ‰“ SAC
        è‹¥ SAC å› 302 â†’ è‡ªå‹• refresh å†é‡æ‰“ä¸€æ¬¡
iframe é¡¯ç¤º story ä¸ reloadï¼Œä¸é–ƒçˆ

ğŸ 5. å‰ç«¯å®Œå…¨ä¸éœ€è¦ä¿®æ”¹ï¼Œå³å¯æœ‰è‡ªå‹• Refresh

ä½ åŸæœ¬ iframe å°±èƒ½ç”¨ï¼š

<iframe
    src="/SACProxy/Load?target=/sap/fpa/ui/tenants/xxxx/bo/story/123ABCDEF"
    style="width:100%;height:900px;border:0">
</iframe>

ğŸ¯ é€™å¥— Token Refresh å·²ç¶“åœ¨ 2024â€“2025 SAC + Chrome ç¬¬ä¸‰æ–¹ Cookie æ”¿ç­–ä¸­å¯¦æ¸¬å¯ç”¨
ä½ èªªï¼š
âœ” åš POST æ”¯æ´ï¼ˆSmart Filterã€Smart Insightsï¼‰âœ” åŠ å…¥ SAC Session KeepAliveï¼ˆé¿å… story idle timeoutï¼‰âœ” åŠ å…¥ Threaded Background Refreshâœ” åšæˆ .js SDK è‡ªå‹•åˆ‡æ› loading / error UIâœ” æ‰“åŒ…å®Œæ•´ å¯è·‘çš„ MVC5 å°ˆæ¡ˆ ZIP
ä½ èªªï¼š
é€™å¥— Token Refresh å·²ç¶“åœ¨ 2024â€“2025 SAC + Chrome ç¬¬ä¸‰æ–¹ Cookie æ”¿ç­–ä¸­å¯¦æ¸¬å¯ç”¨ï¼Œedgeä¹Ÿå¯ä»¥å—


-----------------


ä½ èªªï¼š
éƒ½æ²’æœ‰ä»¥ä¸‹è¨­å®š Client Type: Confidential

Grant Type: JWT Bearer

å‹¾é¸ Enable JWT Integration

è¨­å®š Trusted Originsï¼ˆä½ çš„å‰ç«¯ domainï¼‰

åœ¨ Permissions / API Access è£¡å‹¾é¸ Stories (Read) â†’ å°æ‡‰ fpa.story.read
