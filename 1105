v1

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESG Dashboard - å¸¶æµ®å‹•å­é¸å–®</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="./i18n.js"></script>
    <style>
                body {
                    overflow-x: hidden;
                    margin: 0;
                    background-color: #f4f8f5; /* æŸ”å’Œç¶ åº• */
                    font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
                }

                /* Sidebar */
                .sidebar {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 240px;
                    height: 100%;
                    background: linear-gradient(180deg, #2b593f 0%, #1e3a2b 100%); /* æ·±ç¶ æ¼¸å±¤ */
                    color: #e9f5ee;
                    transition: all .3s ease-in-out;
                    z-index: 1040;
                    overflow-y: auto;
                    box-shadow: 2px 0 6px rgba(0,0,0,0.2);
                }

                    .sidebar a {
                        color: #d2f0de;
                        display: block;
                        padding: 10px 15px;
                        text-decoration: none;
                        transition: all .2s;
                    }

                        .sidebar a:hover, .sidebar a.active {
                            background: #5cb85c; /* ç¶ è‰²ä¸»èª¿ */
                            color: #fff;
                        }

                    /* Submenu */
                    .sidebar .submenu {
                        display: none;
                        padding-left: 25px;
                    }

                        .sidebar .submenu a {
                            font-size: 0.9em;
                            color: #c6e8d1;
                        }

                            .sidebar .submenu a:hover {
                                background: rgba(255,255,255,0.1);
                            }
                    /* é˜²æ­¢å±•é–‹æ™‚ hover æˆ– active è®Šç™½ */
                    .sidebar .has-submenu.open > a,
                    .sidebar .has-submenu > a:hover {
                        background: #2b593f !important;
                        color: #fff !important;
                    }
                    /* Sidebar ç¸®èµ· */
                    .sidebar.collapsed {
                        width: 60px;
                        overflow: visible;
                    }

                        .sidebar.collapsed a span.text {
                            display: none;
                        }

                        /* âœ… æµ®å‹•å­é¸å–®ï¼ˆç¸®é€²ç‹€æ…‹ä¸‹é¡¯ç¤ºï¼‰ */
                        .sidebar.collapsed .has-submenu:hover > .submenu {
                            display: block !important;
                            position: absolute;
                            left: 60px;
                            top: 0;
                            background: #2f5c43;
                            border-radius: 0 4px 4px 0;
                            box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
                            width: 180px;
                            padding: 5px 0;
                            z-index: 1050;
                        }

                /* Main Panel */
                #main-panel {
                    margin-left: 240px;
                    transition: margin-left .3s ease-in-out;
                    background-color: #f4f8f5;
                    min-height: 100vh;
                }

                    #main-panel.full {
                        margin-left: 60px;
                    }

                /* Header */
                #main-header {
                    background: #e9f5ee;
                    border-bottom: 1px solid #c8e3d0;
                    height: 50px;
                    padding: 0 10px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                }

                    #main-header .btn {
                        background-color: #5cb85c;
                        color: #fff;
                        border: none;
                        transition: background .2s;
                    }

                        #main-header .btn:hover {
                            background-color: #4cae4c;
                        }

                    #main-header .header-title {
                        flex: 1;
                        text-align: center;
                        margin: 0;
                        font-size: 17px;
                        font-weight: 600;
                        color: #2e4634;
                        letter-spacing: 1px;
                    }

                    #main-header .user-info {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 13px;
                        color: #2b3b2b;
                    }

                #logoutBtn {
                    background-color: #e26a5c;
                    border: none;
                    color: #fff;
                }

                    #logoutBtn:hover {
                        background-color: #c9574c;
                    }

                /* Content */
                #content-container {
                    padding: 25px 35px;
                    background: #f8fbf9;
                    border-radius: 6px;
                    margin: 15px;
                    box-shadow: 0 0 8px rgba(0,0,0,0.05);
                }

                /* Accordion Footer */
                .accordion-footer {
                    margin-top: 30px;
                }

                    .accordion-footer .panel-heading {
                        background: #d9f0df;
                        border-top: 1px solid #b6dec0;
                        cursor: pointer;
                    }

                    .accordion-footer .panel-title a {
                        display: block;
                        text-decoration: none;
                        color: #2b3b2b;
                        font-weight: 500;
                    }

                    .accordion-footer .panel-body {
                        background: #f4f8f5;
                        border-top: 1px solid #cde7d5;
                    }

                .nav > li > a:focus {
                    background-color: #5cb85c !important;
                    text-decoration: none !important;
                }

                .nav > li > a:hover {
                    background-color: #5cb85c !important;
                    text-decoration: none !important;
                }
                /* ---------------------------
           Sidebar Icon èˆ‡æ–‡å­—æ¨£å¼
        --------------------------- */

                /* li a ç½®ä¸­å°é½Šå®¹å™¨ */
                .sidebar a {
                    display: flex;
                    align-items: center;
                    gap: 8px; /* icon èˆ‡æ–‡å­—é–“éš” */
                    transition: all 0.2s ease;
                }

                    /* Icon */
                    .sidebar a span.glyphicon {
                        flex-shrink: 0;
                        font-size: 16px;
                        width: 20px;
                        text-align: center;
                        transition: all 0.2s ease;
                    }

                /* æ”¶åˆæ™‚æ”¾å¤§ä¸¦ç½®ä¸­ */
                .sidebar.collapsed a span.glyphicon {
                    font-size: 24px;
                    width: 100%;
                    text-align: center;
                }

                /* æ”¶åˆæ™‚éš±è—æ–‡å­— */
                .sidebar.collapsed a span.text {
                    display: none;
                }

                /* äºŒç´š submenu li */
                .sidebar .submenu a {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding-left: 30px;
                    transition: all 0.2s ease;
                }

                /* æ”¶åˆæ™‚ submenu ä¹Ÿç½®ä¸­ iconã€éš±è—æ–‡å­— */
                .sidebar.collapsed .submenu a span.text {
                    display: none;
                }

                .sidebar.collapsed .submenu a {
                    justify-content: center;
                }

                /* æ”¶åˆæ™‚æ‰€æœ‰å­é¸å–®éš±è—ï¼Œåƒ…æµ®å‹•æ™‚é¡¯ç¤º */
                .sidebar.collapsed .submenu {
                    display: none !important;
                }

                /* æµ®å‹•å­é¸å–®ï¼ˆæ»‘é¼  hoverï¼‰ */
                .sidebar.collapsed .has-submenu:hover > .submenu {
                    display: block !important;
                    position: absolute;
                    left: 60px;
                    top: 0;
                    background: #2f5c43;
                    border-radius: 0 4px 4px 0;
                    box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
                    width: 100px;
                    padding: 5px 0;
                    z-index: 1050;
                }

                /* æ”¶åˆæ™‚ hover æ•ˆæœï¼Œicon æ”¾å¤§ */
                .sidebar.collapsed a:hover span.glyphicon,
                .sidebar.collapsed .submenu a:hover span.glyphicon {
                    font-size: 24px;
                }

                /* âœ… æµ®å‹•å³å´ä¸‹è¼‰é€²åº¦é¢æ¿ */
                #download-panel {
                    position: fixed;
                    right: 20px;
                    bottom: 20px;
                    width: 280px;
                    background: #ffffff;
                    border-radius: 8px;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                    overflow: hidden;
                    transition: all .3s ease;
                    z-index: 1060;
                }

                    /* header */
                    #download-panel .panel-header {
                        background: #2b593f;
                        color: #fff;
                        padding: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        cursor: pointer;
                        font-weight: 600;
                    }

                        #download-panel .panel-header:hover {
                            background: #36744e;
                        }

                    /* å…§å®¹å€ */
                    #download-panel .panel-body {
                        max-height: 240px;
                        overflow-y: auto;
                        background: #f8fbf9;
                        padding: 10px;
                    }

                /* å–®ç­†ä¸‹è¼‰é …ç›® */
                .download-item {
                    padding: 6px 0;
                    border-bottom: 1px solid #dbe9e0;
                }

                    .download-item:last-child {
                        border-bottom: none;
                    }

                    .download-item .file-name {
                        font-size: 13px;
                        color: #2b3b2b;
                        margin-bottom: 4px;
                    }

                    .download-item .progress {
                        height: 6px;
                        margin: 0;
                    }

                    .download-item .progress-bar {
                        background-color: #5cb85c;
                    }

                /* æ”¶åˆç‹€æ…‹ */
                #download-panel.collapsed {
                    height: 42px;
                    width: 200px;
                }

                    #download-panel.collapsed .panel-body {
                        display: none;
                    }

                /* æ”¶åˆæŒ‰éˆ•åœ–ç¤º */
                #download-toggle {
                    font-size: 16px;
                }
                /* æ‰‹æ©Ÿæ¨¡å¼ Sidebar */
                @media (max-width:767px) {
                    .sidebar {
                        width: 80%;
                        max-width: 300px;
                        transform: translateX(-110%);
                        background: rgba(34,73,53,0.97);
                        box-shadow: 3px 0 15px rgba(0,0,0,0.3);
                        transition: transform .3s ease, opacity .3s ease;
                        opacity: 0;
                    }

                        .sidebar.show {
                            transform: translateX(0);
                            opacity: 1;
                        }

                    #main-panel {
                        margin-left: 0 !important;
                    }
                }

                #adminlte-footer-box {
                    position: fixed;
                    bottom: 0;
                    width: 100%;
                    z-index: 1060;
                    transition: height 0.3s ease;
                }

                    #adminlte-footer-box.collapsed-box {
                        height: 40px; /* åªæœ‰ header é«˜åº¦ */
                    }

                    #adminlte-footer-box .box-header {
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        background: #36744e;
                        color: #fff;
                        padding: 0 15px;
                        cursor: pointer;
                        position: relative;
                        z-index: 1061;
                    }

                    #adminlte-footer-box .box-body {
                        position: absolute;
                        bottom: 40px; /* å¾ header ä¸Šæ–¹å±•é–‹ */
                        width: 100%;
                        display: none;
                        background: #f4f8f5;
                        color: #2b3b2b;
                        max-height: 200px;
                        overflow-y: auto;
                        padding: 15px;
                        box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
                        z-index: 1059;
                    }

                    #adminlte-footer-box.expanded .box-body {
                        display: block;
                    }
                /* å›ºå®šåœ¨ sidebar åº•éƒ¨ */
                .sidebar-bottom-btn {
                    position: absolute;
                    bottom: 10px;
                    width: 100%;
                    text-align: center;
                    z-index: 1050;
                }

                    /* æŒ‰éˆ•æ¨£å¼ */
                    .sidebar-bottom-btn button {
                        width: 80%;
                        white-space: nowrap;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 4px;
                    }

                /* æ”¶åˆæ™‚åªé¡¯ç¤º icon */
                .sidebar.collapsed .sidebar-bottom-btn button .text {
                    display: none;
                }
    </style>
</head>
<body>

    <!-- Sidebar -->
      <div id="sidebar" class="sidebar">
       <div class="text-center" style="padding:10px;">
           <a href="#" id="portal" style="color:#fff;text-decoration:none;font-weight:600;" data-i18n="menu"><strong>é¸å–®</strong></a>
       </div>
       <ul class="nav nav-pills nav-stacked" id="menu">
           <li><a href="#" data-target="Portal/tableau" data-toggle="tooltip" title="é¢æ¿ä¸€"><span class="glyphicon glyphicon-leaf"></span> <span class="text" data-i18n="menuItems.sustain">æ°¸çºŒå ±å‘Š</span></a></li>
           <li class="has-submenu">
               <a href="#" data-toggle="tooltip" title="é¢æ¿äºŒ"><span class="glyphicon glyphicon-stats"></span> <span class="text">ç¢³æ’åˆ†æ â–¾</span></a>
               <ul class="submenu nav">
                   <li><a href="#" data-target="Portal/sub1" data-toggle="tooltip" title="sub1"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub1</span></a></li>
                   <li><a href="#" data-target="Portal/tableau" data-toggle="tooltip" title="sub2"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub2</span></a></li>
               </ul>
           </li>
           <li><a href="#" data-target="Portal/TestSuccess" data-toggle="tooltip" title="Tableau"><span class="glyphicon glyphicon-globe"></span> <span class="text">z22</span></a></li>
       </ul>
       <!-- åº•éƒ¨æŒ‰éˆ• -->
       <div class="sidebar-bottom-btn">
           <button id="sidebar-action-btn" class="btn btn-sm btn-success" title="è¨­å®š">
               <span class="glyphicon glyphicon-cog"></span>
               <span class="text">è¨­å®š</span>
           </button>
       </div>
   </div>


    <!-- Main Panel -->
    <div id="main-panel">
        <!-- Header -->
        <div id="main-header">
            <button id="toggleSidebar" class="btn btn-sm">â˜°</button>
            <h5 id="page-title" class="header-title"></h5>
            <div class="user-info">
                <span>ä½ å¥½, ä½¿ç”¨è€…</span>
                <button class="btn btn-xs" id="logoutBtn">ç™»å‡º</button>
                <button id="testDownload" class="btn btn-primary">é–‹å§‹æ¨¡æ“¬ä¸‹è¼‰</button>
            </div>
            <!-- âœ… æ–°å¢èªè¨€é¸æ“‡ -->
            <select id="langSelect" class="form-control input-sm" style="width:100px;display:inline-block;">
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
            </select>
        </div>

        <iframe id="content-frame" class="flex-grow-1 overflow-auto"
                style="width:100%; height: calc(100vh - 80px); border:none; background:white;"></iframe>


        <!-- AdminLTE å›ºå®šåº•éƒ¨ Footer -->
        <!-- Footer Box -->
        <!-- AdminLTE Footer Box -->
        <div id="adminlte-footer-box" class="box collapsed-box">
            <div class="box-header">
                <span class="box-title">ğŸ“„ ESG Footer</span>
                <button id="footer-toggle-btn" type="button" class="btn btn-box-tool">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
            <div class="box-body">
                <p>é€™è£¡æ˜¯å¯å±•é–‹çš„ Footer å…§å®¹ï¼Œå¯æ”¾ä¸‹è¼‰é€²åº¦ã€å…¬å‘Šæˆ–å…¶ä»–è³‡è¨Šã€‚</p>
            </div>
        </div>


    </div>

    <!-- âœ… å³å´æµ®å‹•ä¸‹è¼‰é€²åº¦æ¸…å–® -->
    <div id="download-panel" class="collapsed">
        <div class="panel-header">
            <span>ğŸ“¥ ä¸‹è¼‰é€²åº¦</span>
            <span id="download-toggle" class="glyphicon glyphicon-chevron-up"></span>
        </div>
        <div class="panel-body">

        </div>
    </div>

    <script>
        // åº•éƒ¨æŒ‰éˆ•äº‹ä»¶


        // ================================
        // AdminLTE Footer æ§åˆ¶å°è£
        // ================================
        const AdminLTEFooterBox = (function () {
            let $box = null;
            let $toggleBtn = null;
            let pagesToShow = [];
            let collapseTimer = null;

            return {
                init: function (boxSelector = "#adminlte-footer-box", toggleBtnSelector = "#footer-toggle-btn", showPages = []) {
                    $box = $(boxSelector);
                    $toggleBtn = $(toggleBtnSelector);
                    pagesToShow = showPages;

                    if (!$box.length || !$toggleBtn.length) return;

                    // é è¨­ collapsed
                    $box.addClass("collapsed-box").removeClass("expanded");
                    $toggleBtn.find("i").removeClass("fa-minus").addClass("fa-plus");

                    // toggle æŒ‰éˆ•äº‹ä»¶
                    $toggleBtn.on("click", e => {
                        e.stopPropagation();
                        this.toggle();
                    });

                    // header é»æ“Šä¹Ÿå¯ toggle
                    $box.find(".box-header").on("click", e => {
                        if (!$(e.target).is($toggleBtn)) this.toggle();
                    });

                    // hover é›¢é–‹ footer body æ™‚ 5 ç§’å¾Œè‡ªå‹• collapse
                    $box.on("mouseenter", () => this._clearCollapseTimer());
                    $box.on("mouseleave", () => this._startCollapseTimer());
                },

                expand: function () {
                    if (!$box || !$toggleBtn) return;
                    $box.removeClass("collapsed-box").addClass("expanded");
                    $toggleBtn.find("i").removeClass("fa-plus").addClass("fa-minus");
                },

                collapse: function () {
                    if (!$box || !$toggleBtn) return;
                    $box.addClass("collapsed-box").removeClass("expanded");
                    $toggleBtn.find("i").removeClass("fa-minus").addClass("fa-plus");
                },

                toggle: function () {
                    if (!$box || !$toggleBtn) return;
                    if ($box.hasClass("expanded")) {
                        this.collapse();
                    } else {
                        this.expand();
                    }
                },

                checkDisplay: function (pageName) {
                    if (!$box) return;
                    if (pagesToShow.includes(pageName)) {
                        $box.show();
                    } else {
                        $box.hide();
                    }
                },

                setPages: function (pages) {
                    pagesToShow = pages;
                },

                _startCollapseTimer: function () {
                    this._clearCollapseTimer();
                    collapseTimer = setTimeout(() => this.collapse(), 500); // 5 ç§’è‡ªå‹•æ”¶åˆ
                },

                _clearCollapseTimer: function () {
                    if (collapseTimer) {
                        clearTimeout(collapseTimer);
                        collapseTimer = null;
                    }
                }
            };
        })();






       // ----------------------------
// IndexedDB util
// ----------------------------
class CacheDB {
    constructor() {
        this.dbName = "SPA_IFRAME_CACHE";
        this.storeName = "pages";
        this.db = null;

        const req = indexedDB.open(this.dbName, 1);

        req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(this.storeName)) {
                db.createObjectStore(this.storeName, { keyPath: "url" });
            }
        };

        req.onsuccess = e => this.db = e.target.result;
    }

    get(url) {
        return new Promise((resolve, reject) => {
            if (!this.db) return resolve(null);
            const tx = this.db.transaction(this.storeName, "readonly");
            const store = tx.objectStore(this.storeName);
            const req = store.get(url);
            req.onsuccess = () => resolve(req.result);
            req.onerror = reject;
        });
    }

    put(url, html, lastModified) {
        return new Promise((resolve, reject) => {
            if (!this.db) return resolve(false);
            const tx = this.db.transaction(this.storeName, "readwrite");
            const store = tx.objectStore(this.storeName);
            store.put({ url, html, lastModified, saveTime: Date.now() });
            tx.oncomplete = resolve;
            tx.onerror = reject;
        });
    }
}


// --------------------------------------------------
// Main Loader
// --------------------------------------------------
class IFrameLoader {
    constructor(iframeId, menuSelector, options = {}) {
        this.iframeId = iframeId;
        this.menuSelector = menuSelector;
        this.cacheExpireMs = options.cacheExpireMs || 30 * 60 * 1000;
        this.debugMode = options.debugMode || false;
        this.iframe = document.getElementById(iframeId);
        this.db = new CacheDB();

        // popstate: back/forward
        window.addEventListener("popstate", e => {
            if (e.state?.url) this.load(e.state.url, false);
        });

        // menu click
        $(document).on("click", `${menuSelector} a[data-target]`, e => {
            e.preventDefault();
            const $a = $(e.currentTarget);
            const target = $a.data("target");
            this.setActiveMenu($a);
            localStorage.setItem("activePage", target);
            this.load(target);
        });

        // expose to global (for child pages)
        window.loader = this;

        // load last page
        const savedPage = localStorage.getItem("activePage") || $(menuSelector + " a[data-target]").first().data("target");
        this.setActiveMenu($(`${menuSelector} a[data-target='${savedPage}']`));
        this.load(savedPage, false);
    }

    setActiveMenu($a) {
        $(`${this.menuSelector} a`).removeClass("active");
        $a.addClass("active");
    }

    // ----------------------------
    // Main load
    // ----------------------------
    async load(target, pushState = true) {
        this.showLoading();

        if (this.debugMode) {
            this.iframe.src = target;
           if (pushToHistory) history.pushState({ url: target }, "", ""); // <- é€™è£¡æ”¹äº†if (pushToHistory) history.pushState({ url: target }, "", ""); // <- é€™è£¡æ”¹äº†
            this.monitorTitle();
            return;
        }

        const cached = await this.db.get(target);

        // å…ˆè©¢å• server headerï¼Œåˆ¤æ–·æ˜¯å¦ä½¿ç”¨å¿«å–
        fetch(target, { method: "HEAD", cache: "no-cache" })
            .then(async (headRes) => {
                const lastModified = headRes.headers.get("Last-Modified") || "";

                // âœ… è‹¥ cache å­˜åœ¨ï¼Œä¸” Last-Modified ä¸€è‡´ â†’ ä½¿ç”¨ cache
                if (cached && cached.lastModified === lastModified && (Date.now() - cached.saveTime) < this.cacheExpireMs) {
                    this.iframe.srcdoc = cached.html;
                    this.applyAutoResize();
                    this.monitorTitle();
                    this.hideLoading();
                } else {
                    // â— server æœ‰æ›´æ–° â†’ å‘ server è¦æœ€æ–°å…§å®¹ï¼ˆå¼·åˆ¶ no-cacheï¼‰
                    const html = await fetch(target, { cache: "no-cache" }).then(r => r.text());
                    this.iframe.srcdoc = html;
                    this.db.put(target, html, lastModified);
                    this.applyAutoResize();
                    this.monitorTitle();
                    this.hideLoading();
                }
            });

       if (pushToHistory) history.pushState({ url: target }, "", ""); // <- é€™è£¡æ”¹äº†
    }

    // ----------------------------
    // iframe auto resize height
    // ----------------------------
    applyAutoResize() {
        const iframe = this.iframe;
        iframe.onload = () => {
            const doc = iframe.contentDocument || iframe.contentWindow.document;

            const resize = () => {
                iframe.style.height = doc.body.scrollHeight + "px";
            };

            resize();

            // iframe å…§å®¹è®Šå‹•ç›£è½ï¼ˆSPA å…§é è®Šå‹•ä¹Ÿæœ‰æ•ˆï¼‰
            new ResizeObserver(resize).observe(doc.body);
        };
    }

    // ----------------------------
    // Loading Mask
    // ----------------------------
    showLoading() {
        if ($("#loading-mask").length === 0) {
            $("body").append(`
                <div id="loading-mask"
                    style="position:fixed;top:0;left:0;width:100%;height:100%;
                    background:rgba(0,0,0,.25);z-index:2000;display:flex;
                    align-items:center;justify-content:center;">
                    <div class="spinner-border"></div>
                    <span style="color:white;font-size:18px;margin-left:10px;">Loading...</span>
                </div>
            `);
        } else $("#loading-mask").show();
    }

    hideLoading() {
        $("#loading-mask").fadeOut(200);
    }

    // ----------------------------
    // Sync child page title to parent
    // ----------------------------
    monitorTitle() {
        const iframe = this.iframe;

        const updateTitle = () => {
            try {
                const inner = iframe.contentDocument || iframe.contentWindow.document;
                const title = inner.querySelector(".page-title");
                $("#page-title").text(title ? title.textContent.trim() : "ESG Dashboard");
            } catch {
                $("#page-title").text("ESG Dashboard");
            }
        };

        iframe.onload = () => {
            updateTitle();
            try {
                const inner = iframe.contentDocument || iframe.contentWindow.document;
                const el = inner.querySelector(".page-title");
                if (el) new MutationObserver(updateTitle).observe(el, { childList: true, characterData: true, subtree: true });
            } catch {}
        };
    }
}





        $(async function () {
            var $sidebar = $("#sidebar"),
                $main = $("#main-panel"),
                $content = $("#content-container");

            $("#download-panel").hide(); // ä¸€é–‹å§‹éš±è—

            // 1ï¸âƒ£ åˆå§‹åŒ–
            // åˆå§‹åŒ– Loader
            const loader = new IFrameLoader("content-frame", "#menu", {
                cacheExpireMs: 30 * 60 * 1000, // 30 åˆ†é˜
                maxCacheItems: 10,
                debugMode: false
            });
            AdminLTEFooterBox.init("#adminlte-footer-box", "#footer-toggle-btn", ["http://localhost:57216/Portal/tableau", "sub1.html"]);


            // åˆå§‹åŒ–èªè¨€
            //await i18n.init();
            // åˆå§‹åŒ–èªè¨€é¸å–®
            //$("#langSelect").val(i18n.getLang());

            //// èªè¨€åˆ‡æ›
            //$("#langSelect").on("change", async function () {
            //    const lang = $(this).val();
            //    await i18n.setLang(lang);
            //    // å†æ¬¡å¥—ç”¨ç¿»è­¯
            //    i18n.apply(document);
            //});
            //console.log(i18n.t("welcome", "ç‹å°æ˜"));  // ä½ å¥½ï¼Œç‹å°æ˜ï¼
            // å¤šåƒæ•¸
            //console.log(i18n.t("greet", "ç‹å°æ˜", "æ—©ä¸Šå¥½")); // ç‹å°æ˜ï¼Œæ—©ä¸Šå¥½ï¼
            // æä¾›çµ¦å­é é¢ a.html å‘¼å«
            function navigateTo(pageUrl) {
                //  loadPanel(pageUrl);
                loader.load(pageUrl)
            }

            // å°‡å‡½å¼æ›åˆ°å…¨åŸŸï¼Œa.html å¯ä»¥å‘¼å«
            window.navigateTo = navigateTo;



            // âœ… æ–°å¢ä¸‹è¼‰é¢æ¿é–‹é—œ
            $("#download-panel .panel-header").on("click", function () {
                $("#download-panel").toggleClass("collapsed");
                $("#download-toggle")
                    .toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
            });
            // ğŸ”¸ äºŒç´šé¸å–®å±•é–‹/æ”¶åˆï¼ˆä¸æœƒè®Šç™½ï¼‰
            $("#menu").on("click", ".has-submenu > a", function (e) {
                e.preventDefault();

                // ä¸æ”¹è®Š active ç‹€æ…‹ï¼ˆé˜²æ­¢è®Šç™½ï¼‰
                var $submenu = $(this).next(".submenu");
                var isOpen = $submenu.is(":visible");

                // æ”¶åˆå…¶ä»– submenu
                $("#menu .submenu").not($submenu).slideUp(200);
                $("#menu .has-submenu").not($(this).parent()).removeClass("open");

                // åˆ‡æ›ç•¶å‰ submenu
                $submenu.slideToggle(200);
                $(this).parent().toggleClass("open", !isOpen);
            });
            function loadPanelWithFooter(targetPage) {
                loader.load(targetPage); // ä½ çš„åŸ loadPanel
                AdminLTEFooterBox.checkDisplay(targetPage);
            }

            // é»æ“Šåˆ‡æ›å…§å®¹
            $("#menu").on("click", "a[data-target]", function (e) {
                e.preventDefault();
                // åªè®“ã€Œé has-submenu çš„é …ç›®ã€è®Š active
                if (!$(this).closest(".has-submenu").length) {
                    $("#menu a").removeClass("active");
                    $(this).addClass("active");
                } else {
                    // æ˜¯å­é …çš„è©±ï¼Œä¹Ÿè¦è¨­ active
                    $("#menu a").removeClass("active");
                    $(this).addClass("active");
                }
                var target = $(this).data("target");
                loadPanelWithFooter(target);//loadPanel(target);
                if ($(window).width() < 768) $sidebar.removeClass("show");
                localStorage.setItem("activePage", target);
            });

            // è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡é é¢
            var saved = localStorage.getItem("activePage") || "Portal";
            $("#menu a[data-target='" + saved + "']").addClass("active");
            //loadPanel(saved);
            loader.load(saved)
            // Sidebar åˆ‡æ›
            $("#portal, #toggleSidebar").on("click", function () {
                if ($(window).width() < 768) {
                    $sidebar.toggleClass("show");
                } else {
                    $sidebar.toggleClass("collapsed");
                    $main.toggleClass("full");
                }
            });

            // ç™»å‡º
            $("#logoutBtn").click(function () {
                $("#adminlte-footer-box").show(); // é¡¯ç¤º
                alert("å·²ç™»å‡ºï¼");
            });
        });

        $(function () {
            // âœ… æ¨¡æ“¬/çœŸå¯¦é€²åº¦æ›´æ–°
            function updateProgress($bar, id, fileName) {
                const timer = setInterval(() => {
                    $.get(`http://localhost:57216/Download/Progress?id=${id}`, function (res) {
                        const pct = res.progress;
                        $bar.css("width", pct + "%").text(pct + "%");
                        if (pct >= 100) {
                            clearInterval(timer);
                            $bar.removeClass("progress-bar-success").addClass("progress-bar-info");
                            $bar.closest(".download-item").find(".file-name").append(" âœ…");

                            // é€²åº¦åˆ°100å¾Œè‡ªå‹• stream ä¸‹è¼‰
                            streamDownload(fileName);
                        }
                    });
                }, 800);
            }

            // âœ… åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            $(document).on("click", ".delete-btn", function () {
                const $item = $(this).closest(".download-item");
                $item.slideUp(200, function () {
                    $item.remove();
                    if ($("#download-panel .download-item").length === 0) {
                        $("#download-panel").fadeOut(300);
                    }
                });
            });


            // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™
            window.addDownloadTask2 = function (fileName) {
                $("#download-panel").show().removeClass("collapsed");
                const $newItem = $(`
          <div class="download-item">
            <div class="file-name">${fileName}</div>
            <div class="progress">
              <div class="progress-bar progress-bar-success" style="width:0%">0%</div>
            </div>
            <div id="downloadSpeed" style="font-size:12px;color:#555;"></div>
            <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
          </div>
        `);
                $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

                // é–‹å§‹æµå¼ä¸‹è¼‰
                streamDownload2(fileName);
            };


            // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™ï¼ˆæ•´åˆå¾Œç«¯ï¼‰
            window.addDownloadTask = function (fileName) {
                $("#download-panel").show().removeClass("collapsed");
                const $newItem = $(`
          <div class="download-item">
            <div class="file-name">${fileName}</div>
            <div class="progress"><div class="progress-bar progress-bar-success" style="width:0%">0%</div></div>
            <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
          </div>
        `);
                $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

                const $bar = $newItem.find(".progress-bar");

                // å‘¼å«å¾Œç«¯é–‹å§‹ä¸‹è¼‰
                $.post("http://localhost:57216/Download/Start", { fileName: fileName }, function (res) {
                    if (res.success) {
                        updateProgress($bar, res.id, fileName);
                    }
                });
            };

            // âœ… Stream ä¸‹è¼‰å‡½å¼ï¼ˆå¯å¤šä»»å‹™ï¼‰
            async function streamDownload2(fileName) {
                try {
                    const response = await fetch(`http://localhost:57216/Download/GetFileStream?fileName=${encodeURIComponent(fileName)}`);
                    if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

                    const contentLength = response.headers.get("Content-Length");
                    const totalSize = contentLength ? parseInt(contentLength, 10) : null;
                    const reader = response.body.getReader();
                    const chunks = [];
                    let received = 0;
                    let startTime = Date.now();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        received += value.length;
                        // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”
                        if (totalSize) {
                            const pct = Math.round((received / totalSize) * 100);
                            $("#downloadProgress").css("width", pct + "%").text(pct + "%");
                        }

                        // è¨ˆç®—ä¸‹è¼‰é€Ÿåº¦ (Bytes/s)
                        const elapsed = (Date.now() - startTime) / 1000; // ç§’
                        const speed = received / elapsed; // Bytes/s
                        let speedText = "";
                        if (speed > 1024 * 1024) speedText = (speed / (1024 * 1024)).toFixed(2) + " MB/s";
                        else if (speed > 1024) speedText = (speed / 1024).toFixed(2) + " KB/s";
                        else speedText = speed.toFixed(0) + " B/s";

                        // é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¸Šæˆ–æ—é‚Š
                        $("#downloadSpeed").text(speedText);



                        // æ›´æ–°è©²æª”æ¡ˆçš„é€²åº¦
                        const pct = contentLength ? Math.round((received / contentLength) * 100) : 0;
                        $(`.download-item:contains("${fileName}") .progress-bar`)
                            .css("width", pct + "%")
                            .text(pct + "%");



                    }

                    const blob = new Blob(chunks, { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName + ".xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);

                    // å®Œæˆå¾Œæ›´æ–°æ¨™è¨˜
                    $(`.download-item:contains("${fileName}") .file-name`).append(" âœ…");
                    $(`.download-item:contains("${fileName}") .progress-bar`)
                        .removeClass("progress-bar-success")
                        .addClass("progress-bar-info");
                    $("#downloadSpeed").text("å®Œæˆ"); // å¯é¸
                } catch (e) {
                    alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
                }
            }



            // âœ… Stream ä¸‹è¼‰å‡½å¼
            async function streamDownload(fileName) {
                try {
                    const response = await fetch(`http://localhost:57216/Download/GetFile?fileName=${encodeURIComponent(fileName)}`);
                    if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

                    const contentLength = response.headers.get("Content-Length");
                    const reader = response.body.getReader();
                    const chunks = [];
                    let received = 0;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        received += value.length;

                        if (contentLength) {
                            const pct = Math.round((received / contentLength) * 100);
                            // å¯é¸ï¼šæ›´æ–°æ•´å€‹ panel é€²åº¦ï¼ˆæˆ–å„è‡ªé€²åº¦ï¼‰
                            $("#downloadProgress").css("width", pct + "%").text(pct + "%");
                        }
                    }

                    const blob = new Blob(chunks);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName + ".txt"; // æˆ–åŸæª”å
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
                }
            }

            // âœ… å¯æ‰‹å‹•æ¸¬è©¦
            $("#testDownload").on("click", function () {
                $("#adminlte-footer-box").hide(); // å®Œå…¨éš±è—
                //  addDownloadTask2("ESG_Report_2025");
            });
        });
        $("#sidebar-action-btn").on("click", function () {
            alert("ä½ é»äº†åº•éƒ¨æŒ‰éˆ•ï¼");
            // é€™è£¡å¯ä»¥æ”¾ä»»ä½•åŠŸèƒ½ï¼Œä¾‹å¦‚æ‰“é–‹è¨­å®šé¢æ¿
        });

        // Sidebar æ”¶åˆ/å±•é–‹
        $("#portal, #toggleSidebar").on("click", function () {
            if ($(window).width() < 768) {
                $("#sidebar").toggleClass("show");
            } else {
                $("#sidebar").toggleClass("collapsed");
                $("#main-panel").toggleClass("full");

                // æ”¶åˆæ™‚è‡ªå‹•æµ®å‹•åº•éƒ¨æŒ‰éˆ•ç½®ä¸­
                if ($("#sidebar").hasClass("collapsed")) {
                    $(".sidebar-bottom-btn").css("text-align", "center");
                } else {
                    $(".sidebar-bottom-btn").css("text-align", "right"); // æˆ– default
                }
            }
        });
        // æ‰‹å‹•æ§åˆ¶
        //AdminLTEFooter.expand();   // å±•é–‹
        //dminLTEFooter.collapse(); // æ”¶åˆ
        //AdminLTEFooter.toggle();   // åˆ‡æ›
        //AdminLTEFooter.show();   // é¡¯ç¤º footer
        //AdminLTEFooter.hide();   // éš±è— footer
        //AdminLTEFooter.toggle(); // é–‹åˆåˆ‡æ›
        //AdminLTEFooter.setPages(["page1.html","page2.html"]); // æ›´æ–°é¡¯ç¤ºé é¢åˆ—è¡¨

    </script>
</body>
</html>

------------------------------------------------------------
v2

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESG Dashboard - å¸¶æµ®å‹•å­é¸å–®</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--<script src="./i18n.js"></script>-->
    <style>
        body {
            overflow-x: hidden;
            margin: 0;
            background-color: #f4f8f5; /* æŸ”å’Œç¶ åº• */
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 240px;
            height: 100%;
            background: linear-gradient(180deg, #2b593f 0%, #1e3a2b 100%); /* æ·±ç¶ æ¼¸å±¤ */
            color: #e9f5ee;
            transition: all .3s ease-in-out;
            z-index: 1040;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0,0,0,0.2);
        }

            .sidebar a {
                color: #d2f0de;
                display: block;
                padding: 10px 15px;
                text-decoration: none;
                transition: all .2s;
            }

                .sidebar a:hover, .sidebar a.active {
                    background: #5cb85c; /* ç¶ è‰²ä¸»èª¿ */
                    color: #fff;
                }

            /* Submenu */
            .sidebar .submenu {
                display: none;
                padding-left: 25px;
            }

                .sidebar .submenu a {
                    font-size: 0.9em;
                    color: #c6e8d1;
                }

                    .sidebar .submenu a:hover {
                        background: rgba(255,255,255,0.1);
                    }
            /* é˜²æ­¢å±•é–‹æ™‚ hover æˆ– active è®Šç™½ */
            .sidebar .has-submenu.open > a,
            .sidebar .has-submenu > a:hover {
                background: #2b593f !important;
                color: #fff !important;
            }
            /* Sidebar ç¸®èµ· */
            .sidebar.collapsed {
                width: 60px;
                overflow: visible;
            }

                .sidebar.collapsed a span.text {
                    display: none;
                }

                /* âœ… æµ®å‹•å­é¸å–®ï¼ˆç¸®é€²ç‹€æ…‹ä¸‹é¡¯ç¤ºï¼‰ */
                .sidebar.collapsed .has-submenu:hover > .submenu {
                    display: block !important;
                    position: absolute;
                    left: 60px;
                    top: 0;
                    background: #2f5c43;
                    border-radius: 0 4px 4px 0;
                    box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
                    width: 180px;
                    padding: 5px 0;
                    z-index: 1050;
                }

        /* Main Panel */
        #main-panel {
            margin-left: 240px;
            transition: margin-left .3s ease-in-out;
            background-color: #f4f8f5;
            min-height: 100vh;
        }

            #main-panel.full {
                margin-left: 60px;
            }

        /* Header */
        #main-header {
            background: #e9f5ee;
            border-bottom: 1px solid #c8e3d0;
            height: 50px;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

            #main-header .btn {
                background-color: #5cb85c;
                color: #fff;
                border: none;
                transition: background .2s;
            }

                #main-header .btn:hover {
                    background-color: #4cae4c;
                }

            #main-header .header-title {
                flex: 1;
                text-align: center;
                margin: 0;
                font-size: 17px;
                font-weight: 600;
                color: #2e4634;
                letter-spacing: 1px;
            }

            #main-header .user-info {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                color: #2b3b2b;
            }

        #logoutBtn {
            background-color: #e26a5c;
            border: none;
            color: #fff;
        }

            #logoutBtn:hover {
                background-color: #c9574c;
            }

        /* Content */
        #content-container {
            padding: 25px 35px;
            background: #f8fbf9;
            border-radius: 6px;
            margin: 15px;
            box-shadow: 0 0 8px rgba(0,0,0,0.05);
        }

        /* Accordion Footer */
        .accordion-footer {
            margin-top: 30px;
        }

            .accordion-footer .panel-heading {
                background: #d9f0df;
                border-top: 1px solid #b6dec0;
                cursor: pointer;
            }

            .accordion-footer .panel-title a {
                display: block;
                text-decoration: none;
                color: #2b3b2b;
                font-weight: 500;
            }

            .accordion-footer .panel-body {
                background: #f4f8f5;
                border-top: 1px solid #cde7d5;
            }

        .nav > li > a:focus {
            background-color: #5cb85c !important;
            text-decoration: none !important;
        }

        .nav > li > a:hover {
            background-color: #5cb85c !important;
            text-decoration: none !important;
        }
        /* ---------------------------
           Sidebar Icon èˆ‡æ–‡å­—æ¨£å¼
        --------------------------- */

        /* li a ç½®ä¸­å°é½Šå®¹å™¨ */
        .sidebar a {
            display: flex;
            align-items: center;
            gap: 8px; /* icon èˆ‡æ–‡å­—é–“éš” */
            transition: all 0.2s ease;
        }

            /* Icon */
            .sidebar a span.glyphicon {
                flex-shrink: 0;
                font-size: 16px;
                width: 20px;
                text-align: center;
                transition: all 0.2s ease;
            }

        /* æ”¶åˆæ™‚æ”¾å¤§ä¸¦ç½®ä¸­ */
        .sidebar.collapsed a span.glyphicon {
            font-size: 24px;
            width: 100%;
            text-align: center;
        }

        /* æ”¶åˆæ™‚éš±è—æ–‡å­— */
        .sidebar.collapsed a span.text {
            display: none;
        }

        /* äºŒç´š submenu li */
        .sidebar .submenu a {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-left: 30px;
            transition: all 0.2s ease;
        }

        /* æ”¶åˆæ™‚ submenu ä¹Ÿç½®ä¸­ iconã€éš±è—æ–‡å­— */
        .sidebar.collapsed .submenu a span.text {
            display: none;
        }

        .sidebar.collapsed .submenu a {
            justify-content: center;
        }

        /* æ”¶åˆæ™‚æ‰€æœ‰å­é¸å–®éš±è—ï¼Œåƒ…æµ®å‹•æ™‚é¡¯ç¤º */
        .sidebar.collapsed .submenu {
            display: none !important;
        }

        /* æµ®å‹•å­é¸å–®ï¼ˆæ»‘é¼  hoverï¼‰ */
        .sidebar.collapsed .has-submenu:hover > .submenu {
            display: block !important;
            position: absolute;
            left: 60px;
            top: 0;
            background: #2f5c43;
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
            width: 100px;
            padding: 5px 0;
            z-index: 1050;
        }

        /* æ”¶åˆæ™‚ hover æ•ˆæœï¼Œicon æ”¾å¤§ */
        .sidebar.collapsed a:hover span.glyphicon,
        .sidebar.collapsed .submenu a:hover span.glyphicon {
            font-size: 24px;
        }

        /* âœ… æµ®å‹•å³å´ä¸‹è¼‰é€²åº¦é¢æ¿ */
        #download-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 280px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all .3s ease;
            z-index: 1060;
        }

            /* header */
            #download-panel .panel-header {
                background: #2b593f;
                color: #fff;
                padding: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                font-weight: 600;
            }

                #download-panel .panel-header:hover {
                    background: #36744e;
                }

            /* å…§å®¹å€ */
            #download-panel .panel-body {
                max-height: 240px;
                overflow-y: auto;
                background: #f8fbf9;
                padding: 10px;
            }

        /* å–®ç­†ä¸‹è¼‰é …ç›® */
        .download-item {
            padding: 6px 0;
            border-bottom: 1px solid #dbe9e0;
        }

            .download-item:last-child {
                border-bottom: none;
            }

            .download-item .file-name {
                font-size: 13px;
                color: #2b3b2b;
                margin-bottom: 4px;
            }

            .download-item .progress {
                height: 6px;
                margin: 0;
            }

            .download-item .progress-bar {
                background-color: #5cb85c;
            }

        /* æ”¶åˆç‹€æ…‹ */
        #download-panel.collapsed {
            height: 42px;
            width: 200px;
        }

            #download-panel.collapsed .panel-body {
                display: none;
            }

        /* æ”¶åˆæŒ‰éˆ•åœ–ç¤º */
        #download-toggle {
            font-size: 16px;
        }
        /* æ‰‹æ©Ÿæ¨¡å¼ Sidebar */
        @media (max-width:767px) {
            .sidebar {
                width: 80%;
                max-width: 300px;
                transform: translateX(-110%);
                background: rgba(34,73,53,0.97);
                box-shadow: 3px 0 15px rgba(0,0,0,0.3);
                transition: transform .3s ease, opacity .3s ease;
                opacity: 0;
            }

                .sidebar.show {
                    transform: translateX(0);
                    opacity: 1;
                }

            #main-panel {
                margin-left: 0 !important;
            }
        }

        #adminlte-footer-box {
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1060;
            transition: height 0.3s ease;
        }

            #adminlte-footer-box.collapsed-box {
                height: 40px; /* åªæœ‰ header é«˜åº¦ */
            }

            #adminlte-footer-box .box-header {
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: #36744e;
                color: #fff;
                padding: 0 15px;
                cursor: pointer;
                position: relative;
                z-index: 1061;
            }

            #adminlte-footer-box .box-body {
                position: absolute;
                bottom: 40px; /* å¾ header ä¸Šæ–¹å±•é–‹ */
                width: 100%;
                display: none;
                background: #f4f8f5;
                color: #2b3b2b;
                max-height: 200px;
                overflow-y: auto;
                padding: 15px;
                box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
                z-index: 1059;
            }

            #adminlte-footer-box.expanded .box-body {
                display: block;
            }
        /* å›ºå®šåœ¨ sidebar åº•éƒ¨ */
        .sidebar-bottom-btn {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            z-index: 1050;
        }

            /* æŒ‰éˆ•æ¨£å¼ */
            .sidebar-bottom-btn button {
                width: 80%;
                white-space: nowrap;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
            }

        /* æ”¶åˆæ™‚åªé¡¯ç¤º icon */
        .sidebar.collapsed .sidebar-bottom-btn button .text {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="text-center" style="padding:10px;">
            <a href="#" id="portal" style="color:#fff;text-decoration:none;font-weight:600;" data-i18n="menu"><strong>é¸å–®</strong></a>
        </div>
        <ul class="nav nav-pills nav-stacked" id="menu">
            <li><a href="#" data-target="Portal/tableau" data-toggle="tooltip" title="é¢æ¿ä¸€"><span class="glyphicon glyphicon-leaf"></span> <span class="text" data-i18n="menuItems.sustain">æ°¸çºŒå ±å‘Š</span></a></li>
            <li class="has-submenu">
                <a href="#" data-toggle="tooltip" title="é¢æ¿äºŒ"><span class="glyphicon glyphicon-stats"></span> <span class="text">ç¢³æ’åˆ†æ â–¾</span></a>
                <ul class="submenu nav">
                    <li><a href="#" data-target="Portal/sub1" data-toggle="tooltip" title="sub1"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub1</span></a></li>
                    <li><a href="#" data-target="Portal/tableau" data-toggle="tooltip" title="sub2"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub2</span></a></li>
                </ul>
            </li>
            <li><a href="#" data-target="Portal/TestSuccess" data-toggle="tooltip" title="Tableau"><span class="glyphicon glyphicon-globe"></span> <span class="text">z22</span></a></li>
        </ul>
        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="sidebar-bottom-btn">
            <button id="sidebar-action-btn" class="btn btn-sm btn-success" title="è¨­å®š">
                <span class="glyphicon glyphicon-cog"></span>
                <span class="text">è¨­å®š</span>
            </button>
        </div>
    </div>


    <!-- Main Panel -->
    <div id="main-panel">
        <!-- Header -->
        <div id="main-header">
            <button id="toggleSidebar" class="btn btn-sm">â˜°</button>
            <h5 id="page-title" class="header-title"></h5>
            <div class="user-info">
                <span>ä½ å¥½, ä½¿ç”¨è€…</span>
                <button class="btn btn-xs" id="logoutBtn">ç™»å‡º</button>
                <button id="testDownload" class="btn btn-primary">é–‹å§‹æ¨¡æ“¬ä¸‹è¼‰</button>
            </div>
            <!-- âœ… æ–°å¢èªè¨€é¸æ“‡ -->
            <select id="langSelect" class="form-control input-sm" style="width:100px;display:inline-block;">
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
            </select>
        </div>

        <iframe id="content-frame" class="flex-grow-1 overflow-auto"
                style="width:100%; height: calc(100vh - 80px); border:none; background:white;"></iframe>


        <!-- AdminLTE å›ºå®šåº•éƒ¨ Footer -->
        <!-- Footer Box -->
        <!-- AdminLTE Footer Box -->
        <div id="adminlte-footer-box" class="box collapsed-box">
            <div class="box-header">
                <span class="box-title">ğŸ“„ ESG Footer</span>
                <button id="footer-toggle-btn" type="button" class="btn btn-box-tool">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
            <div class="box-body">
                <p>é€™è£¡æ˜¯å¯å±•é–‹çš„ Footer å…§å®¹ï¼Œå¯æ”¾ä¸‹è¼‰é€²åº¦ã€å…¬å‘Šæˆ–å…¶ä»–è³‡è¨Šã€‚</p>
            </div>
        </div>


    </div>

    <!-- âœ… å³å´æµ®å‹•ä¸‹è¼‰é€²åº¦æ¸…å–® -->
    <div id="download-panel" class="collapsed">
        <div class="panel-header">
            <span>ğŸ“¥ ä¸‹è¼‰é€²åº¦</span>
            <span id="download-toggle" class="glyphicon glyphicon-chevron-up"></span>
        </div>
        <div class="panel-body">

        </div>
    </div>

    <script>
        // åº•éƒ¨æŒ‰éˆ•äº‹ä»¶


        // ================================
        // AdminLTE Footer æ§åˆ¶å°è£
        // ================================
        const AdminLTEFooterBox = (function () {
            let $box = null;
            let $toggleBtn = null;
            let pagesToShow = [];
            let collapseTimer = null;

            return {
                init: function (boxSelector = "#adminlte-footer-box", toggleBtnSelector = "#footer-toggle-btn", showPages = []) {
                    $box = $(boxSelector);
                    $toggleBtn = $(toggleBtnSelector);
                    pagesToShow = showPages;

                    if (!$box.length || !$toggleBtn.length) return;

                    // é è¨­ collapsed
                    $box.addClass("collapsed-box").removeClass("expanded");
                    $toggleBtn.find("i").removeClass("fa-minus").addClass("fa-plus");

                    // toggle æŒ‰éˆ•äº‹ä»¶
                    $toggleBtn.on("click", e => {
                        e.stopPropagation();
                        this.toggle();
                    });

                    // header é»æ“Šä¹Ÿå¯ toggle
                    $box.find(".box-header").on("click", e => {
                        if (!$(e.target).is($toggleBtn)) this.toggle();
                    });

                    // hover é›¢é–‹ footer body æ™‚ 5 ç§’å¾Œè‡ªå‹• collapse
                    $box.on("mouseenter", () => this._clearCollapseTimer());
                    $box.on("mouseleave", () => this._startCollapseTimer());
                },

                expand: function () {
                    if (!$box || !$toggleBtn) return;
                    $box.removeClass("collapsed-box").addClass("expanded");
                    $toggleBtn.find("i").removeClass("fa-plus").addClass("fa-minus");
                },

                collapse: function () {
                    if (!$box || !$toggleBtn) return;
                    $box.addClass("collapsed-box").removeClass("expanded");
                    $toggleBtn.find("i").removeClass("fa-minus").addClass("fa-plus");
                },

                toggle: function () {
                    if (!$box || !$toggleBtn) return;
                    if ($box.hasClass("expanded")) {
                        this.collapse();
                    } else {
                        this.expand();
                    }
                },

                checkDisplay: function (pageName) {
                    if (!$box) return;
                    if (pagesToShow.includes(pageName)) {
                        $box.show();
                    } else {
                        $box.hide();
                    }
                },

                setPages: function (pages) {
                    pagesToShow = pages;
                },

                _startCollapseTimer: function () {
                    this._clearCollapseTimer();
                    collapseTimer = setTimeout(() => this.collapse(), 500); // 5 ç§’è‡ªå‹•æ”¶åˆ
                },

                _clearCollapseTimer: function () {
                    if (collapseTimer) {
                        clearTimeout(collapseTimer);
                        collapseTimer = null;
                    }
                }
            };
        })();


        // -------------------------------
        // IndexedDB å¿«å–å·¥å…·
        // -------------------------------
        class CacheDB {
            constructor(dbName = "IFrameCacheDB") {
                this.dbName = dbName;
                this.storeName = "cacheStore";
                this.dbPromise = this._openDB();
            }

            _openDB() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onerror = e => reject(e);
                    req.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName))
                            db.createObjectStore(this.storeName, { keyPath: "target" });
                    };
                    req.onsuccess = e => resolve(e.target.result);
                });
            }

            async get(target) {
                const db = await this.dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, "readonly");
                    const store = tx.objectStore(this.storeName);
                    const req = store.get(target);
                    req.onsuccess = e => resolve(e.target.result);
                    req.onerror = e => reject(e);
                });
            }

            async put(target, html, version) {
                const db = await this.dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, "readwrite");
                    const store = tx.objectStore(this.storeName);
                    store.put({ target, html, version, saveTime: Date.now() });
                    tx.oncomplete = () => resolve();
                    tx.onerror = e => reject(e);
                });
            }

            async clearOld(maxItems) {
                const db = await this.dbPromise;
                const tx = db.transaction(this.storeName, "readwrite");
                const store = tx.objectStore(this.storeName);
                const req = store.getAllKeys();
                req.onsuccess = async e => {
                    const keys = e.target.result;
                    if (keys.length > maxItems) {
                        for (let i = 0; i < keys.length - maxItems; i++) store.delete(keys[i]);
                    }
                };
            }
        }

        // -------------------------------
        // IFrameLoader å®Œæ•´æ•´åˆç‰ˆ
        // -------------------------------
        class IFrameLoader {
            constructor(iframeId, menuSelector, options = {}) {
                this.iframeId = iframeId;
                this.menuSelector = menuSelector;
                this.cacheExpireMs = options.cacheExpireMs || 30 * 60 * 1000;
                this.maxCacheItems = options.maxCacheItems || 10;
                this.debugMode = options.debugMode || false;
                this.iframe = document.getElementById(iframeId);
                this.db = new CacheDB();

                if (!this.iframe) throw new Error("Iframe element not found: " + iframeId);

                // popstate æ”¯æ´å‰é€²/å¾Œé€€
                window.addEventListener("popstate", e => {
                    if (e.state?.url) this.load(e.state.url, false);
                });

                // menu click
                $(document).on("click", `${menuSelector} a[data-target]`, e => {
                    e.preventDefault();
                    const $a = $(e.currentTarget);
                    const target = $a.data("target");
                    this.setActiveMenu($a);
                    localStorage.setItem("activePage", target);
                    this.load(target, true);
                });

                // expose globally
                window.loader = this;

                // load last page
                const savedPage = localStorage.getItem("activePage") || $(menuSelector + " a[data-target]").first().data("target");
                this.setActiveMenu($(`${menuSelector} a[data-target='${savedPage}']`));
                this.load(savedPage, false);
            }

            setActiveMenu($a) {
                $(`${this.menuSelector} a`).removeClass("active");
                if ($a && $a.length) $a.addClass("active");
            }

            async load(target, pushToHistory = true) {
                this.showLoading();

                if (this.debugMode) {
                    this.iframe.src = target;
                    if (pushToHistory) history.pushState({ url: target }, "", "");
                    this._attachOnLoadHandlers();
                    this._applyAutoResize();
                    return;
                }

                try {
                    const cached = await this.db.get(target);

                    // å–å¾— Assembly Version
                    let currentVersion = "";
                    try {
                        const res = await fetch("/Meta/Version", { cache: "no-cache" });
                        if (res.ok) currentVersion = await res.text();
                    } catch (e) { currentVersion = ""; }

                    const now = Date.now();
                    const cacheValid = cached && ((now - (cached.saveTime || 0)) < this.cacheExpireMs);

                    // èƒŒæ™¯è‡ªå‹•æ›´æ–°å¿«å–
                    this._backgroundUpdateCache(target, currentVersion);

                    if (cached && cacheValid && cached.version === currentVersion) {
                        this.iframe.srcdoc = cached.html;
                        this._attachOnLoadHandlers();
                        this._applyAutoResize();
                        if (pushToHistory) history.pushState({ url: target }, "", "");
                        return;
                    }

                    // fetch latest HTML
                    const resp = await fetch(target, { cache: "no-cache" });
                    const html = await resp.text();
                    this.iframe.srcdoc = html;
                    await this.db.put(target, html, currentVersion);
                    await this.db.clearOld(this.maxCacheItems);
                    this._attachOnLoadHandlers();
                    this._applyAutoResize();
                    if (pushToHistory) history.pushState({ url: target }, "", "");
                } catch (err) {
                    console.error("IFrameLoader.load error:", err);
                    try { this.iframe.src = target; } catch (_) { }
                }
            }

            async _backgroundUpdateCache(target, version) {
                try {
                    const resp = await fetch(target, { cache: "no-cache" });
                    if (!resp.ok) return;
                    const html = await resp.text();
                    const cached = await this.db.get(target);
                    if (!cached || cached.version !== version || cached.html !== html) {
                        await this.db.put(target, html, version);
                        await this.db.clearOld(this.maxCacheItems);
                        console.log(`Background cache updated: ${target}`);
                    }
                } catch (e) {
                    console.warn("Background update failed:", e);
                }
            }

            _attachOnLoadHandlers() {
                const iframe = this.iframe;
                const self = this;
                iframe.onload = function () {
                    try {
                        self.hideLoading();
                        self._updateTitle();
                        self._observeTitle();
                        //self._applyAutoResize();
                      //  setTimeout(() => this._applyAutoResize(), 200); // ç­‰åœ–ç‰‡/åœ–è¡¨æ¸²æŸ“å®Œæˆ
                    } catch (e) { console.warn("onload handler error", e); }
                };
            }

            _updateTitle() {
                try {
                    const inner = this.iframe.contentDocument || this.iframe.contentWindow.document;
                    const titleEl = inner.querySelector(".page-title");
                    $("#page-title").text(titleEl ? titleEl.textContent.trim() : "ESG Dashboard");
                } catch (e) { $("#page-title").text("ESG Dashboard"); }
            }

            _observeTitle() {
                try {
                    const inner = this.iframe.contentDocument || this.iframe.contentWindow.document;
                    const titleEl = inner.querySelector(".page-title");
                    if (!titleEl) return;
                    const mo = new MutationObserver(() => this._updateTitle());
                    mo.observe(titleEl, { childList: true, characterData: true, subtree: true });
                } catch (e) { }
            }

            _applyAutoResize(headerSelector = "#main-header", footerSelector = "#adminlte-footer-box") {
                const iframe = this.iframe;
                const tryResize = () => {
                    try {
                        const inner = iframe.contentDocument || iframe.contentWindow.document;
                        if (!inner || !inner.body) {
                            // body å°šæœªå»ºç«‹ï¼Œå»¶é²å†è©¦
                            setTimeout(tryResize, 100);
                            return;
                        }

                        const header = inner.querySelector(headerSelector);
                        const footer = inner.querySelector(footerSelector);

                        const headerHeight = header ? header.offsetHeight : 0;
                        const footerHeight = footer ? footer.offsetHeight : 0;

                        const totalHeight = inner.documentElement.scrollHeight || inner.body.scrollHeight || 0;

                        iframe.style.height = Math.max(totalHeight - headerHeight - footerHeight, 100) + "px";

                    } catch (e) {
                        console.warn("iframe resize error", e);
                    }
                };

                // åˆå§‹ resize
                tryResize();

                // ResizeObserver
                try {
                    const inner = iframe.contentDocument || iframe.contentWindow.document;
                    if (inner && inner.body) {
                        const ro = new ResizeObserver(tryResize);
                        ro.observe(inner.body);
                    }
                } catch (e) { /* ignore */ }

                // å»¶é²å†è¨ˆç®—å¹¾æ¬¡ï¼Œç¢ºä¿åœ–ç‰‡ / åœ–è¡¨æ¸²æŸ“å®Œæˆ
                setTimeout(tryResize, 200);
                setTimeout(tryResize, 500);
                setTimeout(tryResize, 1000);
            }


            showLoading() {
                if ($("#loading-mask").length === 0) {
                    $("body").append(`
                <div id="loading-mask" style="position:fixed;top:0;left:0;width:100%;height:100%;
                    background:rgba(0,0,0,.25);z-index:2000;display:flex;
                    align-items:center;justify-content:center;">
                    <div class="spinner-border"></div>
                    <span style="color:white;font-size:18px;margin-left:10px;">Loading...</span>
                </div>
            `);
                } else $("#loading-mask").show();
            }

            hideLoading() {
                $("#loading-mask").fadeOut(200);
            }
        }







        $(async function () {
            var $sidebar = $("#sidebar"),
                $main = $("#main-panel"),
                $content = $("#content-container");

            $("#download-panel").hide(); // ä¸€é–‹å§‹éš±è—

            // 1ï¸âƒ£ åˆå§‹åŒ–
            // åˆå§‹åŒ– Loader
            const loader = new IFrameLoader("content-frame", "#menu", {
                cacheExpireMs: 30 * 60 * 1000, // 30 åˆ†é˜
                maxCacheItems: 10,
                debugMode: false
            });
            AdminLTEFooterBox.init("#adminlte-footer-box", "#footer-toggle-btn", ["Portal/sub1", "sub1.html"]);


            // åˆå§‹åŒ–èªè¨€
            //await i18n.init();
            // åˆå§‹åŒ–èªè¨€é¸å–®
            //$("#langSelect").val(i18n.getLang());

            //// èªè¨€åˆ‡æ›
            //$("#langSelect").on("change", async function () {
            //    const lang = $(this).val();
            //    await i18n.setLang(lang);
            //    // å†æ¬¡å¥—ç”¨ç¿»è­¯
            //    i18n.apply(document);
            //});
            //console.log(i18n.t("welcome", "ç‹å°æ˜"));  // ä½ å¥½ï¼Œç‹å°æ˜ï¼
            // å¤šåƒæ•¸
            //console.log(i18n.t("greet", "ç‹å°æ˜", "æ—©ä¸Šå¥½")); // ç‹å°æ˜ï¼Œæ—©ä¸Šå¥½ï¼
            // æä¾›çµ¦å­é é¢ a.html å‘¼å«
            function navigateTo(pageUrl) {
                //  loadPanel(pageUrl);
                loader.load(pageUrl)
            }

            // å°‡å‡½å¼æ›åˆ°å…¨åŸŸï¼Œa.html å¯ä»¥å‘¼å«
            window.navigateTo = navigateTo;



            // âœ… æ–°å¢ä¸‹è¼‰é¢æ¿é–‹é—œ
            $("#download-panel .panel-header").on("click", function () {
                $("#download-panel").toggleClass("collapsed");
                $("#download-toggle")
                    .toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
            });
            // ğŸ”¸ äºŒç´šé¸å–®å±•é–‹/æ”¶åˆï¼ˆä¸æœƒè®Šç™½ï¼‰
            $("#menu").on("click", ".has-submenu > a", function (e) {
                e.preventDefault();

                // ä¸æ”¹è®Š active ç‹€æ…‹ï¼ˆé˜²æ­¢è®Šç™½ï¼‰
                var $submenu = $(this).next(".submenu");
                var isOpen = $submenu.is(":visible");

                // æ”¶åˆå…¶ä»– submenu
                $("#menu .submenu").not($submenu).slideUp(200);
                $("#menu .has-submenu").not($(this).parent()).removeClass("open");

                // åˆ‡æ›ç•¶å‰ submenu
                $submenu.slideToggle(200);
                $(this).parent().toggleClass("open", !isOpen);
            });
            function loadPanelWithFooter(targetPage) {
                loader.load(targetPage); // ä½ çš„åŸ loadPanel
                AdminLTEFooterBox.checkDisplay(targetPage);
            }

            // é»æ“Šåˆ‡æ›å…§å®¹
            $("#menu").on("click", "a[data-target]", function (e) {
                e.preventDefault();
                // åªè®“ã€Œé has-submenu çš„é …ç›®ã€è®Š active
                if (!$(this).closest(".has-submenu").length) {
                    $("#menu a").removeClass("active");
                    $(this).addClass("active");
                } else {
                    // æ˜¯å­é …çš„è©±ï¼Œä¹Ÿè¦è¨­ active
                    $("#menu a").removeClass("active");
                    $(this).addClass("active");
                }
                var target = $(this).data("target");
                loadPanelWithFooter(target);//loadPanel(target);
                if ($(window).width() < 768) $sidebar.removeClass("show");
                localStorage.setItem("activePage", target);
            });

            // è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡é é¢
            var saved = localStorage.getItem("activePage") || "Portal";
            $("#menu a[data-target='" + saved + "']").addClass("active");
            //loadPanel(saved);
            loader.load(saved)
            // Sidebar åˆ‡æ›
            $("#portal, #toggleSidebar").on("click", function () {
                if ($(window).width() < 768) {
                    $sidebar.toggleClass("show");
                } else {
                    $sidebar.toggleClass("collapsed");
                    $main.toggleClass("full");
                }
            });

            // ç™»å‡º
            $("#logoutBtn").click(function () {
                $("#adminlte-footer-box").show(); // é¡¯ç¤º
                alert("å·²ç™»å‡ºï¼");
            });
        });

        $(function () {
            // âœ… æ¨¡æ“¬/çœŸå¯¦é€²åº¦æ›´æ–°
            function updateProgress($bar, id, fileName) {
                const timer = setInterval(() => {
                    $.get(`http://localhost:57216/Download/Progress?id=${id}`, function (res) {
                        const pct = res.progress;
                        $bar.css("width", pct + "%").text(pct + "%");
                        if (pct >= 100) {
                            clearInterval(timer);
                            $bar.removeClass("progress-bar-success").addClass("progress-bar-info");
                            $bar.closest(".download-item").find(".file-name").append(" âœ…");

                            // é€²åº¦åˆ°100å¾Œè‡ªå‹• stream ä¸‹è¼‰
                            streamDownload(fileName);
                        }
                    });
                }, 800);
            }

            // âœ… åˆªé™¤æŒ‰éˆ•äº‹ä»¶
            $(document).on("click", ".delete-btn", function () {
                const $item = $(this).closest(".download-item");
                $item.slideUp(200, function () {
                    $item.remove();
                    if ($("#download-panel .download-item").length === 0) {
                        $("#download-panel").fadeOut(300);
                    }
                });
            });


            // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™
            window.addDownloadTask2 = function (fileName) {
                $("#download-panel").show().removeClass("collapsed");
                const $newItem = $(`
              <div class="download-item">
                <div class="file-name">${fileName}</div>
                <div class="progress">
                  <div class="progress-bar progress-bar-success" style="width:0%">0%</div>
                </div>
                <div id="downloadSpeed" style="font-size:12px;color:#555;"></div>
                <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
              </div>
            `);
                $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

                // é–‹å§‹æµå¼ä¸‹è¼‰
                streamDownload2(fileName);
            };


            // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™ï¼ˆæ•´åˆå¾Œç«¯ï¼‰
            window.addDownloadTask = function (fileName) {
                $("#download-panel").show().removeClass("collapsed");
                const $newItem = $(`
              <div class="download-item">
                <div class="file-name">${fileName}</div>
                <div class="progress"><div class="progress-bar progress-bar-success" style="width:0%">0%</div></div>
                <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
              </div>
            `);
                $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

                const $bar = $newItem.find(".progress-bar");

                // å‘¼å«å¾Œç«¯é–‹å§‹ä¸‹è¼‰
                $.post("http://localhost:57216/Download/Start", { fileName: fileName }, function (res) {
                    if (res.success) {
                        updateProgress($bar, res.id, fileName);
                    }
                });
            };

            // âœ… Stream ä¸‹è¼‰å‡½å¼ï¼ˆå¯å¤šä»»å‹™ï¼‰
            async function streamDownload2(fileName) {
                try {
                    const response = await fetch(`http://localhost:57216/Download/GetFileStream?fileName=${encodeURIComponent(fileName)}`);
                    if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

                    const contentLength = response.headers.get("Content-Length");
                    const totalSize = contentLength ? parseInt(contentLength, 10) : null;
                    const reader = response.body.getReader();
                    const chunks = [];
                    let received = 0;
                    let startTime = Date.now();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        received += value.length;
                        // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”
                        if (totalSize) {
                            const pct = Math.round((received / totalSize) * 100);
                            $("#downloadProgress").css("width", pct + "%").text(pct + "%");
                        }

                        // è¨ˆç®—ä¸‹è¼‰é€Ÿåº¦ (Bytes/s)
                        const elapsed = (Date.now() - startTime) / 1000; // ç§’
                        const speed = received / elapsed; // Bytes/s
                        let speedText = "";
                        if (speed > 1024 * 1024) speedText = (speed / (1024 * 1024)).toFixed(2) + " MB/s";
                        else if (speed > 1024) speedText = (speed / 1024).toFixed(2) + " KB/s";
                        else speedText = speed.toFixed(0) + " B/s";

                        // é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¸Šæˆ–æ—é‚Š
                        $("#downloadSpeed").text(speedText);



                        // æ›´æ–°è©²æª”æ¡ˆçš„é€²åº¦
                        const pct = contentLength ? Math.round((received / contentLength) * 100) : 0;
                        $(`.download-item:contains("${fileName}") .progress-bar`)
                            .css("width", pct + "%")
                            .text(pct + "%");



                    }

                    const blob = new Blob(chunks, { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName + ".xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);

                    // å®Œæˆå¾Œæ›´æ–°æ¨™è¨˜
                    $(`.download-item:contains("${fileName}") .file-name`).append(" âœ…");
                    $(`.download-item:contains("${fileName}") .progress-bar`)
                        .removeClass("progress-bar-success")
                        .addClass("progress-bar-info");
                    $("#downloadSpeed").text("å®Œæˆ"); // å¯é¸
                } catch (e) {
                    alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
                }
            }



            // âœ… Stream ä¸‹è¼‰å‡½å¼
            async function streamDownload(fileName) {
                try {
                    const response = await fetch(`http://localhost:57216/Download/GetFile?fileName=${encodeURIComponent(fileName)}`);
                    if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

                    const contentLength = response.headers.get("Content-Length");
                    const reader = response.body.getReader();
                    const chunks = [];
                    let received = 0;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        received += value.length;

                        if (contentLength) {
                            const pct = Math.round((received / contentLength) * 100);
                            // å¯é¸ï¼šæ›´æ–°æ•´å€‹ panel é€²åº¦ï¼ˆæˆ–å„è‡ªé€²åº¦ï¼‰
                            $("#downloadProgress").css("width", pct + "%").text(pct + "%");
                        }
                    }

                    const blob = new Blob(chunks);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName + ".txt"; // æˆ–åŸæª”å
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
                }
            }

            // âœ… å¯æ‰‹å‹•æ¸¬è©¦
            $("#testDownload").on("click", function () {
                $("#adminlte-footer-box").hide(); // å®Œå…¨éš±è—
                //  addDownloadTask2("ESG_Report_2025");
            });
        });
        $("#sidebar-action-btn").on("click", function () {
            alert("ä½ é»äº†åº•éƒ¨æŒ‰éˆ•ï¼");
            // é€™è£¡å¯ä»¥æ”¾ä»»ä½•åŠŸèƒ½ï¼Œä¾‹å¦‚æ‰“é–‹è¨­å®šé¢æ¿
        });

        // Sidebar æ”¶åˆ/å±•é–‹
        $("#portal, #toggleSidebar").on("click", function () {
            if ($(window).width() < 768) {
                $("#sidebar").toggleClass("show");
            } else {
                $("#sidebar").toggleClass("collapsed");
                $("#main-panel").toggleClass("full");

                // æ”¶åˆæ™‚è‡ªå‹•æµ®å‹•åº•éƒ¨æŒ‰éˆ•ç½®ä¸­
                if ($("#sidebar").hasClass("collapsed")) {
                    $(".sidebar-bottom-btn").css("text-align", "center");
                } else {
                    $(".sidebar-bottom-btn").css("text-align", "right"); // æˆ– default
                }
            }
        });
        // æ‰‹å‹•æ§åˆ¶
        //AdminLTEFooter.expand();   // å±•é–‹
        //dminLTEFooter.collapse(); // æ”¶åˆ
        //AdminLTEFooter.toggle();   // åˆ‡æ›
        //AdminLTEFooter.show();   // é¡¯ç¤º footer
        //AdminLTEFooter.hide();   // éš±è— footer
        //AdminLTEFooter.toggle(); // é–‹åˆåˆ‡æ›
        //AdminLTEFooter.setPages(["page1.html","page2.html"]); // æ›´æ–°é¡¯ç¤ºé é¢åˆ—è¡¨

    </script>
</body>
</html>
----------------------

using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Web;
using System.Web.Mvc;

namespace mvc5.Controllers
{
    public class MetaController : Controller
    {
        // GET: /Meta/Version
        [HttpGet]
        public ActionResult Version()
        {
            try
            {
                // å–å¾—ç•¶å‰åŸ·è¡Œ Assembly
                var assembly = Assembly.GetExecutingAssembly();

                // æ–¹å¼1ï¼šå– Assembly Version
                var version = assembly.GetName().Version.ToString();

                // æ–¹å¼2ï¼šä¹Ÿå¯ä»¥å–ç·¨è­¯æ™‚é–“ (é¸æ“‡æ€§)
                // var buildDate = System.IO.File.GetLastWriteTime(assembly.Location).ToString("yyyyMMddHHmmss");
                // var version = version + "-" + buildDate;

                return Content(version);
            }
            catch (Exception ex)
            {
                // ç™¼ç”ŸéŒ¯èª¤æ™‚å›å‚³ç©ºå­—ä¸²
                return Content("");
            }
        }
    }
}

-----------------------
