ä½ æƒ³åœ¨ ASP.NET MVC5 + Autofac è£¡æ³¨å…¥æœå‹™ï¼ˆServiceï¼‰ï¼Œè€Œä¸”ä½ çš„å°ˆæ¡ˆè£¡æœ‰ 100 å€‹ä»¥ä¸Šçš„ Serviceï¼Œä¸æƒ³æ¯å€‹éƒ½åœ¨ Controller å»ºæ§‹å­è£¡å¯«å‡ºä¾†ï¼Œä½†ä»ç„¶èƒ½ä½¿ç”¨ï¼Œé€™æ˜¯å¯ä»¥åšåˆ°çš„ï¼Œæˆ‘å¹«ä½ æ•´ç†å¹¾ç¨®æ–¹å¼ï¼š

1ï¸âƒ£ ä½¿ç”¨ IEnumerable<T> æ³¨å…¥æ‰€æœ‰åŒé¡å‹æœå‹™

å¦‚æœä½ çš„ Service éƒ½å¯¦ä½œäº†ç›¸åŒä»‹é¢ï¼Œä¾‹å¦‚ IServiceï¼š

public interface IService { void DoSomething(); }
public class ServiceA : IService { ... }
public class ServiceB : IService { ... }


Autofac è¨»å†Šï¼š

var builder = new ContainerBuilder();

// è¨»å†Šæ‰€æœ‰å¯¦ä½œ IService çš„é¡åˆ¥
builder.RegisterAssemblyTypes(typeof(ServiceA).Assembly)
       .Where(t => typeof(IService).IsAssignableFrom(t))
       .As<IService>();


Controllerï¼š

public class MyController : Controller
{
    private readonly IEnumerable<IService> _services;

    public MyController(IEnumerable<IService> services)
    {
        _services = services;
    }

    public ActionResult Index()
    {
        foreach(var s in _services)
        {
            s.DoSomething();
        }
        return View();
    }
}


âœ… å„ªé»ï¼šä¸éœ€è¦åˆ—å‡ºæ‰€æœ‰ Serviceï¼ŒAutofac æœƒè‡ªå‹•æŠŠæ‰€æœ‰å¯¦ä½œ IService çš„é¡åˆ¥æ³¨å…¥ã€‚

2ï¸âƒ£ ä½¿ç”¨ Service Locator / è§£æå®¹å™¨

å¦‚æœæ¯å€‹ Service çš„ä»‹é¢ä¸åŒï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥æ³¨å…¥ ILifetimeScope æˆ– IComponentContextï¼Œåœ¨ Controller è£¡å‹•æ…‹è§£æï¼š

public class MyController : Controller
{
    private readonly ILifetimeScope _scope;

    public MyController(ILifetimeScope scope)
    {
        _scope = scope;
    }

    public ActionResult Index()
    {
        var serviceA = _scope.Resolve<ServiceA>();
        var serviceB = _scope.Resolve<ServiceB>();
        // å‹•æ…‹è§£æä»»ä½• Service
        return View();
    }
}


âœ… å„ªé»ï¼šä¸éœ€è¦åœ¨å»ºæ§‹å­å¯« 100 å€‹åƒæ•¸
âš ï¸ ç¼ºé»ï¼šä½¿ç”¨ Service Locator æœƒé™ä½å¯æ¸¬è©¦æ€§

3ï¸âƒ£ ä½¿ç”¨ æ³›å‹å·¥å»  / Factory æ¨¡å¼

å¦‚æœä½ çš„ Service éƒ½éµå¾ªæŸå€‹å‘½åè¦å‰‡æˆ–ä»‹é¢ï¼Œå¯ä»¥å»ºç«‹ä¸€å€‹å·¥å» ï¼š

public interface IServiceFactory
{
    T GetService<T>() where T : class;
}

public class ServiceFactory : IServiceFactory
{
    private readonly ILifetimeScope _scope;
    public ServiceFactory(ILifetimeScope scope)
    {
        _scope = scope;
    }

    public T GetService<T>() where T : class
    {
        return _scope.Resolve<T>();
    }
}


Controllerï¼š

public class MyController : Controller
{
    private readonly IServiceFactory _factory;
    public MyController(IServiceFactory factory)
    {
        _factory = factory;
    }

    public ActionResult Index()
    {
        var serviceA = _factory.GetService<ServiceA>();
        var serviceB = _factory.GetService<ServiceB>();
        return View();
    }
}


âœ… å„ªé»ï¼šåªæ³¨å…¥ä¸€å€‹ Factoryï¼Œå‹•æ…‹å–å¾—æ‰€æœ‰ Service

ğŸ”¹ å»ºè­°

å¦‚æœ Service æ•¸é‡è¶…é 100 å€‹ï¼Œå»ºè­°ç”¨ Factory æˆ– ILifetimeScope å‹•æ…‹è§£æï¼Œä¸è¦åœ¨ Controller å»ºæ§‹å­å¯« 100 å€‹åƒæ•¸

å¦‚æœ Service éƒ½å¯¦ä½œåŒä¸€å€‹ä»‹é¢ï¼Œä½¿ç”¨ IEnumerable<IService> æ˜¯æœ€ç°¡å–®ä¸”å¯æ¸¬è©¦çš„æ–¹å¼
