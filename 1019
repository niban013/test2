å¥½çš„ï¼Œæˆ‘å¹«ä½ å¯«ä¸€å€‹å®Œæ•´ç¯„ä¾‹ï¼Œæ»¿è¶³ä»¥ä¸‹æ¢ä»¶ï¼š

100 å€‹ä»¥ä¸Šçš„ Serviceï¼Œä¸ç”¨åœ¨ Controller ä¸€ä¸€æ³¨å…¥

Controller å¯ä»¥ä¾åç¨±å‹•æ…‹å–å¾— Service ä¸¦å‘¼å«

ä½¿ç”¨ Autofac + MVC5

1ï¸âƒ£ å®šç¾© Service ä»‹é¢ï¼ˆå¯é¸çµ±ä¸€ä»‹é¢ï¼‰
public interface IService
{
    string Name { get; }
    void Execute();
}

2ï¸âƒ£ å¯¦ä½œå¤šå€‹ Service
public class ServiceA : IService
{
    public string Name => "ServiceA";
    public void Execute() => System.Diagnostics.Debug.WriteLine("åŸ·è¡Œ ServiceA");
}

public class ServiceB : IService
{
    public string Name => "ServiceB";
    public void Execute() => System.Diagnostics.Debug.WriteLine("åŸ·è¡Œ ServiceB");
}

// å¯ä»¥ç”¨é¡ä¼¼å¯«æ³•æ¨¡æ“¬ 100 å€‹ Service

3ï¸âƒ£ Service Factory
using Autofac;
using System;
using System.Collections.Generic;
using System.Linq;

public interface IServiceFactory
{
    IService GetServiceByName(string name);
    IEnumerable<IService> GetAllServices();
}

public class ServiceFactory : IServiceFactory
{
    private readonly ILifetimeScope _scope;
    private readonly Dictionary<string, Type> _serviceMap;

    public ServiceFactory(ILifetimeScope scope)
    {
        _scope = scope;

        // è‡ªå‹•æƒææ‰€æœ‰ IService é¡åˆ¥
        _serviceMap = AppDomain.CurrentDomain.GetAssemblies()
            .SelectMany(a => a.GetTypes())
            .Where(t => typeof(IService).IsAssignableFrom(t) && t.IsClass && !t.IsAbstract)
            .ToDictionary(t => t.Name, t => t);
    }

    public IService GetServiceByName(string name)
    {
        if (_serviceMap.TryGetValue(name, out var type))
            return (IService)_scope.Resolve(type);

        return null;
    }

    public IEnumerable<IService> GetAllServices()
    {
        foreach (var type in _serviceMap.Values)
            yield return (IService)_scope.Resolve(type);
    }
}

4ï¸âƒ£ Autofac è¨­å®š
using Autofac;
using Autofac.Integration.Mvc;
using System.Web.Mvc;
using System.Reflection;

public class AutofacConfig
{
    public static void RegisterDependencies()
    {
        var builder = new ContainerBuilder();

        // è¨»å†Š Controller
        builder.RegisterControllers(Assembly.GetExecutingAssembly());

        // è¨»å†Šæ‰€æœ‰ IService å¯¦ä½œ
        builder.RegisterAssemblyTypes(Assembly.GetExecutingAssembly())
               .Where(t => typeof(IService).IsAssignableFrom(t))
               .AsSelf(); // ä»¥é¡åˆ¥å‹åˆ¥è§£æ

        // è¨»å†Š ServiceFactory
        builder.RegisterType<ServiceFactory>()
               .As<IServiceFactory>()
               .SingleInstance();

        var container = builder.Build();
        DependencyResolver.SetResolver(new AutofacDependencyResolver(container));
    }
}


åœ¨ Global.asax.cs çš„ Application_Start() å‘¼å«ï¼š

AutofacConfig.RegisterDependencies();

5ï¸âƒ£ Controller ä½¿ç”¨
public class HomeController : Controller
{
    private readonly IServiceFactory _factory;

    public HomeController(IServiceFactory factory)
    {
        _factory = factory;
    }

    public ActionResult Index()
    {
        // å–å¾—å–®å€‹ Service
        var serviceA = _factory.GetServiceByName("ServiceA");
        serviceA?.Execute();

        // æˆ–æ‰¹æ¬¡åŸ·è¡Œæ‰€æœ‰ Service
        foreach (var svc in _factory.GetAllServices())
        {
            svc.Execute();
        }

        return Content("å®Œæˆ");
    }
}


âœ… å„ªé»ï¼š

Controller ä¸ç”¨åˆ—å‡º 100 å€‹ Service

æ–°å¢ Service åªè¦å¯¦ä½œ IServiceï¼ŒFactory è‡ªå‹•æƒæ

å¯ä»¥å‹•æ…‹å–å¾—å–®å€‹ Service æˆ–å…¨éƒ¨åŸ·è¡Œ

é©ç”¨ MVC5 + Aut









ä½ æƒ³åœ¨ ASP.NET MVC5 + Autofac è£¡æ³¨å…¥æœå‹™ï¼ˆServiceï¼‰ï¼Œè€Œä¸”ä½ çš„å°ˆæ¡ˆè£¡æœ‰ 100 å€‹ä»¥ä¸Šçš„ Serviceï¼Œä¸æƒ³æ¯å€‹éƒ½åœ¨ Controller å»ºæ§‹å­è£¡å¯«å‡ºä¾†ï¼Œä½†ä»ç„¶èƒ½ä½¿ç”¨ï¼Œé€™æ˜¯å¯ä»¥åšåˆ°çš„ï¼Œæˆ‘å¹«ä½ æ•´ç†å¹¾ç¨®æ–¹å¼ï¼š

1ï¸âƒ£ ä½¿ç”¨ IEnumerable<T> æ³¨å…¥æ‰€æœ‰åŒé¡å‹æœå‹™

å¦‚æœä½ çš„ Service éƒ½å¯¦ä½œäº†ç›¸åŒä»‹é¢ï¼Œä¾‹å¦‚ IServiceï¼š

public interface IService { void DoSomething(); }
public class ServiceA : IService { ... }
public class ServiceB : IService { ... }


Autofac è¨»å†Šï¼š

var builder = new ContainerBuilder();

// è¨»å†Šæ‰€æœ‰å¯¦ä½œ IService çš„é¡åˆ¥
builder.RegisterAssemblyTypes(typeof(ServiceA).Assembly)
       .Where(t => typeof(IService).IsAssignableFrom(t))
       .As<IService>();


Controllerï¼š

public class MyController : Controller
{
    private readonly IEnumerable<IService> _services;

    public MyController(IEnumerable<IService> services)
    {
        _services = services;
    }

    public ActionResult Index()
    {
        foreach(var s in _services)
        {
            s.DoSomething();
        }
        return View();
    }
}


âœ… å„ªé»ï¼šä¸éœ€è¦åˆ—å‡ºæ‰€æœ‰ Serviceï¼ŒAutofac æœƒè‡ªå‹•æŠŠæ‰€æœ‰å¯¦ä½œ IService çš„é¡åˆ¥æ³¨å…¥ã€‚

2ï¸âƒ£ ä½¿ç”¨ Service Locator / è§£æå®¹å™¨

å¦‚æœæ¯å€‹ Service çš„ä»‹é¢ä¸åŒï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥æ³¨å…¥ ILifetimeScope æˆ– IComponentContextï¼Œåœ¨ Controller è£¡å‹•æ…‹è§£æï¼š

public class MyController : Controller
{
    private readonly ILifetimeScope _scope;

    public MyController(ILifetimeScope scope)
    {
        _scope = scope;
    }

    public ActionResult Index()
    {
        var serviceA = _scope.Resolve<ServiceA>();
        var serviceB = _scope.Resolve<ServiceB>();
        // å‹•æ…‹è§£æä»»ä½• Service
        return View();
    }
}


âœ… å„ªé»ï¼šä¸éœ€è¦åœ¨å»ºæ§‹å­å¯« 100 å€‹åƒæ•¸
âš ï¸ ç¼ºé»ï¼šä½¿ç”¨ Service Locator æœƒé™ä½å¯æ¸¬è©¦æ€§

3ï¸âƒ£ ä½¿ç”¨ æ³›å‹å·¥å»  / Factory æ¨¡å¼

å¦‚æœä½ çš„ Service éƒ½éµå¾ªæŸå€‹å‘½åè¦å‰‡æˆ–ä»‹é¢ï¼Œå¯ä»¥å»ºç«‹ä¸€å€‹å·¥å» ï¼š

public interface IServiceFactory
{
    T GetService<T>() where T : class;
}

public class ServiceFactory : IServiceFactory
{
    private readonly ILifetimeScope _scope;
    public ServiceFactory(ILifetimeScope scope)
    {
        _scope = scope;
    }

    public T GetService<T>() where T : class
    {
        return _scope.Resolve<T>();
    }
}


Controllerï¼š

public class MyController : Controller
{
    private readonly IServiceFactory _factory;
    public MyController(IServiceFactory factory)
    {
        _factory = factory;
    }

    public ActionResult Index()
    {
        var serviceA = _factory.GetService<ServiceA>();
        var serviceB = _factory.GetService<ServiceB>();
        return View();
    }
}


âœ… å„ªé»ï¼šåªæ³¨å…¥ä¸€å€‹ Factoryï¼Œå‹•æ…‹å–å¾—æ‰€æœ‰ Service

ğŸ”¹ å»ºè­°

å¦‚æœ Service æ•¸é‡è¶…é 100 å€‹ï¼Œå»ºè­°ç”¨ Factory æˆ– ILifetimeScope å‹•æ…‹è§£æï¼Œä¸è¦åœ¨ Controller å»ºæ§‹å­å¯« 100 å€‹åƒæ•¸

å¦‚æœ Service éƒ½å¯¦ä½œåŒä¸€å€‹ä»‹é¢ï¼Œä½¿ç”¨ IEnumerable<IService> æ˜¯æœ€ç°¡å–®ä¸”å¯æ¸¬è©¦çš„æ–¹å¼
