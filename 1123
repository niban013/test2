<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å°è£ Select2 å¤§è³‡æ–™åˆ†é æœå°‹</title>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  select { width: 300px; margin: 10px; }
</style>
</head>
<body>
<h2>å°è£ Select2 - å¤§è³‡æ–™åˆ†é  + æœå°‹</h2>

<select id="mySelect"></select>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// æ¨¡æ“¬å¤§é‡è³‡æ–™
const largeData = [];
for(let i=1;i<=1000;i++){
    largeData.push({id: i, text: `é¸é … ${i}`});
}
(function ($) {
    $.fn.largeSelect2 = function (options) {

        const settings = $.extend({
            placeholder: "è«‹é¸æ“‡",
            allowClear: true,
            pageSize: 50,
            initValue: null,          // å¯ç‚º {id, text} æˆ– [ {id,text}, ... ]
            dataSource: null,
            delay: 250,
            enableSearch: false,

            localSearchOnly: false,
            serverSearchOnly: false,

            minSearchLength: 0,
            multiple: false           // ğŸ”¥ æ–°å¢ï¼šæ”¯æ´å¤šé¸
        }, options);

        const $select = $(this);

        // ---------------------
        // åˆå§‹åŒ– Select2
        // ---------------------
        function init() {
            const config = {
                placeholder: settings.placeholder,
                allowClear: settings.allowClear,
                multiple: settings.multiple     // ğŸ”¥ å¥—ç”¨å¤šé¸
            };

            // ------------------------------------------------------
            // ğŸ”¥ enableSearch = false â†’ ç„¡æœå°‹ï¼Œä¸ç”¨ AJAX
            // ------------------------------------------------------
            if (!settings.enableSearch) {
                config.minimumResultsForSearch = Infinity;

                if (settings.serverSearchOnly) {
                    console.warn("largeSelect2: enableSearch=false ç„¡æ³• serverSearchOnly â†’ æ”¹ç‚ºä½¿ç”¨ local");
                }

                config.data = getAllLocalItems();

            } else {
                config.ajax = buildAjax();
            }

            $select.select2(config);

            // åˆå§‹åŒ–é è¨­å€¼
            if (settings.initValue) {
                if (Array.isArray(settings.initValue)) {
                    setValues(settings.initValue);
                } else {
                    setValue(settings.initValue.id, settings.initValue.text);
                }
            }
        }

        // ç”¨æ–¼ enableSearch=false æ™‚ç›´æ¥æä¾› data
        function getAllLocalItems() {
            let source = [];

            if (Array.isArray(settings.dataSource)) {
                source = settings.dataSource;
            } else if (typeof settings.dataSource === "function") {
                console.warn("largeSelect2: enableSearch=false â†’ dataSource å¿…é ˆæ˜¯ arrayï¼Œfunction å°‡è¢«å¿½ç•¥");
            }

            return source;
        }

        // ---------------------
        // Select2 Ajax Transport
        // ---------------------
        function buildAjax() {
            return {
                transport: async function (params, success, failure) {
                    const page = params.data.page || 1;
                    const search = params.data.q || "";

                    // æœå°‹å­—æ•¸ä¸è¶³ï¼Œå›å‚³ç©º
                    if (settings.minSearchLength > 0 && search.length < settings.minSearchLength) {
                        return success({ results: [], pagination: { more: false } });
                    }

                    try {
                        const result = await fetchData(search, page);
                        success(result);
                    } catch (err) {
                        failure(err);
                    }
                },
                delay: settings.delay
            };
        }

        // ---------------------
        // è³‡æ–™æ¨¡å¼é‚è¼¯
        // ---------------------
        async function fetchData(search, page) {

            // 1ï¸âƒ£ localSearchOnly
            if (settings.localSearchOnly) {
                const source = settings.dataSource || [];
                let filtered = search
                    ? source.filter(x => x.text.includes(search))
                    : source;

                return paginate(filtered, page);
            }

            // 2ï¸âƒ£ serverSearchOnly
            if (settings.serverSearchOnly) {
                if (typeof settings.dataSource !== "function") {
                    console.error("serverSearchOnly requires dataSource to be a function");
                    return paginate([], page);
                }
                return await settings.dataSource({ search, page, pageSize: settings.pageSize });
            }

            // 3ï¸âƒ£ Hybrid / Auto
            if (typeof settings.dataSource === "function") {
                return await settings.dataSource({ search, page, pageSize: settings.pageSize });
            } else {
                const source = settings.dataSource || [];
                let filtered = search
                    ? source.filter(x => x.text.includes(search))
                    : source;

                return paginate(filtered, page);
            }
        }

        // ---------------------
        // æœ¬åœ°åˆ†é å·¥å…·
        // ---------------------
        function paginate(list, page) {
            const pageSize = settings.pageSize;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;

            return {
                results: list.slice(start, end),
                pagination: { more: end < list.length }
            };
        }

        // ---------------------
        // Public API
        // ---------------------
        function getValue() {
            return $select.val();
        }

        // å–®ç­†é¸æ“‡
        function setValue(id, text) {
            const option = new Option(text, id, true, true);
            $select.append(option).trigger("change");
        }

        // å¤šé¸ç‰ˆæœ¬
        function setValues(items) {
            if (!Array.isArray(items)) return;

            items.forEach(({ id, text }) => {
                const option = new Option(text, id, true, true);
                $select.append(option);
            });

            $select.trigger("change");
        }

        function clear() {
            $select.val(null).trigger("change");
        }

        function updateSource(newSource) {
            settings.dataSource = newSource;
            refresh();
        }

        function refresh() {
            destroy();
            init();
        }

        function destroy() {
            $select.off();
            $select.select2("destroy");
        }

        // Expose API
        $select.data("largeSelect2", {
            getValue,
            setValue,
            setValues,
            clear,
            updateSource,
            refresh,
            destroy
        });

        init();
        return this;
    };
})(jQuery);


// ä½¿ç”¨ç¯„ä¾‹
$("#mySelect").largeSelect2({
    multiple: true,enableSearch:true,minSearchLength:0,
 //   dataSource: largeData,
    placeholder: "è«‹é¸æ“‡é …ç›®"
});

const api = $('#mySelect').data('largeSelect2');


api.updateSource(largeData)

//api.setValue(5, "é¸é … 5");
api.setValues([{ id:5, text:"é¸é … 5" },{ id:2, text:"é¸é … 2" }]); 
// ç›£è½è®ŠåŒ–
$('#mySelect').on('change', function () {
    console.log('æ”¹è®Š:', $(this).val());
	
	const api = $('#mySelect').data('largeSelect2');

console.log("ç›®å‰å€¼:", api.getValue());
});
</script>
</body>
</html>

using System.Linq;
using System.Web.Mvc;

public class ApiController : Controller
{
    // æ¨¡æ“¬è³‡æ–™åº«
    private static List<Item> items = new List<Item>
    {
        new Item { Id = 1, Name = "è˜‹æœ" },
        new Item { Id = 2, Name = "é¦™è•‰" },
        new Item { Id = 3, Name = "è‘¡è„" },
        new Item { Id = 4, Name = "èŠ’æœ" },
        new Item { Id = 5, Name = "é³³æ¢¨" },
        // ... å¯å¤§é‡è³‡æ–™
    };

    [HttpGet]
    public ActionResult Items(string keyword = "", int page = 1, int pageSize = 50)
    {
        // ğŸ” æœå°‹
        var query = items.AsQueryable();

        if (!string.IsNullOrEmpty(keyword))
        {
            query = query.Where(x => x.Name.Contains(keyword));
        }

        // ğŸ“„ åˆ†é 
        int skip = (page - 1) * pageSize;
        var pagedData = query.Skip(skip).Take(pageSize).ToList();

        // æ˜¯å¦é‚„æœ‰ä¸‹ä¸€é 
        bool hasMore = query.Count() > skip + pageSize;

        // ğŸ”„ Select2 æ ¼å¼
        var result = new
        {
            results = pagedData.Select(x => new
            {
                id = x.Id,
                text = x.Name
            }),

            pagination = new { more = hasMore }
        };

        return Json(result, JsonRequestBehavior.AllowGet);
    }
}

// æ¨¡å‹
public class Item
{
    public int Id { get; set; }
    public string Name { get; set; }
}
// =========================
//   Download Manager å·¥å…·
// =========================
const DownloadManager = (function () {

    // é¢æ¿ DOM
    let $panel
    let $body

    // åˆå§‹åŒ–æŒ‰éˆ•äº‹ä»¶ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
    function init() {
        $panel = $("#download-panel");
        $body = $("#download-panel .panel-body");
        $("#download-panel .panel-header").on("click", function () {
            $panel.toggleClass("collapsed");
            $("#download-toggle")
                .toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
        });

        // ç›£è½åˆªé™¤æŒ‰éˆ•ï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
        $(document).on("click", ".download-item .delete-btn", function () {
            const $item = $(this).closest(".download-item");
            $item.slideUp(200, function () {
                $item.remove();

                if ($(".download-item").length === 0)
                    $panel.fadeOut(300);
            });
        });
    }

    // å»ºç«‹å–®ç­† UI
    function createItem(fileName) {
        const id = "dl_" + Date.now();

        const $item = $(`
      <div class="download-item" data-id="${id}">
        <div class="file-name">${fileName}</div>

        <div class="progress">
          <div class="progress-bar progress-bar-success" style="width:0%">0%</div>
        </div>

        <div class="speed" style="font-size:12px;color:#555;">--</div>

        <button class="btn btn-xs btn-danger delete-btn" 
                style="float:right;margin-top:-18px;">âœ•</button>
      </div>
    `);

        $body.append($item.hide().slideDown(200));
        $panel.show().removeClass("collapsed");

        return id;
    }

    // æ›´æ–° UI
    function updateProgress(id, pct, speedText) {
        const $item = $(`.download-item[data-id="${id}"]`);
        $item.find(".progress-bar")
            .css("width", pct + "%")
            .text(pct + "%");

        $item.find(".speed").text(speedText);
    }

    // å®Œæˆ UI
    function finishItem(id) {
        const $item = $(`.download-item[data-id="${id}"]`);

        $item.find(".file-name").append(" âœ…");
        $item.find(".progress-bar")
            .removeClass("progress-bar-success")
            .addClass("progress-bar-info");

        $item.find(".speed").text("å®Œæˆ");
    }

    // æµå¼ä¸‹è¼‰
    async function streamDownload(id, fileName, url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

            const contentLength = res.headers.get("Content-Length");
            const totalSize = contentLength ? parseInt(contentLength, 10) : null;

            const reader = res.body.getReader();
            const chunks = [];
            let received = 0;
            let start = Date.now();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                chunks.push(value);
                received += value.length;

                // è¨ˆç®—é€²åº¦
                let pct = totalSize
                    ? Math.round((received / totalSize) * 100)
                    : 0;

                // è¨ˆç®—é€Ÿåº¦
                const seconds = (Date.now() - start) / 1000;
                const bps = received / seconds;
                let speed = "";
                if (bps > 1024 * 1024) speed = (bps / 1024 / 1024).toFixed(2) + " MB/s";
                else if (bps > 1024) speed = (bps / 1024).toFixed(2) + " KB/s";
                else speed = bps.toFixed(0) + " B/s";

                updateProgress(id, pct, speed);
            }

            // ä¸‹è¼‰å®Œæˆ -> ç”Ÿæˆ Blob
            const blob = new Blob(chunks);
            const link = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = link;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(link);

            finishItem(id);

        } catch (err) {
            alert("ä¸‹è¼‰éŒ¯èª¤: " + err.message);
        }
    }

    // å°å¤– API ------------------------------------
    return {
        init,
        addTask(fileName, url) {
            const id = createItem(fileName);
            streamDownload(id, fileName, url);
            return id;
        }
    };
})();

// åˆå§‹åŒ–ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
$(document).ready(() => {
    DownloadManager.init();
});

        $("#testDownload").on("click", function () {
            $("#adminlte-footer-box").hide(); // å®Œå…¨éš±è—
            let fileName = "ESG_Report_2025"
            DownloadManager.addTask(
                fileName,
                `http://localhost:57216/Download/GetFileStream?fileName=${encodeURIComponent(fileName)}`
            );
            //  addDownloadTask2("ESG_Report_2025");
        });  


        /* âœ… æµ®å‹•å³å´ä¸‹è¼‰é€²åº¦é¢æ¿ */
        #download-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 280px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all .3s ease;
            z-index: 1060;
        }

            /* header */
            #download-panel .panel-header {
                background: #2b593f;
                color: #fff;
                padding: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                font-weight: 600;
            }

                #download-panel .panel-header:hover {
                    background: #36744e;
                }

            /* å…§å®¹å€ */
            #download-panel .panel-body {
                max-height: 240px;
                overflow-y: auto;
                background: #f8fbf9;
                padding: 10px;
            }

        /* å–®ç­†ä¸‹è¼‰é …ç›® */
        .download-item {
            padding: 6px 0;
            border-bottom: 1px solid #dbe9e0;
        }

            .download-item:last-child {
                border-bottom: none;
            }

            .download-item .file-name {
                font-size: 13px;
                color: #2b3b2b;
                margin-bottom: 4px;
            }

            .download-item .progress {
                height: 6px;
                margin: 0;
            }

            .download-item .progress-bar {
                background-color: #5cb85c;
            }

        /* æ”¶åˆç‹€æ…‹ */
        #download-panel.collapsed {
            height: 42px;
            width: 200px;
        }

            #download-panel.collapsed .panel-body {
                display: none;
            }

        /* æ”¶åˆæŒ‰éˆ•åœ–ç¤º */
        #download-toggle {
            font-size: 16px;
        }
