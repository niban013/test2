<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ä¸‰å±¤ä¸‹æ‹‰å°è£ï¼ˆL1-L2-L3 æ™ºæ…§é€£å‹•ï¼‰</title>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
select { margin:10px; padding:5px; width:200px; }
</style>
</head>
<body>
<h2>ä¸‰å±¤ä¸‹æ‹‰å°è£ï¼ˆæ™ºæ…§é€£å‹• + è‡ªå‹•å›æ¨çˆ¶å±¤ï¼‰</h2>

<div class="location-group" data-group="1">
  <select class="select-L1"></select>
  <select class="select-L2"></select>
  <select class="select-L3"></select>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// æ¨¡æ“¬è³‡æ–™
const locationData = {
  "å°ç£": { "å°åŒ—": ["ä¸­æ­£å€","å¤§å®‰å€"], "å°ä¸­": ["åŒ—å€","è¥¿å±¯å€"] },
  "æ—¥æœ¬": { "æ±äº¬": ["æ–°å®¿","æ¸‹è°·"], "å¤§é˜ª": ["æ¢…ç”°","é›£æ³¢"] },
  "ç¾åœ‹": { "ç´ç´„": ["æ›¼å“ˆé “","å¸ƒé­¯å…‹æ—"], "æ´›æ‰ç£¯": ["å¥½èŠå¡¢","æ¯”ä½›åˆ©å±±"] }
};

class MultiLevelSelector {
  constructor($group, data, levels, defaultValues){
    this.data = data;
    this.levels = levels.map(l=>$group.find(`.select-${l}`));
    this.levelNames = levels;
    this.childToParent = {};
    this.buildChildMap(data);
    this.initSelect2();
    this.bindEvents();
    this.levels.forEach((_, idx)=>this.updateLevel(idx));
    if(defaultValues) this.setDefaultValues(defaultValues);
  }

  buildChildMap(obj, parent=null){
    for(const k in obj){
      if(parent) this.childToParent[k] = parent;
      if(typeof obj[k]==='object' && !Array.isArray(obj[k])){
        this.buildChildMap(obj[k], k);
      } else if(Array.isArray(obj[k])){
        obj[k].forEach(v => this.childToParent[v] = k);
      }
    }
  }

  initSelect2(){
    this.levels.forEach(l => l.select2({ width:'200px', minimumResultsForSearch: Infinity }));
  }

  allL2(){ 
    let arr=[]; 
    for(const l1 in this.data) arr.push(...Object.keys(this.data[l1])); 
    return arr; 
  }

  allL3(){ 
    let arr=[]; 
    for(const l1 in this.data) Object.values(this.data[l1]).forEach(a=>arr.push(...a)); 
    return arr; 
  }

  l2ByL1(l1){ return Object.keys(this.data[l1]||{}); }
  l3ByL1(l1){ let arr=[]; Object.values(this.data[l1]||{}).forEach(a=>arr.push(...a)); return arr; }

  updateLevel(idx, options=null){
    const $level=this.levels[idx];
    const placeholder=`è«‹é¸${this.levelNames[idx]}`;
    $level.empty();
    $level.append(new Option(placeholder, placeholder, true, true));

    if(!options){
      if(idx===0) options=Object.keys(this.data);
      else if(idx===1){
        const l1=this.levels[0].val();
        if(l1 && !l1.startsWith("è«‹é¸")) options=this.l2ByL1(l1);
        else options=this.allL2();
      }
      else if(idx===2){
        const l1=this.levels[0].val();
        const l2=this.levels[1].val();
        if(l2 && !l2.startsWith("è«‹é¸")) options=this.data[l1]?.[l2]||[];
        else if(l1 && !l1.startsWith("è«‹é¸")) options=this.l3ByL1(l1);
        else options=this.allL3();
      }
    }

    options.forEach(o=>$level.append(new Option(o,o,false,false)));
    $level.val(placeholder).trigger("change.select2");
  }

  bindEvents(){
    this.levels.forEach((level,i)=>{
      level.on("change",()=>{
        const val=level.val();

        // âœ… æ‰€æœ‰å±¤é¸ã€Œè«‹é¸XXã€â†’ ä¸‰å±¤å…¨å›é è¨­
        if(val && val.startsWith("è«‹é¸")){
          this.levels.forEach((_,idx)=>this.updateLevel(idx));
          return;
        }

        // âœ… L1 æ”¹è®Š â†’ æ›´æ–° L2ã€L3
        if(i===0){
          this.updateLevel(1);
          this.updateLevel(2);
          return;
        }

        // âœ… L2 æ”¹è®Š â†’ å›æ¨ L1 + æ›´æ–° L3
        if(i===1){
          const parent=this.childToParent[val];
          if(parent && this.levels[0].val()!==parent){
            this.levels[0].val(parent).trigger("change.select2");
          }
          const l2Opts=this.l2ByL1(parent);
          this.updateLevel(1,l2Opts);
          this.levels[1].val(val).trigger("change.select2");
          const l3Opts=this.data[parent]?.[val]||[];
          this.updateLevel(2,l3Opts);
          return;
        }

        // âœ… L3 æ”¹è®Š â†’ å›æ¨ L2/L1
        if(i===2){
          const parentCity=this.childToParent[val];
          const parentL1=this.childToParent[parentCity];
          if(parentL1 && this.levels[0].val()!==parentL1)
            this.levels[0].val(parentL1).trigger("change.select2");
          const l2Opts=this.l2ByL1(parentL1);
          this.updateLevel(1,l2Opts);
          this.levels[1].val(parentCity).trigger("change.select2");
          const l3Opts=this.data[parentL1]?.[parentCity]||[];
          this.updateLevel(2,l3Opts);
          this.levels[2].val(val).trigger("change.select2");
        }
      });
    });
  }

  setDefaultValues(values){
    if(!Array.isArray(values)) return;
    const applyLevel=(idx)=>{
      if(idx>=this.levels.length) return;
      const $level=this.levels[idx];
      this.updateLevel(idx);
      setTimeout(()=>{
        let val=values[idx];
        if(val && $level.find(`option[value="${val}"]`).length){
          $level.val(val).trigger("change.select2");
        }
        applyLevel(idx+1);
      },0);
    };
    applyLevel(0);
  }
}

// åˆå§‹åŒ–
$(document).ready(()=>{
  new MultiLevelSelector(
    $(".location-group[data-group=1]"),
    locationData,
    ['L1','L2','L3'],
    // ['æ—¥æœ¬']         // æ¸¬è©¦é è¨­å€¼1
    // ['æ—¥æœ¬','å¤§é˜ª']  // æ¸¬è©¦é è¨­å€¼2
  );
});
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‡ªé©æ‡‰ä¸‰åˆ—å¤šè¡Œ ECharts å®¹å™¨ (autoDataZoom + å‹•æ…‹ xlabelMode + legendMode)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<style>
body { font-family:"Microsoft JhengHei",sans-serif; margin:20px; background:#FFFFFF; }
h2 { text-align:center; color:#444; margin-bottom:20px; }
/* âœ… ä¿®æ”¹å¾Œçš„éŸ¿æ‡‰å¼ä¸‰æ¬„ç¶²æ ¼ */
/* ===== å…¨å¯¬éŸ¿æ‡‰å¼ï¼šæ”¹ç”¨ Flexboxï¼Œæœ€å¤š 3 æ¬„ï¼Œå°‘æ–¼ 3 å€‹å¹³å‡åˆ†é… ===== */
.chart-grid {
  display: flex;
  flex-wrap: wrap;      /* âœ… è¶…éä¸‰å¼µè‡ªå‹•æ›è¡Œ */
  gap: 20px;
  width: 100%;
  box-sizing: border-box;
  justify-content: flex-start; /* âœ… é å·¦æ’åˆ—ï¼Œä¸å¹³å±• */
  align-items: stretch;
}

/* âœ… æ¯å¼µåœ–å›ºå®šä½” 1/3ï¼ˆæ¸›å»é–“è·ï¼‰ */
.chart-item {
  flex: 0 0 calc((100% - 40px) / 3); /* 3 æ¬„ï¼Œæ¯æ¬„å¯¬åº¦å¹³å‡ */
  background: #FFFFFF;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  min-height: 300px;
  padding: 10px;
  border: none;
  box-sizing: border-box;
}

/* âœ… è‹¥åªæœ‰ 1 æˆ– 2 å¼µï¼Œè‡ªå‹•å¹³å‡åˆ†é…æ•´åˆ—å¯¬åº¦ */
.chart-grid:has(.chart-item:nth-child(2):last-child) .chart-item {
  flex: 0 0 calc(50% - 10px);
}
.chart-grid:has(.chart-item:only-child) .chart-item {
  flex: 0 0 100%;
}

/* âœ… æ‰‹æ©Ÿä¸€æ¬„ï¼ˆé¸æ“‡æ€§ï¼‰ */
@media (max-width: 600px) {
  .chart-item { flex: 0 0 100%; }
}

/* tooltipå‹•ç•« */
.echarts-tooltip, .echarts-tooltip div { white-space: normal !important; }
.custom-tooltip { font-size: 13px; line-height: 1.5; }
.tooltip-line { position: relative; padding-bottom: 2px; margin: 2px 0; }
.tooltip-line .line-underline { position: absolute; bottom: 0; left: 0; height: 2px; width: 100%; background: transparent; }
.tooltip-line.active-line .line-underline {
  background: linear-gradient(90deg, transparent, red, transparent);
  background-size: 200% 100%;
  animation: underline-flow 1.5s linear infinite;
}
@keyframes underline-flow { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body>

<h2>ğŸ“Š è‡ªé©æ‡‰ä¸‰åˆ—å¤šè¡Œ ECharts åœ–è¡¨ï¼ˆautoDataZoom + å‹•æ…‹ xlabelMode + legendModeï¼‰</h2>
<div class="chart-grid" id="chartContainer"></div>
<!-- Modal -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">åœ–è¡¨æ”¾å¤§</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalChart" style="width:100%;height:600px;"></div>
      </div>
    </div>
  </div>
</div>
<script>
const ChartUtil = {

  openInModal(cfg, onClose) {
    // è‹¥ Modal ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹
    let modalEl = document.getElementById('chartModal');
    if (!modalEl) {
      modalEl = document.createElement('div');
      modalEl.className = 'modal fade';
      modalEl.id = 'chartModal';
      modalEl.tabIndex = -1;
      modalEl.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="modalChart" style="width:100%;height:400px;"></div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modalEl);
    }

    const modalChartEl = modalEl.querySelector('#modalChart');
    modalEl.querySelector('.modal-title').textContent = cfg.title || 'åœ–è¡¨';

    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();

    // é¡¯ç¤ºå¾Œåˆå§‹åŒ– ECharts
    const shownHandler = () => {
      if (modalChartEl.chartInstance) {
        modalChartEl.chartInstance.dispose();
      }
      ChartUtil.renderChart(modalChartEl.id, cfg);
      modalEl.removeEventListener('shown.bs.modal', shownHandler);
    };
    modalEl.addEventListener('shown.bs.modal', shownHandler);

    // é—œé–‰å¾Œé‡‹æ”¾åœ–è¡¨èˆ‡å›å‘¼
    const hiddenHandler = () => {
      console.log('Modal å·²é—œé–‰');
      if (modalChartEl.chartInstance) {
        modalChartEl.chartInstance.dispose();
        modalChartEl.chartInstance = null;
      }
      if (typeof onClose === 'function') onClose();
      modalEl.removeEventListener('hidden.bs.modal', hiddenHandler);
    };
    modalEl.addEventListener('hidden.bs.modal', hiddenHandler);
  },
  renderChart: function(containerId, config){
    const container = document.getElementById(containerId);
    if(container.chartInstance) container.chartInstance.dispose();
    //const chart = echarts.init(container);
	
	 const chart = echarts.init(container, null, {
  // è‡ªå‹•åµæ¸¬è£ç½® pixel ratio
  renderer: 'canvas',
  devicePixelRatio: window.devicePixelRatio || 1
});
    container.chartInstance = chart;
    const isMobile = window.innerWidth < 600;

    // === Legend è¨­å®šï¼ˆæ–°å¢ legendMode æ§åˆ¶ï¼‰
    const legendMode = config.legendMode || 'scroll'; // scroll / wrap / none
    const legendBase = (config.type==='pie')
      ? (isMobile?{orient:'horizontal',top:'10%',left:'center'}:{orient:'vertical',left:'5%',top:'10%'})
      : (isMobile?{top:0,left:'center'}:{orient:'horizontal',top:'10%',left:'center'});
    const legendOption = (legendMode==='none') ? {show:false} : {
      ...legendBase,
      type: legendMode==='scroll' ? 'scroll' : 'plain',
      itemGap: 10,
      padding: [5,5,5,5],
      textStyle:{fontSize:12}
    };

    // === Grid padding
    const gridPadding = isMobile ? { left:'10%', right:'10%', bottom:'15%', containLabel:true } : { left:'5%', right:'5%', bottom:'10%' , containLabel:true};

    // === XLabel è‡ªå‹•è™•ç†
    function getXAxisLabelOption(categories, mode){
      const maxLen = 8;
      if(mode==='auto'){
        if(categories.length > 10){
          return { interval:0, rotate: categories.some(v=>v.length>maxLen)?45:30, fontSize:12 };
        } else return { interval:0, rotate:0, fontSize:12 };
      }
      switch(mode){
        case 'wrap': return {interval:0, rotate:0, formatter:v=>v.length>maxLen?v.match(new RegExp('.{1,'+maxLen+'}','g')).join('\n'):v,fontSize:12};
        case 'rotate': return {interval:0, rotate: categories.some(v=>v.length>maxLen)?(isMobile?30:45):0,formatter:'{value}',fontSize:12};
        case 'alternate': return {interval:0, formatter:(v,i)=>i%2===0?v:'\n'+v,fontSize:12};
        default: return {interval:0,formatter:'{value}',fontSize:12};
      }
    }

    // === è¨ˆç®—é–“è·é¿å… title / legend ç–Š
    const titleHeight = config.title?40:0;
    const legendRows = (legendMode==='wrap')
      ? Math.ceil((config.series?.length||1)/6)
      : 1;
    const legendHeight = (legendMode==='none')?0:(legendRows*30);
    const gridTop = titleHeight + legendHeight + 30; // +30 æä¾›å®‰å…¨é–“è·

    // === dataZoom
    let dataZoomOption;
    if(typeof config.autoDataZoom === 'number'){
      const N = config.categories.length;
      if(config.autoDataZoom === -1){
        dataZoomOption = undefined;
      } else if(config.autoDataZoom > 0 && N > config.autoDataZoom){
        const end = (config.autoDataZoom / N) * 100;
        dataZoomOption = [{ type:'slider', xAxisIndex:0, start:0, end }];
      }
    }
const bgColor = getComputedStyle(document.body).backgroundColor;
    // === çµ„åˆ Option
	
	  // ä½¿ç”¨ axisTitleMap è¨­å®š title / X / Y è»¸
  const chartTitle = config.axisTitleMap['title'] || config.title ;
  const xTitle = config.axisTitleMap[config.xlabel] || config.xlabel;
  const yTitle = config.axisTitleMap[config.ylabel] || config.ylabel;

	// tooltip formatter
    const formatterFunc = (params) => {
              let str = `<div class="custom-tooltip"><div class="tooltip-title">${params[0].axisValue}</div>`;
			   const activeSeries = chart._hoveredSeries || null;
              params.forEach(p=>{
                const valueStr = (config.type==='stackedPercent' && p.data.rawValue!==undefined)? `${p.data.rawValue} (${p.value}%)`:p.value;
                const activeClass = (p.seriesName===activeSeries)?'active-line':'';
                str += `<div class="tooltip-line ${activeClass}">${p.marker}${p.seriesName}: ${valueStr}<span class="line-underline"></span></div>`;
              });
              str += '</div>'; return str;
            };
    let option = {};
    switch(config.type){
      case 'bar': case 'grouped': case 'stacked': case 'stackedPercent': case 'line': case 'mixed':
        option = {
		 backgroundColor: bgColor,
 
          title:{ text: chartTitle, left:'center' },
          legend: legendOption,
          grid: Object.assign({}, gridPadding, { top:gridTop }),
          tooltip:{
            trigger:'axis',
            axisPointer:{ type:'shadow'
			},
            enterable:true,
            formatter: formatterFunc
          },
          xAxis:{ type:'category', data: config.categories,  nameGap:40,    nameLocation: 'center',name: xTitle, axisLabel:getXAxisLabelOption(config.categories, config.xlabelMode) },
          yAxis:{ type:'value', name: yTitle, min:0, max: config.type==='stackedPercent'?100:undefined, axisLabel:{  margin: 20,formatter:config.type==='stackedPercent'?'{value}%':'{value}'} },
          series: config.series.map((s,i)=>({
            name: s.name,
            type: s.type || (config.type==='line'?'line':'bar'),
            stack: (config.type==='stacked' || config.type==='stackedPercent')?'total':undefined,
            label:{ show:s.type!=='line', position:'top', formatter: config.type==='stackedPercent'?'{c}%':'{c}' },
            data: s.data,
            itemStyle:{ color: config.colors?.[i] },
            smooth: s.type==='line'?true:false
          })),
          dataZoom: dataZoomOption
        };
        break;

      case 'pie':
        const pieData = config.series.map((s,i)=>({
          name:s.name,
          value:s.data.reduce((a,b)=>a+b,0),
          itemStyle:{ color: config.colors?.[i] }
        }));
        option = {
          title:{ text: config.title, left:'center' },
          tooltip:{ trigger:'item', formatter:'{a}<br/>{b}: {c} ({d}%)' },
          legend: legendOption,
          series:[{
            name: config.ylabel||'ç¸½å’Œ',
            type:'pie',
            radius:['40%','70%'],
            center:isMobile?['50%','55%']:['65%','55%'],
            data:pieData,
            label:{formatter:'{b}: {d}%'}
          }]
        };
        break;
    }

    chart.setOption(option);
    chart.resize();
chart.getOption().series.forEach((s, i) => {
  chart.on('mouseover', function(params){
    if(params.seriesIndex === i){
      chart._hoveredSeries = params.seriesName;
    }
  });
  chart.on('mouseout', function(params){
    if(params.seriesIndex === i){
      chart._hoveredSeries = null;
    }
  });
});
    // === å‹•æ…‹èª¿æ•´ XLabel
    function updateXAxisLabel(el){
      if(!chart.getOption().xAxis) return;
      const axis = chart.getOption().xAxis[0];
      if(!axis) return;
      let visibleCategories = axis.data;
      const dz = chart.getOption().dataZoom?.[0];
      if(dz){
        const total = axis.data.length;
        const startIndex = Math.floor(dz.start/100*total);
        const endIndex = Math.ceil(dz.end/100*total);
        visibleCategories = axis.data.slice(startIndex,endIndex);
      }
      const newLabel = getXAxisLabelOption(visibleCategories, config.xlabelMode);
      chart.setOption({ xAxis:[{ axisLabel: newLabel }] });
	  
	    const resizeObserver = new ResizeObserver(() => chart.resize());
  resizeObserver.observe(el);
  // âœ… é é˜² SPA æˆ–è¼‰å…¥å»¶é²ï¼Œåˆæ¬¡è£œä¸€åˆ€
  setTimeout(() => chart.resize(), 100);
    }

    updateXAxisLabel(container);
    chart.on('dataZoom', updateXAxisLabel(container));
	
	
    window.addEventListener('resize', ()=>{ chart.resize(); updateXAxisLabel(container); });
    return chart;
  }
};

// ç¯„ä¾‹è³‡æ–™
const rawData = [
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABp","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AAc","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHy" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAs","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAk","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHa" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHz" },
  { "ACT_LV1":"AAb","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHz" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHu" },
  { "ACT_LV1":"ABp","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABe","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AAc","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABx","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAxs","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAk","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABcz","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHz" },
  { "ACT_LV1":"AAbz","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABzc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHz" }
]

// === å»ºç«‹åœ–è¡¨è¨­å®š ===
function buildChartConfig(data, opts={}) {
  const { valueField='EM_TOTAL', xField='ACT_LV1', groupField='SITE', chartType='bar', title='åœ–è¡¨', axisTitleMap, xlabel=xField, ylabel=valueField, xlabelMode='auto', colors=[], autoDataZoom=0, legendMode='scroll' } = opts;
  if(!Array.isArray(data)||data.length===0) return { type:chartType, title, categories:[], series:[], autoDataZoom };
  const categories = [...new Set(data.map(d=>d[xField]))];
  let series = [];
  if(chartType==='pie'){
    const groups = groupField?[...new Set(data.map(d=>d[groupField]))]:categories;
    series = groups.map(g=>({ name:g, data:[data.filter(d=>groupField?d[groupField]===g:d[xField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0)] }));
  } else {
    const groups = groupField?[...new Set(data.map(d=>d[groupField]))]:[];
    if(chartType==='stackedPercent'){
      series = groups.map(g=>({ name:g, data:categories.map(cat=>{
        const total = data.filter(d=>d[xField]===cat).reduce((sum,d)=>sum+Number(d[valueField]||0),0);
        const val = data.filter(d=>d[xField]===cat && d[groupField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0);
        return { value: total?((val/total)*100).toFixed(2):0, rawValue: val };
      })}));
    } else {
      series = groups.map((g,i)=>({ name:g, type: chartType==='mixed' && i===1?'line':undefined, data:categories.map(cat=>data.filter(d=>d[xField]===cat && d[groupField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0)) }));
    }
  }
  return { type:chartType, title, xlabel, ylabel, xlabelMode, categories, series, colors, autoDataZoom, legendMode,axisTitleMap };
}
const axisMap = {
  title: 'å †ç–Šåœ–ç¤ºä¾‹',
  ACT_LV1: 'æ´»å‹•ç­‰ç´š',
  EM_TOTAL: 'ç¸½é‡',
  SITE: 'ç«™é»'
};

// === ç”Ÿæˆåœ–è¡¨ ===
const charts = [
  buildChartConfig(rawData,{ chartType:'stacked', title:'å †ç–Šåœ–ç¤ºä¾‹', legendMode:'wrap', axisTitleMap:axisMap }),
  buildChartConfig(rawData,{ chartType:'stackedPercent', title:'ç™¾åˆ†æ¯”å †ç–Šåœ–', autoDataZoom:20, legendMode:'scroll', axisTitleMap:axisMap }), 
    buildChartConfig(rawData,{ chartType:'grouped', title:'ç¾¤çµ„ç›´æ¢åœ–', autoDataZoom:20, axisTitleMap:axisMap }),
  buildChartConfig(rawData,{ chartType:'pie', title:'åœ“é¤…åœ–ç¤ºä¾‹', legendMode:'scroll', axisTitleMap:axisMap }),
 // buildChartConfig(rawData,{ chartType:'line', title:'æŠ˜ç·šåœ–ç¤ºä¾‹', autoDataZoom:10 }),
 // buildChartConfig(rawData,{ chartType:'mixed', title:'æŸ±ç‹€+æŠ˜ç·šæ··åˆ', colors:['#3b82f6','#f97316'], autoDataZoom:20 })
];

const container = document.getElementById('chartContainer');
charts.forEach((cfg,i)=>{
  const div = document.createElement('div');
  div.className='chart-item';
  div.id='chart'+i;
  container.appendChild(div);
  const chart= ChartUtil.renderChart(div.id,cfg);
   
   // é»æ“Šå°åœ–è¡¨ â†’ modal æ”¾å¤§
  div.addEventListener('click', ()=>{
   ChartUtil.openInModal(cfg, () => {
    console.log('ä½¿ç”¨è€…é—œé–‰ Modal');
  });
  });
  
  
});

 
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>SPA iframe cache</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<style>
#menu { padding: 10px; }
#menu button { margin-right: 10px; }
#iframeContainer { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 10px; }
</style>
</head>
<body>

<div id="menu">
  <button data-url="page1.html">è¼‰å…¥ Page 1</button>
  <button data-url="page2.html">è¼‰å…¥ Page 2</button>
  <button id="clearCache">æ¸…é™¤å¿«å–</button>
</div>

<div id="iframeContainer">
  <iframe id="spaFrame" src="" width="100%" height="100%" frameborder="0"></iframe>
</div>

<script>
(function($){

  // --- å¿«å–ç‰©ä»¶ ---
  const iframeCache = {};

  // --- å¿«å–è¼‰å…¥å™¨ ---
  function loadPageWithCache(url){
    const $iframe = $('#spaFrame');

    if(iframeCache[url]) {
      console.log('âœ… ä½¿ç”¨å¿«å–:', url);
      // ç›´æ¥ç”¨ Blob URL æ›¿ä»£è¼‰å…¥ï¼ˆä¸å†é‡æ–°è«‹æ±‚ï¼‰
      const blob = new Blob([iframeCache[url]], {type: 'text/html'});
      const blobUrl = URL.createObjectURL(blob);
      $iframe.attr('src', blobUrl);
    } else {
      console.log('ğŸŒ å¾ä¼ºæœå™¨è¼‰å…¥:', url);
      $.get(url, function(html){
        iframeCache[url] = html; // å­˜å…¥å¿«å–
        const blob = new Blob([html], {type: 'text/html'});
        const blobUrl = URL.createObjectURL(blob);
        $iframe.attr('src', blobUrl);
      }).fail(()=>{
        alert('è¼‰å…¥å¤±æ•—ï¼š' + url);
      });
    }
  }

  // --- ç¶å®šäº‹ä»¶ ---
  $('#menu button[data-url]').on('click', function(){
    const url = $(this).data('url');
    loadPageWithCache(url);
  });

  $('#clearCache').on('click', function(){
    Object.keys(iframeCache).forEach(k => delete iframeCache[k]);
    alert('å¿«å–å·²æ¸…é™¤');
  });

})(jQuery);
</script>

</body>
</html>
console.time('iframeLoad');
$('#spaFrame').on('load', function(){
    console.timeEnd('iframeLoad');
});
