
using mvc5.autofac;
using mvc5.Service;
using Newtonsoft.Json;
using Quartz;
using Quartz.Impl.Matchers;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using System.Web.Mvc;
using static Quartz.Logging.OperationName;

namespace mvc5.Controllers
{
    // å‹•æ…‹æŸ¥è©¢æ¨¡å‹
    public class DynamicFilter
    {
        public string TableName { get; set; } = "";
        public Dictionary<string, object> Conditions { get; set; } = new Dictionary<string, object>();
    }

    // JobViewModel å¯æ ¹æ“šéœ€è¦å‹•æ…‹ç”¢ç”Ÿæ¬„ä½
    public class Field
    {
        public string Id { get; set; }
        public string Label { get; set; }
        public string Type { get; set; } // select, text, checkbox
        public List<string> Options { get; set; } = new List<string>();
        public string DefaultValue { get; set; }
    }
    public class EmployeeController : Controller
    {
        public ActionResult Index()
        {
            return View();
        }
        // å–å¾—å‰ç«¯è¦ç”Ÿæˆçš„å‹•æ…‹æ¬„ä½
        public JsonResult GetFields(string tableName)
        {
            // ç¯„ä¾‹: æ ¹æ“š tableName å›å‚³ä¸åŒæ¬„ä½
            var fields = new List<Field>();

            if (tableName == "Employees")
            {
                fields.Add(new Field { Id = "Department", Label = "éƒ¨é–€", Type = "select", Options = new List<string> { "HR", "IT", "Sales" }, DefaultValue = "IT" } );
                fields.Add(new Field { Id = "Active", Label = "ç‹€æ…‹", Type = "select", Options = new List<string> { "Active", "Inactive" } });
                fields.Add(new Field { Id = "Name", Label = "å§“å", Type = "text" });
            }
            else if (tableName == "Departments")
            {
                fields.Add(new Field { Id = "Location", Label = "åœ°é»", Type = "select", Options = new List<string> { "Taipei", "Kaohsiung" } });
                fields.Add(new Field { Id = "Manager", Label = "ç¶“ç†", Type = "text" });
            }

            return Json(fields, JsonRequestBehavior.AllowGet);
        }
        [HttpGet]
        public JsonResult GetSearchFields()
        {
            // å¾Œç«¯æ±ºå®šå“ªäº›æ¬„ä½è¦é¡¯ç¤º
            var fields = new List<object>
        {
            new { Type = "select", Id = "department", Label = "éƒ¨é–€", Options = new[] { "HR", "IT", "Sales" }  },
            new { Type = "text", Id = "name", Label = "å§“å" },
            new { Type = "checkbox", Id = "active", Label = "åŒ…å«é›¢è·å“¡å·¥" }
        };

            return Json(fields, JsonRequestBehavior.AllowGet);
        }
        [HttpGet]
        public JsonResult GetTableDefinition()
        {
            // å¾Œç«¯æ±ºå®š DataTable æ¬„ä½
            var columns = new[]
            {
            new { data = "Id", title = "ç·¨è™Ÿ" },
            new { data = "Name", title = "å§“å" },
            new { data = "Department", title = "éƒ¨é–€" },
            new { data = "Active", title = "ç‹€æ…‹" },
            new { data = "HireDate", title = "åˆ°è·æ—¥" }
        };
            return Json(columns, JsonRequestBehavior.AllowGet);
        }
        [HttpGet]
        public JsonResult GetDepartments()
        {
            var list = new[] { "HR", "IT", "Sales", "Finance", "Admin" };
            return Json(list, JsonRequestBehavior.AllowGet);
        }
        Dictionary<string, string> auto = new Dictionary<string, string>();
        // âœ… æ¨¡æ“¬è³‡æ–™ä¾†æº (å¯¦å‹™ä¸Šå¯æ”¹ç‚ºè³‡æ–™åº«æŸ¥è©¢)
        private DataTable GetMockData()
        {
            auto["Department"] = "D";
            auto["Active"] = "C";
            auto["Name"] = "T";
            var dt = new DataTable();
            dt.Columns.Add("Id", typeof(int));
            dt.Columns.Add("Name", typeof(string));
            dt.Columns.Add("Department", typeof(string));
            dt.Columns.Add("Active", typeof(bool));
            dt.Columns.Add("HireDate", typeof(DateTime));
            dt.Columns.Add("Auto", typeof(bool));

            dt.Rows.Add(1, "John", "HR", true, DateTime.Now.AddYears(-3));
            dt.Rows.Add(2, "Mary", "IT", true, DateTime.Now.AddYears(-1));
            dt.Rows.Add(3, "Tom", "Sales", false, DateTime.Now.AddYears(-5));
            dt.Rows.Add(4, "Jane", "IT", true, DateTime.Now.AddYears(-2));
            dt.Rows.Add(5, "Kevin", "Sales", false, DateTime.Now.AddYears(-4));

            return dt;
        }

        // âœ… DataTables AJAX ç«¯é»
        [HttpPost]
        public JsonResult SearchEmployees(EmployeeFilter filter)
        {
            var dt = GetMockData();

            var query = dt.AsEnumerable();

            // æ¨¡æ“¬ç¯©é¸æ¢ä»¶
            if (!string.IsNullOrEmpty(filter.Department))
                query = query.Where(r => r.Field<string>("Department") == filter.Department);

            if (!string.IsNullOrEmpty(filter.Keyword))
                query = query.Where(r => r.Field<string>("Name").Contains(filter.Keyword));

            if (!filter.IncludeInactive)
                query = query.Where(r => r.Field<bool>("Active"));

            var result = query.Select(r => new
            {
                Id = r.Field<int>("Id"),
                Name = r.Field<string>("Name"),
                Department = r.Field<string>("Department"),
                Active = r.Field<bool>("Active") ? "Active" : "Inactive",
                HireDate = r.Field<DateTime>("HireDate").ToString("yyyy-MM-dd")
            }).ToList();

            return Json(new { data = result }, JsonRequestBehavior.AllowGet);
        }

        // å‹•æ…‹æŸ¥è©¢
        [HttpPost]
        public JsonResult Search([Microsoft.AspNetCore.Mvc.FromBody] DynamicFilter filter)
        {
            if (string.IsNullOrEmpty(filter.TableName))
                return Json(new { data = new List<object>() });

          

            var dt = GetMockData();

            var query = dt.AsEnumerable();

            foreach (var kv in filter.Conditions)
            {
                //if (kv.Value is string str && str.Contains("%"))
                //    whereClauses.Add($"{kv.Key} LIKE @{kv.Key}");
                //else
                query = query.Where(r => r.Field<string>(kv.Key) == kv.Value.ToString());
                //    ////whereClauses.Add($"{kv.Key} = @{kv.Key}");
            }


            //// æ¨¡æ“¬ç¯©é¸æ¢ä»¶
            //if (!string.IsNullOrEmpty(filter.Department))
            //    query = query.Where(r => r.Field<string>("Department") == filter.Department);

            //if (!string.IsNullOrEmpty(filter.Keyword))
            //    query = query.Where(r => r.Field<string>("Name").Contains(filter.Keyword));

            //if (!filter.IncludeInactive)
            //    query = query.Where(r => r.Field<bool>("Active"));

            var result = query.Select(r => new
            {
                Id = r.Field<int>("Id"),
                Name = r.Field<string>("Name"),
                Department = r.Field<string>("Department"),
                Active = r.Field<bool>("Active") ? "Active" : "Inactive",
                HireDate = r.Field<DateTime>("HireDate").ToString("yyyy-MM-dd")
            }).ToList();

            ////string sql = BuildDynamicSql(filter);

            ////using (var conn = new SqlConnection(ConfigurationManager.ConnectionStrings["DefaultConnection"].ConnectionString))
            ////using (var cmd = new SqlCommand(sql, conn))
            ////{
            ////    foreach (var kv in filter.Conditions)
            ////        cmd.Parameters.AddWithValue("@" + kv.Key, kv.Value ?? DBNull.Value);

            ////    var da = new SqlDataAdapter(cmd);
            ////    da.Fill(dt);
            ////}

            return Json(new { data = result }, JsonRequestBehavior.AllowGet);
        }

        private string BuildDynamicSql(DynamicFilter filter)
        {
            var whereClauses = new List<string>();

            foreach (var kv in filter.Conditions)
            {
                if (kv.Value is string str && str.Contains("%"))
                    whereClauses.Add($"{kv.Key} LIKE @{kv.Key}");
                else
                    whereClauses.Add($"{kv.Key} = @{kv.Key}");
            }

            string whereSql = whereClauses.Any() ? "WHERE " + string.Join(" AND ", whereClauses) : "";
            string sql = $"SELECT * FROM {filter.TableName} {whereSql}";
            return sql;
        }
    }
    public class EmployeeFilter
    {
        public string Department { get; set; }
        public string Keyword { get; set; }
        public bool IncludeInactive { get; set; }
    }
}

@{
    ViewBag.Title = "å‹•æ…‹æŸ¥è©¢ç¯„ä¾‹";
}

<h2>å‹•æ…‹æŸ¥è©¢ + DataTable</h2>

<div>
    é¸æ“‡è¡¨ï¼š
    <select id="tableSelector" class="form-control input-sm">
        <option value="">è«‹é¸æ“‡è¡¨</option>
        <option value="Employees">Employees</option>
        <option value="Departments">Departments</option>
    </select>
</div>

<div id="filterArea" class="form-row mt-3"></div>

<button id="btnSearch" class="btn btn-primary mt-2">æŸ¥è©¢</button>

<hr />

<div id="tableWrapper" class="mt-3"></div>

@section Scripts{
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        let fields = [];
        let table;

        // ç•¶é¸æ“‡è¡¨æ ¼æ™‚ï¼Œå‹•æ…‹ç”ŸæˆæŸ¥è©¢æ¬„ä½
        $("#tableSelector").on("change", function() {
            const tableName = $(this).val();
            $("#filterArea").empty();
            $("#tableWrapper").empty();

            if (!tableName) return;

            $.getJSON('/Employee/GetFields', { tableName: tableName }, function(result){
                fields = result;
                const $area = $("#filterArea");

                fields.forEach(f => {
                    let html = '';
                      let defaultValue = f.DefaultValue || ''; // é è¨­å€¼
                    if (f.Type === "select") {
                        html += `<label for="${f.Id}">${f.Label}</label>`;
                        html += `<select id="${f.Id}" class="form-control input-sm">`;
                        html += `<option value="">å…¨éƒ¨</option>`;
                         f.Options.forEach(opt => {
      const selected = (opt === defaultValue) ? 'selected' : '';
      html += `<option value="${opt}" ${selected}>${opt}</option>`;
  });
                        html += `</select>`;
                    } else if (f.Type === "text") {
                         html += `<label for="${f.Id}">${f.Label}</label>`;
   html += `<input id="${f.Id}" type="text" class="form-control input-sm" value="${defaultValue}" />`;
                    } else if (f.Type === "checkbox") {
                      const checked = (defaultValue === true) ? 'checked' : '';
 html += `<label><input type="checkbox" id="${f.Id}" ${checked}> ${f.Label}</label>`;
                    }
                    $area.append(`<div class="form-group mr-2 d-inline-block">${html}</div>`);
                });

                // ç”¢ç”ŸDataTableå®¹å™¨
                $("#tableWrapper").html(`<table id="dataTable" class="display" style="width:100%"><thead></thead></table>`);
                $("#btnSearch").trigger("click");

              //  table = $('#dataTable').DataTable({
             //       columns: [], // ç­‰æŸ¥è©¢å¾Œå‹•æ…‹ç”Ÿæˆ
             //   });
            });
        });

        $("#btnSearch").on("click", function() {
            const filter = {
                TableName: $("#tableSelector").val(),
                Conditions: {}
            };

            fields.forEach(f => {
                const val = $(`#${f.Id}`).val();
                if (val !== null && val !== "")
                    filter.Conditions[f.Id] = val;
            });

            $.ajax({
                url: '/Employee/Search',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(filter),
                success: function(result) {
                    if (!result.data || !result.data.length) return;

                    // å‹•æ…‹ç”Ÿæˆæ¬„ä½
                    const keys = Object.keys(result.data[0]);
                    const columns = keys.map(k => ({ title: k, data: k }));

                    if ($.fn.DataTable.isDataTable('#dataTable')) {
                        table.destroy();
                        $('#dataTable').remove();
                        $("#tableWrapper").html('<table id="dataTable" class="display" style="width:100%"><thead></thead></table>');
                    }

                    table = $('#dataTable').DataTable({
                        data: result.data,
                        columns: columns
                    });
                }
            });
        });
    </script>
}


@{
    ViewBag.Title = "å“¡å·¥æŸ¥è©¢";
}

<h2>å“¡å·¥æŸ¥è©¢</h2>
<style>
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* æ¯æ ¼æœ€å°220pxï¼Œè‡ªå‹•å¡«æ»¿ */
        gap: 12px 16px; /* åˆ—é–“è·ã€è¡Œé–“è· */
        align-items: center;
    }

    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .form-group select,
    .form-group input[type="text"] {
        width: 100%;
        padding: 4px 6px;
        box-sizing: border-box;
    }

    .form-group input[type="checkbox"] {
        margin-right: 4px;
    }

  /*  .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
*/
   /* .modal-content {
        background: #fff;
        border-radius: 10px;
        width: 500px;
        max-width: 90%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        overflow: hidden;
    }*/
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 15px;
        max-width: 800px;
        width: 80%;
        max-height: 90%;
        overflow-y: auto;
        transition: all 0.3s ease;
    }

        /* ğŸ”¹ å…¨è¢å¹•æ¨£å¼ */
        .modal-content.fullscreen {
            width: 95%;
            height: 90%;
            max-width: none;
            max-height: none;
        }
    .modal-header, .modal-footer {
        padding: 10px 16px;
        background: #f5f5f5;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px 16px;
    }

    .close {
        cursor: pointer;
        font-size: 22px;
    }

    .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #007bff;
        color: #fff;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: #fff;
    }

</style>

<div>
    é¸æ“‡è¡¨ï¼š
    <select id="tableSelector" class="form-control input-sm">
        <option value="">è«‹é¸æ“‡è¡¨</option>
        <option value="Employees">Employees</option>
        <option value="Departments">Departments</option>
    </select>
</div>
<!-- ğŸ” æŸ¥è©¢å€ -->
<div id="searchArea" class="form-grid"><!-- é€™æ˜¯ä½”ä½ç¬¦ --></div>

<button id="btnSearch" style="margin-top:10px;">æŸ¥è©¢</button>
<button id="btnShow">é–‹å•Ÿç¯„ä¾‹ Modal</button>

<!-- ğŸ“‹ è³‡æ–™è¡¨ -->
<!-- Table ä½”ä½ç¬¦ -->
<table id="empTable" class="display" style="width:100%">
    <thead>
        <tr id="empHeaderRow"></tr>
    </thead>
</table>
<!-- Modal çµæ§‹ -->
<div id="myModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle"></h3>
            <span id="modalClose" class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="modalFieldsArea" class="form-grid"></div> <!-- é€™è£¡æ˜¯å‹•æ…‹ç”¢ç”Ÿæ¬„ä½çš„åœ°æ–¹ -->
            <div id="modalBody">
                
                <table id="empTable2" class="display" style="width:100%">
                    <thead>
                        <tr id="empHeaderRow2"></tr>
                    </thead>
                </table>
                
                </div>       <!-- é€™è£¡å¯æ”¾å…¶ä»–å…§å®¹æˆ–çµæœ -->

        </div>
        <div class="modal-footer">
            <button id="modalCancel" class="btn btn-secondary">é—œé–‰</button>
            <button id="modalOk" class="btn btn-primary">ç¢ºå®š</button>
        </div>
    </div>
</div>
@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />

    <script>
$(async function () {
    // 1ï¸âƒ£ å¾å¾Œç«¯å–å¾—æ¬„ä½è¨­å®š
    const fields = await $.get('@Url.Action("GetSearchFields", "Employee")');
    const columns = await $.get('@Url.Action("GetTableDefinition", "Employee")');
    const $area = $('#searchArea');
    const $area2 = $('#modalFieldsArea');
    const $theadRow = $('#empHeaderRow');
    const $theadRow2 = $('#empHeaderRow2');
    // 2ï¸âƒ£ å‹•æ…‹ç”¢ç”Ÿæ¬„ä½
    $area.empty();
    $area2.empty();

    fields.forEach(f => {
        let html = '';
        let defaultValue = f.DefaultValue || ''; // é è¨­å€¼
        if (f.Type === "select") {
            html += `<label for="${f.Id}">${f.Label}</label>`;
            html += `<select id="${f.Id}" class="form-control input-sm">`;
            html += `<option value="">å…¨éƒ¨</option>`;
            f.Options.forEach(opt => {
                const selected = (opt === defaultValue) ? 'selected' : '';
                html += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            html += `</select>`;
        } else if (f.Type === "text") {
            html += `<label for="${f.Id}">${f.Label}</label>`;
            html += `<input id="${f.Id}" type="text" class="form-control input-sm" value="${defaultValue}" />`;
        } else if (f.Type === "checkbox") {
            const checked = (defaultValue === true) ? 'checked' : '';
            html += `<label><input type="checkbox" id="${f.Id}" ${checked}> ${f.Label}</label>`;
        }

        $area.append(`<div class="form-group">${html}</div>`);
    });
    // 3ï¸âƒ£ å‹•æ…‹ç”¢ç”Ÿ thead
    columns.forEach(col => {
        $theadRow.append(`<th>${col.title}</th>`);
    });
    // 3ï¸âƒ£ åˆå§‹åŒ– DataTable
     // 4ï¸âƒ£ åˆå§‹åŒ– DataTable
    const table = $('#empTable').DataTable({
        ajax: {
            url: '@Url.Action("SearchEmployees", "Employee")',
            type: 'POST',
            data: function (d) {
                fields.forEach(f => {
                    if (f.Type === "checkbox")
                        d[f.Id] = $(`#${f.Id}`).is(':checked');
                    else
                        d[f.Id] = $(`#${f.Id}`).val();
                });
            }
        },
        columns: columns,
        searching: false,
        paging: true
    });
    // 3ï¸âƒ£ å‹•æ…‹ç”¢ç”Ÿ thead
    columns.forEach(col => {
        $theadRow2.append(`<th>${col.title}</th>`);
    });
    const table2 = $('#empTable2').DataTable({
    ajax: {
        url: '@Url.Action("SearchEmployees", "Employee")',
        type: 'POST',
        data: function (d) {
            fields.forEach(f => {
                if (f.Type === "checkbox")
                    d[f.Id] = $(`#${f.Id}`).is(':checked');
                else
                    d[f.Id] = $(`#${f.Id}`).val();
            });
        }
    },
    columns: columns,
    searching: false,
    paging: true
});
    // 4ï¸âƒ£ æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
    $('#btnSearch').on('click', function () {
        table.ajax.reload();
    });

    // é–‹å•Ÿ modal
    function openModal(title, bodyHtml, onOk, fullscreen = false) {
        $("#modalTitle").text(title);
        const $modal = $("#myModal");
        const $content = $modal.find(".modal-content");
        const $area = $("#modalFieldsArea");
        $area2.empty(); // æ¸…ç©ºèˆŠå…§å®¹
        $content.removeClass("fullscreen"); // å…ˆç§»é™¤èˆŠæ¨£å¼

        // ğŸ”¹ æ˜¯å¦å…¨è¢å¹•
        if (fullscreen) {
            $content.addClass("fullscreen");
        }
        // ğŸ”¹ æ ¹æ“š fields å‹•æ…‹å»ºç«‹æ¬„ä½
        fields.forEach(f => {
            let html = '';
            if (f.Type === "select") {
                html += `<label for="${f.Id}">${f.Label}</label>`;
                html += `<select id="${f.Id}" class="form-control input-sm">`;
                html += `<option value="">å…¨éƒ¨</option>`;
                f.Options.forEach(opt => {
                    html += `<option value="${opt}">${opt}</option>`;
                });
                html += `</select>`;
            } else if (f.Type === "text") {
                html += `<label for="${f.Id}">${f.Label}</label>`;
                html += `<input id="${f.Id}" type="text" class="form-control input-sm" />`;
            } else if (f.Type === "checkbox") {
                html += `<label><input type="checkbox" id="${f.Id}"> ${f.Label}</label>`;
            }
            $area2.append(`<div class="form-group">${html}</div>`);
        });

        $("#myModal").fadeIn(150);

        // ç¶å®šç¢ºå®šäº‹ä»¶
        $("#modalOk").off("click").on("click", function () {
            if (onOk) onOk();
            closeModal();
        });
    }

    // é—œé–‰ modal
    function closeModal() {
        $("#myModal").fadeOut(150);
    }
    $("#btnShow").on("click", function () {

        // ç¯„ä¾‹ï¼šé»æ“ŠæŒ‰éˆ•é–‹å•Ÿ Modal ä¸¦ AJAX å–è³‡æ–™
        $("#btnShow").on("click", function () {
            let empId = 101; // å‡è¨­è¦æŸ¥çš„å“¡å·¥IDï¼Œå¯æ”¹æˆå¾ DataTable æ‹¿


            openModal("å‹•æ…‹æœå°‹æ¢ä»¶", fields,true,true);

            // å¯é¸ï¼šé–‹å•Ÿå¾Œå† AJAX å–å¾—åˆå§‹è³‡æ–™
            // $.get('/Employee/GetFilters', function(data) {
            //     openModal("æ¢ä»¶é¸æ“‡", data.fields);
            // });



            @*// å‘¼å«å¾Œç«¯ MVC Action
            $.ajax({
                url: '@Url.Action("SearchEmployees", "Employee")',
                type: 'GET',
                data: { id: empId },
                success: function (res) {


                    $("#modalBody").html(html);
                },
                error: function () {
                    $("#modalBody").html("<p style='color:red;'>è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>");
                }
            });*@
        });






//        openModal("å“¡å·¥æ˜ç´°", `
//     <div id="searchArea2" class="form-grid"><!-- é€™æ˜¯ä½”ä½ç¬¦ --></div>

//<button id="btnSearch2" style="margin-top:10px;">æŸ¥è©¢</button>
//    `, function () {
//            alert("ä½¿ç”¨è€…æŒ‰ä¸‹ç¢ºå®šï¼");
//        });
    });
    // ç¶å®šé—œé–‰æŒ‰éˆ•
    $(document).ready(function () {
        $("#modalClose, #modalCancel").on("click", closeModal);
    });
});
    </script>
}






