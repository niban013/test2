<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç¾¤çµ„ç‰ˆ PropertyGrid + å¤šç­† JSON åˆ‡æ› + æ–°å¢/åˆªé™¤</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; display: flex; gap: 20px; }
    .left, .right { flex: 1; }
    table.property-grid {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
      margin-bottom: 20px;
    }
    table.property-grid th, table.property-grid td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      vertical-align: middle;
    }
    table.property-grid th { background: #f0f0f0; text-align: left; width: 180px; }
    .readonly input, .readonly select { background: #eee; pointer-events: none; }
    .hint { color: #777; font-size: 12px; display: block; margin-top: 2px; }
    .group-header {
      background: #dfe9f3; font-weight: bold; cursor: pointer;
      padding: 8px 10px; border: 1px solid #bbb; user-select: none;
    }
    .group-header::before {
      content: "â–¸"; display: inline-block; margin-right: 6px; transition: transform 0.2s;
    }
    .group-header.open::before { transform: rotate(90deg); }
    .group-body { display: none; }
    .group-body.open { display: table-row-group; }
    textarea {
      width: 100%; height: 600px; font-family: monospace;
      font-size: 13px; border: 1px solid #ccc; border-radius: 6px;
      padding: 8px; box-sizing: border-box; background: #fafafa;
    }
    button, select {
      margin-top: 10px; padding: 6px 12px; font-size: 14px; cursor: pointer;
    }
    .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="left">
  <h2>âš™ï¸ ç¾¤çµ„ç‰ˆ PropertyGrid</h2>

  <div class="toolbar">
    <label>é¸æ“‡è³‡æ–™ç­†æ•¸ï¼š</label>
    <select id="recordSelector"></select>
    <button id="addRecord">ï¼‹ æ–°å¢</button>
    <button id="deleteRecord">ğŸ—‘ åˆªé™¤</button>
  </div>

  <div id="gridContainer"></div>
  <button id="showJson">ğŸ“¤ åŒ¯å‡º JSON</button>
</div>

<div class="right">
  <h2>ğŸ§¾ JSON è³‡æ–™ç·¨è¼¯å€</h2>
  <textarea id="jsonEditor"></textarea>
  <button id="importJson">ğŸ“¥ åŒ¯å…¥ JSON</button>
</div>

<script>
// ğŸ§© åˆå§‹å¤šç­†è³‡æ–™ï¼ˆåŠ ä¸Š pkï¼‰
  let models = [
  {
    "index": 0,
    "pk": "U1001",
    "Name": "Alice",
    "Age": 28,
    "IsActive": true,
    "Department": "IT",
    "Tags": ["HR", "Finance"],
    "Role": "User",
    "Note": "ä¸»è² è²¬äºº",
    "CreatedDate": "2024-09-10",
    "PermissionLevel": 3
  },
  {
    "index": 1,
    "pk": "U1002",
    "Name": "Bob",
    "Age": 34,
    "IsActive": false,
    "Department": "Sales",
    "Tags": ["Sales"],
    "Role": "Admin",
    "Note": "ä¸»ç®¡",
    "CreatedDate": "2024-08-01",
    "PermissionLevel": 5
  }
]


  // ğŸ§± Schema çµæ§‹ï¼ˆæ–°å¢ pk æ¬„ä½ï¼‰
  const schemaGroups = [
    {
      group: "åŸºæœ¬å±¬æ€§",
      properties: [
        { key: "pk", type: "string", label: "ä¸»éµ", readonly: true, hint: "è‡ªå‹•ç”¢ç”Ÿï¼Œä¸å¯ä¿®æ”¹" },
        { key: "Name", type: "string", label: "å§“å", hint: "å“¡å·¥å…¨å" },
        { key: "Age", type: "number", label: "å¹´é½¡" },
        { key: "IsActive", type: "boolean", label: "æ˜¯å¦å•Ÿç”¨" },
        { key: "Department", type: "enum", label: "éƒ¨é–€", options: ["HR", "IT", "Sales", "Finance"] }
      ]
    },
    {
      group: "é€²éšå±¬æ€§",
      properties: [
        {
          key: "Tags",
          type: "tomselect",
          label: "æ¨™ç±¤ (å¤šé¸)",
          options: [
            { key: "HR", value: "äººè³‡" },
            { key: "IT", value: "è³‡è¨Š" },
            { key: "Finance", value: "è²¡å‹™" },
            { key: "Sales", value: "éŠ·å”®" }
          ]
        },
        { key: "Role", type: "enum", label: "è§’è‰²", options: ["Admin", "User", "Guest"] },
        { key: "Note", type: "string", label: "å‚™è¨»", hint: "å¯å¡«å…¥èªªæ˜" },
        { key: "PermissionLevel", type: "number", label: "æ¬Šé™ç­‰ç´š" }
      ]
    },
    {
      group: "ç³»çµ±å±¬æ€§",
      properties: [
        { key: "CreatedDate", type: "string", label: "å»ºç«‹æ—¥æœŸ", readonly: true }
      ]
    }
  ];

  let currentIndex = 0;
  let model = { ...models[currentIndex] };

 
    // ğŸ”‘ ç”¢ç”Ÿå”¯ä¸€ pkï¼ˆUUID ç°¡åŒ–ç‰ˆï¼‰
  function generatePk() {
    return "U" + Math.random().toString(36).substring(2, 8).toUpperCase();
  }
 // ğŸª„ å±¬æ€§è®Šæ›´äº‹ä»¶
const onPropertyChanged = (key, value) => {
  models[currentIndex] = { ...model };

  // ğŸ”¢ æ¯ç­†åŠ ä¸Š index
  const indexedModels = models.map((m, i) => ({ index: i, ...m }));

  $("#jsonEditor").val(JSON.stringify(indexedModels, null, 2));
};

  // ğŸ§± å»ºç«‹ PropertyGrid
  function renderGroupedGrid(obj, groupedSchema) {
    const $container = $("#gridContainer").empty();

    groupedSchema.forEach(group => {
      const $header = $(`<div class="group-header">${group.group}</div>`);
      const $table = $('<table class="property-grid"><thead><tr><th>å±¬æ€§</th><th>å€¼</th></tr></thead></table>');
      const $tbody = $("<tbody class='group-body'></tbody>");
      $table.append($tbody);
      $container.append($header).append($table);

      // å±•é–‹/æ”¶åˆ
      $header.on("click", () => {
        const open = !$header.hasClass("open");
        $header.toggleClass("open", open);
        $tbody.toggleClass("open", open);
      });

      // æ¯å€‹æ¬„ä½
      group.properties.forEach(p => {
        const value = obj[p.key];
        const $tr = $("<tr>");
        const $label = $("<td>").html(`${p.label || p.key}${p.readonly ? " ğŸ”’" : ""}`);
        const $valCell = $("<td>");
        let $input;

        switch (p.type) {
          case "boolean":
            $input = $('<input type="checkbox">').prop("checked", !!value);
            $input.on("change", () => {
              obj[p.key] = $input.prop("checked");
              onPropertyChanged(p.key, obj[p.key]);
            });
            break;
          case "number":
            $input = $(`<input type="number" value="${value}">`);
            $input.on("input", () => {
              obj[p.key] = Number($input.val());
              onPropertyChanged(p.key, obj[p.key]);
            });
            break;
          case "enum":
            $input = $("<select></select>");
            p.options.forEach(opt => {
              const $opt = $(`<option value="${opt}">${opt}</option>`);
              if (opt === value) $opt.prop("selected", true);
              $input.append($opt);
            });
            $input.on("change", () => {
              obj[p.key] = $input.val();
              onPropertyChanged(p.key, obj[p.key]);
            });
            break;
          case "tomselect":
            $input = $('<select multiple class="tomSelect"></select>');
            p.options.forEach(opt => {
              const $opt = $(`<option value="${opt.key}">${opt.value}</option>`);
              $input.append($opt);
            });
            setTimeout(() => {
              const ts = new TomSelect($input[0], {
                valueField: "key",
                labelField: "value",
                searchField: ["value"],
                options: p.options,
                create: (input) => ({ key: input, value: input }),
                onChange: (vals) => {
                  obj[p.key] = vals;
                  onPropertyChanged(p.key, obj[p.key]);
                },
                render: {
                  option: (item, escape) => `<div>${escape(item.value)} (${escape(item.key)})</div>`,
                  item: (item, escape) => `<div>${escape(item.value)} (${escape(item.key)})</div>`
                }
              });
              ts.setValue(value);
            });
            break;
        default:
		  $input = $(`<input type="text" value="${value}">`);
		  $input.on("input", () => {
			obj[p.key] = $input.val();
			onPropertyChanged(p.key, obj[p.key]);

			// ğŸ”„ è‹¥ä¿®æ”¹çš„æ˜¯å§“åï¼Œæ›´æ–°ä¸‹æ‹‰é¸é …æ–‡å­—
			if (p.key === "Name") {
			  const $sel = $("#recordSelector option").eq(currentIndex);
			  const pk = models[currentIndex].pk;
			  const name = obj[p.key] || "æœªå‘½å";
			  $sel.text(`${currentIndex + 1} - ${name} (${pk})`);
			}
		  });
		  break;

        }

        if (p.readonly) $input.prop("disabled", true).addClass("readonly");
        $valCell.append($input);
        if (p.hint) $valCell.append(`<span class="hint">${p.hint}</span>`);
        $tr.append($label, $valCell);
        $tbody.append($tr);
      });
    });

    $(".group-header").addClass("open");
    $(".group-body").addClass("open");
  }

  // ğŸ”„ åŒ¯å‡º JSONï¼ˆåŠ ä¸Š indexï¼‰
$("#showJson").on("click", () => {
  const indexedModels = models.map((m, i) => ({ index: i, ...m }));
  $("#jsonEditor").val(JSON.stringify(indexedModels, null, 2));
});

   // ğŸ” åŒ¯å…¥ JSONï¼ˆè£œä¸Šç¼º pk çš„è³‡æ–™ï¼‰
  $("#importJson").on("click", () => {
    try {
      const parsed = JSON.parse($("#jsonEditor").val());
      models = Array.isArray(parsed) ? parsed : [parsed];
      models.forEach(m => {
        if (!m.pk) m.pk = generatePk(); // ğŸ”‘ è‹¥ç„¡ pk è‡ªå‹•è£œ
      });
      currentIndex = 0;
      updateRecordSelector();
      model = { ...models[currentIndex] };
      renderGroupedGrid(model, schemaGroups);
      $("#jsonEditor").val(JSON.stringify(models, null, 2));
    } catch {
      alert("âŒ JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªå…§å®¹æ˜¯å¦æ­£ç¢ºï¼");
    }
  });

  // ğŸ§­ æ›´æ–°ä¸‹æ‹‰é¸å–®
  function updateRecordSelector() {
    const $sel = $("#recordSelector").empty();
    models.forEach((m, i) => {
      const name = m.Name || "æœªå‘½å";
      $sel.append(`<option value="${i}">${i + 1} - ${name} (${m.pk})</option>`);
    });
    $sel.val(currentIndex);
  }


  $("#recordSelector").on("change", function() {
    currentIndex = Number($(this).val());
    model = { ...models[currentIndex] };
    renderGroupedGrid(model, schemaGroups);
  });

  // â• æ–°å¢ä¸€ç­†
$("#addRecord").on("click", function() {
  const template = JSON.parse(JSON.stringify(models[0]));
  template.pk = generatePk();
  template.Name = "æ–°ä½¿ç”¨è€…";
  template.CreatedDate = new Date().toISOString().slice(0,10);
  models.push(template);
  currentIndex = models.length - 1;
  model = { ...models[currentIndex] };
  updateRecordSelector();
  renderGroupedGrid(model, schemaGroups);

  const indexedModels = models.map((m, i) => ({ index: i, ...m }));
  $("#jsonEditor").val(JSON.stringify(indexedModels, null, 2));
});

// ğŸ—‘ åˆªé™¤ä¸€ç­†
$("#deleteRecord").on("click", function() {
  if (models.length === 0) return alert("âŒ æ²’æœ‰è³‡æ–™å¯åˆªé™¤ï¼");
  if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™å—ï¼Ÿ")) return;
  models.splice(currentIndex, 1);
  if (models.length === 0) {
    models = [{}];
  }
  currentIndex = Math.max(0, currentIndex - 1);
  model = { ...models[currentIndex] };
  updateRecordSelector();
  renderGroupedGrid(model, schemaGroups);

  const indexedModels = models.map((m, i) => ({ index: i, ...m }));
  $("#jsonEditor").val(JSON.stringify(indexedModels, null, 2));
});

  // åˆå§‹åŒ–
  updateRecordSelector();
  renderGroupedGrid(model, schemaGroups);
  $("#jsonEditor").val(JSON.stringify(models, null, 2));
</script>
</body>
</html>
