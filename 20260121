Models/OrderDto.cs
namespace SapFacadeMvc5.Models;

public class OrderDto
{
    public string OrderNo { get; set; }
    public DateTime OrderDate { get; set; }
    public decimal Amount { get; set; }
    public string CustomerName { get; set; }
}

Models/SapODataResponse.cs
using System.Collections.Generic;
using System.Text.Json.Serialization;

namespace SapFacadeMvc5.Models;

public class SapODataResponse<T>
{
    [JsonPropertyName("value")]
    public List<T> Value { get; set; }
}

public class SapOrderEntity
{
    public string OrderNo { get; set; }
    public DateTime OrderDate { get; set; }
    public decimal Amount { get; set; }
    public string CustomerName { get; set; }
}


ğŸ“Œ MVC5 ä¹Ÿå¯ä»¥ç”¨ System.Text.Json
ï¼ˆæˆ–ä½ åŸæœ¬å°±ç”¨ Newtonsoft ä¹Ÿ OKï¼‰

2ï¸âƒ£ Facade ä»‹é¢
Facades/ISapOrderFacade.cs
using SapFacadeMvc5.Models;

namespace SapFacadeMvc5.Facades;

public interface ISapOrderFacade
{
    Task<IReadOnlyList<OrderDto>> GetOrdersAsync(
        DateTime from,
        DateTime to);
}

3ï¸âƒ£ Facade å¯¦ä½œï¼ˆMVC5 é‡é»åœ¨é€™ï¼‰
Facades/SapOrderODataFacade.cs
using SapFacadeMvc5.Models;
using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text.Json;

namespace SapFacadeMvc5.Facades;

public class SapOrderODataFacade : ISapOrderFacade
{
    // MVC5ï¼šHttpClient å»ºè­°ã€Œé‡ç”¨ã€
    private static readonly HttpClient _client;

    static SapOrderODataFacade()
    {
        var handler = new HttpClientHandler
        {
            Proxy = new WebProxy("http://corp-proxy:8080"),
            UseProxy = true
        };

        _client = new HttpClient(handler)
        {
            BaseAddress = new Uri(
                System.Configuration.ConfigurationManager
                    .AppSettings["SapBaseUrl"]),
            Timeout = TimeSpan.FromSeconds(30)
        };

        var auth = Convert.ToBase64String(
            System.Text.Encoding.UTF8.GetBytes(
                System.Configuration.ConfigurationManager
                    .AppSettings["SapUser"] + ":" +
                System.Configuration.ConfigurationManager
                    .AppSettings["SapPassword"])
        );

        _client.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Basic", auth);
    }

    public async Task<IReadOnlyList<OrderDto>> GetOrdersAsync(
        DateTime from,
        DateTime to)
    {
        var filter =
            $"OrderDate ge datetime'{from:yyyy-MM-ddT00:00:00}' " +
            $"and OrderDate le datetime'{to:yyyy-MM-ddT23:59:59}'";

        var url =
            $"Orders?$filter={Uri.EscapeDataString(filter)}" +
            $"&$select=OrderNo,OrderDate,Amount,CustomerName";

        var response = await _client.GetAsync(url);
        response.EnsureSuccessStatusCode();

        var json = await response.Content.ReadAsStringAsync();

        var sapResult =
            JsonSerializer.Deserialize<
                SapODataResponse<SapOrderEntity>>(json);

        return sapResult?.Value
            .Select(x => new OrderDto
            {
                OrderNo = x.OrderNo,
                OrderDate = x.OrderDate,
                Amount = x.Amount,
                CustomerName = x.CustomerName
            })
            .ToList()
            ?? new List<OrderDto>();
    }
}

ğŸ“Œ MVC5 é—œéµæ³¨æ„

âŒ ä¸è¦æ¯æ¬¡ new HttpClient

âœ… static HttpClientï¼ˆæˆ– Singletonï¼‰

Proxy / Auth åœ¨ Facade è£¡è§£æ±º

4ï¸âƒ£ Web API Controllerï¼ˆMVC5ï¼‰
Controllers/OrdersController.cs
using SapFacadeMvc5.Facades;
using System.Web.Http;

namespace SapFacadeMvc5.Controllers;

[RoutePrefix("api/orders")]
public class OrdersController : ApiController
{
    private readonly ISapOrderFacade _sap;

    public OrdersController()
    {
        // MVC5 æ²’ DI å°±å…ˆé€™æ¨£ï¼ˆä¹‹å¾Œå¯æ› Autofacï¼‰
        _sap = new SapOrderODataFacade();
    }

    [HttpGet]
    [Route("")]
    public async Task<IHttpActionResult> Get(
        DateTime from,
        DateTime to)
    {
        var result = await _sap.GetOrdersAsync(from, to);
        return Ok(result);
    }
}

5ï¸âƒ£ WebApiConfigï¼ˆä¸€å®šè¦ï¼‰
App_Start/WebApiConfig.cs
using System.Web.Http;

public static class WebApiConfig
{
    public static void Register(HttpConfiguration config)
    {
        config.MapHttpAttributeRoutes();

        config.Routes.MapHttpRoute(
            name: "DefaultApi",
            routeTemplate: "api/{controller}/{id}",
            defaults: new { id = RouteParameter.Optional }
        );
    }
}

6ï¸âƒ£ Web.configï¼ˆSAP è¨­å®šï¼‰
<appSettings>
  <add key="SapBaseUrl" value="https://sap.example.com/odata/" />
  <add key="SapUser" value="SAP_USER" />
  <add key="SapPassword" value="SAP_PASSWORD" />
</appSettings>

å‘¼å«æ–¹å¼
GET /api/orders?from=2024-01-01&to=2024-01-31

MVC5 å¯¦æˆ°å»ºè­°ï¼ˆè¶…é‡è¦ï¼‰
âœ… ä¸€å®šè¦ Facade

SAP ä¸èƒ½ç›´æ¥åœ¨ Controller ç”¨ HttpClient

âœ… HttpClient é‡ç”¨

é¿å… socket exhaustion

âœ… Controller åªåš HTTP

å•†æ¥­é‚è¼¯åœ¨ Facade

âŒ ä¸è¦è®“ View / JS ç›´æ¥æ‰“ SAP
å¦‚æœä½ è¦ã€Œä¼æ¥­ç´š MVC5ã€
