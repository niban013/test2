<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESG Dashboard - å¸¶æµ®å‹•å­é¸å–®</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./i18n.js"></script>
<style>
body {
  overflow-x:hidden;
  margin:0;
  background-color:#f4f8f5; /* æŸ”å’Œç¶ åº• */
  font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
}

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: 240px;
  height: 100%;
  background: linear-gradient(180deg, #2b593f 0%, #1e3a2b 100%); /* æ·±ç¶ æ¼¸å±¤ */
  color: #e9f5ee;
  transition: all .3s ease-in-out;
  z-index: 1040;
  overflow-y: auto;
  box-shadow: 2px 0 6px rgba(0,0,0,0.2);
}
.sidebar a {
  color: #d2f0de;
  display: block;
  padding: 10px 15px;
  text-decoration: none;
  transition: all .2s;
}
.sidebar a:hover, .sidebar a.active {
  background: #5cb85c; /* ç¶ è‰²ä¸»èª¿ */
  color: #fff;
}

/* Submenu */
.sidebar .submenu { display: none; padding-left: 25px; }
.sidebar .submenu a {
  font-size: 0.9em;
  color: #c6e8d1;
}
.sidebar .submenu a:hover {
  background: rgba(255,255,255,0.1);
}
/* é˜²æ­¢å±•é–‹æ™‚ hover æˆ– active è®Šç™½ */
.sidebar .has-submenu.open > a,
.sidebar .has-submenu > a:hover {
  background: #2b593f !important;
  color: #fff !important;
}
/* Sidebar ç¸®èµ· */
.sidebar.collapsed { width: 60px; overflow: visible; }
.sidebar.collapsed a span.text { display: none; }

/* âœ… æµ®å‹•å­é¸å–®ï¼ˆç¸®é€²ç‹€æ…‹ä¸‹é¡¯ç¤ºï¼‰ */
.sidebar.collapsed .has-submenu:hover > .submenu {
  display: block !important;
  position: absolute;
  left: 60px;
  top: 0;
  background: #2f5c43;
  border-radius: 0 4px 4px 0;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
  width: 180px;
  padding: 5px 0;
  z-index: 1050;
}

/* Main Panel */
#main-panel {
  margin-left: 240px;
  transition: margin-left .3s ease-in-out;
  background-color: #f4f8f5;
  min-height: 100vh;
}
#main-panel.full { margin-left: 60px; }

/* Header */
#main-header {
  background: #e9f5ee;
  border-bottom: 1px solid #c8e3d0;
  height: 50px;
  padding: 0 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

#main-header .btn {
  background-color: #5cb85c;
  color: #fff;
  border: none;
  transition: background .2s;
}
#main-header .btn:hover { background-color: #4cae4c; }

#main-header .header-title {
  flex: 1;
  text-align: center;
  margin: 0;
  font-size: 17px;
  font-weight: 600;
  color: #2e4634;
  letter-spacing: 1px;
}
#main-header .user-info {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: #2b3b2b;
}
#logoutBtn {
  background-color: #e26a5c;
  border: none;
  color: #fff;
}
#logoutBtn:hover { background-color: #c9574c; }

/* Content */
#content-container {
  padding: 25px 35px;
  background: #f8fbf9;
  border-radius: 6px;
  margin: 15px;
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
}

/* Accordion Footer */
.accordion-footer {
  margin-top: 30px;
}
.accordion-footer .panel-heading {
  background: #d9f0df;
  border-top: 1px solid #b6dec0;
  cursor: pointer;
}
.accordion-footer .panel-title a {
  display: block;
  text-decoration: none;
  color: #2b3b2b;
  font-weight: 500;
}
.accordion-footer .panel-body {
  background: #f4f8f5;
  border-top: 1px solid #cde7d5;
}
.nav > li > a:focus{
    background-color: #5cb85c !important;
    text-decoration: none !important;
  }
  
  .nav > li > a:hover {
    background-color: #5cb85c !important;
    text-decoration: none !important;
  }
/* ---------------------------
   Sidebar Icon èˆ‡æ–‡å­—æ¨£å¼
--------------------------- */

/* li a ç½®ä¸­å°é½Šå®¹å™¨ */
.sidebar a {
  display: flex;
  align-items: center;
  gap: 8px; /* icon èˆ‡æ–‡å­—é–“éš” */
  transition: all 0.2s ease;
}

/* Icon */
.sidebar a span.glyphicon {
  flex-shrink: 0;
  font-size: 16px;
  width: 20px;
  text-align: center;
  transition: all 0.2s ease;
}

/* æ”¶åˆæ™‚æ”¾å¤§ä¸¦ç½®ä¸­ */
.sidebar.collapsed a span.glyphicon {
  font-size: 24px;
  width: 100%;
  text-align: center;
}

/* æ”¶åˆæ™‚éš±è—æ–‡å­— */
.sidebar.collapsed a span.text {
  display: none;
}

/* äºŒç´š submenu li */
.sidebar .submenu a {
  display: flex;
  align-items: center;
  gap: 6px;
  padding-left: 30px;
  transition: all 0.2s ease;
}

/* æ”¶åˆæ™‚ submenu ä¹Ÿç½®ä¸­ iconã€éš±è—æ–‡å­— */
.sidebar.collapsed .submenu a span.text {
  display: none;
}
.sidebar.collapsed .submenu a {
  justify-content: center;
}

/* æ”¶åˆæ™‚æ‰€æœ‰å­é¸å–®éš±è—ï¼Œåƒ…æµ®å‹•æ™‚é¡¯ç¤º */
.sidebar.collapsed .submenu {
  display: none !important;
}

/* æµ®å‹•å­é¸å–®ï¼ˆæ»‘é¼  hoverï¼‰ */
.sidebar.collapsed .has-submenu:hover > .submenu {
  display: block !important;
  position: absolute;
  left: 60px;
  top: 0;
  background: #2f5c43;
  border-radius: 0 4px 4px 0;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
  width: 100px;
  padding: 5px 0;
  z-index: 1050;
}

/* æ”¶åˆæ™‚ hover æ•ˆæœï¼Œicon æ”¾å¤§ */
.sidebar.collapsed a:hover span.glyphicon,
.sidebar.collapsed .submenu a:hover span.glyphicon {
  font-size: 24px;
}

/* âœ… æµ®å‹•å³å´ä¸‹è¼‰é€²åº¦é¢æ¿ */
#download-panel {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 280px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  overflow: hidden;
  transition: all .3s ease;
  z-index: 1060;
}

/* header */
#download-panel .panel-header {
  background: #2b593f;
  color: #fff;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  font-weight: 600;
}
#download-panel .panel-header:hover {
  background: #36744e;
}

/* å…§å®¹å€ */
#download-panel .panel-body {
  max-height: 240px;
  overflow-y: auto;
  background: #f8fbf9;
  padding: 10px;
}

/* å–®ç­†ä¸‹è¼‰é …ç›® */
.download-item {
  padding: 6px 0;
  border-bottom: 1px solid #dbe9e0;
}
.download-item:last-child { border-bottom: none; }

.download-item .file-name {
  font-size: 13px;
  color: #2b3b2b;
  margin-bottom: 4px;
}
.download-item .progress {
  height: 6px;
  margin: 0;
}
.download-item .progress-bar {
  background-color: #5cb85c;
}

/* æ”¶åˆç‹€æ…‹ */
#download-panel.collapsed {
  height: 42px;
  width: 200px;
}
#download-panel.collapsed .panel-body {
  display: none;
}

/* æ”¶åˆæŒ‰éˆ•åœ–ç¤º */
#download-toggle {
  font-size: 16px;
}
/* æ‰‹æ©Ÿæ¨¡å¼ Sidebar */
@media (max-width:767px){
  .sidebar {
    width: 80%; max-width: 300px;
    transform: translateX(-110%);
    background: rgba(34,73,53,0.97);
    box-shadow: 3px 0 15px rgba(0,0,0,0.3);
    transition: transform .3s ease, opacity .3s ease;
    opacity: 0;
  }
  .sidebar.show { transform: translateX(0); opacity: 1; }
  #main-panel { margin-left: 0 !important; }
}
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <div class="text-center" style="padding:10px;">
    <a href="#" id="portal" style="color:#fff;text-decoration:none;font-weight:600;"  data-i18n="menu"><strong>é¸å–®</strong></a>
  </div>
  <ul class="nav nav-pills nav-stacked" id="menu">
    <li><a href="#" data-target="z33.html" data-toggle="tooltip" title="é¢æ¿ä¸€"><span class="glyphicon glyphicon-leaf"></span> <span class="text" data-i18n="menuItems.sustain">æ°¸çºŒå ±å‘Š</span></a></li>
    <li class="has-submenu">
      <a href="#" data-toggle="tooltip" title="é¢æ¿äºŒ"><span class="glyphicon glyphicon-stats"></span> <span class="text">ç¢³æ’åˆ†æ â–¾</span></a>
      <ul class="submenu nav">
        <li><a href="#" data-target="sub1.html" data-toggle="tooltip" title="sub1"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub1</span></a></li>
        <li><a href="#" data-target="sub2.html" data-toggle="tooltip" title="sub2"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub2</span></a></li>
      </ul>
    </li>
    <li><a href="#" data-target="z22.html" data-toggle="tooltip" title="Tableau"><span class="glyphicon glyphicon-globe"></span> <span class="text">z22</span></a></li>
  </ul>
</div>

<!-- Main Panel -->
<div id="main-panel">
  <!-- Header -->
  <div id="main-header">
    <button id="toggleSidebar" class="btn btn-sm">â˜°</button>
    <h5 id="page-title" class="header-title"></h5>
    <div class="user-info">
      <span>ä½ å¥½, ä½¿ç”¨è€…</span>
      <button class="btn btn-xs" id="logoutBtn">ç™»å‡º</button>
	  <button id="testDownload" class="btn btn-primary">é–‹å§‹æ¨¡æ“¬ä¸‹è¼‰</button>
    </div>
	  <!-- âœ… æ–°å¢èªè¨€é¸æ“‡ -->
      <select id="langSelect" class="form-control input-sm" style="width:100px;display:inline-block;">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
  </div>

  <div id="content-container" class="flex-grow-1 overflow-auto">
    <h3 class="text-center text-muted">è«‹å¾å·¦å´é¸å–®é¸æ“‡å…§å®¹ ğŸŒ±</h3>
  </div>
</div>

<!-- âœ… å³å´æµ®å‹•ä¸‹è¼‰é€²åº¦æ¸…å–® -->
<div id="download-panel" class="collapsed">
  <div class="panel-header">
    <span>ğŸ“¥ ä¸‹è¼‰é€²åº¦</span>
    <span id="download-toggle" class="glyphicon glyphicon-chevron-up"></span>
  </div>
  <div class="panel-body">
    
  </div>
</div>

<script>

     
	    $(async function(){
  var $sidebar = $("#sidebar"),
      $main = $("#main-panel"),
      $content = $("#content-container");
	  
	  $("#download-panel").hide(); // ä¸€é–‹å§‹éš±è—
	 
  // åˆå§‹åŒ–èªè¨€
      await i18n.init();
	    // åˆå§‹åŒ–èªè¨€é¸å–®
      $("#langSelect").val(i18n.getLang());

       // èªè¨€åˆ‡æ›
      $("#langSelect").on("change", async function(){
        const lang = $(this).val();
        await i18n.setLang(lang);
		  // å†æ¬¡å¥—ç”¨ç¿»è­¯
        i18n.apply(document);
      });
 console.log(i18n.t("welcome", "ç‹å°æ˜"));  // ä½ å¥½ï¼Œç‹å°æ˜ï¼
// å¤šåƒæ•¸
console.log(i18n.t("greet", "ç‹å°æ˜", "æ—©ä¸Šå¥½")); // ç‹å°æ˜ï¼Œæ—©ä¸Šå¥½ï¼
// æä¾›çµ¦å­é é¢ a.html å‘¼å«
function navigateTo(pageUrl) {
    loadPanel(pageUrl);
}

// å°‡å‡½å¼æ›åˆ°å…¨åŸŸï¼Œa.html å¯ä»¥å‘¼å«
window.navigateTo = navigateTo;
	  
	  
	  
 // âœ… æ–°å¢ä¸‹è¼‰é¢æ¿é–‹é—œ
  $("#download-panel .panel-header").on("click", function(){
    $("#download-panel").toggleClass("collapsed");
    $("#download-toggle")
      .toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
  });
   // ğŸ”¸ äºŒç´šé¸å–®å±•é–‹/æ”¶åˆï¼ˆä¸æœƒè®Šç™½ï¼‰
  $("#menu").on("click", ".has-submenu > a", function(e){
    e.preventDefault();

    // ä¸æ”¹è®Š active ç‹€æ…‹ï¼ˆé˜²æ­¢è®Šç™½ï¼‰
    var $submenu = $(this).next(".submenu");
    var isOpen = $submenu.is(":visible");

    // æ”¶åˆå…¶ä»– submenu
    $("#menu .submenu").not($submenu).slideUp(200);
    $("#menu .has-submenu").not($(this).parent()).removeClass("open");

    // åˆ‡æ›ç•¶å‰ submenu
    $submenu.slideToggle(200);
    $(this).parent().toggleClass("open", !isOpen);
  });


  // è¼‰å…¥å…§å®¹
 function loadPanel(target) {
  //  const $content = $("#main-content"); // âœ… å»ºè­°å›ºå®šå®¹å™¨è®Šæ•¸
    $content.html("<div class='text-center text-muted' style='padding:50px;'>ğŸŒ¿ è³‡æ–™è¼‰å…¥ä¸­...</div>");

    $.get(target)
        .done(function (html) {
            // âœ… ä½¿ç”¨ .empty() + .append() é¿å… innerHTML æ±™æŸ“ DOM
            $content.empty().append(html);

            // âœ… æ ¹æ“šç›®æ¨™æª”æ¡ˆè¨­å®šæ¨™é¡Œ
          //  const titleMap = {
            //    "z33.html": "z33",
           //     "sub1.html": "ç¯„ç–‡ä¸€æ’æ”¾",
             //   "sub2.html": "ç¯„ç–‡äºŒæ’æ”¾",
            //    "z22.html": "z22"
            //};
           // $("#page-title").text(titleMap[target] || "ESG Dashboard");
const pageTitle = $content.find(".page-title").text().trim();
      $("#page-title").text(pageTitle || "ESG Dashboard");
            // âœ… å»¶é²æ’å…¥ footerï¼Œç¢ºä¿ DOM å·²æ¸²æŸ“å®Œæˆ
            if (target === "z22.html" && $content.find(".accordion-footer").length === 0) {
                setTimeout(() => {
                    // é˜²æ­¢é‡è¤‡æ’å…¥
                    if ($content.find(".accordion-footer").length === 0) {
                        const footerHtml = `
                            <div class="panel-group accordion-footer" id="footerAccordion">
                                <div class="panel panel-default">
                                    <div class="panel-heading" data-toggle="collapse" data-parent="#footerAccordion" href="#footerContent">
                                        <h4 class="panel-title">
                                            <a>ï¼‹ é»æ“Šå±•é–‹ ESG è³‡è¨Š</a>
                                        </h4>
                                    </div>
                                    <div id="footerContent" class="panel-collapse collapse">
                                        <div class="panel-body text-center text-muted">
                                            &copy; 2025 ç¶ è‰²æ°¸çºŒè‚¡ä»½æœ‰é™å…¬å¸ - ESGå ±å‘Šå¹³å°<br>
                                            è¯çµ¡ä¿¡ç®±ï¼šinfo@esgcompany.com
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        $content.append(footerHtml);
                    }
                }, 50); // å¾®å»¶é²ç¢ºä¿ HTML å®Œå…¨æ’å…¥
            }
        })
        .fail(function () {
            $content.html("<div class='text-center text-danger' style='padding:50px;'>âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—</div>");
        });
}

  // é»æ“Šåˆ‡æ›å…§å®¹
  $("#menu").on("click","a[data-target]",function(e){
    e.preventDefault();
     // åªè®“ã€Œé has-submenu çš„é …ç›®ã€è®Š active
    if(!$(this).closest(".has-submenu").length){
      $("#menu a").removeClass("active");
      $(this).addClass("active");
    } else {
      // æ˜¯å­é …çš„è©±ï¼Œä¹Ÿè¦è¨­ active
      $("#menu a").removeClass("active");
      $(this).addClass("active");
    }
    var target = $(this).data("target");
    loadPanel(target);
    if($(window).width() < 768) $sidebar.removeClass("show");
    localStorage.setItem("activePage", target);
  });

  // è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡é é¢
  var saved = localStorage.getItem("activePage") || "z181.html";
  $("#menu a[data-target='"+saved+"']").addClass("active");
  loadPanel(saved);

  // Sidebar åˆ‡æ›
  $("#portal, #toggleSidebar").on("click", function(){
    if($(window).width() < 768){
      $sidebar.toggleClass("show");
    } else {
      $sidebar.toggleClass("collapsed");
      $main.toggleClass("full");
    }
  });

  // ç™»å‡º
  $("#logoutBtn").click(function(){ alert("å·²ç™»å‡ºï¼"); });
});

 $(function () {
  // âœ… æ¨¡æ“¬/çœŸå¯¦é€²åº¦æ›´æ–°
  function updateProgress($bar, id, fileName) {
    const timer = setInterval(() => {
      $.get(`http://localhost:57216/Download/Progress?id=${id}`, function (res) {
        const pct = res.progress;
        $bar.css("width", pct + "%").text(pct + "%");
        if (pct >= 100) {
          clearInterval(timer);
          $bar.removeClass("progress-bar-success").addClass("progress-bar-info");
          $bar.closest(".download-item").find(".file-name").append(" âœ…");

          // é€²åº¦åˆ°100å¾Œè‡ªå‹• stream ä¸‹è¼‰
          streamDownload(fileName);
        }
      });
    }, 800);
  }

  // âœ… åˆªé™¤æŒ‰éˆ•äº‹ä»¶
  $(document).on("click", ".delete-btn", function () {
    const $item = $(this).closest(".download-item");
    $item.slideUp(200, function () {
      $item.remove();
      if ($("#download-panel .download-item").length === 0) {
        $("#download-panel").fadeOut(300);
      }
    });
  });

  
  // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™
  window.addDownloadTask2 = function(fileName) {
    $("#download-panel").show().removeClass("collapsed");
    const $newItem = $(`
      <div class="download-item">
        <div class="file-name">${fileName}</div>
        <div class="progress">
          <div class="progress-bar progress-bar-success" style="width:0%">0%</div>
        </div>
		<div id="downloadSpeed" style="font-size:12px;color:#555;"></div>
        <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
      </div>
    `);
    $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

    // é–‹å§‹æµå¼ä¸‹è¼‰
    streamDownload2(fileName);
  };
  
  
  // âœ… æ–°å¢ä¸‹è¼‰ä»»å‹™ï¼ˆæ•´åˆå¾Œç«¯ï¼‰
  window.addDownloadTask = function (fileName) {
    $("#download-panel").show().removeClass("collapsed");
    const $newItem = $(` 
      <div class="download-item">
        <div class="file-name">${fileName}</div>
        <div class="progress"><div class="progress-bar progress-bar-success" style="width:0%">0%</div></div>
        <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">âœ•</button>
      </div>
    `);
    $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

    const $bar = $newItem.find(".progress-bar");

    // å‘¼å«å¾Œç«¯é–‹å§‹ä¸‹è¼‰
    $.post("http://localhost:57216/Download/Start", { fileName: fileName }, function (res) {
      if (res.success) {
        updateProgress($bar, res.id, fileName);
      }
    });
  };

// âœ… Stream ä¸‹è¼‰å‡½å¼ï¼ˆå¯å¤šä»»å‹™ï¼‰
  async function streamDownload2(fileName) {
    try {
      const response = await fetch(`http://localhost:57216/Download/GetFileStream?fileName=${encodeURIComponent(fileName)}`);
      if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

    const contentLength = response.headers.get("Content-Length");
    const totalSize = contentLength ? parseInt(contentLength, 10) : null;
      const reader = response.body.getReader();
      const chunks = [];
      let received = 0; 
      let startTime = Date.now();
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
 // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”
      if (totalSize) {
        const pct = Math.round((received / totalSize) * 100);
        $("#downloadProgress").css("width", pct + "%").text(pct + "%");
      }
	  
	  // è¨ˆç®—ä¸‹è¼‰é€Ÿåº¦ (Bytes/s)
      const elapsed = (Date.now() - startTime) / 1000; // ç§’
      const speed = received / elapsed; // Bytes/s
      let speedText = "";
      if (speed > 1024 * 1024) speedText = (speed / (1024 * 1024)).toFixed(2) + " MB/s";
      else if (speed > 1024) speedText = (speed / 1024).toFixed(2) + " KB/s";
      else speedText = speed.toFixed(0) + " B/s";

      // é¡¯ç¤ºåœ¨é€²åº¦æ¢ä¸Šæˆ–æ—é‚Š
      $("#downloadSpeed").text(speedText);
	  
	  
	  
        // æ›´æ–°è©²æª”æ¡ˆçš„é€²åº¦
        const pct = contentLength ? Math.round((received / contentLength) * 100) : 0;
        $(`.download-item:contains("${fileName}") .progress-bar`)
          .css("width", pct + "%")
          .text(pct + "%");
		  
		  
		  
      }

      const blob = new Blob(chunks, { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName + ".xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // å®Œæˆå¾Œæ›´æ–°æ¨™è¨˜
      $(`.download-item:contains("${fileName}") .file-name`).append(" âœ…");
      $(`.download-item:contains("${fileName}") .progress-bar`)
        .removeClass("progress-bar-success")
        .addClass("progress-bar-info");
 $("#downloadSpeed").text("å®Œæˆ"); // å¯é¸
    } catch (e) {
      alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
    }
  }



  // âœ… Stream ä¸‹è¼‰å‡½å¼
  async function streamDownload(fileName) {
    try {
      const response = await fetch(`http://localhost:57216/Download/GetFile?fileName=${encodeURIComponent(fileName)}`);
      if (!response.ok) throw new Error("ä¸‹è¼‰å¤±æ•—");

      const contentLength = response.headers.get("Content-Length");
      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;

        if (contentLength) {
          const pct = Math.round((received / contentLength) * 100);
          // å¯é¸ï¼šæ›´æ–°æ•´å€‹ panel é€²åº¦ï¼ˆæˆ–å„è‡ªé€²åº¦ï¼‰
          $("#downloadProgress").css("width", pct + "%").text(pct + "%");
        }
      }

      const blob = new Blob(chunks);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName + ".txt"; // æˆ–åŸæª”å
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
    }
  }

  // âœ… å¯æ‰‹å‹•æ¸¬è©¦
  $("#testDownload").on("click", function () {
    addDownloadTask2("ESG_Report_2025");
  });
});

</script>
</body>
</html>
