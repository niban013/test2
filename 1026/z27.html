<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESG Dashboard - 帶浮動子選單</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./i18n.js"></script>
<style>
body {
  overflow-x:hidden;
  margin:0;
  background-color:#f4f8f5; /* 柔和綠底 */
  font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
}

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: 240px;
  height: 100%;
  background: linear-gradient(180deg, #2b593f 0%, #1e3a2b 100%); /* 深綠漸層 */
  color: #e9f5ee;
  transition: all .3s ease-in-out;
  z-index: 1040;
  overflow-y: auto;
  box-shadow: 2px 0 6px rgba(0,0,0,0.2);
}
.sidebar a {
  color: #d2f0de;
  display: block;
  padding: 10px 15px;
  text-decoration: none;
  transition: all .2s;
}
.sidebar a:hover, .sidebar a.active {
  background: #5cb85c; /* 綠色主調 */
  color: #fff;
}

/* Submenu */
.sidebar .submenu { display: none; padding-left: 25px; }
.sidebar .submenu a {
  font-size: 0.9em;
  color: #c6e8d1;
}
.sidebar .submenu a:hover {
  background: rgba(255,255,255,0.1);
}
/* 防止展開時 hover 或 active 變白 */
.sidebar .has-submenu.open > a,
.sidebar .has-submenu > a:hover {
  background: #2b593f !important;
  color: #fff !important;
}
/* Sidebar 縮起 */
.sidebar.collapsed { width: 60px; overflow: visible; }
.sidebar.collapsed a span.text { display: none; }

/* ✅ 浮動子選單（縮進狀態下顯示） */
.sidebar.collapsed .has-submenu:hover > .submenu {
  display: block !important;
  position: absolute;
  left: 60px;
  top: 0;
  background: #2f5c43;
  border-radius: 0 4px 4px 0;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
  width: 180px;
  padding: 5px 0;
  z-index: 1050;
}

/* Main Panel */
#main-panel {
  margin-left: 240px;
  transition: margin-left .3s ease-in-out;
  background-color: #f4f8f5;
  min-height: 100vh;
}
#main-panel.full { margin-left: 60px; }

/* Header */
#main-header {
  background: #e9f5ee;
  border-bottom: 1px solid #c8e3d0;
  height: 50px;
  padding: 0 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

#main-header .btn {
  background-color: #5cb85c;
  color: #fff;
  border: none;
  transition: background .2s;
}
#main-header .btn:hover { background-color: #4cae4c; }

#main-header .header-title {
  flex: 1;
  text-align: center;
  margin: 0;
  font-size: 17px;
  font-weight: 600;
  color: #2e4634;
  letter-spacing: 1px;
}
#main-header .user-info {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: #2b3b2b;
}
#logoutBtn {
  background-color: #e26a5c;
  border: none;
  color: #fff;
}
#logoutBtn:hover { background-color: #c9574c; }

/* Content */
#content-container {
  padding: 25px 35px;
  background: #f8fbf9;
  border-radius: 6px;
  margin: 15px;
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
}

/* Accordion Footer */
.accordion-footer {
  margin-top: 30px;
}
.accordion-footer .panel-heading {
  background: #d9f0df;
  border-top: 1px solid #b6dec0;
  cursor: pointer;
}
.accordion-footer .panel-title a {
  display: block;
  text-decoration: none;
  color: #2b3b2b;
  font-weight: 500;
}
.accordion-footer .panel-body {
  background: #f4f8f5;
  border-top: 1px solid #cde7d5;
}
.nav > li > a:focus{
    background-color: #5cb85c !important;
    text-decoration: none !important;
  }
  
  .nav > li > a:hover {
    background-color: #5cb85c !important;
    text-decoration: none !important;
  }
/* ---------------------------
   Sidebar Icon 與文字樣式
--------------------------- */

/* li a 置中對齊容器 */
.sidebar a {
  display: flex;
  align-items: center;
  gap: 8px; /* icon 與文字間隔 */
  transition: all 0.2s ease;
}

/* Icon */
.sidebar a span.glyphicon {
  flex-shrink: 0;
  font-size: 16px;
  width: 20px;
  text-align: center;
  transition: all 0.2s ease;
}

/* 收合時放大並置中 */
.sidebar.collapsed a span.glyphicon {
  font-size: 24px;
  width: 100%;
  text-align: center;
}

/* 收合時隱藏文字 */
.sidebar.collapsed a span.text {
  display: none;
}

/* 二級 submenu li */
.sidebar .submenu a {
  display: flex;
  align-items: center;
  gap: 6px;
  padding-left: 30px;
  transition: all 0.2s ease;
}

/* 收合時 submenu 也置中 icon、隱藏文字 */
.sidebar.collapsed .submenu a span.text {
  display: none;
}
.sidebar.collapsed .submenu a {
  justify-content: center;
}

/* 收合時所有子選單隱藏，僅浮動時顯示 */
.sidebar.collapsed .submenu {
  display: none !important;
}

/* 浮動子選單（滑鼠 hover） */
.sidebar.collapsed .has-submenu:hover > .submenu {
  display: block !important;
  position: absolute;
  left: 60px;
  top: 0;
  background: #2f5c43;
  border-radius: 0 4px 4px 0;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
  width: 100px;
  padding: 5px 0;
  z-index: 1050;
}

/* 收合時 hover 效果，icon 放大 */
.sidebar.collapsed a:hover span.glyphicon,
.sidebar.collapsed .submenu a:hover span.glyphicon {
  font-size: 24px;
}

/* ✅ 浮動右側下載進度面板 */
#download-panel {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 280px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  overflow: hidden;
  transition: all .3s ease;
  z-index: 1060;
}

/* header */
#download-panel .panel-header {
  background: #2b593f;
  color: #fff;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  font-weight: 600;
}
#download-panel .panel-header:hover {
  background: #36744e;
}

/* 內容區 */
#download-panel .panel-body {
  max-height: 240px;
  overflow-y: auto;
  background: #f8fbf9;
  padding: 10px;
}

/* 單筆下載項目 */
.download-item {
  padding: 6px 0;
  border-bottom: 1px solid #dbe9e0;
}
.download-item:last-child { border-bottom: none; }

.download-item .file-name {
  font-size: 13px;
  color: #2b3b2b;
  margin-bottom: 4px;
}
.download-item .progress {
  height: 6px;
  margin: 0;
}
.download-item .progress-bar {
  background-color: #5cb85c;
}

/* 收合狀態 */
#download-panel.collapsed {
  height: 42px;
  width: 200px;
}
#download-panel.collapsed .panel-body {
  display: none;
}

/* 收合按鈕圖示 */
#download-toggle {
  font-size: 16px;
}
/* 手機模式 Sidebar */
@media (max-width:767px){
  .sidebar {
    width: 80%; max-width: 300px;
    transform: translateX(-110%);
    background: rgba(34,73,53,0.97);
    box-shadow: 3px 0 15px rgba(0,0,0,0.3);
    transition: transform .3s ease, opacity .3s ease;
    opacity: 0;
  }
  .sidebar.show { transform: translateX(0); opacity: 1; }
  #main-panel { margin-left: 0 !important; }
}
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <div class="text-center" style="padding:10px;">
    <a href="#" id="portal" style="color:#fff;text-decoration:none;font-weight:600;"  data-i18n="menu"><strong>選單</strong></a>
  </div>
  <ul class="nav nav-pills nav-stacked" id="menu">
    <li><a href="#" data-target="z33.html" data-toggle="tooltip" title="面板一"><span class="glyphicon glyphicon-leaf"></span> <span class="text" data-i18n="menuItems.sustain">永續報告</span></a></li>
    <li class="has-submenu">
      <a href="#" data-toggle="tooltip" title="面板二"><span class="glyphicon glyphicon-stats"></span> <span class="text">碳排分析 ▾</span></a>
      <ul class="submenu nav">
        <li><a href="#" data-target="sub1.html" data-toggle="tooltip" title="sub1"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub1</span></a></li>
        <li><a href="#" data-target="sub2.html" data-toggle="tooltip" title="sub2"><span class="glyphicon glyphicon-stats"></span> <span class="text">sub2</span></a></li>
      </ul>
    </li>
    <li><a href="#" data-target="z22.html" data-toggle="tooltip" title="Tableau"><span class="glyphicon glyphicon-globe"></span> <span class="text">z22</span></a></li>
  </ul>
</div>

<!-- Main Panel -->
<div id="main-panel">
  <!-- Header -->
  <div id="main-header">
    <button id="toggleSidebar" class="btn btn-sm">☰</button>
    <h5 id="page-title" class="header-title"></h5>
    <div class="user-info">
      <span>你好, 使用者</span>
      <button class="btn btn-xs" id="logoutBtn">登出</button>
	  <button id="testDownload" class="btn btn-primary">開始模擬下載</button>
    </div>
	  <!-- ✅ 新增語言選擇 -->
      <select id="langSelect" class="form-control input-sm" style="width:100px;display:inline-block;">
        <option value="zh">中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
      </select>
  </div>

  <div id="content-container" class="flex-grow-1 overflow-auto">
    <h3 class="text-center text-muted">請從左側選單選擇內容 🌱</h3>
  </div>
</div>

<!-- ✅ 右側浮動下載進度清單 -->
<div id="download-panel" class="collapsed">
  <div class="panel-header">
    <span>📥 下載進度</span>
    <span id="download-toggle" class="glyphicon glyphicon-chevron-up"></span>
  </div>
  <div class="panel-body">
    
  </div>
</div>

<script>

     
	    $(async function(){
  var $sidebar = $("#sidebar"),
      $main = $("#main-panel"),
      $content = $("#content-container");
	  
	  $("#download-panel").hide(); // 一開始隱藏
	 
  // 初始化語言
      await i18n.init();
	    // 初始化語言選單
      $("#langSelect").val(i18n.getLang());

       // 語言切換
      $("#langSelect").on("change", async function(){
        const lang = $(this).val();
        await i18n.setLang(lang);
		  // 再次套用翻譯
        i18n.apply(document);
      });
 console.log(i18n.t("welcome", "王小明"));  // 你好，王小明！
// 多參數
console.log(i18n.t("greet", "王小明", "早上好")); // 王小明，早上好！
// 提供給子頁面 a.html 呼叫
function navigateTo(pageUrl) {
    loadPanel(pageUrl);
}

// 將函式掛到全域，a.html 可以呼叫
window.navigateTo = navigateTo;
	  
	  
	  
 // ✅ 新增下載面板開關
  $("#download-panel .panel-header").on("click", function(){
    $("#download-panel").toggleClass("collapsed");
    $("#download-toggle")
      .toggleClass("glyphicon-chevron-down glyphicon-chevron-up");
  });
   // 🔸 二級選單展開/收合（不會變白）
  $("#menu").on("click", ".has-submenu > a", function(e){
    e.preventDefault();

    // 不改變 active 狀態（防止變白）
    var $submenu = $(this).next(".submenu");
    var isOpen = $submenu.is(":visible");

    // 收合其他 submenu
    $("#menu .submenu").not($submenu).slideUp(200);
    $("#menu .has-submenu").not($(this).parent()).removeClass("open");

    // 切換當前 submenu
    $submenu.slideToggle(200);
    $(this).parent().toggleClass("open", !isOpen);
  });


  // 載入內容
 function loadPanel(target) {
  //  const $content = $("#main-content"); // ✅ 建議固定容器變數
    $content.html("<div class='text-center text-muted' style='padding:50px;'>🌿 資料載入中...</div>");

    $.get(target)
        .done(function (html) {
            // ✅ 使用 .empty() + .append() 避免 innerHTML 汙染 DOM
            $content.empty().append(html);

            // ✅ 根據目標檔案設定標題
          //  const titleMap = {
            //    "z33.html": "z33",
           //     "sub1.html": "範疇一排放",
             //   "sub2.html": "範疇二排放",
            //    "z22.html": "z22"
            //};
           // $("#page-title").text(titleMap[target] || "ESG Dashboard");
const pageTitle = $content.find(".page-title").text().trim();
      $("#page-title").text(pageTitle || "ESG Dashboard");
            // ✅ 延遲插入 footer，確保 DOM 已渲染完成
            if (target === "z22.html" && $content.find(".accordion-footer").length === 0) {
                setTimeout(() => {
                    // 防止重複插入
                    if ($content.find(".accordion-footer").length === 0) {
                        const footerHtml = `
                            <div class="panel-group accordion-footer" id="footerAccordion">
                                <div class="panel panel-default">
                                    <div class="panel-heading" data-toggle="collapse" data-parent="#footerAccordion" href="#footerContent">
                                        <h4 class="panel-title">
                                            <a>＋ 點擊展開 ESG 資訊</a>
                                        </h4>
                                    </div>
                                    <div id="footerContent" class="panel-collapse collapse">
                                        <div class="panel-body text-center text-muted">
                                            &copy; 2025 綠色永續股份有限公司 - ESG報告平台<br>
                                            聯絡信箱：info@esgcompany.com
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        $content.append(footerHtml);
                    }
                }, 50); // 微延遲確保 HTML 完全插入
            }
        })
        .fail(function () {
            $content.html("<div class='text-center text-danger' style='padding:50px;'>⚠️ 資料載入失敗</div>");
        });
}

  // 點擊切換內容
  $("#menu").on("click","a[data-target]",function(e){
    e.preventDefault();
     // 只讓「非 has-submenu 的項目」變 active
    if(!$(this).closest(".has-submenu").length){
      $("#menu a").removeClass("active");
      $(this).addClass("active");
    } else {
      // 是子項的話，也要設 active
      $("#menu a").removeClass("active");
      $(this).addClass("active");
    }
    var target = $(this).data("target");
    loadPanel(target);
    if($(window).width() < 768) $sidebar.removeClass("show");
    localStorage.setItem("activePage", target);
  });

  // 自動載入上次頁面
  var saved = localStorage.getItem("activePage") || "z181.html";
  $("#menu a[data-target='"+saved+"']").addClass("active");
  loadPanel(saved);

  // Sidebar 切換
  $("#portal, #toggleSidebar").on("click", function(){
    if($(window).width() < 768){
      $sidebar.toggleClass("show");
    } else {
      $sidebar.toggleClass("collapsed");
      $main.toggleClass("full");
    }
  });

  // 登出
  $("#logoutBtn").click(function(){ alert("已登出！"); });
});

 $(function () {
  // ✅ 模擬/真實進度更新
  function updateProgress($bar, id, fileName) {
    const timer = setInterval(() => {
      $.get(`http://localhost:57216/Download/Progress?id=${id}`, function (res) {
        const pct = res.progress;
        $bar.css("width", pct + "%").text(pct + "%");
        if (pct >= 100) {
          clearInterval(timer);
          $bar.removeClass("progress-bar-success").addClass("progress-bar-info");
          $bar.closest(".download-item").find(".file-name").append(" ✅");

          // 進度到100後自動 stream 下載
          streamDownload(fileName);
        }
      });
    }, 800);
  }

  // ✅ 刪除按鈕事件
  $(document).on("click", ".delete-btn", function () {
    const $item = $(this).closest(".download-item");
    $item.slideUp(200, function () {
      $item.remove();
      if ($("#download-panel .download-item").length === 0) {
        $("#download-panel").fadeOut(300);
      }
    });
  });

  
  // ✅ 新增下載任務
  window.addDownloadTask2 = function(fileName) {
    $("#download-panel").show().removeClass("collapsed");
    const $newItem = $(`
      <div class="download-item">
        <div class="file-name">${fileName}</div>
        <div class="progress">
          <div class="progress-bar progress-bar-success" style="width:0%">0%</div>
        </div>
		<div id="downloadSpeed" style="font-size:12px;color:#555;"></div>
        <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">✕</button>
      </div>
    `);
    $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

    // 開始流式下載
    streamDownload2(fileName);
  };
  
  
  // ✅ 新增下載任務（整合後端）
  window.addDownloadTask = function (fileName) {
    $("#download-panel").show().removeClass("collapsed");
    const $newItem = $(` 
      <div class="download-item">
        <div class="file-name">${fileName}</div>
        <div class="progress"><div class="progress-bar progress-bar-success" style="width:0%">0%</div></div>
        <button class="btn btn-xs btn-danger delete-btn" style="float:right;margin-top:-18px;">✕</button>
      </div>
    `);
    $("#download-panel .panel-body").append($newItem.hide().slideDown(200));

    const $bar = $newItem.find(".progress-bar");

    // 呼叫後端開始下載
    $.post("http://localhost:57216/Download/Start", { fileName: fileName }, function (res) {
      if (res.success) {
        updateProgress($bar, res.id, fileName);
      }
    });
  };

// ✅ Stream 下載函式（可多任務）
  async function streamDownload2(fileName) {
    try {
      const response = await fetch(`http://localhost:57216/Download/GetFileStream?fileName=${encodeURIComponent(fileName)}`);
      if (!response.ok) throw new Error("下載失敗");

    const contentLength = response.headers.get("Content-Length");
    const totalSize = contentLength ? parseInt(contentLength, 10) : null;
      const reader = response.body.getReader();
      const chunks = [];
      let received = 0; 
      let startTime = Date.now();
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
 // 計算進度百分比
      if (totalSize) {
        const pct = Math.round((received / totalSize) * 100);
        $("#downloadProgress").css("width", pct + "%").text(pct + "%");
      }
	  
	  // 計算下載速度 (Bytes/s)
      const elapsed = (Date.now() - startTime) / 1000; // 秒
      const speed = received / elapsed; // Bytes/s
      let speedText = "";
      if (speed > 1024 * 1024) speedText = (speed / (1024 * 1024)).toFixed(2) + " MB/s";
      else if (speed > 1024) speedText = (speed / 1024).toFixed(2) + " KB/s";
      else speedText = speed.toFixed(0) + " B/s";

      // 顯示在進度條上或旁邊
      $("#downloadSpeed").text(speedText);
	  
	  
	  
        // 更新該檔案的進度
        const pct = contentLength ? Math.round((received / contentLength) * 100) : 0;
        $(`.download-item:contains("${fileName}") .progress-bar`)
          .css("width", pct + "%")
          .text(pct + "%");
		  
		  
		  
      }

      const blob = new Blob(chunks, { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName + ".xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // 完成後更新標記
      $(`.download-item:contains("${fileName}") .file-name`).append(" ✅");
      $(`.download-item:contains("${fileName}") .progress-bar`)
        .removeClass("progress-bar-success")
        .addClass("progress-bar-info");
 $("#downloadSpeed").text("完成"); // 可選
    } catch (e) {
      alert("下載失敗：" + e.message);
    }
  }



  // ✅ Stream 下載函式
  async function streamDownload(fileName) {
    try {
      const response = await fetch(`http://localhost:57216/Download/GetFile?fileName=${encodeURIComponent(fileName)}`);
      if (!response.ok) throw new Error("下載失敗");

      const contentLength = response.headers.get("Content-Length");
      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;

        if (contentLength) {
          const pct = Math.round((received / contentLength) * 100);
          // 可選：更新整個 panel 進度（或各自進度）
          $("#downloadProgress").css("width", pct + "%").text(pct + "%");
        }
      }

      const blob = new Blob(chunks);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName + ".txt"; // 或原檔名
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      alert("下載失敗：" + e.message);
    }
  }

  // ✅ 可手動測試
  $("#testDownload").on("click", function () {
    addDownloadTask2("ESG_Report_2025");
  });
});

</script>
</body>
</html>
