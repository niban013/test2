<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‡ªé©æ‡‰ä¸‰åˆ—å¤šè¡Œ ECharts å®¹å™¨ (autoDataZoom + å‹•æ…‹ xlabelMode + legendMode)</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<style>
body { font-family:"Microsoft JhengHei",sans-serif; margin:20px; background:#000000; }
h2 { text-align:center; color:#444; margin-bottom:20px; }
.chart-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; }
.chart-item { background:#000000; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); min-height:300px; padding:10px; border:none;}
/* éŸ¿æ‡‰å¼ */
@media (max-width:900px){ .chart-grid{grid-template-columns:repeat(2,1fr);} }
@media (max-width:600px){ .chart-grid{grid-template-columns:1fr;} }
/* tooltipå‹•ç•« */
.echarts-tooltip, .echarts-tooltip div { white-space: normal !important; }
.custom-tooltip { font-size: 13px; line-height: 1.5; }
.tooltip-line { position: relative; padding-bottom: 2px; margin: 2px 0; }
.tooltip-line .line-underline { position: absolute; bottom: 0; left: 0; height: 2px; width: 100%; background: transparent; }
.tooltip-line.active-line .line-underline {
  background: linear-gradient(90deg, transparent, red, transparent);
  background-size: 200% 100%;
  animation: underline-flow 1.5s linear infinite;
}
@keyframes underline-flow { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body>

<h2>ğŸ“Š è‡ªé©æ‡‰ä¸‰åˆ—å¤šè¡Œ ECharts åœ–è¡¨ï¼ˆautoDataZoom + å‹•æ…‹ xlabelMode + legendModeï¼‰</h2>
<div class="chart-grid" id="chartContainer"></div>

<script>
const ChartUtil = {
  renderChart: function(containerId, config){
    const container = document.getElementById(containerId);
    if(container.chartInstance) container.chartInstance.dispose();
    const chart = echarts.init(container);
    container.chartInstance = chart;
    const isMobile = window.innerWidth < 600;

    // === Legend è¨­å®šï¼ˆæ–°å¢ legendMode æ§åˆ¶ï¼‰
    const legendMode = config.legendMode || 'scroll'; // scroll / wrap / none
    const legendBase = (config.type==='pie')
      ? (isMobile?{orient:'horizontal',top:'10%',left:'center'}:{orient:'vertical',left:'5%',top:'10%'})
      : (isMobile?{top:0,left:'center'}:{orient:'horizontal',top:'10%',left:'center'});
    const legendOption = (legendMode==='none') ? {show:false} : {
      ...legendBase,
      type: legendMode==='scroll' ? 'scroll' : 'plain',
      itemGap: 10,
      padding: [5,5,5,5],
      textStyle:{fontSize:12}
    };

    // === Grid padding
    const gridPadding = isMobile ? { left:'10%', right:'10%', bottom:'15%' } : { left:'10%', right:'15%', bottom:'15%' };

    // === XLabel è‡ªå‹•è™•ç†
    function getXAxisLabelOption(categories, mode){
      const maxLen = 8;
      if(mode==='auto'){
        if(categories.length > 10){
          return { interval:0, rotate: categories.some(v=>v.length>maxLen)?45:30, fontSize:12 };
        } else return { interval:0, rotate:0, fontSize:12 };
      }
      switch(mode){
        case 'wrap': return {interval:0, rotate:0, formatter:v=>v.length>maxLen?v.match(new RegExp('.{1,'+maxLen+'}','g')).join('\n'):v,fontSize:12};
        case 'rotate': return {interval:0, rotate: categories.some(v=>v.length>maxLen)?(isMobile?30:45):0,formatter:'{value}',fontSize:12};
        case 'alternate': return {interval:0, formatter:(v,i)=>i%2===0?v:'\n'+v,fontSize:12};
        default: return {interval:0,formatter:'{value}',fontSize:12};
      }
    }

    // === è¨ˆç®—é–“è·é¿å… title / legend ç–Š
    const titleHeight = config.title?40:0;
    const legendRows = (legendMode==='wrap')
      ? Math.ceil((config.series?.length||1)/6)
      : 1;
    const legendHeight = (legendMode==='none')?0:(legendRows*30);
    const gridTop = titleHeight + legendHeight + 30; // +30 æä¾›å®‰å…¨é–“è·

    // === dataZoom
    let dataZoomOption;
    if(typeof config.autoDataZoom === 'number'){
      const N = config.categories.length;
      if(config.autoDataZoom === -1){
        dataZoomOption = undefined;
      } else if(config.autoDataZoom > 0 && N > config.autoDataZoom){
        const end = (config.autoDataZoom / N) * 100;
        dataZoomOption = [{ type:'slider', xAxisIndex:0, start:0, end }];
      }
    }
const bgColor = getComputedStyle(document.body).backgroundColor;
    // === çµ„åˆ Option
    let option = {};
    switch(config.type){
      case 'bar': case 'grouped': case 'stacked': case 'stackedPercent': case 'line': case 'mixed':
        option = {
		 backgroundColor: bgColor,
 
          title:{ text: config.title, left:'center' },
          legend: legendOption,
          grid: Object.assign({}, gridPadding, { top:gridTop }),
          tooltip:{
            trigger:'axis',
            axisPointer:{ type:'shadow'
			},
            enterable:true,
            formatter:function(params){ 
              let str = `<div class="custom-tooltip"><div class="tooltip-title">${params[0].axisValue}</div>`;
			   const activeSeries = chart._hoveredSeries || null;
              params.forEach(p=>{
                const valueStr = (config.type==='stackedPercent' && p.data.rawValue!==undefined)? `${p.data.rawValue} (${p.value}%)`:p.value;
                const activeClass = (p.seriesName===activeSeries)?'active-line':'';
                str += `<div class="tooltip-line ${activeClass}">${p.marker}${p.seriesName}: ${valueStr}<span class="line-underline"></span></div>`;
              });
              str += '</div>'; return str;
            }
          },
          xAxis:{ type:'category', data: config.categories, name: config.xlabel, axisLabel:getXAxisLabelOption(config.categories, config.xlabelMode) },
          yAxis:{ type:'value', name: config.ylabel, min:0, max: config.type==='stackedPercent'?100:undefined, axisLabel:{formatter:config.type==='stackedPercent'?'{value}%':'{value}'} },
          series: config.series.map((s,i)=>({
            name: s.name,
            type: s.type || (config.type==='line'?'line':'bar'),
            stack: (config.type==='stacked' || config.type==='stackedPercent')?'total':undefined,
            label:{ show:s.type!=='line', position:'top', formatter: config.type==='stackedPercent'?'{c}%':'{c}' },
            data: s.data,
            itemStyle:{ color: config.colors?.[i] },
            smooth: s.type==='line'?true:false
          })),
          dataZoom: dataZoomOption
        };
        break;

      case 'pie':
        const pieData = config.series.map((s,i)=>({
          name:s.name,
          value:s.data.reduce((a,b)=>a+b,0),
          itemStyle:{ color: config.colors?.[i] }
        }));
        option = {
          title:{ text: config.title, left:'center' },
          tooltip:{ trigger:'item', formatter:'{a}<br/>{b}: {c} ({d}%)' },
          legend: legendOption,
          series:[{
            name: config.ylabel||'ç¸½å’Œ',
            type:'pie',
            radius:['40%','70%'],
            center:isMobile?['50%','55%']:['65%','55%'],
            data:pieData,
            label:{formatter:'{b}: {d}%'}
          }]
        };
        break;
    }

    chart.setOption(option);
    chart.resize();
chart.getOption().series.forEach((s, i) => {
  chart.on('mouseover', function(params){
    if(params.seriesIndex === i){
      chart._hoveredSeries = params.seriesName;
    }
  });
  chart.on('mouseout', function(params){
    if(params.seriesIndex === i){
      chart._hoveredSeries = null;
    }
  });
});
    // === å‹•æ…‹èª¿æ•´ XLabel
    function updateXAxisLabel(){
      if(!chart.getOption().xAxis) return;
      const axis = chart.getOption().xAxis[0];
      if(!axis) return;
      let visibleCategories = axis.data;
      const dz = chart.getOption().dataZoom?.[0];
      if(dz){
        const total = axis.data.length;
        const startIndex = Math.floor(dz.start/100*total);
        const endIndex = Math.ceil(dz.end/100*total);
        visibleCategories = axis.data.slice(startIndex,endIndex);
      }
      const newLabel = getXAxisLabelOption(visibleCategories, config.xlabelMode);
      chart.setOption({ xAxis:[{ axisLabel: newLabel }] });
    }

    updateXAxisLabel();
    chart.on('dataZoom', updateXAxisLabel);
    window.addEventListener('resize', ()=>{ chart.resize(); updateXAxisLabel(); });
    return chart;
  }
};

// ç¯„ä¾‹è³‡æ–™
const rawData = [
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABp","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AAc","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHy" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAs","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAk","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHa" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHz" },
  { "ACT_LV1":"AAb","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHz" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHu" },
  { "ACT_LV1":"ABp","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABe","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AAc","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABx","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAxs","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHd" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABc","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHq" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AAk","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"ABcz","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"AA","DATA_YM":"202501","EM_TOTAL":3333,"SCOPE":"1","SITE":"AUHz" },
  { "ACT_LV1":"AAbz","DATA_YM":"202501","EM_TOTAL":4444,"SCOPE":"2","SITE":"AUHC" },
  { "ACT_LV1":"ABzc","DATA_YM":"202501","EM_TOTAL":5555,"SCOPE":"1","SITE":"AUHC" },
  { "ACT_LV1":"AB","DATA_YM":"202501","EM_TOTAL":2222,"SCOPE":"2","SITE":"AUHz" }
]

// === å»ºç«‹åœ–è¡¨è¨­å®š ===
function buildChartConfig(data, opts={}) {
  const { valueField='EM_TOTAL', xField='ACT_LV1', groupField='SITE', chartType='bar', title='åœ–è¡¨', xlabel=xField, ylabel=valueField, xlabelMode='auto', colors=[], autoDataZoom=0, legendMode='scroll' } = opts;
  if(!Array.isArray(data)||data.length===0) return { type:chartType, title, categories:[], series:[], autoDataZoom };
  const categories = [...new Set(data.map(d=>d[xField]))];
  let series = [];
  if(chartType==='pie'){
    const groups = groupField?[...new Set(data.map(d=>d[groupField]))]:categories;
    series = groups.map(g=>({ name:g, data:[data.filter(d=>groupField?d[groupField]===g:d[xField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0)] }));
  } else {
    const groups = groupField?[...new Set(data.map(d=>d[groupField]))]:[];
    if(chartType==='stackedPercent'){
      series = groups.map(g=>({ name:g, data:categories.map(cat=>{
        const total = data.filter(d=>d[xField]===cat).reduce((sum,d)=>sum+Number(d[valueField]||0),0);
        const val = data.filter(d=>d[xField]===cat && d[groupField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0);
        return { value: total?((val/total)*100).toFixed(2):0, rawValue: val };
      })}));
    } else {
      series = groups.map((g,i)=>({ name:g, type: chartType==='mixed' && i===1?'line':undefined, data:categories.map(cat=>data.filter(d=>d[xField]===cat && d[groupField]===g).reduce((sum,d)=>sum+Number(d[valueField]||0),0)) }));
    }
  }
  return { type:chartType, title, xlabel, ylabel, xlabelMode, categories, series, colors, autoDataZoom, legendMode };
}

// === ç”Ÿæˆåœ–è¡¨ ===
const charts = [
  buildChartConfig(rawData,{ chartType:'stacked', title:'å †ç–Šåœ–ç¤ºä¾‹', legendMode:'wrap' }),
  buildChartConfig(rawData,{ chartType:'stackedPercent', title:'ç™¾åˆ†æ¯”å †ç–Šåœ–', autoDataZoom:20, legendMode:'scroll' }),
  buildChartConfig(rawData,{ chartType:'grouped', title:'ç¾¤çµ„ç›´æ¢åœ–', autoDataZoom:20 }),
  buildChartConfig(rawData,{ chartType:'pie', title:'åœ“é¤…åœ–ç¤ºä¾‹', legendMode:'scroll' }),
  buildChartConfig(rawData,{ chartType:'line', title:'æŠ˜ç·šåœ–ç¤ºä¾‹', autoDataZoom:10 }),
  buildChartConfig(rawData,{ chartType:'mixed', title:'æŸ±ç‹€+æŠ˜ç·šæ··åˆ', colors:['#3b82f6','#f97316'], autoDataZoom:20 })
];

const container = document.getElementById('chartContainer');
charts.forEach((cfg,i)=>{
  const div = document.createElement('div');
  div.className='chart-item';
  div.id='chart'+i;
  container.appendChild(div);
  ChartUtil.renderChart(div.id,cfg);
});
</script>
</body>
</html>
