// å­é  JS
window.parent.loader.load("pages/report.html");

// ä¾‹å¦‚ï¼šå­é æƒ³è®“å·¦å´é¸å–® highlight æŸå€‹é …ç›®
const link = window.parent.document.querySelector(`a[data-target='pages/report.html']`);
window.parent.loader.setActiveMenu($(link));


function loadPage(target) {
    if (window.parent && window.parent.loader) {
        window.parent.loader.load(target);
    }
}


async load(target, pushToHistory = true) {
    this.showLoading();

    if (this.debugMode) {
        this.iframe.src = target;
        this.iframe.onload = () => this.iframe.contentWindow.__PAGE_URL__ = target;
        if (pushToHistory) history.pushState({ url: target }, "", "");
        this._attachOnLoadHandlers();
        this._applyAutoResize();
        return;
    }

    try {
        const cached = await this.db.get(target);

        // ğŸ”¸ åªç”¨ version.txt ä¾†åˆ¤æ–·å¿«å–æ˜¯å¦å¤±æ•ˆ
        let currentVersion = "";
        try {
            const res = await fetch("/version.txt", { method: "GET", cache: "no-store" });
            if (res.ok) {
                const etag = res.headers.get("ETag");
                const lastMod = res.headers.get("Last-Modified");
                currentVersion = etag || lastMod || "";
            }
        } catch (e) {
            console.warn("Failed to fetch version.txt:", e);
        }

        const now = Date.now();
        const cacheValid = cached && ((now - (cached.saveTime || 0)) < this.cacheExpireMs);

        // èƒŒæ™¯æ›´æ–°å¿«å–ï¼ˆéåŒæ­¥ï¼‰
        this._backgroundUpdateCache(target, currentVersion);

        if (cached && cacheValid && cached.version === currentVersion) {
            this.iframe.srcdoc = cached.html;
            setTimeout(() => this.iframe.contentWindow.__PAGE_URL__ = target, 10);
            this._attachOnLoadHandlers();
            this._applyAutoResize();
            if (pushToHistory) history.pushState({ url: target }, "", "");
            return;
        }

        // âš™ï¸ æ²’å¿«å–æˆ–ç‰ˆæœ¬è®Šæ›´ â†’ é‡æ–°æŠ“å–
        const resp = await fetch(target, { cache: "no-cache" });
        const html = await resp.text();
        this.iframe.srcdoc = html;
        setTimeout(() => this.iframe.contentWindow.__PAGE_URL__ = target, 10);

        await this.db.put(target, html, currentVersion);
        await this.db.clearOld(this.maxCacheItems);

        this._attachOnLoadHandlers();
        this._applyAutoResize();
        if (pushToHistory) history.pushState({ url: target }, "", "");
    } catch (err) {
        console.error("IFrameLoader.load error:", err);
        try { this.iframe.src = target; } catch (_) { }
    }
}


if (this.debugMode && currentVersion) {
    console.log("ğŸ”¹ version.txt:", currentVersion);
}

ä½ åªéœ€è¦ æ–°å¢å…©å€‹æ–¹æ³•ï¼š

showVersionUpdating()

hideVersionUpdating()

ä¸¦åœ¨ detect version change çš„åœ°æ–¹å‘¼å«ã€‚

âœ” Step 1ï¼šåœ¨ class è£¡æ–°å¢ Overlay UIï¼ˆæ”¾åœ¨æœ€å¾Œ methods å€ï¼‰

æŠŠé€™æ®µç›´æ¥è²¼åˆ° IFrameLoader class è£¡ä»»æ„ä½ç½®ï¼ˆå»ºè­°è²¼åœ¨ showLoading/hideLoading åº•ä¸‹ï¼‰ï¼š

// é¡¯ç¤ºã€ŒUpdating versionã€æç¤º
showVersionUpdating() {
    if ($("#version-update-mask").length === 0) {
        $("body").append(`
            <div id="version-update-mask" style="
                position: fixed; top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,.6);
                z-index: 3000; display: flex;
                align-items: center; justify-content: center;
                flex-direction: column; color: white;
                font-size: 22px; font-weight: bold;
            ">
                <div class="spinner-border"></div>
                <span style="margin-top: 12px;">Updating version...</span>
            </div>
        `);
    } else {
        $("#version-update-mask").show();
    }
}

hideVersionUpdating() {
    $("#version-update-mask").fadeOut(200);
}

âœ” Step 2ï¼šåœ¨ load() åŠ å…¥ç‰ˆæœ¬è®Šå‹•åˆ¤æ–·

æ‰¾åˆ°ä½  load() è£¡çš„ï¼š

if (cached && cacheValid && cached.version === currentVersion) {


æ”¹æˆï¼š

if (cached && cacheValid && cached.version === currentVersion) {
    // âœ” å¿«å–æœ‰æ•ˆï¼Œç›´æ¥è¼‰å…¥
    this.iframe.srcdoc = cached.html;

    setTimeout(() => {
        this.iframe.contentWindow.__PAGE_URL__ = target;
    }, 10);

    this._attachOnLoadHandlers();
    this._applyAutoResize();
    if (pushToHistory) history.pushState({ url: target }, "", "");
    return;
}
else if (cached && cached.version !== currentVersion) {
    // â—ç‰ˆæœ¬è®Šå‹•ï¼šé¡¯ç¤º Updating animation
    this.showVersionUpdating();
}

âœ” Step 3ï¼šç•¶å®ŒæˆæŠ“æœ€æ–° HTML å¾Œï¼Œæ¶ˆé™¤ overlay

åœ¨ load() çš„ fetch å¾Œé¢ï¼ˆæˆåŠŸæ›´æ–°å¿«å–å¾Œï¼‰ï¼ŒåŠ å…¥ï¼š

await this.db.put(target, html, currentVersion);
await this.db.clearOld(this.maxCacheItems);

// âœ… ç‰ˆæœ¬æ›´æ–°è™•ç†å®Œæˆ
this.hideVersionUpdating();

âœ… å®Œæ•´ç‰ˆæœ¬è®Šå‹•æµç¨‹
éšæ®µ	äº‹ä»¶
1	fetch /version.txt çš„ ETag / Last-Modified
2	èˆ‡ IndexedDB å¿«å–ç‰ˆæœ¬æ¯”å°
3	ğŸš¨ è‹¥ç‰ˆæœ¬ä¸åŒ â†’ showVersionUpdating()
4	æŠ“æ–°çš„ HTML
5	æ›´æ–° IndexedDB
6	âœ… hideVersionUpdating()
ğŸ”¥ Debug Mode æ”¯æ´

è‹¥ debugMode=trueï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰ï¼Œä»æœƒç›´æ¥è¼‰å…¥ iframe.src = target
ä¸æœƒä½¿ç”¨å¿«å–ï¼Œç”¨æ–¼èª¿è©¦ã€‚

è‹¥éœ€è¦ ETag fallback or Last-Modified å„ªå…ˆæ¯”è¼ƒï¼Œä¹Ÿå¯å†è£œå¼·ï¼š
currentVersion = etag || lastMod || Date.now();

ğŸ‰ æœ€å¾Œçµæœ

ä½ ç¾åœ¨æ“æœ‰ï¼š

âœ… å‰ç«¯åƒ…ä¾ version.txt åˆ¤æ–· cache æ˜¯å¦å¤±æ•ˆ

âœ… ç‰ˆæœ¬è®Šå‹•è‡ªå‹•é¡¯ç¤º Updating å‹•ç•«

âœ… zero backend æ”¹å‹•ï¼ˆä½ åªè¦æ›´æ–° version.txt timestampï¼‰

âœ… ä¸è®€ version.txt å…§å®¹ï¼Œåªè®€ Header

âœ… æœ€é«˜æ•ˆç‡ï¼šç„¡é ˆ HEADï¼Œåªç”¨ GET

å¦‚æœä½ é¡˜æ„ï¼Œæˆ‘å¯ä»¥å†æä¾›ï¼š

CacheDB schema + IndexedDB å¯è¦–åŒ–å·¥å…·

å¦‚ä½•åŠ ä¸Š md5(html) â†’ å¼·åˆ¶æ¯”è¼ƒå…§å®¹å·®ç•°

åŠ å…¥ ServiceWorker â†’ å…¨ç«™ AppCache



<PropertyGroup>
  <VersionFilePath>$(ProjectDir)version.txt</VersionFilePath>
</PropertyGroup>

<Target Name="GenerateVersionFile" AfterTargets="Build">
  <WriteLinesToFile
      File="$(VersionFilePath)"
      Lines="$(MSBuildProjectName) $(MSBuildThisFileModifiedTime)"
      Overwrite="true" />
</Target>
const res = await fetch("/version.txt", { cache: "no-store" });
const currentVersion = res.headers.get("Last-Modified") || res.headers.get("ETag") || await res.text();

