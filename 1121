ChatGPT èªªï¼š

æ˜ç™½ï¼Œä½ å¸Œæœ›çš„æ˜¯ï¼šä½¿ç”¨è€…ç›´æ¥åœ¨ç€è¦½å™¨è¼¸å…¥ MVC5 çš„ URLï¼ˆä¾‹å¦‚ /Dashboardï¼‰ï¼Œä½†æ˜¯å¯¦éš›ä¸Šå¾Œç«¯ä¸ç›´æ¥å›å‚³ MVC Viewï¼Œè€Œæ˜¯æŠŠä½¿ç”¨è€…å°å‘ä¸€å€‹åŒ…å« SPAï¼ˆå–®é æ‡‰ç”¨ï¼‰ iframe çš„é é¢ï¼Œä¸¦ä¸”é€™å€‹ SPA å…§éƒ¨å†è¼‰å…¥å…§å®¹ã€‚

é€™åœ¨ MVC5 + jQuery SPA çµ„åˆä¸­æ˜¯å¸¸è¦‹çš„ã€ŒURL å°å‘ SPAã€åšæ³•ã€‚æˆ‘æ•´ç†äº†å®Œæ•´æ–¹æ¡ˆï¼š

1ï¸âƒ£ å»ºç«‹ä¸€å€‹ MVC5 Controller ä¾†ä½œç‚ºã€ŒSPAå…¥å£ã€
public class SpaController : Controller
{
    // æ‰€æœ‰ç›´æ¥è¼¸å…¥ URL éƒ½å°å‘æ­¤ action
    public ActionResult Index(string route = "")
    {
        // route å¯ä»¥ç”¨ä¾†å‘Šè¨´ iframe è¦è¼‰å…¥å“ªå€‹é é¢
        ViewBag.Route = route;
        return View();
    }
}

2ï¸âƒ£ å»ºç«‹å°æ‡‰çš„ View (Index.cshtml)
@{
    Layout = null; // SPA é€šå¸¸ä¸éœ€è¦ MVC Layout
    var route = ViewBag.Route ?? "";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SPA Container</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <iframe id="spaFrame" style="width:100%; height:100vh; border:none;"></iframe>

    <script>
        $(function(){
            var route = '@route';
            // å°‡ route åƒæ•¸é™„åŠ åˆ° iframe çš„ src
            var url = "/spaapp.html"; // ä½ çš„ SPA HTML é é¢
            if(route) {
                url += "#" + route; // hash è·¯ç”±
            }
            $("#spaFrame").attr("src", url);
        });
    </script>
</body>
</html>


âœ… èªªæ˜ï¼š

route å¯ä»¥æ¥æ”¶åŸæœ¬è¼¸å…¥çš„ URLï¼Œä¾‹å¦‚ /Dashboard â†’ ?route=Dashboardã€‚

iframe å…§è¼‰å…¥ä½ çš„ SPA HTML (spaapp.html)ã€‚

SPA å¯ä»¥ä½¿ç”¨ hash routing æˆ– history routing ä¾†æ§åˆ¶å…§éƒ¨é é¢ã€‚

3ï¸âƒ£ MVC Route è¨­å®šï¼ˆé¿å…æ‰¾ä¸åˆ°è·¯ç”±ï¼‰

åœ¨ RouteConfig.cs ä¸­åŠ ä¸Š catch-all routeï¼ŒæŠŠæ‰€æœ‰æœªåŒ¹é…çš„ URL å°å‘ SPAï¼š

routes.MapRoute(
    name: "SpaFallback",
    url: "{*route}",
    defaults: new { controller = "Spa", action = "Index" }
);


{*route} æ•æ‰æ‰€æœ‰ URLã€‚

é¿å…ä½¿ç”¨è€…ç›´æ¥è¼¸å…¥ /Dashboard æ™‚ 404ï¼Œæœƒè‡ªå‹•é€²å…¥ SPA å®¹å™¨ã€‚

å¦‚æœä½ æœ‰ä¸€äº› API æˆ–å…¶ä»– MVC Pageï¼Œéœ€è¦æ”¾åœ¨ å‰é¢å®šç¾©ï¼Œè®“ catch-all ä¸è¦†è“‹ã€‚

4ï¸âƒ£ SPA å…§éƒ¨è™•ç† route

å¦‚æœä½¿ç”¨ hash routing (#dashboard)ï¼Œiframe å…§çš„ jQuery SPA å¯ä»¥è®€å– window.location.hashã€‚

å¦‚æœä½¿ç”¨ history routingï¼Œä½ éœ€è¦è¨­å®šå‰ç«¯ router å»è§£æ /Dashboardã€‚

ğŸ”¹ å®Œæ•´æµç¨‹ç¤ºæ„

ä½¿ç”¨è€…è¼¸å…¥ https://yourdomain.com/Dashboard

MVC5 Route catch-all å°å‘ SpaController.Index(route="Dashboard")

Index.cshtml ç”Ÿæˆ iframeï¼Œä¸¦æŠŠ #Dashboard å‚³çµ¦ SPA

SPA è§£æ hashï¼Œè¼‰å…¥å°æ‡‰å…§å®¹

é€™æ¨£åšçš„å¥½è™•ï¼š

å¾Œç«¯ä¸éœ€è¦ç‚ºæ¯å€‹ SPA å­é é¢å»ºç«‹ Actionã€‚

å¯ä»¥çµ±ä¸€åœ¨ iframe å…§ç®¡ç† SPAã€‚

ä¿ç•™åŸæœ¬ URLï¼ˆæˆ–ç”¨ hash/history routingï¼‰ã€‚

æˆ‘å¯ä»¥å¹«ä½ å¯«ä¸€å€‹ å¯ç›´æ¥ç”¨åœ¨ MVC5 çš„å®Œæ•´ SPA iframe ç¯„ä¾‹ï¼ŒåŒ…å«ï¼š

catch-all route

iframe è‡ªå‹•å°å‘ hash

jQuery SPA å…§éƒ¨è¼‰å…¥å…§å®¹

é€™æ¨£ç›´æ¥è¼¸å…¥ä»»ä½• URL éƒ½æœƒè·‘ SPAã€‚

ä½ å¸Œæœ›æˆ‘å¹«ä½ å¯«å—ï¼Ÿ

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å°è£ Select2 å¤§è³‡æ–™åˆ†é æœå°‹</title>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  select { width: 300px; margin: 10px; }
</style>
</head>
<body>
<h2>å°è£ Select2 - å¤§è³‡æ–™åˆ†é  + æœå°‹</h2>

<select id="mySelect"></select>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// æ¨¡æ“¬å¤§é‡è³‡æ–™
const largeData = [];
for(let i=1;i<=1000;i++){
    largeData.push({id: i, text: `é¸é … ${i}`});
}
(function ($) {
    $.fn.largeSelect2 = function (options) {

        const settings = $.extend({
            placeholder: "è«‹é¸æ“‡",
            allowClear: true,
            pageSize: 50,
            initValue: null,          // å¯ç‚º {id, text} æˆ– [ {id,text}, ... ]
            dataSource: null,
            delay: 250,
            enableSearch: true,

            localSearchOnly: false,
            serverSearchOnly: false,

            minSearchLength: 0,
            multiple: false           // ğŸ”¥ æ–°å¢ï¼šæ”¯æ´å¤šé¸
        }, options);

        const $select = $(this);

        // ---------------------
        // åˆå§‹åŒ– Select2
        // ---------------------
        function init() {
            const config = {
                placeholder: settings.placeholder,
                allowClear: settings.allowClear,
                multiple: settings.multiple     // ğŸ”¥ å¥—ç”¨å¤šé¸
            };

            // ------------------------------------------------------
            // ğŸ”¥ enableSearch = false â†’ ç„¡æœå°‹ï¼Œä¸ç”¨ AJAX
            // ------------------------------------------------------
            if (!settings.enableSearch) {
                config.minimumResultsForSearch = Infinity;

                if (settings.serverSearchOnly) {
                    console.warn("largeSelect2: enableSearch=false ç„¡æ³• serverSearchOnly â†’ æ”¹ç‚ºä½¿ç”¨ local");
                }

                config.data = getAllLocalItems();

            } else {
                config.ajax = buildAjax();
            }

            $select.select2(config);

            // åˆå§‹åŒ–é è¨­å€¼
            if (settings.initValue) {
                if (Array.isArray(settings.initValue)) {
                    setValues(settings.initValue);
                } else {
                    setValue(settings.initValue.id, settings.initValue.text);
                }
            }
        }

        // ç”¨æ–¼ enableSearch=false æ™‚ç›´æ¥æä¾› data
        function getAllLocalItems() {
            let source = [];

            if (Array.isArray(settings.dataSource)) {
                source = settings.dataSource;
            } else if (typeof settings.dataSource === "function") {
                console.warn("largeSelect2: enableSearch=false â†’ dataSource å¿…é ˆæ˜¯ arrayï¼Œfunction å°‡è¢«å¿½ç•¥");
            }

            return source;
        }

        // ---------------------
        // Select2 Ajax Transport
        // ---------------------
        function buildAjax() {
            return {
                transport: async function (params, success, failure) {
                    const page = params.data.page || 1;
                    const search = params.data.q || "";

                    // æœå°‹å­—æ•¸ä¸è¶³ï¼Œå›å‚³ç©º
                    if (settings.minSearchLength > 0 && search.length < settings.minSearchLength) {
                        return success({ results: [], pagination: { more: false } });
                    }

                    try {
                        const result = await fetchData(search, page);
                        success(result);
                    } catch (err) {
                        failure(err);
                    }
                },
                delay: settings.delay
            };
        }

        // ---------------------
        // è³‡æ–™æ¨¡å¼é‚è¼¯
        // ---------------------
        async function fetchData(search, page) {

            // 1ï¸âƒ£ localSearchOnly
            if (settings.localSearchOnly) {
                const source = settings.dataSource || [];
                let filtered = search
                    ? source.filter(x => x.text.includes(search))
                    : source;

                return paginate(filtered, page);
            }

            // 2ï¸âƒ£ serverSearchOnly
            if (settings.serverSearchOnly) {
                if (typeof settings.dataSource !== "function") {
                    console.error("serverSearchOnly requires dataSource to be a function");
                    return paginate([], page);
                }
                return await settings.dataSource({ search, page, pageSize: settings.pageSize });
            }

            // 3ï¸âƒ£ Hybrid / Auto
            if (typeof settings.dataSource === "function") {
                return await settings.dataSource({ search, page, pageSize: settings.pageSize });
            } else {
                const source = settings.dataSource || [];
                let filtered = search
                    ? source.filter(x => x.text.includes(search))
                    : source;

                return paginate(filtered, page);
            }
        }

        // ---------------------
        // æœ¬åœ°åˆ†é å·¥å…·
        // ---------------------
        function paginate(list, page) {
            const pageSize = settings.pageSize;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;

            return {
                results: list.slice(start, end),
                pagination: { more: end < list.length }
            };
        }

        // ---------------------
        // Public API
        // ---------------------
        function getValue() {
            return $select.val();
        }

        // å–®ç­†é¸æ“‡
        function setValue(id, text) {
            const option = new Option(text, id, true, true);
            $select.append(option).trigger("change");
        }

        // å¤šé¸ç‰ˆæœ¬
        function setValues(items) {
            if (!Array.isArray(items)) return;

            items.forEach(({ id, text }) => {
                const option = new Option(text, id, true, true);
                $select.append(option);
            });

            $select.trigger("change");
        }

        function clear() {
            $select.val(null).trigger("change");
        }

        function updateSource(newSource) {
            settings.dataSource = newSource;
            refresh();
        }

        function refresh() {
            destroy();
            init();
        }

        function destroy() {
            $select.off();
            $select.select2("destroy");
        }

        // Expose API
        $select.data("largeSelect2", {
            getValue,
            setValue,
            setValues,
            clear,
            updateSource,
            refresh,
            destroy
        });

        init();
        return this;
    };
})(jQuery);


// ä½¿ç”¨ç¯„ä¾‹
$("#mySelect").largeSelect2({
    multiple: true,
    dataSource: largeData,
    placeholder: "è«‹é¸æ“‡é …ç›®"
});
// ç›£è½è®ŠåŒ–
$('#mySelect').on('change', function () {
    console.log('æ”¹è®Š:', $(this).val());
	
	const api = $('#mySelect').data('largeSelect2');

console.log("ç›®å‰å€¼:", api.getValue());
});
</script>
</body>
</html>
