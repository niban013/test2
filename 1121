<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å°è£ Select2 å¤§è³‡æ–™åˆ†é æœå°‹</title>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  select { width: 300px; margin: 10px; }
</style>
</head>
<body>
<h2>å°è£ Select2 - å¤§è³‡æ–™åˆ†é  + æœå°‹</h2>

<select id="mySelect"></select>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// æ¨¡æ“¬å¤§é‡è³‡æ–™
const largeData = [];
for(let i=1;i<=1000;i++){
    largeData.push({id: i, text: `é¸é … ${i}`});
}
(function ($) {
    $.fn.largeSelect2 = function (options) {

        const settings = $.extend({
            placeholder: "è«‹é¸æ“‡",
            allowClear: true,
            pageSize: 50,
            initValue: null,          // å¯ç‚º {id, text} æˆ– [ {id,text}, ... ]
            dataSource: null,
            delay: 250,
            enableSearch: true,

            localSearchOnly: false,
            serverSearchOnly: false,

            minSearchLength: 0,
            multiple: false           // ğŸ”¥ æ–°å¢ï¼šæ”¯æ´å¤šé¸
        }, options);

        const $select = $(this);

        // ---------------------
        // åˆå§‹åŒ– Select2
        // ---------------------
        function init() {
            const config = {
                placeholder: settings.placeholder,
                allowClear: settings.allowClear,
                multiple: settings.multiple     // ğŸ”¥ å¥—ç”¨å¤šé¸
            };

            // ------------------------------------------------------
            // ğŸ”¥ enableSearch = false â†’ ç„¡æœå°‹ï¼Œä¸ç”¨ AJAX
            // ------------------------------------------------------
            if (!settings.enableSearch) {
                config.minimumResultsForSearch = Infinity;

                if (settings.serverSearchOnly) {
                    console.warn("largeSelect2: enableSearch=false ç„¡æ³• serverSearchOnly â†’ æ”¹ç‚ºä½¿ç”¨ local");
                }

                config.data = getAllLocalItems();

            } else {
                config.ajax = buildAjax();
            }

            $select.select2(config);

            // åˆå§‹åŒ–é è¨­å€¼
            if (settings.initValue) {
                if (Array.isArray(settings.initValue)) {
                    setValues(settings.initValue);
                } else {
                    setValue(settings.initValue.id, settings.initValue.text);
                }
            }
        }

        // ç”¨æ–¼ enableSearch=false æ™‚ç›´æ¥æä¾› data
        function getAllLocalItems() {
            let source = [];

            if (Array.isArray(settings.dataSource)) {
                source = settings.dataSource;
            } else if (typeof settings.dataSource === "function") {
                console.warn("largeSelect2: enableSearch=false â†’ dataSource å¿…é ˆæ˜¯ arrayï¼Œfunction å°‡è¢«å¿½ç•¥");
            }

            return source;
        }

        // ---------------------
        // Select2 Ajax Transport
        // ---------------------
        function buildAjax() {
            return {
                transport: async function (params, success, failure) {
                    const page = params.data.page || 1;
                    const search = params.data.q || "";

                    // æœå°‹å­—æ•¸ä¸è¶³ï¼Œå›å‚³ç©º
                    if (settings.minSearchLength > 0 && search.length < settings.minSearchLength) {
                        return success({ results: [], pagination: { more: false } });
                    }

                    try {
                        const result = await fetchData(search, page);
                        success(result);
                    } catch (err) {
                        failure(err);
                    }
                },
                delay: settings.delay
            };
        }

        // ---------------------
        // è³‡æ–™æ¨¡å¼é‚è¼¯
        // ---------------------
        async function fetchData(search, page) {

            // 1ï¸âƒ£ localSearchOnly
            if (settings.localSearchOnly) {
                const source = settings.dataSource || [];
                let filtered = search
                    ? source.filter(x => x.text.includes(search))
                    : source;

                return paginate(filtered, page);
            }

            // 2ï¸âƒ£ serverSearchOnly
            if (settings.serverSearchOnly) {
                if (typeof settings.dataSource !== "function") {
                    console.error("serverSearchOnly requires dataSource to be a function");
                    return paginate([], page);
                }
                return await settings.dataSource({ search, page, pageSize: settings.pageSize });
            }

            // 3ï¸âƒ£ Hybrid / Auto
            if (typeof settings.dataSource === "function") {
                return await settings.dataSource({ search, page, pageSize: settings.pageSize });
            } else {
                const source = settings.dataSource || [];
                let filtered = search
                    ? source.filter(x => x.text.includes(search))
                    : source;

                return paginate(filtered, page);
            }
        }

        // ---------------------
        // æœ¬åœ°åˆ†é å·¥å…·
        // ---------------------
        function paginate(list, page) {
            const pageSize = settings.pageSize;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;

            return {
                results: list.slice(start, end),
                pagination: { more: end < list.length }
            };
        }

        // ---------------------
        // Public API
        // ---------------------
        function getValue() {
            return $select.val();
        }

        // å–®ç­†é¸æ“‡
        function setValue(id, text) {
            const option = new Option(text, id, true, true);
            $select.append(option).trigger("change");
        }

        // å¤šé¸ç‰ˆæœ¬
        function setValues(items) {
            if (!Array.isArray(items)) return;

            items.forEach(({ id, text }) => {
                const option = new Option(text, id, true, true);
                $select.append(option);
            });

            $select.trigger("change");
        }

        function clear() {
            $select.val(null).trigger("change");
        }

        function updateSource(newSource) {
            settings.dataSource = newSource;
            refresh();
        }

        function refresh() {
            destroy();
            init();
        }

        function destroy() {
            $select.off();
            $select.select2("destroy");
        }

        // Expose API
        $select.data("largeSelect2", {
            getValue,
            setValue,
            setValues,
            clear,
            updateSource,
            refresh,
            destroy
        });

        init();
        return this;
    };
})(jQuery);


// ä½¿ç”¨ç¯„ä¾‹
$("#mySelect").largeSelect2({
    multiple: true,
    dataSource: largeData,
    placeholder: "è«‹é¸æ“‡é …ç›®"
});
// ç›£è½è®ŠåŒ–
$('#mySelect').on('change', function () {
    console.log('æ”¹è®Š:', $(this).val());
	
	const api = $('#mySelect').data('largeSelect2');

console.log("ç›®å‰å€¼:", api.getValue());
});
</script>
</body>
</html>
